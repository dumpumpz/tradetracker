<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; }
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: #666; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: #007bff; border-bottom-color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #bank-balance-container { position: relative; text-align: center; margin: 10px auto 25px auto; font-size: 24px; font-weight: bold; color: #333; padding: 10px; background-color: #e9ecef; border-radius: 8px; max-width: 400px; transition: all 0.2s ease-in-out; }
        #toggle-balance-btn { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.6; margin: 0; }
        #toggle-balance-btn:hover { opacity: 1; }
        #toggle-balance-btn svg { width: 24px; height: 24px; }
        #bank-balance-container .icon-show { display: block; }
        #bank-balance-container .icon-hide { display: none; }
        #bank-balance-container.balance-minimized { font-size: 16px; padding: 5px 10px; max-width: 180px; background-color: #f8f9fa; }
        #bank-balance-container.balance-minimized #bank-balance-value { display: none; }
        #bank-balance-container.balance-minimized .icon-show { display: none; }
        #bank-balance-container.balance-minimized .icon-hide { display: block; }
        #bank-balance-value { font-weight: bolder; }

        .master-only { display: none; }
        #add-trade-form { max-width: 950px; margin: 20px auto; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button:hover { opacity: 0.85; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; }
        th { background-color: #e9ecef; font-weight: bold; }
        .action-buttons button { padding: 5px 10px; font-size: 12px; }

        #journal-tab { position: relative; }
        #journal-controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin: 20px auto; }
        #journal-controls > div { display: flex; align-items: center; gap: 8px; }
        
        #journal-entry { width: 100%; min-height: 25vh; resize: vertical; line-height: 1.6; margin-top: 5px; overflow-y: hidden; }
        #journal-entry:read-only { background-color: #f8f9fa; cursor: not-allowed; color: #555; }
        
        #image-upload-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: #007bff; }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid #ddd; padding: 5px; background: #fafafa; border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; border-radius: 2px; }
        
        .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; opacity: 0.7; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .journal-image-wrapper:hover .delete-journal-image { opacity: 1; transform: scale(1.1); }
        .delete-journal-image svg { width: 16px; height: 16px; fill: white; }

        #journal-tab.drag-over { border: 3px dashed #007bff; background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #007bff; z-index: 999; pointer-events: none; }
        
        @media (max-width: 768px) { .container { padding: 10px; } #add-trade-form { grid-template-columns: 1fr; } .section-header { flex-direction: column; } .backup-controls { position: static; margin-top: 10px; } .journal-image-wrapper { max-width: 100%; } th, td { font-size: 12px; padding: 6px; } .action-buttons button { font-size: 11px; padding: 4px 8px; } }
    </style>
</head>
<body>
    <div class="container"><!-- HTML structure is unchanged --></div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
            authDomain: "journal-a003f.firebaseapp.com",
            databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "journal-a003f",
            storageBucket: "journal-a003f.firebasestorage.app",
            messagingSenderId: "1038636626553",
            appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const tradesRef = database.ref('trades');
        const completedTradesRef = database.ref('completed_trades');
        const bankRef = database.ref('bank');
        const journalRef = database.ref('journal_text'); 
        const journalImagesRef = database.ref('journal_images'); 
        const FEE_RATE = 0.00075;
        const STARTING_BALANCE = 4000;

        document.addEventListener('DOMContentLoaded', function () {
            // Unchanged variables and element cache
            let isMasterUser = false, masterPassword = null, allJournalText = {}, allJournalImages = {};
            const journalSymbolEl = document.getElementById('journal-symbol');
            const journalTimeframeEl = document.getElementById('journal-timeframe');
            const journalEntryEl = document.getElementById('journal-entry');
            const journalImagesContainer = document.getElementById('journal-images-container');
            const bankBalanceContainer = document.getElementById('bank-balance-container');
            const toggleBalanceBtn = document.getElementById('toggle-balance-btn');
            const balanceTextEl = document.getElementById('balance-text');
            const tradesTbody = document.getElementById('trades-tbody');
            const completedTradesTbody = document.getElementById('completed-trades-tbody');
            const journalTab = document.getElementById('journal-tab');
            
            // --- UPDATED UPLOAD FUNCTION WITH ERROR CATCHING ---
            function handleFileUpload(file) {
                if (!isMasterUser || !masterPassword) return; 
                if (!file || !file.type.startsWith('image/')) return;

                const safeSymbol = getSafeSymbol(journalSymbolEl.value);
                const timeframe = journalTimeframeEl.value;
                const fileName = `${Date.now()}_${file.name}`;
                const fileRef = storage.ref(`journal_images/${safeSymbol}/${timeframe}/${fileName}`);
                const metadata = { customMetadata: { 'password': masterPassword } };
                const uploadTask = fileRef.put(file, metadata);
                const uploadProgressEl = document.getElementById('upload-progress');
                
                uploadProgressEl.style.display = 'block';
                uploadTask.on('state_changed', 
                    (s) => { uploadProgressEl.textContent = `Uploading... ${Math.round((s.bytesTransferred/s.totalBytes)*100)}%`; },
                    (storageError) => { 
                        console.error("FIREBASE STORAGE UPLOAD ERROR:", storageError);
                        uploadProgressEl.textContent = `Upload Failed: ${storageError.code}`;
                    }, 
                    () => {
                        // This block runs AFTER the file is successfully in Storage
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            const imageData = { url: downloadURL, fileName: fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                            
                            // Now, try to save the link to the Realtime Database
                            journalImagesRef.child(safeSymbol).child(timeframe).push(imageData)
                                .then(() => {
                                    // THIS IS THE TRUE SUCCESS
                                    uploadProgressEl.textContent = 'Upload Complete!';
                                    setTimeout(() => { uploadProgressEl.style.display = 'none'; }, 2000);
                                })
                                .catch((dbError) => {
                                    // THIS CATCHES THE DATABASE ERROR
                                    console.error("REALTIME DATABASE WRITE ERROR:", dbError);
                                    uploadProgressEl.textContent = 'Upload OK, but DB save failed: ' + dbError.message;
                                    // Optional: automatically delete the orphaned image from storage
                                    fileRef.delete(); 
                                });
                        });
                    }
                );
            }

            // --- ALL OTHER FUNCTIONS (UNCHANGED) ---
            function autoResizeTextarea(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }
            function getSafeSymbol(symbol) { return symbol.replace('/', '-'); }
            function updateJournalView() { const selectedSymbol = getSafeSymbol(journalSymbolEl.value); const selectedTimeframe = journalTimeframeEl.value; const symbolTextData = allJournalText[selectedSymbol] || {}; journalEntryEl.value = symbolTextData[selectedTimeframe] || ''; autoResizeTextarea(journalEntryEl); const symbolImageData = allJournalImages[selectedSymbol] || {}; renderJournalImages(selectedSymbol, selectedTimeframe, symbolImageData); }
            function checkMasterMode() { const urlParams = new URLSearchParams(window.location.search); if (urlParams.get('master') === 'true') { const password = prompt("Please enter master password:"); if (password) { isMasterUser = true; masterPassword = password; document.querySelectorAll('.master-only').forEach(el => { if (el.id === 'add-trade-form') el.style.display = 'grid'; else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell'; else if (el.classList.contains('backup-controls')) el.style.display = 'flex'; else el.style.display = 'block'; }); journalEntryEl.readOnly = false; } } if (!isMasterUser) { journalEntryEl.readOnly = true; } }
            checkMasterMode();
            function renderJournalImages(symbol, timeframe, imagesForSymbol) { journalImagesContainer.innerHTML = ''; const imagesForTimeframe = imagesForSymbol[timeframe] || {}; Object.keys(imagesForTimeframe).sort((a,b)=>imagesForTimeframe[a].timestamp-imagesForTimeframe[b].timestamp).forEach(id => { const img = imagesForTimeframe[id]; const wrapper = document.createElement('div'); wrapper.className = 'journal-image-wrapper'; const deleteButton = (isMasterUser && masterPassword) ? `<button class="delete-journal-image" title="Delete Image" data-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${img.fileName}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : ''; wrapper.innerHTML = `${deleteButton}<img src="${img.url}" alt="Journal Image">`; journalImagesContainer.appendChild(wrapper); }); }
            toggleBalanceBtn.addEventListener('click', () => { bankBalanceContainer.classList.toggle('balance-minimized'); balanceTextEl.textContent = bankBalanceContainer.classList.contains('balance-minimized') ? 'Balance Hidden' : 'Current Balance: '; });
            const saveJournalEntry = (() => { let t; return () => { clearTimeout(t); t = setTimeout(() => { if (!isMasterUser || !masterPassword) return; const safeSymbol = getSafeSymbol(journalSymbolEl.value); const timeframe = journalTimeframeEl.value; document.getElementById('save-status').textContent = 'Saving...'; journalRef.child(safeSymbol).child(timeframe).set(journalEntryEl.value).then(() => { document.getElementById('save-status').textContent = 'Saved.'; setTimeout(() => document.getElementById('save-status').textContent = '', 2000); }).catch(e => document.getElementById('save-status').textContent = `Error: ${e.message}`); }, 750); }; })();
            journalEntryEl.addEventListener('input', () => autoResizeTextarea(journalEntryEl));
            journalEntryEl.addEventListener('input', saveJournalEntry);
            tradesTbody.addEventListener('click', e => { if (!isMasterUser || !masterPassword) return; const button = e.target.closest('button'); if (!button) return; const { id } = button.dataset; if (button.classList.contains('delete-btn')) { if (confirm('Delete live trade?')) tradesRef.child(id).remove(); } else if (button.classList.contains('win-btn')) { completeTrade(id, 'win'); } else if (button.classList.contains('loss-btn')) { completeTrade(id, 'loss'); } });
            completedTradesTbody.addEventListener('click', e => { if (!isMasterUser || !masterPassword) return; const button = e.target.closest('.delete-btn-completed'); if (button && confirm('Delete completed trade?')) { completedTradesRef.child(button.dataset.id).remove(); } });
            journalSymbolEl.addEventListener('change', updateJournalView);
            journalTimeframeEl.addEventListener('change', updateJournalView);
            document.getElementById('journal-image-upload').addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
            journalImagesContainer.addEventListener('click', (e) => { const button = e.target.closest('.delete-journal-image'); if (!isMasterUser || !masterPassword || !button) return; const { symbol, timeframe, id, filename } = button.dataset; if (confirm('Delete this image?')) { storage.ref(`journal_images/${symbol}/${timeframe}/${filename}`).delete().then(() => journalImagesRef.child(symbol).child(timeframe).child(id).remove()).catch((err) => { console.error(err); if (err.code === 'storage/object-not-found') journalImagesRef.child(symbol).child(timeframe).child(id).remove(); }); } });
            document.querySelector('.tabs').addEventListener('click', (e) => { if (e.target.matches('.tab-link')) { document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(e.target.dataset.tab + '-tab').classList.add('active'); } });
            ['dragenter','dragover','dragleave','drop'].forEach(ev=>journalTab.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
            ['dragenter','dragover'].forEach(ev=>journalTab.addEventListener(ev,()=>(isMasterUser && masterPassword) && journalTab.classList.add('drag-over')));
            ['dragleave','drop'].forEach(ev=>journalTab.addEventListener(ev,()=>(isMasterUser && masterPassword) && journalTab.classList.remove('drag-over')));
            journalTab.addEventListener('drop', (e) => { if (isMasterUser && e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]); });
            function calculateNetResult(trade, exitPrice) { const entry=parseFloat(trade.entry),posValue=parseFloat(trade.size),exit=parseFloat(exitPrice);if(isNaN(entry)||isNaN(posValue)||isNaN(exit))return{net_result:0,entry_fee:0,exit_fee:0};const entryFee=posValue*FEE_RATE,exitPosValue=(exit/entry)*posValue,exitFee=exitPosValue*FEE_RATE;const grossResult=trade.type==="Long"?(exit-entry)*(posValue/entry):(entry-exit)*(posValue/entry);return{net_result:grossResult-entryFee-exitFee,entry_fee:entryFee,exit_fee:exitFee};}
            function completeTrade(tradeId,outcome){database.ref('trades/'+tradeId).once('value',s=>{const t=s.val();if(!t)return;const d=outcome==='win'?t.target:t.stoploss;const p=prompt(`Enter exact exit price:`,d);if(p===null)return;const e=parseFloat(p);if(isNaN(e))return alert("Invalid exit price.");const{net_result,entry_fee,exit_fee}=calculateNetResult(t,e);const c={...t,closed_date:new Date().toLocaleString(),exit_price:e,net_result,entry_fee,exit_fee};delete c.expected_profit;delete c.expected_loss;completedTradesRef.push(c).then(()=>tradesRef.child(tradeId).remove());});}
            function renderLiveTable(d){const t=document.getElementById('trades-tbody');t.innerHTML='';if(!d)return;Object.keys(d).sort((a,b)=>new Date(d[b].date)-new Date(d[a].date)).forEach(id=>{const a=d[id],r=document.createElement('tr');r.innerHTML=`<td>${a.symbol}</td><td>${a.type}</td><td>${parseFloat(a.entry).toFixed(2)}</td><td>${parseFloat(a.stoploss).toFixed(2)}</td><td>${parseFloat(a.target).toFixed(2)}</td><td>${parseFloat(a.size).toFixed(2)}</td><td style="color: #28a745;">${parseFloat(a.expected_profit).toFixed(2)}</td><td style="color: #dc3545;">${parseFloat(a.expected_loss).toFixed(2)}</td><td>${a.date}</td>${isMasterUser?`<td class="action-buttons"><button class="win-btn" data-id="${id}">Win</button><button class="loss-btn" data-id="${id}">Loss</button><button class="delete-btn" data-id="${id}">Delete</button></td>`:''}`;t.appendChild(r);});}
            function renderCompletedTable(d){const t=document.getElementById('completed-trades-tbody');t.innerHTML='';if(!d)return;Object.keys(d).sort((a,b)=>new Date(d[b].closed_date)-new Date(d[a].closed_date)).forEach(id=>{const a=d[id],r=document.createElement('tr');const c=a.net_result>=0?'#28a745':'#dc3545',e=(a.entry_fee||0)+(a.exit_fee||0);r.innerHTML=`<td>${a.symbol}</td><td>${a.type}</td><td>${parseFloat(a.entry).toFixed(2)}</td><td>${parseFloat(a.exit_price).toFixed(2)}</td><td>${e.toFixed(2)}</td><td style="color:${c};font-weight:bold;">${parseFloat(a.net_result).toFixed(2)}</td><td>${a.date}</td><td>${a.closed_date}</td>${isMasterUser?`<td class="action-buttons"><button class="delete-btn-completed" data-id="${id}">Delete</button></td>`:''}`;t.appendChild(r);});}
            tradesRef.on('value',snapshot=>renderLiveTable(snapshot.val()));
            completedTradesRef.on('value',snapshot=>{const d=snapshot.val();renderCompletedTable(d);let t=0;if(d)t=Object.values(d).reduce((s,a)=>s+(a.net_result||0),0);bankRef.set({currentBalance:STARTING_BALANCE+t});});
            bankRef.on('value',s=>{let b=STARTING_BALANCE;if(s.exists()&&s.val().currentBalance!==null)b=s.val().currentBalance;document.getElementById('bank-balance-value').textContent=`$${parseFloat(b).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;document.getElementById('bank-balance-value').style.color=b>=STARTING_BALANCE?'#28a745':'#dc3545';});
            journalRef.on('value', (s) => { allJournalText = s.val() || {}; updateJournalView(); });
            journalImagesRef.on('value', (s) => { allJournalImages = s.val() || {}; updateJournalView(); });
        });
    </script>
</body>
</html>
