<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

</head>
        <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #333;
            --border-color: #ddd;
            --header-bg: #e9ecef;
            --link-color: #007bff;
            --subtle-text: #666;
            --card-bg: #fafafa;
            --shadow-color: rgba(0,0,0,0.1);
            --green-bg: #d4edda;
            --red-bg: #f8d7da;
            --purple-bg: #e2d9f3;
            --green-border: #c3e6cb;
            --red-border: #f5c6cb;
            --green-text: #155724;
            --red-text: #721c24;
            --green-bar: rgba(40, 167, 69, 0.2);
            --red-bar: rgba(220, 53, 69, 0.2);

        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --header-bg: #2c2c2c;
            --link-color: #58a6ff;
            --subtle-text: #888;
            --card-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.4);
            --green-bg: #1c3b23;
            --red-bg: #4d1f24;
            --purple-bg: #3c2a4d;
            --green-border: #285732;
            --red-border: #6b282e;
            --green-text: #a7d7b2;
            --red-text: #f5b7bd;
            --green-bar: rgba(40, 167, 69, 0.4);
            --red-bar: rgba(220, 53, 69, 0.4);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { 
    max-width: 98%; /* Uses almost the entire screen width */
    margin: auto; 
    background: var(--container-bg); 
    padding: 15px; 
    border-radius: 8px; 
    box-shadow: 0 2px 10px var(--shadow-color); 
    transition: background-color 0.3s; 
}
        h1 { text-align: center; color: var(--text-color); margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        h3 { text-align: center; color: var(--text-color); margin-top: 30px; margin-bottom: -5px; font-weight: 500;}
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: var(--subtle-text); }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

/* Default: Hidden */
.master-only { 
    display: none !important; 
}

/* If Body has 'is-master' class, show block elements */
body.is-master .master-only {
    display: block !important;
}

/* If Body has 'is-master' class, show table cells properly */
body.is-master td.master-only,
body.is-master th.master-only {
    display: table-cell !important;
}

/* Specific styling for the Close Group button */
.close-group-btn {
    background-color: var(--purple-bg) !important; 
    color: var(--text-color) !important;
    border: 1px solid var(--border-color);
    width: 100%; 
    font-size: 11px; 
    padding: 6px; 
    cursor: pointer;
    font-weight: bold;
    border-radius: 4px;
}
.close-group-btn:hover {
    filter: brightness(0.9);
}        #add-trade-form { margin: 0 auto; padding: 0; border: none; border-radius: 0; background-color: transparent; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button:hover { opacity: 0.85; }
.table-wrapper { 
    width: 100%;
    overflow-x: auto;   
    overflow-y: hidden; 
    padding-bottom: 5px; 
    margin-bottom: 10px;
}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
        th { background-color: var(--header-bg); font-weight: bold; vertical-align: middle; text-align: center; }
        .action-buttons button { padding: 3px 4px; font-size: 10px; margin-right: 4px; }

        .note-cell { white-space: normal; max-width: 300px; min-width: 250px; font-size: 12px; line-height: 1.4; }

        #journal-tab { position: relative; }
        .controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin: 20px auto; }
        .controls-container > div { display: flex; align-items: center; gap: 8px; }

        #journal-entry, #persistent-notes-entry, #tracker-scratchpad, .setups-notes-area {
            width: 100%; 
            resize: vertical;
            line-height: 1.6;
            margin-top: 5px;
            overflow-y: hidden; 
            min-height: 120px; 
        }
        #tracker-scratchpad, #persistent-notes-entry { margin: 0; }
        .setups-notes-area {
            margin-top: 15px;
            min-height: 80px;
        }

        #journal-entry:read-only, #persistent-notes-entry:read-only, #tracker-scratchpad:read-only, .setups-notes-area:read-only { 
            background-color: var(--card-bg); 
            cursor: not-allowed; 
        }

        #image-upload-section { margin-top: 20px; border-top: 1px dashed var(--border-color); padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload, #library-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: var(--link-color); }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid var(--border-color); padding: 5px; background: var(--card-bg); border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; border-radius: 2px; cursor: pointer; }

        .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; opacity: 0.7; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .journal-image-wrapper:hover .delete-journal-image { opacity: 1; }
        .delete-journal-image svg { width: 16px; height: 16px; fill: white; }

        #journal-tab.drag-over { border: 3px dashed var(--link-color); background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: var(--link-color); z-index: 999; pointer-events: none; }

        #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
        #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        #stats-fab:hover { opacity: 0.9; }
        #stats-fab svg { width: 28px; height: 28px; fill: white; }
        #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s; pointer-events: none; }
        #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .stats-header h3 { margin: 0; font-size: 18px; color: var(--text-color); }
        #close-stats-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 5px; line-height: 1; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
        .stat-label { font-size: 14px; color: var(--subtle-text); }
        .stat-value { font-size: 16px; font-weight: 600; color: var(--text-color); }
        #stat-balance-aud { font-size: 14px; color: var(--subtle-text); }

        .date-nav-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px auto 20px auto; }
        #date-buttons-container { display: flex; gap: 8px; }
        .date-nav-btn { padding: 8px 12px; font-size: 14px; background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--subtle-text); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; }

        .date-nav-btn.active { background-color: var(--link-color); color: white; border-color: var(--link-color); font-weight: bold; }
        .date-nav-btn.has-entry { border-bottom: 3px solid var(--green-border); }
        .date-nav-arrow { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 10px; }


        .ema-summary-container {
            font-size: 13px;
            padding: 8px 12px;
            margin: 0 auto 15px auto;
            max-width: 95%;
            border-radius: 6px;
            background-color: var(--bg-color);
        }
        .ema-level-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .ema-summary-container h4 {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 10px;
            color: var(--subtle-text);
        }
        .ema-level-summary {
            line-height: 1.5;
        }

        .ema-level-summary ul {
            margin: 5px 0 0 0;
            padding-left: 20px;
            list-style-type: disc;
        }
        .ema-level-summary li {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        .ema-level-summary strong {
            font-weight: 600;
        }
        
        .sr-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }
        .sr-table th, .sr-table td {
            font-size: 13px;
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            border-left: none;
            border-right: none;
        }
        .sr-table th {
            text-align: center;
            font-weight: 500;
            color: var(--subtle-text);
            border-top: none;
        }
        .sr-table tr:last-child td {
            border-bottom: none;
        }
        .sr-table td:first-child, .sr-table th:first-child {
            text-align: center;
        }
        .sr-table .sr-center-price {
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
        }
        .sr-table .sr-score-cell {
            position: relative;
            background-repeat: no-repeat;
            background-position: left center;
        }
        .sr-table .sr-score-value {
            position: relative;
            z-index: 1;
            background-color: var(--container-bg); 
            padding: 1px 4px;
            border-radius: 3px;
        }
        .sr-table .sr-pivots-cell {
            color: var(--subtle-text);
        }

        .price-above { color: #dc3545 !important; }
        .price-below { color: #28a745 !important; }

        .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 20px; z-index: 10; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: var(--link-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .journal-input-wrapper {
            position: relative;
        }
        #favourite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            padding: 0;
            margin: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: #ccc; 
            cursor: pointer;
            display: none; 
            transition: all 0.2s ease;
            z-index: 5;
        }
        #favourite-btn:hover {
            border-color: #ffc107;
            color: #ffc107;
        }
        #favourite-btn.active {
            color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }
        #favourited-entry-container {
            background-color: var(--purple-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .favourited-header {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 14px;
        }
        .favourited-header .star-icon {
            font-size: 18px;
            margin-right: 8px;
            color: #ffc107;
        }
        #favourited-entry-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
        }

        .setups-table th:first-child { text-align: left; padding-left: 15px; color: var(--link-color); }
        .setups-table td { text-align: center; }
        .setups-table .editable-setup-cell[contenteditable="true"]:focus {
            background-color: var(--header-bg);
            outline: 2px solid var(--link-color);
            box-shadow: 0 0 5px var(--shadow-color);
        }

        .setups-table td.highlight-long {
            background-color: var(--green-bg);
            color: var(--green-text);
            font-weight: bold;
        }
        .setups-table td.highlight-short {
            background-color: var(--red-bg);
            color: var(--red-text);
            font-weight: bold;
        }

        .setups-table .percent-cell {
            font-size: 11px;
            color: var(--subtle-text);
            text-align: right;
            padding-right: 10px;
            font-style: italic;
        }

        .setups-table thead tr:first-child th:nth-child(n+2) {
            border-top: 2px solid yellow;
        }
        .setups-table tbody tr:last-child td:nth-child(n+1),
        .setups-table thead tr:last-child th:nth-child(n+1) {
            border-bottom: 2px solid yellow;
        }
        .setups-table thead tr:first-child th:nth-child(2), 
        .setups-table thead tr:last-child th:nth-child(1),
        .setups-table tbody td:nth-child(2),
        .setups-table thead tr:first-child th:nth-child(3),
        .setups-table thead tr:last-child th:nth-child(6),
        .setups-table tbody td:nth-child(7),
        .setups-table thead tr:first-child th:nth-child(4),
        .setups-table thead tr:last-child th:nth-child(11),
        .setups-table tbody td:nth-child(12) {
            border-left: 2px solid yellow;
        }
        .setups-table thead tr:first-child th:nth-child(2),
        .setups-table thead tr:last-child th:nth-child(5),
        .setups-table tbody td:nth-child(6),
        .setups-table thead tr:first-child th:nth-child(3),
        .setups-table thead tr:last-child th:nth-child(10),
        .setups-table tbody td:nth-child(11),
        .setups-table thead tr:first-child th:nth-child(4),
        .setups-table thead tr:last-child th:nth-child(15),
        .setups-table tbody td:nth-child(16) {
            border-right: 2px solid yellow;
        }

        .setups-container {
            margin-bottom: 30px; 
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        .setups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            cursor: pointer;
        }
        .setups-header h2 {
            margin: 0;
            font-size: 18px;
            padding: 0;
            border: none;
        }
        .setups-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            font-weight: bold;
            margin: 0;
            transition: transform 0.3s ease, color 0.2s, border-color 0.2s;
        }
        .setups-header:hover .setups-toggle-btn {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .setups-controls {
            text-align: center;
            margin-top: 15px;
        }
        .setups-controls button {
            margin: 0 10px;
        }
        .setups-save-status {
            text-align:center;
            font-style:italic;
            color:var(--subtle-text);
            height:1em;
        }

        .editable-cell[contenteditable="true"]:focus {
            background-color: var(--header-bg);
            outline: 2px solid var(--link-color);
            box-shadow: 0 0 5px var(--shadow-color);
        }

        .toggle-history-btn {
            font-size: 12px;
            padding: 4px 10px;
            margin: 15px auto 0 auto;
            cursor: pointer;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            border-radius: 4px;
            display: none; 
        }
        .toggle-history-btn:hover {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .section-header h2 {
            margin-bottom: 0; 
        }

        .historical-entry {
            display: none;
        }
        .pagination-controls {
            text-align: center;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .pagination-btn {
            padding: 6px 12px;
            font-size: 14px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .pagination-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #sentiment-page-info, #completed-trades-page-info {
            font-size: 14px;
            color: var(--subtle-text);
        }


        #image-library-container, #setups-image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .library-image-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            padding: 5px;
            background: var(--container-bg);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .library-image-wrapper img {
            width: 100%;
            object-fit: contain;
            aspect-ratio: 16 / 9;
            display: block;
            border-radius: 2px;
            cursor: pointer;
            flex-grow: 1; 
            min-height: 0;
        }
        .library-image-wrapper:hover .delete-library-image,
        .library-image-wrapper:hover .edit-caption-btn {
            opacity: 1;
        }
        .delete-library-image {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(220, 53, 69, 0.85);
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease-in-out;
            opacity: 0;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .delete-library-image svg {
            width: 14px;
            height: 14px;
            fill: white;
        }
       .edit-caption-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(0, 123, 255, 0.85);
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease-in-out;
            opacity: 0;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .edit-caption-btn svg {
            width: 14px;
            height: 14px;
            fill: white;
        }
        .library-image-caption {
            font-size: 12px;
            line-height: 1.4;
            color: var(--subtle-text);
            padding: 8px 4px 4px 4px;
            text-align: center;
            flex-shrink: 0;
            word-wrap: break-word;
        }
        .library-image-caption.is-today {
            color: #ffc107;
            font-weight: 500;
        }

       .modal-overlay {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            overflow-y: auto;
            animation-name: fadeIn;
            animation-duration: 0.3s;
        }
        #image-modal .modal-content {
            margin: auto;
            display: block;
            max-width: 90vw;
            max-height: 85vh;
            animation-name: zoomIn;
            animation-duration: 0.4s;
        }

        @keyframes fadeIn {
            from {opacity: 0}
            to {opacity: 1}
        }
        @keyframes zoomIn {
            from {transform:scale(0.1)}
            to {transform:scale(1)}
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 2002;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        #modal-caption {
            text-align: center;
            color: #ccc;
            padding: 15px 0;
            font-size: 18px;
            line-height: 1.4;
            max-width: 80vw;
            word-wrap: break-word; 
        }
        .modal-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            transition: background-color 0.2s ease;
        }
        .modal-nav:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        #modal-prev { left: 20px; }
        #modal-next { right: 20px; }

        .in-merge-mode #completed-trades-tbody tr {
            cursor: crosshair;
        }
        .in-merge-mode #completed-trades-tbody tr:hover {
            background-color: var(--header-bg);
        }
        #completed-trades-tbody tr.is-merge-base {
            background-color: var(--purple-bg) !important;
            color: var(--text-color);
        }
        #completed-trades-tbody tr.is-merge-base td {
            font-weight: bold;
        }

        .collapsible-section {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            overflow: hidden; 
        }
        .collapsible-section.master-only {
            display: none;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            background-color: var(--header-bg);
            transition: background-color 0.2s ease;
        }
        .collapsible-header h2 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .collapsible-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 22px;
            line-height: 26px;
            font-weight: bold;
            padding: 0;
            margin: 0;
            text-align: center;
            transition: transform 0.3s ease, background-color 0.2s, border-color 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        .collapsible-header:hover .collapsible-toggle-btn {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .collapsible-content-inner {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .trade-image-thumbnails {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            max-width: 150px;
        }
        .trade-image-thumbnails .thumbnail-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
        }
        .trade-image-thumbnails img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .trade-image-thumbnails .delete-trade-image {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
            border: 1px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            line-height: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 0;
            z-index: 1;
        }
        .trade-image-thumbnails .thumbnail-wrapper:hover .delete-trade-image {
            opacity: 1;
        }

        #notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        .note-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--container-bg);
            overflow: hidden;
            aspect-ratio: 1 / 1;
        }
        .note-item-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            transition: background-color 0.2s ease;
            height: 100%;
        }
        .note-item-header:hover {
            background-color: var(--header-bg);
        }
        .note-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .note-title {
            font-weight: 500;
            color: var(--text-color);
            word-break: break-word;
            margin: 0;
        }
        .note-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: transparent;
            border: 1px solid transparent;
            color: var(--subtle-text);
            cursor: pointer;
            font-size: 16px;
            line-height: 22px;
            padding: 0;
            transition: all 0.2s ease;
            opacity: 0.5;
        }
        .note-item:hover .note-delete-btn {
            opacity: 1;
        }
        .note-delete-btn:hover {
            background-color: var(--red-bg);
            color: var(--red-text);
            border-color: var(--red-border);
        }

        .note-modal-container {
            background-color: var(--container-bg);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 25px var(--shadow-color);
            animation-name: zoomIn;
            animation-duration: 0.4s;
            margin: auto;
            max-height: 90vh; /* <-- FIX: Added this line to constrain the modal height */
        }
        #note-modal-title {
            font-size: 24px;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid var(--border-color);
            padding: 10px 5px;
            margin: 0 0 20px 0;
            background-color: transparent;
            flex-shrink: 0;
        }
        #note-modal-title:focus {
            outline: none;
            border-bottom-color: var(--link-color);
        }
        #note-modal-content {
            flex-grow: 1;
            font-size: 16px;
            line-height: 1.7;
            border: 1px solid var(--border-color);
            padding: 15px;
            resize: none;
            overflow-y: auto;
        }
        .note-modal-actions {
            margin-top: 20px;
            text-align: right;
            flex-shrink: 0;
        }
        #note-modal-close {
             width: auto;
             padding: 10px 20px;
        }

        #calculator-tab .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }
        #calculator-tab .radio-group {
            display: flex;
            gap: 10px;
        }
        #calculator-tab .radio-group label {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #calculator-tab .radio-group input[type="radio"] {
            display: none;
        }
        #calculator-tab .radio-group input[type="radio"]:checked + label {
            background-color: var(--link-color);
            color: white;
            border-color: var(--link-color);
        }
        #calculator-tab .result-display {
            text-align: center;
            font-size: 14px;
            color: var(--subtle-text);
            margin: 15px 0;
        }
        #calculator-tab .result-display span {
            font-weight: bold;
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
        }
        #calculator-tab .quick-fill-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        #calculator-tab .quick-fill-group button {
            flex: 1;
            min-width: 60px;
            margin-top: 0;
            padding: 6px 10px;
            font-size: 12px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
        }
        #calculator-tab .quick-fill-group button:hover {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        #calculator-tab .targets-table th, 
        #calculator-tab .targets-table td {
            padding: 8px;
            font-size: 13px;
            text-align: right;
            vertical-align: middle;
        }
        #calculator-tab .targets-table th:first-child,
        #calculator-tab .targets-table td:first-child {
            text-align: left;
        }
        #calculator-tab .targets-table input[type="number"] {
            padding: 6px;
            text-align: right;
        }
        #calculator-tab .remove-row-btn {
            background-color: transparent;
            border: none;
            color: var(--red-text);
            font-weight: bold;
            font-size: 18px;
            padding: 0 5px;
            cursor: pointer;
            margin: 0;
            opacity: 0.7;
        }
        #calculator-tab .remove-row-btn:hover {
            opacity: 1;
        }
        #calculator-tab .risk-sizer-instance {
            position: relative;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--bg-color);
        }
        #calculator-tab .risk-sizer-output {
            text-align: center;
            margin-top: 15px;
        }
        #calculator-tab .risk-sizer-output .label {
            font-size: 13px;
            color: var(--subtle-text);
        }
        #calculator-tab .risk-sizer-output .value {
            display: block;
            font-size: 20px;
            font-weight: bold;
            margin-top: 4px;
            color: var(--green-text);
            font-family: 'Courier New', Courier, monospace;
        }
        #calculator-tab .risk-sizer-output .sub-value {
            font-size: 13px;
            font-weight: normal;
            color: var(--red-text);
        }
        #calculator-tab .remove-sizer-btn {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        @media (max-width: 768px) { 
            .container { padding: 10px; } 
            #add-trade-form { grid-template-columns: 1fr; } 
            .journal-image-wrapper { max-width: 100%; } 
            th, td { font-size: 12px; padding: 6px; } 
            .action-buttons button { font-size: 11px; padding: 4px 8px; } 
            #stats-panel-container { bottom: 10px; left: 10px; }
            #stats-fab { width: 50px; height: 50px; }
            #stats-panel { width: calc(100vw - 40px); }
            .theme-switch-wrapper { top: 8px; right: 10px; }
            .modal-nav {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
            #modal-prev { left: 5px; }
            #modal-next { right: 5px; }
            .collapsible-content-inner { padding: 15px 10px; }
            .collapsible-header { padding: 10px 15px; }
            .collapsible-header h2 { font-size: 1em; }
            .ema-level-summary-grid { grid-template-columns: 1fr; }

            .modal-overlay {
                padding: 0;
            }
            .note-modal-container {
                width: 100%;
                min-height: 100%;
                height: auto;
                border-radius: 0;
                box-shadow: none;
                padding: 15px;
            }
            #note-modal-title { font-size: 20px; }
            #note-modal-content { font-size: 15px; }

            .setups-table th,
            .setups-table td {
                font-size: 11px;
                padding: 6px 5px;
            }

            .setups-table thead tr:first-of-type th:first-child,
            .setups-table tbody th:first-child {
                position: -webkit-sticky;
                position: sticky;
                left: 0;
            }

            .setups-table thead tr:first-of-type th:first-child {
                background-color: var(--header-bg);
                z-index: 2;
            }

            .setups-table tbody th:first-child {
                background-color: var(--card-bg);
                z-index: 1;
            }
        }

/* Calendar Summary Styles */
    .calendar-summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* 4 columns */
        gap: 5px;
        text-align: center;
    }
    .cal-stat {
        display: flex;
        flex-direction: column;
    }
    .cal-label {
        font-size: 10px;
        color: var(--subtle-text);
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    .cal-value {
        font-size: 13px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }

    /* Mobile adjustment */
    @media (max-width: 768px) {
        .calendar-summary-grid {
            grid-template-columns: repeat(2, 1fr); /* 2x2 grid on phone */
            gap: 10px;
        }
    }


    /* PnL Calendar Styles */
    .calendar-container { padding: 5px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .calendar-header h3 { margin: 0; font-size: 16px; }
    .calendar-nav-btn { background: none; border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; padding: 2px 8px; border-radius: 4px; }

    /* Grid Layout */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }

    .calendar-day-header { text-align: center; font-size: 11px; font-weight: bold; color: var(--subtle-text); padding-bottom: 5px; }

    .calendar-cell {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        min-height: 50px; /* Default height */
        padding: 4px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-radius: 4px;
        overflow: hidden; /* Keeps content inside */
    }

    .calendar-date-label { font-size: 10px; color: var(--subtle-text); text-align: right; }

    .calendar-pnl-value {
        font-size: 11px;
        font-weight: bold;
        text-align: center;
        margin-top: auto;
        margin-bottom: auto;
        white-space: nowrap; /* Prevents wrapping */
    }

    .pnl-positive { color: var(--green-text); }
    .pnl-negative { color: var(--red-text); }
    .calendar-cell.today { border: 1px solid var(--link-color); }

    /* MOBILE SCALING FIXES */
    @media (max-width: 768px) {
        .calendar-cell {
            min-height: 35px; /* Shorter boxes on mobile */
            padding: 2px;
        }
        .calendar-date-label { font-size: 8px; }
        .calendar-pnl-value { 
            font-size: 9px; 
            letter-spacing: -0.5px; /* Squeeze numbers slightly */
        }
        .calendar-header h3 { font-size: 14px; }
    }


            /* Calendar Summary Styles */
    .calendar-summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Changed to 3 columns */
        gap: 8px; /* Slightly larger gap */
        text-align: center;
    }
    .cal-stat {
        display: flex;
        flex-direction: column;
        background: rgba(128, 128, 128, 0.05); /* Slight background for readability */
        padding: 4px;
        border-radius: 4px;
    }
    .cal-label {
        font-size: 9px;
        color: var(--subtle-text);
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    .cal-value {
        font-size: 13px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }

    /* Mobile adjustment */
    @media (max-width: 768px) {
        .calendar-summary-grid {
            grid-template-columns: repeat(3, 1fr); /* Keep 3 cols on mobile, fits well */
            gap: 4px;
        }
        .cal-value { font-size: 11px; } /* Slightly smaller text on phone */
    }


            /* --- NEW SPLIT SUMMARY STYLES --- */
        .summary-split-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }
        .summary-card {
            flex: 1;
            min-width: 300px;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }
        .summary-card.long-card {
            border-top: 3px solid var(--green-text);
            background-color: rgba(40, 167, 69, 0.05);
        }
        .summary-card.short-card {
            border-top: 3px solid var(--red-text);
            background-color: rgba(220, 53, 69, 0.05);
        }
        .summary-card h5 {
            margin: 0 0 10px 0;
            text-align: center;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
        }
        .summary-grid-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 8px;
            text-align: center;
        }
        .summary-grid-row.financials {
            grid-template-columns: repeat(2, 1fr);
            border-top: 1px dashed var(--border-color);
            padding-top: 8px;
        }
        .sum-label { font-size: 10px; color: var(--subtle-text); text-transform: uppercase; display: block; }
        .sum-val { font-size: 15px; font-weight: 700; font-family: 'Courier New', monospace; }
        .val-green { color: var(--green-text); }
        .val-red { color: var(--red-text); }

/* --- FORCE VISIBLE SCROLLBAR --- */

/* 1. Main Dimensions - Thick enough to click */
.table-wrapper::-webkit-scrollbar {
    height: 16px !important;
    width: 16px !important;
}

/* 2. The Track (Background) - Dark Grey */
.table-wrapper::-webkit-scrollbar-track {
    background-color: #333333 !important; 
    border-top: 1px solid #555 !important;
    border-radius: 0 !important;
}

/* 3. The Thumb (Draggable Bar) - Bright Silver */
.table-wrapper::-webkit-scrollbar-thumb {
    background-color: #c0c0c0 !important; /* Very Light Grey */
    border-radius: 10px !important;
    border: 4px solid #333333 !important; /* Creates a "floating" effect */
    min-height: 50px !important; /* Ensures it never disappears */
}

/* 4. Hover Effect - Pure White */
.table-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: #ffffff !important;
    border-color: #333333 !important;
}

/* 5. REMOVE ARROWS (This hides the triangles) */
.table-wrapper::-webkit-scrollbar-button {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
}

/* 6. Corner */
.table-wrapper::-webkit-scrollbar-corner {
    background: #333333 !important;
}








            /* Completed Table - Group Header */
.completed-group-header {
    background-color: rgba(0, 123, 255, 0.1) !important; /* Light Blue */
    font-weight: 600;
    color: var(--text-color);
    border-top: 2px solid var(--border-color);
}
[data-theme="dark"] .completed-group-header {
    background-color: rgba(0, 123, 255, 0.2) !important;
}

.completed-group-header .group-stats {
    display: flex;
    gap: 20px;
    align-items: center;
    font-size: 0.95em;
}

/* Indent child rows in completed table */
.completed-child-row td:first-child {
    border-left: 3px solid var(--border-color);
}





            /* Ensure pagination buttons don't get pushed off screen */
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px; /* Space between buttons and text */
    margin-top: 20px;
    width: 100%;
    flex-direction: row; /* Forces horizontal alignment */
    flex-wrap: nowrap;   /* Prevents them from stacking vertically */
    padding-bottom: 15px; /* Keeps the bottom buffer */
}

/* Ensure text doesn't wrap inside the buttons */
.pagination-btn {
    white-space: nowrap;
    min-width: 80px; 
}

/* Ensure the page number text stays on one line */
#completed-trades-page-info, 
#setups-images-page-info {
    white-space: nowrap;
    font-weight: bold;
    color: var(--text-color);
}

/* Ensure the wrapper handles scroll bars correctly on zoom */
.collapsible-content-inner {
    padding-bottom: 25px; /* Extra padding at bottom to prevent cut-off */
}



            /* Market Alert Banners */
.alert-banner {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 6px;
    text-align: center;
    font-size: 14px;
    line-height: 1.5;
    animation: fadeIn 0.5s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.alert-banner strong {
    font-weight: 700;
    text-transform: uppercase;
    margin-right: 5px;
}
.alert-banner + .alert-banner {
    margin-top: -10px; /* Stack them closer if multiple exist */
}
    </style>
<body>
    <div class="container">

        <!-- Theme Switch -->
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <!-- Stats Panel -->
        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header">
                    <h3>Performance Stats</h3>
                    <button id="close-stats-btn" title="Close Panel">Ã—</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">AUD Value (est.)</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L (AUD)</span><span id="stat-total-pl-aud" class="stat-value">A$0.00</span></div>
                    <hr style="grid-column: 1 / -1; border: 0; border-top: 1px solid var(--border-color); margin: 5px 0;">
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item">
                        <span class="stat-label">Wins / Losses</span>
                        <div><span id="stat-wins" class="stat-value" style="color: var(--green-text);">0</span> / <span id="stat-losses" class="stat-value" style="color: var(--red-text);">0</span></div>
                    </div>
                    <div class="stat-item"><span class="stat-label">Win Rate</span><span id="stat-win-rate" class="stat-value">0.0%</span></div>
                    <div class="stat-item"><span class="stat-label">Profit Factor</span><span id="stat-profit-factor" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Win</span><span id="stat-avg-win" class="stat-value" style="color: var(--green-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Loss</span><span id="stat-avg-loss" class="stat-value" style="color: var(--red-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Reward:Risk Ratio</span><span id="stat-reward-risk" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7-14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg>
            </button>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal & Setups</button>
            <button class="tab-link" data-tab="notes">Notes</button>
        </div>

        <!-- Tab 1: Tracker -->
        <div id="tracker-tab" class="tab-content active">
            
            <div id="tracker-alerts"></div> 

            <!-- Add Trade (Master Only) -->
            <div class="collapsible-section master-only">
                <div class="collapsible-header">
                    <h2>Add New Trade</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <form id="add-trade-form">
                            <div style="display: flex; gap: 5px;">
                                <div style="flex: 2;">
                                    <label for="trade-session">Session:</label>
                                    <select id="trade-session">
                                        <option value="Pre_Asia">Pre Asia</option><option value="Asia">Asia</option><option value="Pre_London">Pre London</option><option value="London">London</option><option value="Pre_NY_AM">Pre NY AM</option><option value="NY_AM">NY AM</option><option value="Pre_NYL">Pre NYL</option><option value="NYL">NYL</option><option value="Pre_NY_PM">Pre NY PM</option><option value="NY_PM">NY PM</option>
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <label for="trade-variant">#:</label>
                                    <select id="trade-variant">
                                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="trade-symbol">Symbol:</label>
                                <input type="text" id="trade-symbol" list="symbol-list" placeholder="BTC/USDT">
                                <datalist id="symbol-list"><option value="BTC/USDT"><option value="ETH/USDT"></datalist>
                            </div>
                            <div>
                                <label for="trade-exchange">Exchange / Fees:</label>
                                <select id="trade-exchange">
                                    <option value="binance">Binance (0% M / 0.075% T)</option>
                                    <option value="hyperliquid">Hyperliquid (0.015% M / 0.045% T)</option>
                                </select>
                            </div>
                            <div>
                                <label for="trade-type">Trade Type:</label>
                                <select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select>
                            </div>
                            <div>
                                <label for="trade-status">Status:</label>
                                <select id="trade-status"><option value="live">Live Trade</option><option value="resting">Resting (Limit)</option></select>
                            </div>
                            <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                            <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                            <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                            <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                            <div>
                                <label for="entry-fee-type">Entry Fee:</label>
                                <select id="entry-fee-type"><option value="taker">Taker Fee</option><option value="maker">Maker Fee</option></select>
                            </div>
                            <div><button type="submit">Add Trade</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Resting Orders Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Resting Limit Orders</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="resting-trades-summary-container" class="ema-summary-container" style="display:none;"></div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th><th>Type</th><th>Group</th><th>Setup</th><th>Entry</th><th>SL</th><th>Target</th><th>RR(T)</th><th>RR(M)</th><th>Value</th><th>Qty</th><th>/100</th><th>Fees</th><th>Pr(T)</th><th>Pr(M)</th><th>Ls(T)</th><th>Ls(M)</th><th colspan="3">Notes</th><th class="master-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resting-trades-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Trades Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Live Trades</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="live-trades-summary-container" class="ema-summary-container" style="display:none;"></div>
                        <div class="table-wrapper">
                            <table>
                                <tbody id="trades-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Setups -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Trading Setups</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <textarea id="primary-setups-notes" class="setups-notes-area" placeholder=""></textarea>
                        <textarea id="secondary-setups-notes" class="setups-notes-area" placeholder=""></textarea>
                    </div>
                </div>
            </div>

            <!-- Setups Library -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Setups</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="setups-upload-section" class="master-only" style="text-align: center; margin-bottom: 20px;">
                            <label for="setups-image-upload" class="image-upload-label">Add Setup Image</label>
                            <input type="file" id="setups-image-upload" accept="image/*" multiple style="display:none;">
                            <div id="setups-upload-progress"></div>
                        </div>
                        <div id="setups-image-container"></div>
                        <button id="toggle-all-setups-images" class="toggle-history-btn">Show All</button>
                        <div id="setups-images-pagination-controls" class="pagination-controls" style="display: none;">
                            <button id="setups-images-prev-page" class="pagination-btn">&lt; Prev</button>
                            <span id="setups-images-page-info"></span>
                            <button id="setups-images-next-page" class="pagination-btn">Next &gt;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Trades -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Completed Trades</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper">
                            <table>
                                <tbody id="completed-trades-tbody"></tbody>
                            </table>
                        </div>
                        <button id="toggle-all-completed-trades" class="toggle-history-btn">Show All</button>
                        <div id="completed-trades-pagination-controls" class="pagination-controls" style="display: none;">
                            <button id="completed-trades-prev-page" class="pagination-btn">&lt; Prev</button>
                            <span id="completed-trades-page-info"></span>
                            <button id="completed-trades-next-page" class="pagination-btn">Next &gt;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Journal -->
        <div id="journal-tab" class="tab-content">
            <div>
                <label for="journal-image-filter">Filter Images:</label>
                <select id="journal-image-filter">
                    <option value="all" selected>All for Timeframe</option>
                    <option value="today">Selected Day Only</option>
                </select>
            </div>
            <div class="controls-container" id="journal-controls">
                <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
            </div>
            <div class="date-nav-container">
                <button id="date-prev" class="date-nav-arrow"><</button>
                <div id="date-buttons-container"></div>
                <button id="date-next" class="date-nav-arrow">></button>
            </div>
            <div id="favourited-entry-container" style="display: none;">
                <div class="favourited-header"><span class="star-icon">â­</span><span>Pinned Note</span></div>
                <div id="favourited-entry-text"></div>
            </div>
            <div class="journal-input-wrapper">
                 <button id="favourite-btn" class="master-only" title="Pin note">â­</button>
                 <textarea id="journal-entry" placeholder=""></textarea>
            </div>
            <p id="save-status"></p>
            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture</label>
                <input type="file" id="journal-image-upload" accept="image/*" multiple>
                <div id="upload-progress"></div>
            </div>
            <div id="journal-images-container"></div>
        </div>

        <!-- Tab 3: Notes -->
        <div id="notes-tab" class="tab-content">
            <div class="collapsible-section">
                 <div class="collapsible-header">
                    <h2>My Notes</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="notes-controls" class="master-only" style="text-align: right; margin-bottom: 20px;">
                            <button id="create-new-note-btn">Create New Note</button>
                        </div>
                        <div id="notes-container"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="image-modal" class="modal-overlay" style="display: none;">
        <span class="modal-close">&times;</span>
        <button id="modal-prev" class="modal-nav">&lt;</button>
        <img class="modal-content" id="modal-image-content">
        <button id="modal-next" class="modal-nav">&gt;</button>
        <div id="modal-caption"></div>
    </div>

    <div id="note-edit-modal" class="modal-overlay" style="display: none;">
        <div class="note-modal-container">
            <input type="text" id="note-modal-title" placeholder="Note Title">
            <textarea id="note-modal-content" placeholder="Start typing..."></textarea>
            <div class="note-modal-actions"><button id="note-modal-close">Close</button></div>
        </div>
    </div>

    <input type="file" id="trade-image-uploader" accept="image/*" style="display:none;" multiple>



    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const CONFIG = {
            FIREBASE: {
                apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                authDomain: "journal-a003f.firebaseapp.com",
                databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "journal-a003f",
                storageBucket: "journal-a003f.firebasestorage.app", 
                messagingSenderId: "1038636626553",
                appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
            },
            DB_PATHS: { TRADES: 'trades', COMPLETED_TRADES: 'completed_trades',    DAILY_NOTES: 'daily_notes' , BANK: 'bank', JOURNAL_TEXT: 'journal_text', JOURNAL_IMAGES: 'journal_images', IMAGE_LIBRARY: 'image_library', SETUPS_IMAGES: 'setups_images', CHART_LIBRARY_2: 'chart_library_2', JOURNAL_FAVOURITES: 'journal_favourites', SETUPS_1: 'current_setups_1', SETUPS_2: 'current_setups_2', GENERAL_NOTES: 'general_notes', RESTING_ORDERS: 'resting_orders' },
            TRADE_SETTINGS: {
                MAKER_FEE_RATE: 0.0000, // 0% for Maker
                TAKER_FEE_RATE: 0.00075, // Standard Taker fee
                STARTING_BALANCE: 5137,
                STATS_RESET_DATE: '2025-10-20',
            }
        };

        // --- DOM ELEMENT CACHE ---
        const DOM = {
            tabs: document.querySelector('.tabs'),
            themeToggle: document.getElementById('theme-checkbox'),
            trackerTab: document.getElementById('tracker-tab'),
            tradeImageUploader: document.getElementById('trade-image-uploader'),
            statsPanelContainer: document.getElementById('stats-panel-container'),
            statsFab: document.getElementById('stats-fab'),
            statsPanel: document.getElementById('stats-panel'),
            closeStatsBtn: document.getElementById('close-stats-btn'),
            statBalance: document.getElementById('stat-balance'),
            statBalanceAud: document.getElementById('stat-balance-aud'),
            statTotalPl: document.getElementById('stat-total-pl'),
            statTotalPlAud: document.getElementById('stat-total-pl-aud'),
            statCompletedTrades: document.getElementById('stat-completed-trades'),
            statWins: document.getElementById('stat-wins'),
            statLosses: document.getElementById('stat-losses'),
            statWinRate: document.getElementById('stat-win-rate'),
            statProfitFactor: document.getElementById('stat-profit-factor'),
            statAvgWin: document.getElementById('stat-avg-win'),
            statAvgLoss: document.getElementById('stat-avg-loss'),
            statRewardRisk: document.getElementById('stat-reward-risk'),
            statOpenTrades: document.getElementById('stat-open-trades'),
            addTradeForm: document.getElementById('add-trade-form'),
            tradesTbody: document.getElementById('trades-tbody'),
            completedTradesTbody: document.getElementById('completed-trades-tbody'),
            restingTradesTbody: document.getElementById('resting-trades-tbody'),
            setupsImageContainer: document.getElementById('setups-image-container'),
            setupsImageUpload: document.getElementById('setups-image-upload'),
            setupsUploadProgress: document.getElementById('setups-upload-progress'),
            imageModal: document.getElementById('image-modal'),
            modalImageContent: document.getElementById('modal-image-content'),
            modalClose: document.querySelector('.modal-close'),
            modalCaption: document.getElementById('modal-caption'),
            modalPrevBtn: document.getElementById('modal-prev'),
            modalNextBtn: document.getElementById('modal-next'),
            journalTab: document.getElementById('journal-tab'),
            notesTab: document.getElementById('notes-tab'),
            createNewNoteBtn: document.getElementById('create-new-note-btn'),
            notesContainer: document.getElementById('notes-container'),
            primarySetupsNotes: document.getElementById('primary-setups-notes'),
            secondarySetupsNotes: document.getElementById('secondary-setups-notes'),
            journalSymbolEl: document.getElementById('journal-symbol'),
            journalTimeframeEl: document.getElementById('journal-timeframe'),
            journalImageFilterEl: document.getElementById('journal-image-filter'),
            dateButtonsContainer: document.getElementById('date-buttons-container'),
            datePrevBtn: document.getElementById('date-prev'),
            dateNextBtn: document.getElementById('date-next'),
            favouritedEntryContainer: document.getElementById('favourited-entry-container'),
            favouritedEntryText: document.getElementById('favourited-entry-text'),
            favouriteBtn: document.getElementById('favourite-btn'),
            journalEntryEl: document.getElementById('journal-entry'),
            saveStatus: document.getElementById('save-status'),
            journalImageUpload: document.getElementById('journal-image-upload'),
            uploadProgress: document.getElementById('upload-progress'),
            journalImagesContainer: document.getElementById('journal-images-container'),
            noteEditModal: document.getElementById('note-edit-modal'),
            noteModalTitle: document.getElementById('note-modal-title'),
            noteModalContent: document.getElementById('note-modal-content'),
            noteModalClose: document.getElementById('note-modal-close'),
            // Calendar DOM Elements
            calMonthYear: document.getElementById('cal-month-year'),
            calPrevBtn: document.getElementById('cal-prev-btn'),
            calNextBtn: document.getElementById('cal-next-btn'),
            pnlCalendarGrid: document.getElementById('pnl-calendar-grid'),
        };

        // --- APPLICATION STATE ---
        const STATE = {
            isMasterUser: false,  isProcessing: false, masterPassword: null, viewerId: null, usdToAudRate: 1.53, journalText: {}, journalImages: {}, favouriteEntries: {}, setupsData1: {}, setupsData2: {}, generalNotes: {}, selectedDate: null, centerDate: null, journalSaveTimer: null, notesSaveTimer: null, setups1NotesTimer: null, setups2NotesTimer: null, isMerging: false, mergeBaseTradeId: null, modalImageGallery: [], modalImageIndex: -1, imageUploadContext: { id: null, type: null },
            allCompletedTrades: {}, completedTradesShowAll: false, completedTradesCurrentPage: 1, completedTradesItemsPerPage: 5,
            allSetupsImages: {}, setupsImagesShowAll: false, setupsImagesCurrentPage: 1, setupsImagesItemsPerPage: 50,
            chartInstances: {}, dailyNotes: {}, 
            calendarViewDate: new Date() // State for PnL Calendar
        };

        // --- INITIALIZE FIREBASE ---
        firebase.initializeApp(CONFIG.FIREBASE);
        const database = firebase.database();
        const storage = firebase.storage();
        const dbRefs = { trades: database.ref(CONFIG.DB_PATHS.TRADES), dailyNotes: database.ref(CONFIG.DB_PATHS.DAILY_NOTES) ,completedTrades: database.ref(CONFIG.DB_PATHS.COMPLETED_TRADES), bank: database.ref(CONFIG.DB_PATHS.BANK), journalText: database.ref(CONFIG.DB_PATHS.JOURNAL_TEXT), journalImages: database.ref(CONFIG.DB_PATHS.JOURNAL_IMAGES), imageLibrary: database.ref(CONFIG.DB_PATHS.IMAGE_LIBRARY), setupsImages: database.ref(CONFIG.DB_PATHS.SETUPS_IMAGES), chartLibrary2: database.ref(CONFIG.DB_PATHS.CHART_LIBRARY_2), favourites: database.ref(CONFIG.DB_PATHS.JOURNAL_FAVOURITES), setups1: database.ref(CONFIG.DB_PATHS.SETUPS_1), setups2: database.ref(CONFIG.DB_PATHS.SETUPS_2), generalNotes: database.ref(CONFIG.DB_PATHS.GENERAL_NOTES), restingOrders: database.ref(CONFIG.DB_PATHS.RESTING_ORDERS) };

        // --- HELPER FUNCTIONS ---
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };

function calculateBreakevenPrice(trade) {
    const entry = parseFloat(trade.entry);
    if (isNaN(entry) || entry <= 0) {
        return 0;
    }

    // Determine fees based on trade exchange
    const rates = getFeeRates(trade.exchange);

    // If entry is Maker, return just the entry price as requested
    if (trade.entryFeeType === 'maker') {
        return entry;
    }

    // Otherwise calculate Breakeven for Taker
    const entryFeeRate = rates.TAKER; 
    const exitFeeRate = rates.TAKER; // Assume worst-case Taker exit

    if (trade.type === "Long") {
        return entry * (1 + entryFeeRate) / (1 - exitFeeRate);
    } else {
        return entry * (1 - entryFeeRate) / (1 + exitFeeRate);
    }
}
    // FIND THIS FUNCTION
function autoResizeTextarea(textarea) { 
    if (!textarea || textarea.tagName !== 'TEXTAREA') return; 
    
    // START FIX: Save the current scroll position
    const currentScrollPos = window.scrollY;
    
    textarea.style.height = 'auto'; 
    textarea.style.height = `${textarea.scrollHeight}px`; 
    
    // END FIX: Restore the scroll position immediately
    window.scrollTo(window.scrollX, currentScrollPos);
}  
        
function resizeParentCollapsible(elementInside) {
    const section = elementInside.closest('.collapsible-section');
    if (section && section.classList.contains('is-open')) {
        const content = section.querySelector('.collapsible-content');
        if (content) {
            // FIX: Add +100px buffer to ensure buttons/pagination are never cut off
            const newHeight = content.scrollHeight + 100;
            content.style.maxHeight = newHeight + 'px';
        }
    }
}        const debouncedResizeParent = debounce(resizeParentCollapsible, 250);
        const formatCurrency = (num, symbol = '$') => { if (typeof num !== 'number' || isNaN(num)) { return '--'; } const maximumFractionDigits = num > 100 ? 2 : (num > 1 ? 4 : 8); return `${symbol}${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits })}`; };
        function adjustCollapsibleSize(elementInside) { if (!elementInside) return; if (elementInside.tagName === 'TEXTAREA') { autoResizeTextarea(elementInside); } resizeParentCollapsible(elementInside); }
        const getYYYYMMDD = (date) => date.toISOString().split('T')[0];
        const getPerthDateString = (date = new Date()) => { try { const formatter = new Intl.DateTimeFormat('en-CA', { timeZone: 'Australia/Perth', year: 'numeric', month: '2-digit', day: '2-digit' }); return formatter.format(date); } catch (e) { console.error("Timezone formatting failed, using fallback.", e); const perthTime = new Date(date.getTime() + (8 * 60 * 60 * 1000)); return perthTime.toISOString().split('T')[0]; } };
        const getSafeSymbol = (symbol) => symbol.replace(/\//g, '-');
        // --- MISSING HELPER: TRADING DAY LOGIC ---
const getTradingDayString = (closedTS, openedTS) => {
    if (!closedTS) return 'Unknown';
    
    const closedDate = new Date(closedTS);
    const openedDate = openedTS ? new Date(openedTS) : closedDate;

    // Get hours in Perth time (or fallback to local)
    const getPerthHour = (d) => {
        try {
            return parseInt(new Intl.DateTimeFormat('en-AU', {
                timeZone: 'Australia/Perth',
                hour: 'numeric',
                hour12: false
            }).format(d));
        } catch (e) { return d.getHours(); }
    };

    const closedHour = getPerthHour(closedDate);
    const openedHour = getPerthHour(openedDate);
    
    const closedCalDay = getPerthDateString(closedDate);
    const openedCalDay = getPerthDateString(openedDate);

    // RULE: If closed before 6am
    if (closedHour < 6) {
        // EXCEPTION: Unless opened after 5am today
        if (openedCalDay === closedCalDay && openedHour >= 5) {
            return closedCalDay;
        } else {
            // Roll back to previous day
            const prevDay = new Date(closedDate);
            prevDay.setDate(prevDay.getDate() - 1);
            return getPerthDateString(prevDay);
        }
    }
    return closedCalDay;
};
        function getViewerId() { if (STATE.viewerId) return STATE.viewerId; let id = localStorage.getItem('viewerId'); if (!id) { id = `viewer_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`; localStorage.setItem('viewerId', id); } STATE.viewerId = id; return id; }

        // --- DATA FETCHING ---
        async function fetchLiveConversionRate() { try { const response = await fetch('https://open.er-api.com/v6/latest/USD'); if (!response.ok) return; const data = await response.json(); if (data?.result === "success" && data?.rates?.AUD) { STATE.usdToAudRate = data.rates.AUD; } } catch (error) { console.error("Could not fetch conversion rate.", error); } }

        // --- RENDERING FUNCTIONS ---
        function toggleHistoricalRows(tbodyId, button) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            const historicalRows = tbody.querySelectorAll('.historical-entry');
            if (historicalRows.length === 0) return;
            const isCurrentlyHidden = historicalRows[0].style.display === 'none';
            const displayStyle = isCurrentlyHidden ? 'table-row' : 'none';
            historicalRows.forEach(row => { row.style.display = displayStyle; });
            button.textContent = isCurrentlyHidden ? 'Hide Older' : 'Show All';
            adjustCollapsibleSize(button);
        }

        function renderNotes(notesData) {
            const container = DOM.notesContainer;
            if (!container) return;
            const sortedIds = Object.keys(notesData).sort((a, b) => (notesData[b].timestamp || 0) - (notesData[a].timestamp || 0));
            const notesHtml = sortedIds.map(id => {
                const note = notesData[id];
                const masterDeleteBtn = STATE.isMasterUser ? `<button class="note-delete-btn" data-note-id="${id}" title="Delete Note">&times;</button>` : '';
                return `<div class="note-item" id="note-item-${id}"><div class="note-item-header" data-note-id="${id}">${masterDeleteBtn}<div class="note-icon">ðŸ“</div><h4 class="note-title">${note.title || 'Untitled Note'}</h4></div></div>`;
            }).join('');
            container.innerHTML = notesHtml;
            adjustCollapsibleSize(container);
        }

        function renderAttachmentThumbnails(entry, entryId, entryType) {
            const images = entry.attachedImages || {};
            const masterDeleteBtn = (imageId, fileName) => (STATE.isMasterUser) ? `<button class="delete-trade-image" title="Delete Attachment" data-entry-id="${entryId}" data-entry-type="${entryType}" data-image-id="${imageId}" data-filename="${fileName}">Ã—</button>` : '';
            const thumbnailsHtml = Object.keys(images).sort((a, b) => images[b].timestamp - images[a].timestamp).map(imageId => {
                const imgData = images[imageId];
                if (!imgData?.url) return '';
                return `<div class="thumbnail-wrapper">${masterDeleteBtn(imageId, imgData.fileName)}<img src="${imgData.url}" alt="Attachment" data-full-src="${imgData.url}" data-caption="Attachment for ${entryType} ${entryId}"></div>`;
            }).join('');
            return `<td class="trade-image-thumbnails">${thumbnailsHtml}</td>`;
        }
function renderRestingTable(data) {
    try {
        const trades = data || {};
        const groupedTrades = {};

        // --- 1. Group & Aggregate ---
        Object.keys(trades).forEach(id => {
            const trade = trades[id];
            const gid = trade.groupId || `${trade.symbol}_${trade.type}_Legacy`;

            if (!groupedTrades[gid]) {
                groupedTrades[gid] = {
                    id: gid,
                    symbol: trade.symbol,
                    type: trade.type,
                    trades: [],
                    totalSize: 0,
                    totalQty: 0,
                    wEntry: 0,
                    wStop: 0,
                    wTarget: 0,
                    // Financials
                    profitTaker: 0, profitMaker: 0,
                    lossTaker: 0, lossMaker: 0,
                    fees: 0,
                    pnlPer100: 0
                };
            }

            groupedTrades[gid].trades.push({ ...trade, dbId: id });

            const size = parseFloat(trade.size) || 0;
            const entry = parseFloat(trade.entry) || 0;
            const stop = parseFloat(trade.stoploss) || 0;
            const target = parseFloat(trade.target) || 0;
            const qty = (entry > 0) ? size / entry : 0;
            
            const metrics = calculateTradeMetrics(trade);

            groupedTrades[gid].totalSize += size;
            groupedTrades[gid].totalQty += qty;
            
            groupedTrades[gid].wEntry += (entry * qty);
            groupedTrades[gid].wStop += (stop * qty);
            groupedTrades[gid].wTarget += (target * qty);

            groupedTrades[gid].profitTaker += parseFloat(metrics.expected_profit_taker || 0);
            groupedTrades[gid].profitMaker += parseFloat(metrics.expected_profit_maker || 0);
            groupedTrades[gid].lossTaker += parseFloat(metrics.expected_loss_taker || 0);
            groupedTrades[gid].lossMaker += parseFloat(metrics.expected_loss_maker || 0);
            groupedTrades[gid].fees += parseFloat(metrics.estimated_total_fee || 0);
            groupedTrades[gid].pnlPer100 += parseFloat(metrics.pnl_per_100_move || 0);
        });

        // --- 2. Generate HTML ---
        let tableHtml = '';
        
        // Sort by most recent added
        const sortedGroupKeys = Object.keys(groupedTrades).sort((a, b) => {
            const getLatestDate = (group) => Math.max(...group.trades.map(t => t.date || 0));
            return getLatestDate(groupedTrades[b]) - getLatestDate(groupedTrades[a]);
        });

        sortedGroupKeys.forEach(gid => {
            const group = groupedTrades[gid];
            const avgEntry = group.totalQty > 0 ? (group.wEntry / group.totalQty) : 0;
            
            // Dominant PnL for Summary Row
            const dominantProfit = (group.type === 'Short') ? group.profitMaker : group.profitTaker;
            const dominantLoss = (group.type === 'Short') ? group.lossMaker : group.lossTaker;

            // --- PARENT ROW (Summary) ---
            tableHtml += `
            <tr style="background-color: rgba(127, 127, 127, 0.07); border-top: 2px solid var(--border-color); font-weight: bold;">
                <td style="border-left: 4px solid var(--subtle-text);">${group.symbol}</td>
                <td style="color: ${group.type === 'Long' ? 'var(--green-text)' : 'var(--red-text)'};">${group.type}</td>
                <td colspan="3" style="color: var(--text-color); font-size: 0.95em;">ðŸ“‚ ${gid}</td>
                
                <td>--</td> <td>--</td> <td>--</td> <td>--</td> <td>--</td> 
                
                <!-- Totals -->
                <td style="font-size: 1.05em;">$${group.totalSize.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                <td style="font-family: 'Courier New';">${group.totalQty.toFixed(4)}</td>
                <td>$${group.pnlPer100.toFixed(2)}</td>
                <td>$${group.fees.toFixed(2)}</td>
                
                <td colspan="2" style="text-align:center; color: var(--green-text); opacity: 0.8;">
                    TP: $${dominantProfit.toFixed(2)}
                </td>
                <td colspan="2" style="text-align:center; color: var(--red-text); opacity: 0.8;">
                    SL: $${dominantLoss.toFixed(2)}
                </td>
                
                <td colspan="3" style="text-align:right; font-weight:normal; font-style:italic;">Avg: ${avgEntry.toFixed(4)}</td>
                <td class="master-only"></td> <!-- Placeholder for future Group Action -->
            </tr>`;

            // --- CHILD ROWS ---
            group.trades.forEach(trade => {
                const metrics = calculateTradeMetrics(trade);
                
                // Conditional PnL Columns
                const isMaker = (trade.entryFeeType === 'maker');
                const valProfitTaker = !isMaker ? parseFloat(metrics.expected_profit_taker).toFixed(2) : '--';
                const valProfitMaker = isMaker ? parseFloat(metrics.expected_profit_maker).toFixed(2) : '--';
                const valLossTaker = !isMaker ? parseFloat(metrics.expected_loss_taker).toFixed(2) : '--';
                const valLossMaker = isMaker ? parseFloat(metrics.expected_loss_maker).toFixed(2) : '--';

                const styleTaker = !isMaker ? "opacity: 1; font-weight:bold;" : "opacity: 0.3;";
                const styleMaker = isMaker ? "opacity: 1; font-weight:bold;" : "opacity: 0.3;";

                // Note: 'setupType' is editable for legacy reasons or quick categorization
                const setupCat = trade.setupType || 'Major';

                const masterButtons = STATE.isMasterUser ? 
                    `<div style="display:flex; gap:2px; justify-content:flex-end;">
                        <button class="activate-btn" data-id="${trade.dbId}" style="padding:4px 8px; font-size:11px; background:#28a745; width:auto;">â–¶ Active</button>
                        <button class="delete-resting-btn" data-id="${trade.dbId}" style="padding:4px 8px; font-size:11px; background:#dc3545; width:auto;">Del</button>
                     </div>` : '';

                tableHtml += `
                <tr class="child-row" style="font-size: 0.9em; color: var(--subtle-text);">
                    <td></td> <td></td> 
                    <td style="text-align:right;">â†³ Order:</td>
                    
                    ${/* Editable Setup Type */ ''}
                    <td class="editable-cell" data-id="${trade.dbId}" data-field="setupType" contenteditable="${STATE.isMasterUser}">${setupCat}</td>

                    <td class="editable-cell" data-id="${trade.dbId}" data-field="entry" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.entry).toFixed(4)}</td>
                    <td class="editable-cell" data-id="${trade.dbId}" data-field="stoploss" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.stoploss).toFixed(4)}</td>
                    <td class="editable-cell" data-id="${trade.dbId}" data-field="target" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.target).toFixed(4)}</td>
                    
                    <td>${metrics.rr_taker}</td>
                    <td>${metrics.rr_maker}</td>

                    <td class="editable-cell" data-id="${trade.dbId}" data-field="size" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.size).toFixed(2)}</td>
                    <td>${(parseFloat(trade.size)/parseFloat(trade.entry)).toFixed(4)}</td>
                    <td>--</td>
                    
                    <td>${parseFloat(metrics.estimated_total_fee).toFixed(2)}</td>
                    
                    <td style="${styleTaker}">${valProfitTaker}</td>
                    <td style="${styleMaker}">${valProfitMaker}</td>
                    <td style="${styleTaker}">${valLossTaker}</td>
                    <td style="${styleMaker}">${valLossMaker}</td>

                    <td colspan="3" class="note-cell" title="${trade.note || ''}">${trade.note || ''}</td>
                    <td class="master-only">${masterButtons}</td>
                </tr>`;
            });
        });

        DOM.restingTradesTbody.innerHTML = tableHtml;
        
        // Update Headers to match Live Table + 'Setup' column
        const thead = DOM.restingTradesTbody.closest('table').querySelector('thead');
        if(thead) thead.innerHTML = `<tr><th>Sym</th><th>Type</th><th>Group / Details</th><th>Setup</th><th>Entry</th><th>SL</th><th>TP</th><th>RR(T)</th><th>RR(M)</th><th>Value ($)</th><th>Qty</th><th>/100</th><th>Fees</th><th>Pr(T)</th><th>Pr(M)</th><th>Ls(T)</th><th>Ls(M)</th><th colspan="3">Notes / Date</th><th class="master-only">Actions</th></tr>`;

        // Render Summaries
        renderRestingSummaryCards(groupedTrades);
        
        setTimeout(() => adjustCollapsibleSize(DOM.restingTradesTbody), 10);

    } catch (e) {
        console.error("Error rendering resting table:", e);
    }
}


        function renderRestingSummaryCards(groupedTrades) {
    const summaryContainer = document.getElementById('resting-trades-summary-container');
    if (!summaryContainer) return;
    
    const groupKeys = Object.keys(groupedTrades);
    if (groupKeys.length === 0) {
        summaryContainer.style.display = 'none';
        return;
    }

    summaryContainer.style.display = 'block';
    let summaryHtml = '<div class="summary-split-container">';

    groupKeys.forEach(key => {
        const g = groupedTrades[key];
        
        // Averages
        const avgEntry = g.totalQty > 0 ? (g.wEntry / g.totalQty) : 0;
        const avgStop = g.totalQty > 0 ? (g.wStop / g.totalQty) : 0;
        const avgTarget = g.totalQty > 0 ? (g.wTarget / g.totalQty) : 0;
        
        const riskDistance = Math.abs(avgEntry - avgStop);
        const directionMult = (g.type === 'Long') ? 1 : -1;
        
        let t1 = "--", t2 = "--", t4 = "--", actualRR = "0.00";
        if (avgEntry > 0 && avgStop > 0 && riskDistance > 0) {
            t1 = (avgEntry + (riskDistance * 1 * directionMult)).toFixed(4);
            t2 = (avgEntry + (riskDistance * 2 * directionMult)).toFixed(4);
            t4 = (avgEntry + (riskDistance * 4 * directionMult)).toFixed(4);
            
            const rewardDistance = Math.abs(avgTarget - avgEntry);
            actualRR = (rewardDistance / riskDistance).toFixed(2);
        }

        // Dominant Fee Logic
        let makerSize = 0, takerSize = 0;
        g.trades.forEach(t => {
            const s = parseFloat(t.size) || 0;
            if (t.entryFeeType === 'maker') makerSize += s;
            else takerSize += s;
        });
        const isMakerDominant = makerSize > takerSize;
        const feeLabel = isMakerDominant ? 'Maker' : 'Taker';

        let expProfit = isMakerDominant ? g.profitMaker : g.profitTaker;
        let expLoss = isMakerDominant ? g.lossMaker : g.lossTaker;

        const cardClass = g.type === 'Long' ? 'long-card' : 'short-card';

        summaryHtml += `
        <div class="summary-card ${cardClass}">
            <h5 style="color: ${g.type === 'Long' ? 'var(--green-text)' : 'var(--red-text)'};">${g.id} (${g.type})</h5>
            
            <div class="summary-grid-row">
                <div><span class="sum-label">Total Size</span><span class="sum-val">$${g.totalSize.toLocaleString(undefined, {minimumFractionDigits:0})}</span></div>
                <div><span class="sum-label">PnL per $100</span><span class="sum-val" style="font-weight:900;">$${g.pnlPer100.toFixed(2)}</span></div>
            </div>
            
            <div class="summary-grid-row" style="background: rgba(0,0,0,0.05); padding: 5px 0; border-radius: 4px; margin-bottom: 8px;">
                <div><span class="sum-label">Avg Entry</span><span class="sum-val">${avgEntry.toFixed(4)}</span></div>
                <div><span class="sum-label">Target RR</span><span class="sum-val" style="color: #d39e00;">${actualRR}:1</span></div>
            </div>

            <div class="summary-grid-row">
                <div><span class="sum-label">Avg Stop</span><span class="sum-val val-red">${avgStop.toFixed(4)}</span></div>
                <div><span class="sum-label">1:1 Target</span><span class="sum-val" style="color:var(--link-color)">${t1}</span></div>
            </div>
            <div class="summary-grid-row">
                <div><span class="sum-label">1:2 Target</span><span class="sum-val" style="color:var(--green-text)">${t2}</span></div>
                <div><span class="sum-label">1:4 Target</span><span class="sum-val" style="color:var(--green-text)">${t4}</span></div>
            </div>

            <div class="summary-grid-row financials">
                <div>
                    <span class="sum-label">Proj Profit (${feeLabel})</span>
                    <span class="sum-val val-green">$${expProfit.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>
                <div>
                    <span class="sum-label">Proj Loss (${feeLabel})</span>
                    <span class="sum-val val-red">$${expLoss.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>
            </div>
        </div>`;
    });
    
    summaryHtml += '</div>';
    summaryContainer.innerHTML = summaryHtml;
}
    function handleRestingTradeUpdate(cell) {
            if (!STATE.isMasterUser) return;
            const tradeId = cell.dataset.id;
            const fieldToUpdate = cell.dataset.field;
            
            // Point to the Resting Orders path
            const tradeRef = dbRefs.restingOrders.child(tradeId);

            tradeRef.once('value', snapshot => {
                const trade = snapshot.val(); 
                if (!trade) { alert('Error: Trade not found.'); return; }
                
                const updates = {};
                
                let newValue = parseFloat(cell.textContent.replace(/[^0-9.-]/g, ''));
                const precision = ['entry', 'stoploss', 'target'].includes(fieldToUpdate) ? 4 : 2;

                if (isNaN(newValue)) { 
                    alert('Invalid number.'); 
                    cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); 
                    return; 
                }

                // If value hasn't changed, do nothing
                if (parseFloat(trade[fieldToUpdate]).toFixed(precision) === newValue.toFixed(precision)) { 
                    cell.textContent = newValue.toFixed(precision); 
                    return; 
                }

                updates[fieldToUpdate] = newValue;

                // Recalculate PnL/RR/Fees based on new value
                const tempTradeForCalc = { ...trade, ...updates };
                const newMetrics = calculateTradeMetrics(tempTradeForCalc);
                Object.assign(updates, newMetrics);

                // Update Note
                updates.note = (trade.note || '') + `\n${fieldToUpdate} updated to ${newValue.toFixed(precision)} on ${new Date().toLocaleString()}`;

                tradeRef.update(updates).catch(error => { 
                    alert('Failed to update trade: ' + error.message); 
                    cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); 
                });
            });
        }
        function handleCloseGroup(groupId) {
    if (STATE.isProcessing) return;
    
    // 1. Confirm with user
    if (!confirm(`Are you sure you want to close ALL trades in group: ${groupId}?`)) return;

    dbRefs.trades.once('value', snapshot => {
        const allTrades = snapshot.val();
        if (!allTrades) return;

        // 2. Find all trades belonging to this groupId
        const groupEntries = Object.entries(allTrades).filter(([id, t]) => t.groupId === groupId);
        
        if (groupEntries.length === 0) {
            alert("No live trades found for this group.");
            return;
        }

        // 3. Prompt for closing details (applying to the whole group)
        const defaultExit = groupEntries[0][1].target;
        const exitPriceStr = prompt(`Closing Group: ${groupId}\nEnter exit price for ALL positions:`, defaultExit);
        if (exitPriceStr === null) return; // User cancelled

        let exitFeeType = prompt("Enter exit fee type (maker/taker):", "taker");
        if (exitFeeType === null) return;
        exitFeeType = exitFeeType.toLowerCase().trim();

        const exitPrice = parseFloat(exitPriceStr);
        if (isNaN(exitPrice)) {
            alert("Invalid exit price.");
            return;
        }

        // 4. Start processing
        STATE.isProcessing = true;
        const updates = {};
        const completedPromises = [];

        groupEntries.forEach(([id, trade]) => {
            // Calculate results for this specific trade portion
            const result = calculateNetResult(trade, exitPrice, exitFeeType);

            const completedTrade = {
                ...trade,
                ...result,
                closed_date: firebase.database.ServerValue.TIMESTAMP,
                exit_price: exitPrice,
                exitFeeType: exitFeeType,
                note: (trade.note || '') + `\nGroup closed @ $${exitPrice}`
            };

            // Add to Completed Trades
            completedPromises.push(dbRefs.completedTrades.push(completedTrade));
            // Queue for removal from Live Trades
            updates[id] = null; 
        });

        // 5. Execute all updates
        Promise.all(completedPromises)
            .then(() => {
                return dbRefs.trades.update(updates);
            })
            .then(() => {
                alert(`Successfully closed ${groupEntries.length} trades in group ${groupId}.`);
            })
            .catch(err => {
                alert("Error closing group: " + err.message);
            })
            .finally(() => {
                STATE.isProcessing = false;
            });
    });
}
        
function renderLiveTable(data) {
    try {
        const trades = data || {};
        const groupedTrades = {};

        // --- 1. Group Data & Aggregate ---
        Object.keys(trades).forEach(id => {
            const trade = trades[id];
            const gid = trade.groupId || `${trade.symbol}_${trade.type}_Legacy`; 
            
            if (!groupedTrades[gid]) {
                groupedTrades[gid] = {
                    id: gid,
                    symbol: trade.symbol,
                    type: trade.type,
                    trades: [],
                    totalSize: 0,
                    totalQty: 0,
                    wEntry: 0,
                    wOrigStop: 0,
                    wTarget: 0,
                    // Financial Aggregates
                    profitTaker: 0, profitMaker: 0,
                    lossTaker: 0, lossMaker: 0,
                    fees: 0,
                    pnlPer100: 0
                };
            }

            groupedTrades[gid].trades.push({ ...trade, dbId: id });

            const size = parseFloat(trade.size) || 0;
            const entry = parseFloat(trade.entry) || 0;
            const origStop = parseFloat(trade.original_stoploss) || parseFloat(trade.stoploss) || 0;
            const target = parseFloat(trade.target) || 0;
            const qty = (entry > 0) ? size / entry : 0;
            const metrics = calculateTradeMetrics(trade);

            groupedTrades[gid].totalSize += size;
            groupedTrades[gid].totalQty += qty;
            
            groupedTrades[gid].wEntry += (entry * qty);
            groupedTrades[gid].wOrigStop += (origStop * qty);
            groupedTrades[gid].wTarget += (target * qty);

            groupedTrades[gid].profitTaker += parseFloat(metrics.expected_profit_taker || 0);
            groupedTrades[gid].profitMaker += parseFloat(metrics.expected_profit_maker || 0);
            groupedTrades[gid].lossTaker += parseFloat(metrics.expected_loss_taker || 0);
            groupedTrades[gid].lossMaker += parseFloat(metrics.expected_loss_maker || 0);
            groupedTrades[gid].fees += parseFloat(metrics.estimated_total_fee || 0);
            groupedTrades[gid].pnlPer100 += parseFloat(metrics.pnl_per_100_move || 0);
        });

        // --- 2. Generate HTML ---
        let tableHtml = '';
        
        const sortedGroupKeys = Object.keys(groupedTrades).sort((a, b) => {
            const getLatestDate = (group) => Math.max(...group.trades.map(t => t.date || 0));
            return getLatestDate(groupedTrades[b]) - getLatestDate(groupedTrades[a]);
        });

        sortedGroupKeys.forEach(gid => {
            const group = groupedTrades[gid];
            const avgEntry = group.totalQty > 0 ? (group.wEntry / group.totalQty) : 0;
            
            // Determine Dominant Fee Type for Group Summary
            const dominantProfit = (group.type === 'Short') ? group.profitMaker : group.profitTaker;
            const dominantLoss = (group.type === 'Short') ? group.lossMaker : group.lossTaker;

            const masterGroupBtn = STATE.isMasterUser ? 
                `<button class="close-group-btn" data-group-id="${gid}">Close Idea</button>` : '';

            // --- PARENT ROW (Summary) ---
            tableHtml += `
            <tr style="background-color: rgba(127, 127, 127, 0.07); border-top: 2px solid var(--border-color); font-weight: bold;">
                <td style="border-left: 4px solid var(--link-color);">${group.symbol}</td>
                <td style="color: ${group.type === 'Long' ? 'var(--green-text)' : 'var(--red-text)'};">${group.type}</td>
                <td colspan="3" style="color: var(--text-color); font-size: 0.95em;">ðŸ“‚ ${gid}</td>
                
                <td>--</td> <td>--</td> <td>--</td> <td>--</td> <td>--</td> 
                
                <td style="font-size: 1.05em;">$${group.totalSize.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                <td style="font-family: 'Courier New';">${group.totalQty.toFixed(4)}</td>
                <td>$${group.pnlPer100.toFixed(2)}</td>
                <td>$${group.fees.toFixed(2)}</td>
                
                <!-- Group Summary PnL -->
                <td colspan="2" style="text-align:center; color: var(--green-text); opacity: 0.8;">
                    TP: $${dominantProfit.toFixed(2)}
                </td>
                <td colspan="2" style="text-align:center; color: var(--red-text); opacity: 0.8;">
                    SL: $${dominantLoss.toFixed(2)}
                </td>
                
                <td colspan="4" style="text-align:right; font-weight:normal; font-style:italic;">Avg: ${avgEntry.toFixed(4)}</td>
                <td class="master-only">${masterGroupBtn}</td>
            </tr>`;

            // --- CHILD ROWS (Individual Trades) ---
            group.trades.forEach(trade => {
                const metrics = calculateTradeMetrics(trade);
                const breakevenPrice = calculateBreakevenPrice(trade);
                const entriesList = (trade.entry_prices || [trade.entry]).join(', ');
                
                // CONDITIONAL DISPLAY
                const isMaker = (trade.entryFeeType === 'maker');
                
                const valProfitTaker = !isMaker ? parseFloat(metrics.expected_profit_taker).toFixed(2) : '--';
                const valProfitMaker = isMaker ? parseFloat(metrics.expected_profit_maker).toFixed(2) : '--';
                const valLossTaker = !isMaker ? parseFloat(metrics.expected_loss_taker).toFixed(2) : '--';
                const valLossMaker = isMaker ? parseFloat(metrics.expected_loss_maker).toFixed(2) : '--';

                const styleTaker = !isMaker ? "opacity: 1; font-weight:bold;" : "opacity: 0.3;";
                const styleMaker = isMaker ? "opacity: 1; font-weight:bold;" : "opacity: 0.3;";

                const masterButtons = STATE.isMasterUser ? 
                    `<div style="display:flex; gap:2px; justify-content:flex-end;">
                        <button class="win-btn" data-id="${trade.dbId}" style="padding:2px 5px; font-size:10px; background:#28a745;">W</button>
                        <button class="loss-btn" data-id="${trade.dbId}" style="padding:2px 5px; font-size:10px; background:#dc3545;">L</button>
                        <button class="add-to-position-btn" data-id="${trade.dbId}" style="padding:2px 5px; font-size:10px; background:#17a2b8;">+</button>
                        <button class="delete-btn" data-id="${trade.dbId}" style="padding:2px 5px; font-size:10px; background:#6c757d;">Ã—</button>
                    </div>` : '';

                tableHtml += `
                <tr class="child-row" style="font-size: 0.9em; color: var(--subtle-text);">
                    <td></td> <td></td> 
                    <td style="text-align:right;">â†³ Trade (${trade.entryFeeType}):</td>
                    
                    <td class="editable-cell" data-id="${trade.dbId}" data-field="entry" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.entry).toFixed(4)}</td>
                    <td style="font-weight:bold;">${breakevenPrice > 0 ? breakevenPrice.toFixed(4) : '--'}</td>
                    <td class="note-cell editable-cell" data-id="${trade.dbId}" data-field="entry_prices" contenteditable="${STATE.isMasterUser}">${entriesList}</td>
                    
                    <td class="editable-cell" data-id="${trade.dbId}" data-field="stoploss" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.stoploss).toFixed(4)}</td>
                    <td class="editable-cell" data-id="${trade.dbId}" data-field="target" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.target).toFixed(4)}</td>
                    
                    <td>${metrics.rr_taker}</td>
                    <td>${metrics.rr_maker}</td>

                    <td class="editable-cell" data-id="${trade.dbId}" data-field="size" contenteditable="${STATE.isMasterUser}">${parseFloat(trade.size).toFixed(2)}</td>
                    <td>${(parseFloat(trade.size)/parseFloat(trade.entry)).toFixed(4)}</td>
                    <td>--</td>
                    
                    <td>${parseFloat(metrics.estimated_total_fee).toFixed(2)}</td>
                    
                    <!-- Conditional PnL Columns -->
                    <td style="${styleTaker}">${valProfitTaker}</td>
                    <td style="${styleMaker}">${valProfitMaker}</td>
                    <td style="${styleTaker}">${valLossTaker}</td>
                    <td style="${styleMaker}">${valLossMaker}</td>

                    <td colspan="4" class="note-cell editable-live-note" data-id="${trade.dbId}" contenteditable="${STATE.isMasterUser}">${trade.note || ''}</td>
                    <td class="master-only">${masterButtons}</td>
                </tr>`;
            });
        });

        DOM.tradesTbody.innerHTML = tableHtml;
        
        // --- FIX: Ensure Headers Exist ---
        const table = DOM.tradesTbody.closest('table');
        let thead = table.querySelector('thead');
        
        // Create thead if it doesn't exist
        if (!thead) {
            thead = document.createElement('thead');
            table.insertBefore(thead, DOM.tradesTbody);
        }
        
        // Inject Header Content
        thead.innerHTML = `<tr><th>Sym</th><th>Type</th><th>Group / Details</th><th>Avg Entry</th><th>BE</th><th>Entries</th><th>SL</th><th>TP</th><th>RR(T)</th><th>RR(M)</th><th>Value ($)</th><th>Qty</th><th>/100</th><th>Fees</th><th>Pr(T)</th><th>Pr(M)</th><th>Ls(T)</th><th>Ls(M)</th><th colspan="4">Notes</th><th class="master-only">Actions</th></tr>`;

        // Render Cards
        if(typeof renderLiveSummaryCards === 'function') renderLiveSummaryCards(groupedTrades);
        
        setTimeout(() => adjustCollapsibleSize(DOM.tradesTbody), 10);

    } catch (e) {
        console.error("Error rendering live table:", e);
    }
}

        function handleLiveNoteUpdate(cell) {
    if (!STATE.isMasterUser) return;

    const tradeId = cell.dataset.id;
    const newNote = cell.textContent.trim();

    dbRefs.trades.child(tradeId).update({
        note: newNote
    }).then(() => {
        // Optional: Flash background green to confirm save
        cell.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
        setTimeout(() => cell.style.backgroundColor = '', 500);
    }).catch(err => alert("Error saving note: " + err.message));
}
// Helper for Summary Cards (Separated for clarity)
function renderLiveSummaryCards(groupedTrades) {
    const summaryContainer = document.getElementById('live-trades-summary-container');
    if (!summaryContainer) return;
    
    const groupKeys = Object.keys(groupedTrades);
    if (groupKeys.length === 0) {
        summaryContainer.style.display = 'none';
        return;
    }

    summaryContainer.style.display = 'block';
    let summaryHtml = '<div class="summary-split-container">';

    groupKeys.forEach(key => {
        const g = groupedTrades[key];
        
        // 1. Calculate Averages
        const avgEntry = g.totalQty > 0 ? (g.wEntry / g.totalQty) : 0;
        const avgOrigStop = g.totalQty > 0 ? (g.wOrigStop / g.totalQty) : 0;
        const avgTarget = g.totalQty > 0 ? (g.wTarget / g.totalQty) : 0;
        
        // 2. Risk Calculations based on ORIGINAL STOP
        const riskDistance = Math.abs(avgEntry - avgOrigStop);
        const directionMult = (g.type === 'Long') ? 1 : -1;
        
        // 3. Target Levels (1:1, 1:2, 1:4)
        let t1 = "--", t2 = "--", t4 = "--", actualRR = "0.00";
        if (avgEntry > 0 && avgOrigStop > 0 && riskDistance > 0) {
            t1 = (avgEntry + (riskDistance * 1 * directionMult)).toFixed(4);
            t2 = (avgEntry + (riskDistance * 2 * directionMult)).toFixed(4);
            t4 = (avgEntry + (riskDistance * 4 * directionMult)).toFixed(4);
            
            const rewardDistance = Math.abs(avgTarget - avgEntry);
            actualRR = (rewardDistance / riskDistance).toFixed(2);
        }

        // 4. DETERMINE DOMINANT FEE TYPE
        // We sum up the size of maker trades vs taker trades to see which is dominant
        let makerSize = 0;
        let takerSize = 0;
        
        g.trades.forEach(t => {
            const s = parseFloat(t.size) || 0;
            if (t.entryFeeType === 'maker') makerSize += s;
            else takerSize += s;
        });

        const isMakerDominant = makerSize > takerSize;
        const feeLabel = isMakerDominant ? 'Maker' : 'Taker';

        // 5. Select Financials based on the detected dominant fee type
        let expProfit = 0, expLoss = 0;
        
        if (isMakerDominant) {
            expProfit = g.profitMaker;
            expLoss = g.lossMaker;
        } else {
            expProfit = g.profitTaker;
            expLoss = g.lossTaker;
        }

        const cardClass = g.type === 'Long' ? 'long-card' : 'short-card';

        // 6. Build HTML
        summaryHtml += `
        <div class="summary-card ${cardClass}">
            <h5 style="color: ${g.type === 'Long' ? 'var(--green-text)' : 'var(--red-text)'};">${g.id} (${g.type})</h5>
            
            <div class="summary-grid-row">
                <div><span class="sum-label">Total Size</span><span class="sum-val">$${g.totalSize.toLocaleString(undefined, {minimumFractionDigits:0})}</span></div>
                <div><span class="sum-label">PnL per $100</span><span class="sum-val" style="font-weight:900;">$${g.pnlPer100.toFixed(2)}</span></div>
            </div>
            
            <div class="summary-grid-row" style="background: rgba(0,0,0,0.05); padding: 5px 0; border-radius: 4px; margin-bottom: 8px;">
                <div><span class="sum-label">Avg Entry</span><span class="sum-val">${avgEntry.toFixed(4)}</span></div>
                <div><span class="sum-label">Avg Target RR</span><span class="sum-val" style="color: #d39e00;">${actualRR}:1</span></div>
            </div>

            <div class="summary-grid-row">
                <div><span class="sum-label">Avg Orig Stop</span><span class="sum-val val-red">${avgOrigStop.toFixed(4)}</span></div>
                <div><span class="sum-label">1:1 Target</span><span class="sum-val" style="color:var(--link-color)">${t1}</span></div>
            </div>
            <div class="summary-grid-row">
                <div><span class="sum-label">1:2 Target</span><span class="sum-val" style="color:var(--green-text)">${t2}</span></div>
                <div><span class="sum-label">1:4 Target</span><span class="sum-val" style="color:var(--green-text)">${t4}</span></div>
            </div>

            <div class="summary-grid-row financials">
                <div>
                    <span class="sum-label">Exp Profit (${feeLabel})</span>
                    <span class="sum-val val-green">$${expProfit.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>
                <div>
                    <span class="sum-label">Exp Loss (${feeLabel})</span>
                    <span class="sum-val val-red">$${expLoss.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>
            </div>
        </div>`;
    });
    
    summaryHtml += '</div>';
    summaryContainer.innerHTML = summaryHtml;
}

function checkMarketAlerts() {
    const container = document.getElementById('tracker-alerts');
    if (!container) return;

    // --- CONFIGURATION ---
    const forceTest = false; // Set TRUE to see how they stack
    // ---------------------

    const today = new Date();
    const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
    const dateOfMonth = today.getDate();
    
    const lastDayCurrentMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    let offsetToLastFriday = (lastDayCurrentMonth.getDay() - 5 + 7) % 7;
    const lastFridayDate = lastDayCurrentMonth.getDate() - offsetToLastFriday;

    const messages = [];

    // --- DAILY DEFINITIONS (Always show based on day) ---

    // MONDAY
    if (dayOfWeek === 1 || forceTest) {
        messages.push(`
            <div class="alert-banner" style="background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;">
                <strong>Monday Range Construction:</strong> 
                "Monday Highs/Lows" are often swept later in the week. 
                Don't trust the initial trend immediately.
            </div>
        `);
    }

    // TUESDAY
    if (dayOfWeek === 2 || forceTest) {
        messages.push(`
            <div class="alert-banner" style="background-color: #d4edda; color: #155724; border-color: #c3e6cb;">
                <strong>Tuesday Direction:</strong>
                If Monday formed a range, Tuesday often delivers the true directional move.
                Watch for expansion away from Monday highs or lows.
            </div>
        `);
    }

    // WEDNESDAY
    if (dayOfWeek === 3 || forceTest) {
        messages.push(`
            <div class="alert-banner" style="background-color: #fff3cd; color: #856404; border-color: #ffeeba;">
                <strong>Midweek Volatility:</strong>
                Wednesday often brings expansion or reversal from early-week price action.
                Be alert for failed breakouts or continuation setups.
            </div>
        `);
    }

    // THURSDAY (Added daily definition so it doesn't disappear)
    if (dayOfWeek === 4 || forceTest) {
        messages.push(`
            <div class="alert-banner" style="background-color: #fcfcfc; border: 1px solid #ddd; color: #444;">
                <strong>Thursday Distribution:</strong>
                Often a day for trend continuation or profit-taking. Highs/Lows of the week are frequently 
                established or tested during the NY session.
            </div>
        `);
    }

    // FRIDAY (Standard)
    if (dayOfWeek === 5 || forceTest) {
        messages.push(`
            <div class="alert-banner">
                <strong>Friday Warning:</strong> 
              Fridays often trend bearish as traders close out weekly positions, adding selling pressure.
            </div>
        `);
    }

    // SATURDAY
    if (dayOfWeek === 6 || forceTest) {
        messages.push(`
            <div class="alert-banner" style="background-color: #e2e3e5; color: #383d41; border-color: #d6d8db;">
                <strong>Weekend Trading:</strong> 
              Liquidity is typically thinner, increasing volatility and stop-hunt risk.
            Price may move sharply on low volume, resulting in choppy and inefficient price action.
            </div>
        `);
    }

    // SUNDAY
    if (dayOfWeek === 0 || forceTest) {
        messages.push(`
            <div class="alert-banner" style="background-color: #e2e3f5; color: #2f2f5f; border-color: #d6d8ff;">
                <strong>Weekly Open:</strong>
                New weekly candle. Volatility may increase during the open,
                and BTC often seeks inefficiencies from the Friday CME close.
            </div>
        `);
    }


    // --- SPECIAL EVENT DEFINITIONS (Stack on top of daily ones) ---

    // THURSDAY: Pre-Expiry (Only shows on the Thursday before the last Friday)
    if (dayOfWeek === 4 && dateOfMonth === (lastFridayDate - 1)) {
        messages.push(`
            <div class="alert-banner" style="background-color: #e2d9f3; color: #3c2a4d; border-color: #d6d8db;">
                <strong>âš ï¸ Pre-Expiry Volatility:</strong> 
               Tomorrow is Monthly Options Expiry. Expect positioning adjustments and potential volatility today.
            </div>
        `);
    }

    // FRIDAY: NFP (1st Friday)
    if (dayOfWeek === 5 && dateOfMonth <= 7) {
        messages.push(`
            <div class="alert-banner" style="background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;">
                <strong>ðŸ‡ºðŸ‡¸ NFP Data Release:</strong> 
                It is the 1st Friday of the month. Non-Farm Payrolls at 8:30 AM NY. 
                Do not hold tight stops through the release.
            </div>
        `);
    }

    // FRIDAY: Monthly Expiry (Last Friday)
    if (dayOfWeek === 5 && dateOfMonth === lastFridayDate) {
        messages.push(`
            <div class="alert-banner" style="background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;">
                <strong>âš ï¸ Monthly Crypto Expiry:</strong> 
                Last Friday of the month. Deribit/CME expiry may cause "pinning" or volatility.
            </div>
        `);
    }

    // Render alerts
    container.innerHTML = messages.length > 0 ? messages.join('') : '';
}
function renderCompletedTable(data) {
    const trades = data || {};
    const tradeIds = Object.keys(trades).sort((a, b) => new Date(trades[b].closed_date) - new Date(trades[a].closed_date));
    
    let rowsHtml = '';
    const paginationControls = document.getElementById('completed-trades-pagination-controls');
    const showAllButton = document.getElementById('toggle-all-completed-trades');
    const pageInfoSpan = document.getElementById('completed-trades-page-info');

    // --- 1. HEADERS ---
    const table = DOM.completedTradesTbody.closest('table');
    let thead = table.querySelector('thead');
    if (!thead) {
        thead = document.createElement('thead');
        table.insertBefore(thead, DOM.completedTradesTbody);
    }
    thead.innerHTML = `
        <tr>
            <th>Sym</th><th>Type</th><th>Entry</th><th>Entries</th><th>SL</th><th>TP</th><th>Value ($)</th>
            <th>Pr(T)</th><th>Pr(M)</th><th>Ls(T)</th><th>Ls(M)</th>
            <th>RR(T)</th><th>RR(M)</th><th>Exit</th>
            <th>Raw PnL</th>
            <th>Fees</th><th>Net PnL</th>
            <th>% (Net)</th>
            <th>Open</th><th>Closed</th><th colspan="3">Notes</th><th>Pics</th><th class="master-only">Actions</th>
        </tr>
    `;

    // --- 2. ORGANIZE DATA ---
    const tradesByDayAndGroup = {};
    const uniqueTradingDates = [];

    tradeIds.forEach(id => {
        const t = trades[id];
        const tradingDayStr = (typeof getTradingDayString === 'function') 
            ? getTradingDayString(t.closed_date, t.date) 
            : new Date(t.closed_date).toLocaleDateString();
        
        const groupId = t.groupId || 'Ungrouped / Single';

        if (!tradesByDayAndGroup[tradingDayStr]) {
            tradesByDayAndGroup[tradingDayStr] = {}; 
            uniqueTradingDates.push(tradingDayStr); 
        }
        
        if (!tradesByDayAndGroup[tradingDayStr][groupId]) {
            tradesByDayAndGroup[tradingDayStr][groupId] = [];
        }

        tradesByDayAndGroup[tradingDayStr][groupId].push({ ...t, dbId: id });
    });

    uniqueTradingDates.sort((a, b) => b.localeCompare(a)); 

    // --- 3. PAGINATION ---
    let visibleDates = uniqueTradingDates;
    if (STATE.completedTradesShowAll) {
        const totalPages = uniqueTradingDates.length;
        if (STATE.completedTradesCurrentPage > totalPages) STATE.completedTradesCurrentPage = totalPages;
        const start = STATE.completedTradesCurrentPage - 1;
        visibleDates = uniqueTradingDates.slice(start, start + 1); 
        pageInfoSpan.textContent = `Page ${STATE.completedTradesCurrentPage} of ${totalPages}`;
        showAllButton.style.display = 'none';
        paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
    } else {
        const currentLogicalTradingDay = (typeof getTradingDayString === 'function') 
            ? getTradingDayString(Date.now(), Date.now()) 
            : new Date().toLocaleDateString();
        visibleDates = uniqueTradingDates.filter(d => d === currentLogicalTradingDay);
        const hasHistory = uniqueTradingDates.length > 1 || (uniqueTradingDates.length === 1 && uniqueTradingDates[0] !== currentLogicalTradingDay);
        showAllButton.style.display = hasHistory ? 'block' : 'none';
        paginationControls.style.display = 'none';
    }

    // --- 4. RENDER LOOP ---
    if (visibleDates.length === 0) {
        rowsHtml = '<tr><td colspan="25" style="text-align:center; padding:20px; color: var(--subtle-text);"></td></tr>';
    } else {
        visibleDates.forEach(dateStr => {
            const groupsInDate = tradesByDayAndGroup[dateStr];
            
            let dailyPnL = 0;
            let dailyWins = 0, dailyLosses = 0, totalDailyTrades = 0;

            Object.values(groupsInDate).forEach(groupTrades => {
                groupTrades.forEach(t => {
                    dailyPnL += parseFloat(t.net_result || 0);
                    if (parseFloat(t.net_result) >= 0) dailyWins++; else dailyLosses++;
                    totalDailyTrades++;
                });
            });

            const datePnlClass = dailyPnL >= 0 ? 'var(--green-text)' : 'var(--red-text)';
            const pnlSign = dailyPnL >= 0 ? '+' : '';

            // --- DAILY NOTE LOGIC ---
            const safeDateKey = dateStr.replace(/[\/\s,]/g, '-'); 
            const dailyNote = STATE.dailyNotes[safeDateKey] || '';
            const editAttr = STATE.isMasterUser ? 'contenteditable="true"' : '';
            const editClass = STATE.isMasterUser ? 'editable-daily-note' : '';
            const placeHolder = STATE.isMasterUser ? 'Daily Note...' : '';

            // --- DATE ROW (UPDATED COLSPANS) ---
            rowsHtml += `
            <tr style="background-color: var(--header-bg); border-bottom: 2px solid var(--border-color); border-top: 4px solid var(--border-color);">
                <!-- LEFT SIDE: STATS (Colspan 20) -->
                <td colspan="20" style="text-align: left; padding: 10px 10px 10px 20px; vertical-align: middle;">
                    <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 4px; color: var(--text-color);">
                        Date: ${dateStr} <span style="font-weight:normal; font-size:0.9em; color:var(--subtle-text);">(${totalDailyTrades} Trades)</span>
                    </div>
                    <div style="font-size: 0.95em;">
                        <span style="color: var(--green-text); font-weight: bold;">${dailyWins} Wins</span> / 
                        <span style="color: var(--red-text); font-weight: bold;">${dailyLosses} Losses</span>
                        <span style="margin: 0 10px; color: var(--border-color);">|</span>
                        <span style="font-weight: bold; color: var(--text-color);">Daily PnL: <span style="color: ${datePnlClass};">${pnlSign}$${dailyPnL.toFixed(2)}</span></span>
                    </div>
                </td>
                
                <!-- MIDDLE: EDITABLE NOTE (Colspan 1) -->
                <td colspan="1" 
                    class="${editClass}" 
                    data-date-key="${safeDateKey}" 
                    ${editAttr} 
                    style="vertical-align: middle; font-size: 12px; line-height: 1.4; font-weight: normal; font-style: italic; color: white; cursor: text;  white-space: normal;"
                    title="Daily Summary Note"
                >${dailyNote || `<span style=' font-size:0.9em;'>${placeHolder}</span>`}</td>

                <!-- RIGHT FILLER (Colspan 4: Covers Note2, Note3, Pics, Actions) -->
                <td colspan="4"></td>
            </tr>`;

            Object.keys(groupsInDate).forEach(groupId => {
                const groupTrades = groupsInDate[groupId];
                let groupNet = 0;
                let groupWins = 0, groupLosses = 0;
                let groupVolume = 0;
                let groupCoinQty = 0; 
                let groupPnL100 = 0; 
                let totalEntryValue = 0; // For weighted average entry
                let totalTradeCount = groupTrades.length; // Number of positions in the group

                groupTrades.forEach(t => {
                    groupNet += parseFloat(t.net_result || 0);
                    const size = parseFloat(t.size || 0);
                    const entry = parseFloat(t.entry || 1);
                    groupVolume += size;
                    groupCoinQty += (size / entry);
                    totalEntryValue += entry * (size / entry); // Sum (entry price * quantity)

                    const metrics = calculateTradeMetrics(t);
                    groupPnL100 += parseFloat(metrics.pnl_per_100_move || 0);

                    if (parseFloat(t.net_result) >= 0) groupWins++; else groupLosses++;
                });

                const groupPnlClass = groupNet >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                const groupType = groupTrades[0].type || 'Mixed'; 
                const groupSymbol = groupTrades[0].symbol.split('/')[0];
                const groupPercent = groupVolume > 0 ? (groupNet / groupVolume) * 100 : 0;
                const groupAverageEntry = groupCoinQty > 0 ? (totalEntryValue / groupCoinQty) : 0; // Weighted average entry

                rowsHtml += `
                <tr class="completed-group-header">
                    <td colspan="25" style="padding: 8px 15px; text-align: left;">
                        <div style="display:flex; flex-wrap:wrap; gap: 15px; align-items:center;">
                            <span style="font-weight:bold; color:var(--link-color); font-size:1.05em;">
                                ðŸ“‚ ${groupId} <span style="font-weight:normal; font-size:0.9em; color:var(--subtle-text);">(${groupType})</span>
                            </span>
                            <span style="color:var(--border-color);">|</span>
                            <span style="font-weight:bold; font-size:1.05em; color:var(--text-color);">
                                Net: <span style="color:${groupPnlClass};">$${groupNet.toFixed(2)}</span>
                                <span style="font-size:0.85em; margin-left:5px; color:${groupPnlClass};">(${groupPercent.toFixed(2)}%)</span>
                            </span>
                            <span style="color:var(--border-color);">|</span>
                            <span style="font-size:0.95em; color:var(--text-color);">
                                ${groupWins} Wins / ${groupLosses} Losses
                            </span>
                            <span style="color:var(--border-color);">|</span>
                            <span style="font-size:0.9em; color:var(--subtle-text);">
                                Vol: $${groupVolume.toLocaleString(undefined, {maximumFractionDigits:0})} <span style="font-weight:bold; color:var(--text-color);">(${groupCoinQty.toFixed(4)} ${groupSymbol})</span>
                            </span>
                            <span style="color:var(--border-color);">|</span> 
                            <span style="font-size:0.9em; color:var(--text-color); font-weight:bold;">
                                PnL/$100: <span style="font-family: 'Courier New'; color: var(--link-color);">$${groupPnL100.toFixed(2)}</span>
                            </span>
                            <span style="color:var(--border-color);">|</span> 
                            <span style="font-size:0.9em; color:var(--text-color);">
                                Avg Entry: <span style="font-weight:bold; color:var(--link-color);">${groupAverageEntry.toFixed(4)}</span>
                            </span>
                            <span style="color:var(--border-color);">|</span> 
                            <span style="font-size:0.9em; color:var(--text-color);">
                                Positions: <span style="font-weight:bold; color:var(--link-color);">${totalTradeCount}</span>
                            </span>
                        </div>
                    </td>
                </tr>`;

                groupTrades.forEach(trade => {
                    const resultColor = trade.net_result >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                    const totalFees = (parseFloat(trade.entry_fee || 0) + parseFloat(trade.exit_fee || 0));
                    const rawPnL = parseFloat(trade.net_result) + totalFees;
                    const rawColor = rawPnL >= 0 ? 'var(--green-text)' : 'var(--red-text)';

                    const metrics = calculateTradeMetrics(trade);
                    const isMaker = (trade.entryFeeType === 'maker');
                    
                    const tradePercent = (parseFloat(trade.net_result) / parseFloat(trade.size)) * 100;
                    const rrTDisplay = !isMaker ? (trade.rr_taker || metrics.rr_taker) : '--';
                    const rrMDisplay = isMaker ? (trade.rr_maker || metrics.rr_maker) : '--';
                    const rrTStyle = !isMaker ? 'font-weight:bold;' : 'opacity: 0.1;';
                    const rrMStyle = isMaker ? 'font-weight:bold;' : 'opacity: 0.1;';

                    const editAttr = STATE.isMasterUser ? 'contenteditable="true"' : '';
                    const editClass = STATE.isMasterUser ? 'editable-completed-cell' : '';

                    const masterButtons = STATE.isMasterUser ? `<td class="action-buttons">
                        <button class="attach-image-btn" data-id="${trade.dbId}" data-type="completed">Pic</button>
                        <button class="merge-btn-completed" data-id="${trade.dbId}">Merge</button>
                        <button class="delete-btn-completed" data-id="${trade.dbId}">Del</button>
                    </td>` : '';

                    rowsHtml += `
                    <tr class="completed-child-row" style="font-size: 0.95em;">
                        <td>${trade.symbol}</td>
                        <td>${trade.type}</td>
                        <td>${parseFloat(trade.entry).toFixed(4)}</td>
                        <td class="note-cell">${(trade.entry_prices || [trade.entry]).join(', ')}</td>
                        <td>${parseFloat(trade.stoploss || 0).toFixed(4)}</td>
                        <td>${parseFloat(trade.target || 0).toFixed(4)}</td>
                        <td>${parseFloat(trade.size || 0).toFixed(2)}</td>
                        <td style="opacity: ${!isMaker ? '0.6' : '0.1'};">${formatCurrency(metrics.expected_profit_taker)}</td>
                        <td style="opacity: ${isMaker ? '0.6' : '0.1'};">${formatCurrency(metrics.expected_profit_maker)}</td>
                        <td style="opacity: ${!isMaker ? '0.6' : '0.1'};">${formatCurrency(metrics.expected_loss_taker)}</td>
                        <td style="opacity: ${isMaker ? '0.6' : '0.1'};">${formatCurrency(metrics.expected_loss_maker)}</td>
                        
                        <td style="${rrTStyle}">${rrTDisplay}</td>
                        <td style="${rrMStyle}">${rrMDisplay}</td>
                        
                        <td class="editable-completed-cell" data-id="${trade.dbId}" data-field="exit_price" ${editAttr}>${parseFloat(trade.exit_price).toFixed(4)}</td>
                        <td style="color:${rawColor}; font-weight:bold; opacity:0.8;">${rawPnL.toFixed(2)}</td>
                        <td>${totalFees.toFixed(2)}</td>
                        <td style="color:${resultColor};font-weight:bold;">${parseFloat(trade.net_result).toFixed(2)}</td>
                        
                        <td style="color:${resultColor};font-weight:bold;">${tradePercent.toFixed(2)}%</td>

                        <td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td>
                        <td>${trade.closed_date ? new Date(trade.closed_date).toLocaleString() : '--'}</td>
                        <td class="note-cell ${editClass}" data-id="${trade.dbId}" data-field="note" ${editAttr}>${trade.note || ''}</td>
                        <td class="note-cell ${editClass}" data-id="${trade.dbId}" data-field="note2" ${editAttr}>${trade.note2 || ''}</td>
                        <td class="note-cell ${editClass}" data-id="${trade.dbId}" data-field="note3" ${editAttr}>${trade.note3 || ''}</td>
                        ${renderAttachmentThumbnails(trade, trade.dbId, 'completed')}
                        ${masterButtons}
                    </tr>`;
                });
            });
        });
    }

    DOM.completedTradesTbody.innerHTML = rowsHtml;
    setTimeout(() => { if (typeof adjustCollapsibleSize === 'function') adjustCollapsibleSize(DOM.completedTradesTbody); }, 200);
}
        function renderDateNavigation() {
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
            const timeframe = DOM.journalTimeframeEl.value;
            let buttonsHtml = '';
            for (let i = -2; i <= 2; i++) {
                const date = new Date(STATE.centerDate); date.setUTCDate(STATE.centerDate.getUTCDate() + i);
                const yyyymmdd = getYYYYMMDD(date);
                const isActive = yyyymmdd === getYYYYMMDD(STATE.selectedDate);
                const hasEntry = (STATE.journalText[safeSymbol]?.[yyyymmdd]?.[timeframe] || '').trim();
                const btnClasses = `date-nav-btn ${isActive ? 'active' : ''} ${hasEntry ? 'has-entry' : ''}`;
                const btnText = date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', timeZone: 'UTC' });
                buttonsHtml += `<button class="${btnClasses}" data-date="${yyyymmdd}">${btnText}</button>`;
            }
            DOM.dateButtonsContainer.innerHTML = buttonsHtml;
        }

        function updateJournalView(skipImages = false) { // <--- Added parameter
    const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
    const timeframe = DOM.journalTimeframeEl.value;
    const yyyymmdd = getYYYYMMDD(STATE.selectedDate);
    
    // 1. Handle Favourites (Pinned Notes)
    const favouriteText = (STATE.favouriteEntries[safeSymbol] || {})[timeframe];
    if (favouriteText) { 
        DOM.favouritedEntryText.textContent = favouriteText; 
        DOM.favouritedEntryContainer.style.display = 'block'; 
    } else { 
        DOM.favouritedEntryContainer.style.display = 'none'; 
    }

    // 2. Handle Journal Text
    const dailyText = (STATE.journalText[safeSymbol]?.[yyyymmdd]?.[timeframe]) || '';

    // CRITICAL FIX: Only update value if the user is NOT currently typing in it
    if(document.activeElement !== DOM.journalEntryEl) {
        DOM.journalEntryEl.value = dailyText;
        // Only resize if we updated the value programmatically
        setTimeout(() => { adjustCollapsibleSize(DOM.journalEntryEl); }, 50);
    }

    DOM.favouriteBtn.classList.toggle('active', favouriteText && dailyText.trim() === favouriteText);

    // 3. Handle Images - Only if NOT skipped
    if (!skipImages) {
        renderJournalImages(safeSymbol, timeframe, yyyymmdd);
    }
}

        function renderJournalImages(symbol, timeframe, selectedYMD) {
            const imagesForTimeframe = STATE.journalImages[symbol]?.[timeframe] || {};
            const allImageKeys = Object.keys(imagesForTimeframe);
            const filterMode = DOM.journalImageFilterEl.value;
           const imageKeysToRender = allImageKeys.filter(key => getYYYYMMDD(new Date(imagesForTimeframe[key].timestamp)) === selectedYMD);
            if (imageKeysToRender.length === 0) { DOM.journalImagesContainer.innerHTML = ''; return; }
            const deleteButtonHtml = (id, fileName) => (STATE.isMasterUser) ? `<button class="delete-journal-image" title="Delete Image" data-safe-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${fileName}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : '';
            const imagesHtml = imageKeysToRender.sort((a, b) => imagesForTimeframe[b].timestamp - imagesForTimeframe[a].timestamp).map(id => {
                const imgData = imagesForTimeframe[id];
                if (!imgData?.url || !imgData?.fileName) return '';
                return `<div class="journal-image-wrapper">${deleteButtonHtml(id, imgData.fileName)}<img src="${imgData.url}" alt="Journal Image" data-full-src="${imgData.url}" data-caption="Journal Image"></div>`;
            }).join('');
            DOM.journalImagesContainer.innerHTML = imagesHtml;
        }
// --- FIBONACCI CALCULATOR LOGIC ---
// --- 2. Main Calculation Function ---

        function calculateAndDisplayPercentages(row) {
            if (!row) return;
            const cells = row.querySelectorAll('td');
            if (cells.length === 0) return;
            const setups = [ { entry: 0, target: 1, targetPct: 2, stoploss: 3, stoplossPct: 4 }, { entry: 5, target: 6, targetPct: 7, stoploss: 8, stoplossPct: 9 }, { entry: 10, target: 11, targetPct: 12, stoploss: 13, stoplossPct: 14 } ];
            setups.forEach(setup => {
                const entryVal = parseFloat(cells[setup.entry].textContent.replace(/,/g, ''));
                const targetVal = parseFloat(cells[setup.target].textContent.replace(/,/g, ''));
                const stoplossVal = parseFloat(cells[setup.stoploss].textContent.replace(/,/g, ''));
                const targetPctCell = cells[setup.targetPct];
                const stoplossPctCell = cells[setup.stoplossPct];
                if (!isNaN(entryVal) && !isNaN(targetVal) && entryVal !== 0) { const percent = ((targetVal - entryVal) / entryVal) * 100; targetPctCell.textContent = percent.toFixed(1) + '%'; targetPctCell.style.color = percent >= 0 ? 'var(--green-text)' : 'var(--red-text)'; } else { targetPctCell.textContent = ''; }
                if (!isNaN(entryVal) && !isNaN(stoplossVal) && entryVal !== 0) { const percent = ((stoplossVal - entryVal) / entryVal) * 100; stoplossPctCell.textContent = percent.toFixed(1) + '%'; stoplossPctCell.style.color = percent >= 0 ? 'var(--green-text)' : 'var(--red-text)'; } else { stoplossPctCell.textContent = ''; }
            });
        }

        function applyHighlightingToSetupsTable(tableElement) {
            if (!tableElement) return;
            const tbody = tableElement.querySelector('tbody');
            const letterCheckRegex = /[a-zA-Z]/; 
            const setupTypes = [ { baseIndex: 0 }, { baseIndex: 5 }, { baseIndex: 10 } ];
            tbody.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td'); if (cells.length === 0) return;
                setupTypes.forEach(setup => {
                    const [entryCell, targetCell, stoplossCell] = [cells[setup.baseIndex], cells[setup.baseIndex + 1], cells[setup.baseIndex + 3]];
                    [entryCell, targetCell, stoplossCell].forEach(cell => cell.classList.remove('highlight-long', 'highlight-short'));
                    const entryText = entryCell.textContent.trim(), targetText = targetCell.textContent.trim();
                    if (letterCheckRegex.test(entryText) || letterCheckRegex.test(targetText)) return; 
                    const entryValue = parseFloat(String(entryText).replace(/,/g, '')), targetValue = parseFloat(String(targetText).replace(/,/g, ''));
                    if (isNaN(entryValue) || isNaN(targetValue)) return;
                    if (targetValue > entryValue) [entryCell, targetCell, stoplossCell].forEach(cell => cell.classList.add('highlight-long'));
                    else if (entryValue > targetValue) [entryCell, targetCell, stoplossCell].forEach(cell => cell.classList.add('highlight-short'));
                });
            });
        }

       function renderSetupsTable(tableElement, data, notesTextareaId) {
            if (tableElement) {
                const tbody = tableElement.querySelector('tbody');
                tbody.querySelectorAll('tr').forEach(row => {
                    const timeframe = row.firstElementChild.textContent.trim();
                    const rowData = data[timeframe] || {};
                    const cells = row.querySelectorAll('td');
                    cells[0].textContent = rowData.zero_entry || ''; cells[1].textContent = rowData.zero_target || ''; cells[3].textContent = rowData.zero_stoploss || '';
                    cells[5].textContent = rowData.four_entry || ''; cells[6].textContent = rowData.four_target || ''; cells[8].textContent = rowData.four_stoploss || '';
                    cells[10].textContent = rowData.bounce_entry || ''; cells[11].textContent = rowData.bounce_target || ''; cells[13].textContent = rowData.bounce_stoploss || '';
                    calculateAndDisplayPercentages(row);
                });
                applyHighlightingToSetupsTable(tableElement);
                adjustCollapsibleSize(tableElement);
            }
            const notesTextarea = document.getElementById(notesTextareaId);
            if (notesTextarea) {
                if (document.activeElement !== notesTextarea) {
                    notesTextarea.value = data.global_notes || '';
                }
                adjustCollapsibleSize(notesTextarea);
            }
        }
        
        // --- HELPER: Get Fees based on Exchange ---
function getFeeRates(exchangeName) {
    // Default to Binance if undefined (for old trades)
    const exchange = (exchangeName || 'binance').toLowerCase();
    
    if (exchange === 'hyperliquid') {
        return {
            MAKER: 0.00015, // 0.015%
            TAKER: 0.00045  // 0.045%
        };
    } else {
        // Default Binance (or any other fallback)
        return {
            MAKER: 0.0000,  // 0.00%
            TAKER: 0.00075  // 0.075%
        };
    }
}

        // --- DATA HANDLING AND SAVING ---
        function saveSetupsTable(tableElement, dbRef, statusElement, notesTextareaId) {
            if (!STATE.isMasterUser) return;
            const dataToSave = {};
            const tbody = tableElement.querySelector('tbody');
            tbody.querySelectorAll('tr').forEach(row => {
                const timeframe = row.firstElementChild.textContent.trim();
                const cells = row.querySelectorAll('td');
                dataToSave[timeframe] = {
                    zero_entry: cells[0].textContent.trim(), zero_target: cells[1].textContent.trim(), zero_stoploss: cells[3].textContent.trim(),
                    four_entry: cells[5].textContent.trim(), four_target: cells[6].textContent.trim(), four_stoploss: cells[8].textContent.trim(),
                    bounce_entry: cells[10].textContent.trim(), bounce_target: cells[11].textContent.trim(), bounce_stoploss: cells[13].textContent.trim()
                };
            });
            const notesTextarea = document.getElementById(notesTextareaId);
            if (notesTextarea) { dataToSave.global_notes = notesTextarea.value; }
            statusElement.textContent = 'Saving...';
            dbRef.set(dataToSave).then(() => { statusElement.textContent = 'Saved.'; setTimeout(() => { statusElement.textContent = '' }, 2000); }).catch(e => { statusElement.textContent = `Error: ${e.message}`; console.error("Error saving setups table:", e); });
        }

        const saveJournalEntry = () => {
            clearTimeout(STATE.journalSaveTimer);
            STATE.journalSaveTimer = setTimeout(() => {
                if (!STATE.isMasterUser) return;
                const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                const yyyymmdd = getYYYYMMDD(STATE.selectedDate);
                const timeframe = DOM.journalTimeframeEl.value;
                const text = DOM.journalEntryEl.value;

                DOM.saveStatus.textContent = 'Saving...';

                if (!STATE.journalText[safeSymbol]) STATE.journalText[safeSymbol] = {};
                if (!STATE.journalText[safeSymbol][yyyymmdd]) STATE.journalText[safeSymbol][yyyymmdd] = {};
                STATE.journalText[safeSymbol][yyyymmdd][timeframe] = text;

                dbRefs.journalText.child(safeSymbol).child(yyyymmdd).child(timeframe).set(text).then(() => {
                    DOM.saveStatus.textContent = 'Saved.';

                    const currentButton = DOM.dateButtonsContainer.querySelector(`.date-nav-btn[data-date="${yyyymmdd}"]`);
                    if (currentButton) {
                        currentButton.classList.toggle('has-entry', text.trim().length > 0);
                    }

                    setTimeout(() => DOM.saveStatus.textContent = '', 2000);
                }).catch(e => DOM.saveStatus.textContent = `Error: ${e.message}`);
            }, 750);
        };

        function savePrimaryNotesOnly() {
            if (!STATE.isMasterUser) return;
            const notesTextarea = DOM.primarySetupsNotes;
            if (notesTextarea) {
                dbRefs.setups1.child('global_notes').set(notesTextarea.value)
                    .catch(e => console.error("Error saving primary notes:", e));
            }
        }

        function saveSecondaryNotesOnly() {
            if (!STATE.isMasterUser) return;
            const notesTextarea = DOM.secondarySetupsNotes;
            if (notesTextarea) {
                dbRefs.setups2.child('global_notes').set(notesTextarea.value)
                    .catch(e => console.error("Error saving secondary notes:", e));
            }
        }
        function handleFileUpload(files) {
            if (!STATE.isMasterUser || !files || files.length === 0) return;
            DOM.uploadProgress.style.display = 'block';
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
            const timeframe = DOM.journalTimeframeEl.value;
            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `journal_images/${safeSymbol}/${timeframe}/${fileName}`;
                const uploadTask = storage.ref(storagePath).put(file);
                uploadTask.on('state_changed', (s) => { DOM.uploadProgress.textContent = `Uploading ${index + 1}/${files.length}: ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; }, (e) => { console.error("Upload Failed:", e); DOM.uploadProgress.textContent = `Upload Failed: ${e.code}`; }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        const imageData = { url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                        dbRefs.journalImages.child(safeSymbol).child(timeframe).push(imageData);
                        if (index === files.length - 1) { DOM.uploadProgress.textContent = 'Upload Complete!'; setTimeout(() => { DOM.uploadProgress.textContent = ''; }, 2000); }
                    });
                });
            });
        }

        function handleGenericLibraryUpload(files, libraryType, progressElement, dbRef) {
            if (!STATE.isMasterUser || !files || files.length === 0) return;
            progressElement.style.display = 'block';
            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `${libraryType}/${fileName}`;
                const uploadTask = storage.ref(storagePath).put(file);
                uploadTask.on('state_changed', (s) => { progressElement.textContent = `Uploading ${index + 1}/${files.length}: ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; }, (e) => { console.error(`${libraryType} Upload Failed:`, e); progressElement.textContent = `Upload Failed: ${e.code}`; }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        const imageData = { url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP, caption: '' };
                        dbRef.push(imageData);
                        if (index === files.length - 1) { progressElement.textContent = 'Upload Complete!'; setTimeout(() => { progressElement.textContent = ''; }, 2000); }
                    });
                });
            });
        }

function calculateNetResult(trade, exitPrice, exitFeeType) {
    const entry = parseFloat(trade.entry);
    const posValue = parseFloat(trade.size); // This is the USD value being closed
    const exit = parseFloat(exitPrice);
    
    if (isNaN(entry) || isNaN(posValue) || isNaN(exit)) return { net_result: 0, entry_fee: 0, exit_fee: 0 };

    // Get Rates based on Exchange
    const rates = getFeeRates(trade.exchange);
    const MAKER_FEE_RATE = rates.MAKER;
    const TAKER_FEE_RATE = rates.TAKER;

    const entryFeeRate = trade.entryFeeType === 'maker' ? MAKER_FEE_RATE : TAKER_FEE_RATE;
    const exitFeeRate = exitFeeType === 'maker' ? MAKER_FEE_RATE : TAKER_FEE_RATE;

    // 1. Calculate Fees
    const entryFee = posValue * entryFeeRate; // Fee paid when opening this portion
    const positionQty = posValue / entry;     // Amount of Coins
    const exitPosValue = positionQty * exit;  // Value at exit
    const exitFee = exitPosValue * exitFeeRate; // Fee paid now

    // 2. Calculate Gross PnL (Price Diff * Coins)
    const grossResult = trade.type === "Long" 
        ? (exit - entry) * positionQty 
        : (entry - exit) * positionQty;

    // 3. Net Result
    return { 
        net_result: grossResult - entryFee - exitFee, 
        entry_fee: entryFee, 
        exit_fee: exitFee 
    };
}
function completeTrade(tradeId, outcome) {
    // 1. Lock check (already done in handleTradeAction, but redundant safety is good)
    if (STATE.isProcessing) return;
    STATE.isProcessing = true;

    dbRefs.trades.child(tradeId).once('value', snapshot => {
        const trade = snapshot.val(); 
        if (!trade) {
            STATE.isProcessing = false;
            return;
        }
        
        const defaultExit = outcome === 'win' ? trade.target : trade.stoploss;
        const exitPriceStr = prompt(`Closing Trade (${trade.groupId || trade.symbol})\n\nEnter exact exit price:`, defaultExit);
        
        // CANCELLED? RESET LOCK
        if (exitPriceStr === null) {
            STATE.isProcessing = false;
            return;
        }

        const currentSize = parseFloat(trade.size);
        const closeSizeStr = prompt(`How much Value ($) are you closing?\n(Current Total: $${currentSize.toFixed(2)})`, currentSize);
        
        // CANCELLED? RESET LOCK
        if (closeSizeStr === null) {
            STATE.isProcessing = false;
            return;
        }
        
        let exitFeeType = prompt("Enter exit fee type (maker/taker):", "taker");
        // CANCELLED? RESET LOCK
        if (exitFeeType === null) {
            STATE.isProcessing = false;
            return;
        }
        exitFeeType = exitFeeType.toLowerCase().trim();

        const exitPrice = parseFloat(exitPriceStr);
        const closingSize = parseFloat(closeSizeStr);

        if (isNaN(exitPrice) || isNaN(closingSize) || closingSize <= 0 || closingSize > currentSize) {
            alert("Invalid input values.");
            STATE.isProcessing = false;
            return;
        }

        const tradePortion = { ...trade, size: closingSize };
        const result = calculateNetResult(tradePortion, exitPrice, exitFeeType);

        const completedTrade = {
            ...trade,
            size: closingSize,
            ...result,
            closed_date: firebase.database.ServerValue.TIMESTAMP,
            exit_price: exitPrice,
            exitFeeType: exitFeeType,
            note: (trade.note || '') + `\nClosed $${closingSize.toFixed(2)} @ $${exitPrice}`
        };

        if (Math.abs(currentSize - closingSize) < 1) {
            // FULL CLOSE
            dbRefs.completedTrades.push(completedTrade)
                .then(() => dbRefs.trades.child(tradeId).remove())
                .finally(() => { STATE.isProcessing = false; }); // RESET LOCK
        } else {
            // PARTIAL CLOSE
            const remainingSize = currentSize - closingSize;
            const updatedLiveTrade = {
                size: remainingSize,
                note: (trade.note || '') + `\nPartial close: -$${closingSize.toFixed(2)} on ${new Date().toLocaleDateString()}`
            };
            const recalcMetrics = calculateTradeMetrics({ ...trade, size: remainingSize });
            Object.assign(updatedLiveTrade, recalcMetrics);

            dbRefs.completedTrades.push(completedTrade);
            dbRefs.trades.child(tradeId).update(updatedLiveTrade)
                .finally(() => { STATE.isProcessing = false; }); // RESET LOCK
        }
    });
}
        function openImageModal(imageArray, clickedIndex) {
            STATE.modalImageGallery = imageArray;
            STATE.modalImageIndex = clickedIndex;
            displayModalImage();
            DOM.imageModal.style.display = 'flex';
        }

        function displayModalImage() {
            if (STATE.modalImageIndex < 0 || STATE.modalImageIndex >= STATE.modalImageGallery.length) return;
            const currentImage = STATE.modalImageGallery[STATE.modalImageIndex];
            DOM.modalImageContent.src = currentImage.url;
            DOM.modalCaption.textContent = currentImage.caption || '';
            
            // --- NEW LINE: Hide caption in modal if not master user ---
            DOM.modalCaption.style.display = STATE.isMasterUser ? 'block' : 'none';
            // ----------------------------------------------------------

            DOM.modalPrevBtn.style.display = STATE.modalImageIndex > 0 ? 'flex' : 'none';
            DOM.modalNextBtn.style.display = STATE.modalImageIndex < STATE.modalImageGallery.length - 1 ? 'flex' : 'none';
        }

        function closeModal() {
            DOM.imageModal.style.display = 'none';
            STATE.modalImageGallery = [];
            STATE.modalImageIndex = -1;
        }

        let noteModalSaveTimer = null;
        function openNoteForEditing(noteId) {
            const note = STATE.generalNotes[noteId];
            if (!note) return;
            DOM.noteModalTitle.value = note.title || '';
            DOM.noteModalContent.value = note.content || '';
            DOM.noteEditModal.dataset.currentNoteId = noteId;
            DOM.noteEditModal.style.display = 'flex';
            setTimeout(() => { autoResizeTextarea(DOM.noteModalContent); DOM.noteModalContent.focus(); }, 0);
            DOM.noteModalTitle.readOnly = !STATE.isMasterUser;
            DOM.noteModalContent.readOnly = !STATE.isMasterUser;
        }

        function saveNoteFromModal() {
            if (!STATE.isMasterUser) return;
            const noteId = DOM.noteEditModal.dataset.currentNoteId;
            if (!noteId) return;
            clearTimeout(noteModalSaveTimer);
            noteModalSaveTimer = setTimeout(() => {
                const newTitle = DOM.noteModalTitle.value.trim();
                const newContent = DOM.noteModalContent.value;
                dbRefs.generalNotes.child(noteId).update({ title: newTitle, content: newContent });
            }, 500);
        }

        function closeNoteModal() {
            saveNoteFromModal(); 
            clearTimeout(noteModalSaveTimer);
            DOM.noteEditModal.style.display = 'none';
            DOM.noteEditModal.dataset.currentNoteId = '';
            DOM.noteModalTitle.value = '';
            DOM.noteModalContent.value = '';
            renderNotes(STATE.generalNotes);
        }

 function setupEventListeners() {
    // --- 1. Theme Toggle ---
    DOM.themeToggle.addEventListener('change', (e) => {
        const theme = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    });

    // --- 2. Tab Navigation ---
    DOM.tabs.addEventListener('click', (e) => {
        if (!e.target.matches('.tab-link')) return;
        document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
        e.target.classList.add('active');
        const tabId = e.target.dataset.tab;
        const newTabContent = document.getElementById(`${tabId}-tab`);
        if (newTabContent) {
            newTabContent.classList.add('active');
            // Auto-open sections if first time visiting tab
            if (!newTabContent.dataset.sectionsInitialized) { 
                openDefaultSectionsInContainer(newTabContent); 
                newTabContent.dataset.sectionsInitialized = 'true'; 
            }
        }

        // Only show the stats panel if the active tab is 'tracker'
        DOM.statsPanelContainer.style.display = (tabId === 'tracker') ? 'block' : 'none';
        
        // Refresh Journal View if active
        if (tabId === 'journal') { 
            updateJournalView();
            renderDateNavigation(); 
        }
    });

    // --- 3. Stats Panel Toggle ---
    DOM.statsFab.addEventListener('click', () => DOM.statsPanel.classList.toggle('active'));
    DOM.closeStatsBtn.addEventListener('click', () => DOM.statsPanel.classList.remove('active'));
    document.addEventListener('click', (e) => {
        if (!DOM.statsPanel.contains(e.target) && !DOM.statsFab.contains(e.target) && DOM.statsPanel.classList.contains('active')) {
            DOM.statsPanel.classList.remove('active');
        }
    });

    // --- 4. TABLE ACTION LISTENERS (Buttons) ---
    if (DOM.tradesTbody) DOM.tradesTbody.addEventListener('click', handleTradeAction);
    if (DOM.completedTradesTbody) DOM.completedTradesTbody.addEventListener('click', handleTradeAction);
    if (DOM.restingTradesTbody) DOM.restingTradesTbody.addEventListener('click', handleTradeAction);

    // --- 5. EDITABLE CELL UPDATES (Blur Event) ---
    
    // A. Live Trades
    if (DOM.tradesTbody) {
        DOM.tradesTbody.addEventListener('blur', (e) => { 
            // Numeric Edits
            if (e.target.matches('.editable-cell')) handleLiveTradeUpdate(e.target); 
            // Note Edits
            if (e.target.matches('.editable-live-note')) handleLiveNoteUpdate(e.target);
        }, true);
    }

    // B. Resting Orders
    if (DOM.restingTradesTbody) {
        DOM.restingTradesTbody.addEventListener('blur', (e) => { 
            if (e.target.matches('.editable-cell')) handleRestingTradeUpdate(e.target); 
        }, true);
    }

    // C. Completed Trades (Includes Daily Notes)
    if (DOM.completedTradesTbody) {
        DOM.completedTradesTbody.addEventListener('blur', (e) => { 
            // 1. Standard Completed Trade Edits
            if (e.target.matches('.editable-completed-cell')) {
                handleCompletedTradeUpdate(e.target); 
            }
            
            // 2. Daily Summary Notes (The New Feature)
            if (e.target.matches('.editable-daily-note')) {
                if (!STATE.isMasterUser) return;
                const dateKey = e.target.dataset.dateKey;
                const text = e.target.innerText.trim();

                // Save to Firebase
                dbRefs.dailyNotes.child(dateKey).set(text).then(() => {
                    // Flash green feedback
                    e.target.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
                    setTimeout(() => {
                         e.target.style.backgroundColor = 'rgba(255,255,255,0.3)';
                    }, 500);
                });
            }
        }, true);
    }

    // --- 6. ADD TRADE FORM ---
    if (DOM.addTradeForm) {
        DOM.addTradeForm.addEventListener('submit', handleAddTradeSubmit);
    }

    // --- 7. GLOBAL BODY CLICKS (Collapsibles & Pagination) ---
    document.body.addEventListener('click', (e) => {
        // A. Collapsible Section Toggle
        const header = e.target.closest('.collapsible-header');
        if (header) {
            const section = header.parentElement;
            const content = section.querySelector('.collapsible-content');
            const toggleBtn = section.querySelector('.collapsible-toggle-btn');
            section.classList.toggle('is-open');
            toggleBtn.textContent = section.classList.contains('is-open') ? 'âˆ’' : '+';
            toggleBtn.style.transform = section.classList.contains('is-open') ? 'rotate(180deg)' : 'rotate(0deg)';
            
            if (section.classList.contains('is-open')) {
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => { 
                    if (section.classList.contains('is-open')) content.style.maxHeight = content.scrollHeight + 'px'; 
                }, 150);
            } else { 
                content.style.maxHeight = '0px'; 
            }
        }

        // B. Handle Image Actions (Delete/Click)
        if (handleAttachmentActions(e)) return;

        // C. Generic Library Interaction (Setups/Images)
        if (e.target.closest('#setups-image-container, #image-library-container')) {
            handleGenericImageLibraryClick(e);
        } 
        // D. Completed Trades Pagination
        else if (e.target.id === 'toggle-all-completed-trades') {
            STATE.completedTradesShowAll = true;
            STATE.completedTradesCurrentPage = 1;
            renderCompletedTable(STATE.allCompletedTrades);
        } else if (e.target.id === 'completed-trades-prev-page') {
            if (STATE.completedTradesCurrentPage > 1) { 
                STATE.completedTradesCurrentPage--; 
                renderCompletedTable(STATE.allCompletedTrades);  
            }
        } else if (e.target.id === 'completed-trades-next-page') {
            const totalPages = Math.ceil(Object.keys(STATE.allCompletedTrades).length / STATE.completedTradesItemsPerPage);
            if (STATE.completedTradesCurrentPage < totalPages) { 
                STATE.completedTradesCurrentPage++; 
                renderCompletedTable(STATE.allCompletedTrades);  
            }
        } 
        // E. Setups Image Pagination
        else if (e.target.id === 'toggle-all-setups-images') {
            STATE.setupsImagesShowAll = true;
            STATE.setupsImagesCurrentPage = 1;
            renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images');
        } else if (e.target.id === 'setups-images-prev-page') {
            if (STATE.setupsImagesCurrentPage > 1) { 
                STATE.setupsImagesCurrentPage--; 
                renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images');
            }
        } else if (e.target.id === 'setups-images-next-page') {
            const totalPages = Math.ceil(Object.keys(STATE.allSetupsImages).length / STATE.setupsImagesItemsPerPage);
            if (STATE.setupsImagesCurrentPage < totalPages) { 
                STATE.setupsImagesCurrentPage++;
                renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images');
            }
        }
    });

    // --- 8. CALENDAR NAVIGATION ---
    if (DOM.calPrevBtn && DOM.calNextBtn) {
        DOM.calPrevBtn.addEventListener('click', () => {
            STATE.calendarViewDate.setMonth(STATE.calendarViewDate.getMonth() - 1);
            if (typeof renderPnlCalendar === 'function') renderPnlCalendar();
        });
        DOM.calNextBtn.addEventListener('click', () => {
            STATE.calendarViewDate.setMonth(STATE.calendarViewDate.getMonth() + 1);
            if (typeof renderPnlCalendar === 'function') renderPnlCalendar();
        });
    }

    // --- 9. NOTES MODULE ---
    if (DOM.createNewNoteBtn) {
        DOM.createNewNoteBtn.addEventListener('click', () => {
            if (!STATE.isMasterUser) return;
            const title = prompt("Enter a title for the new note:");
            if (title && title.trim()) { 
                dbRefs.generalNotes.push({ 
                    title: title.trim(), 
                    content: '', 
                    timestamp: firebase.database.ServerValue.TIMESTAMP 
                }); 
            }
        });
    }

    if (DOM.notesContainer) {
        DOM.notesContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.note-item-header');
            const deleteBtn = e.target.closest('.note-delete-btn');
            
            if (deleteBtn && STATE.isMasterUser) { 
                e.stopPropagation(); 
                const noteId = deleteBtn.dataset.noteId; 
                if (confirm(`Are you sure you want to delete this note?`)) { 
                    dbRefs.generalNotes.child(noteId).remove(); 
                } 
                return; 
            }
            if (header) { 
                const noteId = header.dataset.noteId; 
                openNoteForEditing(noteId); 
            }
        });
    }

    DOM.noteModalClose.addEventListener('click', closeNoteModal);
    DOM.noteEditModal.addEventListener('click', e => { if (e.target.id === 'note-edit-modal') closeNoteModal(); });
    DOM.noteModalTitle.addEventListener('input', saveNoteFromModal);
    DOM.noteModalContent.addEventListener('input', (e) => { autoResizeTextarea(e.target); saveNoteFromModal(); });

    // --- 10. SETUPS TABLE (Blur & Input) ---
    document.body.addEventListener('blur', (e) => {
        if (e.target.matches('.setups-table .editable-setup-cell')) {
            const table = e.target.closest('.setups-table');
            const row = e.target.closest('tr');
            applyHighlightingToSetupsTable(table);
            if (row) calculateAndDisplayPercentages(row);
            if (table.id === 'primary-setups-table') saveSetupsTable(DOM.setupsTable1, dbRefs.setups1, DOM.setupsSaveStatus1, 'primary-setups-notes'); 
            else saveSetupsTable(DOM.setupsTable2, dbRefs.setups2, DOM.setupsSaveStatus2, 'secondary-setups-notes');
        }
    }, true);

    DOM.primarySetupsNotes.addEventListener('input', (e) => {
        autoResizeTextarea(e.target);
        debouncedResizeParent(e.target);
    });
    DOM.secondarySetupsNotes.addEventListener('input', (e) => {
        autoResizeTextarea(e.target);
        debouncedResizeParent(e.target);
    });
    DOM.primarySetupsNotes.addEventListener('blur', savePrimaryNotesOnly);
    DOM.secondarySetupsNotes.addEventListener('blur', saveSecondaryNotesOnly);

    // --- 11. FILE UPLOADS ---
    DOM.setupsImageUpload.addEventListener('change', (e) => handleGenericLibraryUpload(e.target.files, 'setups_images', DOM.setupsUploadProgress, dbRefs.setupsImages));
    DOM.tradeImageUploader.addEventListener('change', (e) => handleAttachmentImageUpload(e.target.files));
    DOM.journalImageUpload.addEventListener('change', (e) => handleFileUpload(e.target.files));

    // --- 12. IMAGE MODAL ---
    DOM.modalClose.addEventListener('click', closeModal);
    DOM.imageModal.addEventListener('click', (e) => { if (e.target.id === 'image-modal') closeModal(); });
    DOM.modalPrevBtn.addEventListener('click', () => { if (STATE.modalImageIndex > 0) { STATE.modalImageIndex--; displayModalImage(); } });
    DOM.modalNextBtn.addEventListener('click', () => { if (STATE.modalImageIndex < STATE.modalImageGallery.length - 1) { STATE.modalImageIndex++; displayModalImage(); } });

    // --- 13. JOURNAL CONTROLS ---
    [DOM.journalSymbolEl, DOM.journalTimeframeEl, DOM.journalImageFilterEl].forEach(el => el.addEventListener('change', () => {
        updateJournalView(false); 
        renderDateNavigation(); 
    }));
    
    DOM.dateButtonsContainer.addEventListener('click', (e) => { 
        if (e.target.matches('.date-nav-btn')) { 
            const parts = e.target.dataset.date.split('-'); 
            STATE.selectedDate = new Date(Date.UTC(parts[0], parseInt(parts[1], 10) - 1, parts[2])); 
            STATE.centerDate = new Date(STATE.selectedDate); 
            updateJournalView();
            renderDateNavigation(); 
        } 
    });
    DOM.datePrevBtn.addEventListener('click', () => { STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() - 5); renderDateNavigation(); });
    DOM.dateNextBtn.addEventListener('click', () => { STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() + 5); renderDateNavigation(); });

    DOM.journalEntryEl.addEventListener('input', (e) => { autoResizeTextarea(e.target); debouncedResizeParent(e.target); saveJournalEntry(); });
    DOM.favouriteBtn.addEventListener('click', handleFavouriteClick);

    // Journal Image Clicks & Drag-Drop
    DOM.journalTab.addEventListener('click', (e) => {
        if (e.target.closest('.delete-journal-image')) { handleImageDelete(e); return; }
        const img = e.target.closest('#journal-images-container img');
        if(img) { 
            const allImageElements = DOM.journalImagesContainer.querySelectorAll('img'); 
            const imageArray = Array.from(allImageElements).map(el => ({ url: el.dataset.fullSrc, caption: el.dataset.caption })); 
            const clickedIndex = Array.from(allImageElements).indexOf(img); 
            openImageModal(imageArray, clickedIndex); 
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { DOM.journalTab.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }); });
    ['dragenter', 'dragover'].forEach(eventName => { DOM.journalTab.addEventListener(eventName, () => { if (STATE.isMasterUser) DOM.journalTab.classList.add('drag-over'); }); });
    DOM.journalTab.addEventListener('dragleave', () => DOM.journalTab.classList.remove('drag-over'));
    DOM.journalTab.addEventListener('drop', (e) => { 
        DOM.journalTab.classList.remove('drag-over'); 
        if (STATE.isMasterUser && e.dataTransfer?.files.length > 0) handleFileUpload(e.dataTransfer.files); 
    });
}
        function setupSpinbox(inputElement) {
            const handleAdjustment = (multiplier) => {
                let currentValue = parseFloat(inputElement.value) || 0;
                const valueStr = inputElement.value;
                let step = 1;
                if (valueStr.includes('.')) { const decimalPart = valueStr.split('.')[1]; step = Math.pow(10, -decimalPart.length); }
                const precision = Math.pow(10, (valueStr.split('.')[1] || '').length);
                let newValue = (Math.round(currentValue * precision) + Math.round(step * multiplier * precision)) / precision;
                const decimalPlaces = (valueStr.split('.')[1] || '').length;
                inputElement.value = newValue.toFixed(decimalPlaces);
                inputElement.dispatchEvent(new Event('input'));
            };
            inputElement.addEventListener('keydown', e => {
                if (e.key === 'ArrowUp') { e.preventDefault(); handleAdjustment(1); } else if (e.key === 'ArrowDown') { e.preventDefault(); handleAdjustment(-1); }
            });
            inputElement.addEventListener('wheel', e => { e.preventDefault(); handleAdjustment(e.deltaY < 0 ? 1 : -1); });
        }

   // REPLACE THE ENTIRE calculateTradeMetrics FUNCTION
// REPLACE THE ENTIRE calculateTradeMetrics FUNCTION
function calculateTradeMetrics(tradeData) {
    const entry = parseFloat(tradeData.entry); 
    const stoploss = parseFloat(tradeData.stoploss); 
    const target = parseFloat(tradeData.target); 
    const size = parseFloat(tradeData.size); 
    const type = tradeData.type;

    const baseReturn = { 
        rr_taker: 0, rr_maker: 0, estimated_total_fee: 0, 
        expected_profit_taker: 0, expected_profit_maker: 0, 
        expected_loss_taker: 0, expected_loss_maker: 0, 
        expected_profit_percent_taker: 0, expected_profit_percent_maker: 0,
        expected_loss_percent_taker: 0, expected_loss_percent_maker: 0,
        pnl_per_100_move: 0 
    };

    if ([entry, stoploss, target, size].some(v => isNaN(v) || v <= 0)) { return baseReturn; }

    const rates = getFeeRates(tradeData.exchange);
    const MAKER_FEE_RATE = rates.MAKER;
    const TAKER_FEE_RATE = rates.TAKER;

    // Determine Entry Fee
    const entryFeeRate = tradeData.entryFeeType === 'maker' ? MAKER_FEE_RATE : TAKER_FEE_RATE;
    const positionQty = size / entry; 
    const entryFee = size * entryFeeRate;

    // --- NEW CALCULATION ---
    // How much $ is made/lost if price moves $100
    const pnl_per_100_move = positionQty * 100; 

    let potentialProfit, potentialLoss;
    if (type === 'Long') { 
        potentialProfit = positionQty * (target - entry); 
        potentialLoss = positionQty * (entry - stoploss); 
    } else { 
        potentialProfit = positionQty * (entry - target); 
        potentialLoss = positionQty * (stoploss - entry); 
    }

    // --- Profit Calculations ---
    const exitValueAtTarget = (target / entry) * size; 

    // Taker Profit
    const exitFeeAtTarget_Taker = exitValueAtTarget * TAKER_FEE_RATE; 
    const expected_profit_taker = potentialProfit - entryFee - exitFeeAtTarget_Taker;

    // Maker Profit
    const exitFeeAtTarget_Maker = exitValueAtTarget * MAKER_FEE_RATE;
    const expected_profit_maker = potentialProfit - entryFee - exitFeeAtTarget_Maker;

    // --- FIX: Logic for Estimated Total Fee Column ---
    // If entered as Maker, assume Maker exit. If entered as Taker, assume Taker exit.
    const projectedExitFee = tradeData.entryFeeType === 'maker' ? exitFeeAtTarget_Maker : exitFeeAtTarget_Taker;
    const estimated_total_fee = entryFee + projectedExitFee; 

    // --- Loss Calculations ---
    const exitValueAtStop = (stoploss / entry) * size; 

    // Loss Taker
    const exitFeeAtStop_Taker = exitValueAtStop * TAKER_FEE_RATE; 
    const expected_loss_taker = potentialLoss + entryFee + exitFeeAtStop_Taker;

    // Loss Maker
    const exitFeeAtStop_Maker = exitValueAtStop * MAKER_FEE_RATE;
    const expected_loss_maker = potentialLoss + entryFee + exitFeeAtStop_Maker;

    // --- RR Calculations ---
    const rr_taker = (expected_loss_taker > 0) ? (expected_profit_taker / expected_loss_taker) : 0;
    const rr_maker = (expected_loss_maker > 0) ? (expected_profit_maker / expected_loss_maker) : 0;

    // --- Percentages ---
    const expected_profit_percent_taker = (expected_profit_taker / size) * 100; 
    const expected_profit_percent_maker = (expected_profit_maker / size) * 100; 
    const expected_loss_percent_taker = (expected_loss_taker / size) * 100;
    const expected_loss_percent_maker = (expected_loss_maker / size) * 100;

    return { 
        rr_taker: rr_taker.toFixed(2),
        rr_maker: rr_maker.toFixed(2),
        estimated_total_fee: estimated_total_fee, 
        expected_profit_taker: expected_profit_taker, 
        expected_profit_maker: expected_profit_maker,
        expected_loss_taker: expected_loss_taker,
        expected_loss_maker: expected_loss_maker,
        expected_profit_percent_taker: expected_profit_percent_taker,
        expected_profit_percent_maker: expected_profit_percent_maker,
        expected_loss_percent_taker: expected_loss_percent_taker,
        expected_loss_percent_maker: expected_loss_percent_maker,
        pnl_per_100_move: pnl_per_100_move
    };
}
function handleAddTradeSubmit(e) {
    e.preventDefault(); 
    if (!STATE.isMasterUser) return;
    
    const status = document.getElementById('trade-status').value;
    
    const session = document.getElementById('trade-session').value;
    const variant = document.getElementById('trade-variant').value;
    const generatedGroupId = `${session}_${variant}`;

    const entryPrice = parseFloat(document.getElementById('entry-price').value);
    const stopLossPrice = parseFloat(document.getElementById('stop-loss').value);

    const trade = { 
        symbol: document.getElementById('trade-symbol').value, 
        exchange: document.getElementById('trade-exchange').value,
        type: document.getElementById('trade-type').value, 
        setupType: document.getElementById('trade-setup-type')?.value || 'Major', 
        groupId: generatedGroupId, 
        entry: entryPrice, 
        stoploss: stopLossPrice,
        // NEW: Persist the initial risk level
        original_stoploss: stopLossPrice, 
        target: parseFloat(document.getElementById('target').value), 
        size: parseFloat(document.getElementById('position-value').value), 
        date: firebase.database.ServerValue.TIMESTAMP, 
        entry_prices: [],
        entryFeeType: document.getElementById('entry-fee-type').value
    };

    if (Object.values(trade).some(val => val === null || (isNaN(val) && typeof val === 'number'))) {
        return alert('Please fill all fields correctly.');
    }
    
    trade.entry_prices.push(trade.entry);
    
    const metrics = calculateTradeMetrics(trade);
    const tradeWithMetrics = { ...trade, ...metrics };
    
    const targetRef = (status === 'resting') ? dbRefs.restingOrders : dbRefs.trades;
    targetRef.push(tradeWithMetrics).then(() => {
        // Clear only numeric fields to allow rapid entry of same setup
        document.getElementById('entry-price').value = '';
        document.getElementById('stop-loss').value = '';
        document.getElementById('target').value = '';
        document.getElementById('position-value').value = '';
    }).catch(error => alert(`Error: ${error.message}`));
}

function handleCompletedTradeUpdate(cell) {
    if (!STATE.isMasterUser) return;

    const tradeId = cell.dataset.id;
    const field = cell.dataset.field;
    let newValue = cell.textContent.trim();

    // --- SCENARIO 1: Updating Exit Price (Requires Math Recalculation) ---
    if (field === 'exit_price') {
        const newPrice = parseFloat(newValue.replace(/[^0-9.-]/g, ''));

        if (isNaN(newPrice)) {
            alert("Invalid Price");
            return;
        }

        // We must fetch the full trade object to recalculate fees/PnL correctly
        dbRefs.completedTrades.child(tradeId).once('value', snapshot => {
            const trade = snapshot.val();
            if (!trade) {
                alert("Trade not found");
                return;
            }

            // Don't update if the value hasn't actually changed
            if (parseFloat(trade.exit_price) === newPrice) return;

            // Recalculate Financials using your existing helper function
            // We default to 'taker' if exitFeeType is missing from old data
            const result = calculateNetResult(trade, newPrice, trade.exitFeeType || 'taker');

            const updates = {
                exit_price: newPrice,
                net_result: result.net_result,
                entry_fee: result.entry_fee,
                exit_fee: result.exit_fee,
                // Add a note about the edit
                note: (trade.note || '') + `\nExit Price adjusted to $${newPrice} on ${new Date().toLocaleString()}`
            };

            dbRefs.completedTrades.child(tradeId).update(updates).then(() => {
                // Flash green on success
                cell.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                setTimeout(() => cell.style.backgroundColor = '', 500);
            }).catch(err => alert("Error updating trade: " + err.message));
        });
        return; 
    }

    // --- SCENARIO 2: Standard Text Fields (Notes, etc) ---
    dbRefs.completedTrades.child(tradeId).update({
        [field]: newValue
    }).then(() => {
        cell.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
        setTimeout(() => cell.style.backgroundColor = '', 500);
    }).catch(err => alert("Error saving: " + err.message));
}


        
    function handleLiveTradeUpdate(cell) {
    if (!STATE.isMasterUser) return;
    
    const tradeId = cell.dataset.id;
    const fieldToUpdate = cell.dataset.field;
    const tradeRef = dbRefs.trades.child(tradeId);

    tradeRef.once('value', snapshot => {
        const trade = snapshot.val(); 
        if (!trade) { alert('Error: Trade not found.'); return; }
        
        const updates = {};

        // --- 1. Handle Entry Prices List ---
        if (fieldToUpdate === 'entry_prices') {
            // Parse the new input
            const newPricesArray = cell.textContent.split(',')
                .map(s => parseFloat(s.trim()))
                .filter(n => !isNaN(n) && n > 0);

            // Validation: Must have at least one valid price
            if (newPricesArray.length === 0) { 
                alert("Invalid entry prices list."); 
                cell.textContent = (trade.entry_prices || [trade.entry]).join(', '); 
                return; 
            }

            // --- FIX: COMPARE ARRAYS TO PREVENT UNNECESSARY UPDATES ---
            const currentPrices = trade.entry_prices || [trade.entry];
            
            // Check if arrays are different
            const isDifferent = (newPricesArray.length !== currentPrices.length) || 
                                newPricesArray.some((val, index) => val !== currentPrices[index]);

            if (!isDifferent) {
                // If data is the same, just format the text nicely and EXIT
                cell.textContent = currentPrices.join(', ');
                return; 
            }
            // -----------------------------------------------------------

            updates.entry_prices = newPricesArray; 
            updates.note = (trade.note || '') + `\nEntry list updated ${new Date().toLocaleString()}`; 
            tradeRef.update(updates); 
            return; 
        } 

        // --- 2. Handle Single Number Fields (Entry, Stop, Target, Size) ---
        let newValue = parseFloat(cell.textContent.replace(/[^0-9.-]/g, ''));
        const precision = ['entry', 'stoploss', 'target'].includes(fieldToUpdate) ? 4 : 2;

        if (isNaN(newValue)) { 
            alert('Invalid number.'); 
            cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); 
            return; 
        }

        // Compare values to prevent unnecessary updates
        if (parseFloat(trade[fieldToUpdate]).toFixed(precision) === newValue.toFixed(precision)) { 
            cell.textContent = newValue.toFixed(precision); 
            return; 
        }

        updates[fieldToUpdate] = newValue;
        
        // Recalculate metrics based on new value
        const tempTradeForCalc = { ...trade, ...updates };
        const newMetrics = calculateTradeMetrics(tempTradeForCalc);
        Object.assign(updates, newMetrics);
        
        updates.note = (trade.note || '') + `\n${fieldToUpdate} updated to ${newValue.toFixed(precision)} on ${new Date().toLocaleString()}`;
        
        tradeRef.update(updates).catch(error => { 
            alert('Failed to update trade: ' + error.message); 
            cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); 
        });
    });
}

     function handleAddStaggeredEntry(tradeId) {
    if (!STATE.isMasterUser) return;
    const tradeRef = dbRefs.trades.child(tradeId);
    tradeRef.once('value', snapshot => {
        const currentTrade = snapshot.val();
        if (!currentTrade) return alert('Error: Trade not found.');

        const newEntryPriceStr = prompt("Enter NEW entry price:");
        if (newEntryPriceStr === null) return;
        const newPositionValueStr = prompt("Enter value ($) of this NEW position:");
        if (newPositionValueStr === null) return;
        const newEntryFeeType = prompt("Enter fee type for this entry (maker/taker):", currentTrade.entryFeeType || 'taker');
        if (newEntryFeeType === null) return;

        const newEntryPrice = parseFloat(newEntryPriceStr);
        const newPositionValue = parseFloat(newPositionValueStr);
        const isNewEntryMaker = newEntryFeeType.toLowerCase().trim() === 'maker';

        if (isNaN(newEntryPrice) || isNaN(newPositionValue) || newEntryPrice <= 0 || newPositionValue <= 0) {
            return alert("Invalid input.");
        }

        const currentSize = parseFloat(currentTrade.size); 
        const currentAvgEntry = parseFloat(currentTrade.entry);

        // 1. Calculate Coin Quantities
        const currentQty = currentSize / currentAvgEntry;
        const newQty = newPositionValue / newEntryPrice;
        const totalQty = currentQty + newQty;

        // 2. Calculate New Total Size ($)
        const totalValueBasis = currentSize + newPositionValue;

        // 3. Calculate Raw Weighted Average (Hyperliquid Logic)
        const newAverageEntryPrice = totalValueBasis / totalQty;

        const updatedEntryPrices = currentTrade.entry_prices || [currentTrade.entry];
        updatedEntryPrices.push(newEntryPrice);

        // Recalculate metrics
        const tempTradeForCalc = { ...currentTrade, entry: newAverageEntryPrice, size: totalValueBasis };
        const newMetrics = calculateTradeMetrics(tempTradeForCalc);

        const updatedTrade = {
            ...currentTrade,
            entry: newAverageEntryPrice,
            size: totalValueBasis,
            entry_prices: updatedEntryPrices,
            ...newMetrics,
            note: (currentTrade.note || '') + `\n+ Added $${newPositionValue.toFixed(2)} @ $${newEntryPrice.toFixed(4)} (${isNewEntryMaker ? 'Maker' : 'Taker'})`
        };

        tradeRef.update(updatedTrade);
    });
}
        function handleGenericImageLibraryClick(e) {
            const clickedImg = e.target.closest('img');
            if (clickedImg?.dataset.fullSrc) {
                const galleryContainer = clickedImg.closest('#setups-image-container, .trade-image-thumbnails');
                if (galleryContainer) { const allImageElements = galleryContainer.querySelectorAll('img'); const imageArray = Array.from(allImageElements).map(el => ({ url: el.dataset.fullSrc, caption: el.dataset.caption })); const clickedIndex = Array.from(allImageElements).indexOf(clickedImg); if (clickedIndex > -1) openImageModal(imageArray, clickedIndex); }
                return;
            }
            if (e.target.closest('#setups-image-container')) handleLibraryActions(e, 'setups_images', dbRefs.setupsImages);
        }

        function handleLibraryActions(e, libraryType, dbRef) {
            const deleteBtn = e.target.closest('.delete-library-image');
            const editBtn = e.target.closest('.edit-caption-btn');

            if (deleteBtn && STATE.isMasterUser) {
                const { id, filename } = deleteBtn.dataset;
                if (!filename || filename === 'undefined') {
                    alert("Cannot delete image: Filename is missing. Please fix manually in Firebase console.");
                    console.error("Attempted to delete image with missing filename.", { imageId: id, libraryType });
                    return;
                }
                if (confirm(`Delete this image?\n\n${filename}`)) {
                    const storagePath = `${libraryType}/${filename}`;
                    storage.ref(storagePath).delete().then(() => {
                        dbRef.child(id).remove();
                    }).catch((err) => {
                        if (err.code === 'storage/object-not-found') {
                            console.warn("Storage object not found, deleting DB record anyway for:", filename);
                            dbRef.child(id).remove();
                        } else {
                            console.error("Firebase Storage deletion failed:", err);
                            alert('Error deleting image. Check console for details.');
                        }
                    });
                }
            } else if (editBtn && STATE.isMasterUser) {
                const { id } = editBtn.dataset;
                const imageRef = dbRef.child(id);
                imageRef.child('caption').once('value', snapshot => {
                    const newCaption = prompt('Enter image caption:', snapshot.val() || "");
                    if (newCaption !== null) {
                        imageRef.update({ caption: newCaption.trim() });
                    }
                });
            }
        }
// Add this to your STATE object if not already there (at top of script)
// STATE.lastClickTime = 0; 

function handleTradeAction(e) {
    if (!STATE.isMasterUser) return;

    // 1. Find the button
    const button = e.target.closest('button');
    
    // If we are in Merge Mode, handle row clicks (ignore buttons for a moment)
    if (STATE.isMerging && !button) {
        const targetRow = e.target.closest('tr');
        if (targetRow && targetRow.parentElement.id === 'completed-trades-tbody') {
            const absorbedTradeId = targetRow.querySelector('.action-buttons button')?.dataset.id;
            if (absorbedTradeId) executeMerge(STATE.mergeBaseTradeId, absorbedTradeId);
        }
        return;
    }

    if (!button) return;

    // 2. STOP PROPAGATION (Fixes "Double Prompt" if listeners are nested)
    e.stopPropagation();
    e.preventDefault();

    // 3. COOLDOWN (Prevents rapid double-clicks)
    const now = Date.now();
    if (now - (STATE.lastClickTime || 0) < 500) return; 
    STATE.lastClickTime = now;

    // 4. PROCESSING LOCK
    if (STATE.isProcessing) return;

    const { id } = button.dataset;

    // --- BUTTON ROUTING ---

    // A. Close Group Idea
    if (button.matches('.close-group-btn')) {
        const groupId = button.dataset.groupId;
        handleCloseGroup(groupId);
        return;
    }

    // B. Resting Orders
    if (button.closest('#resting-trades-tbody')) {
        if (button.matches('.delete-resting-btn')) {
            if (confirm('Delete this resting order?')) {
                dbRefs.restingOrders.child(id).remove();
            }
        } else if (button.matches('.activate-btn')) {
            if (confirm('Move this order to Live Trades?')) {
                dbRefs.restingOrders.child(id).once('value', snapshot => {
                    const tradeData = snapshot.val();
                    if (tradeData) {
                        const liveTrade = { ...tradeData, date: firebase.database.ServerValue.TIMESTAMP };
                        dbRefs.trades.push(liveTrade)
                            .then(() => dbRefs.restingOrders.child(id).remove())
                            .catch(err => alert("Error moving trade: " + err.message));
                    }
                });
            }
        }
        return;
    }

    // C. Live & Completed Actions
    const isCompleted = button.closest('tbody').id === 'completed-trades-tbody';
    const tradeRef = isCompleted ? dbRefs.completedTrades.child(id) : dbRefs.trades.child(id);

    if (button.matches('.win-btn')) {
        completeTrade(id, 'win');
    } 
    else if (button.matches('.loss-btn')) {
        completeTrade(id, 'loss');
    } 
    else if (button.matches('.add-to-position-btn')) {
        handleAddStaggeredEntry(id);
    } 
    else if (button.matches('.merge-btn-completed')) {
        initiateMerge(id);
    } 
    else if (button.matches('.delete-btn, .delete-btn-completed')) {
        if (confirm('Delete this trade?')) {
            if (isCompleted) resetMergeState();
            tradeRef.remove();
        }
    } 
    else if (button.matches('.note-btn, .note-btn-completed')) {
        tradeRef.child('note').once('value', snapshot => {
            const newNote = prompt("Enter Note 1:", snapshot.val() || "");
            if (newNote !== null) tradeRef.update({ note: newNote });
        });
    }
    else if (button.matches('.note2-btn-completed')) {
        tradeRef.child('note2').once('value', snapshot => {
            const newNote2 = prompt("Enter Note 2:", snapshot.val() || "");
            if (newNote2 !== null) tradeRef.update({ note2: newNote2 });
        });
    }
    else if (button.matches('.note3-btn-completed')) {
        tradeRef.child('note3').once('value', snapshot => {
            const newNote3 = prompt("Enter Note 3:", snapshot.val() || "");
            if (newNote3 !== null) tradeRef.update({ note3: newNote3 });
        });
    }
}

// Ensure STATE is defined globally or accessible here if getPerthDateString needs it.
// For example, if STATE is defined elsewhere like:
// const STATE = { isMasterUser: false, setupsImagesCurrentPage: 1, setupsImagesShowAll: false };
// Or ensure STATE is passed correctly to any function that needs it.

// Helper: Calculate 6am-6am Trading Day String
// Perth is UTC+8. Day break is 06:00 Perth.
// 06:00 Perth = 22:00 UTC (Previous Day).
// Logic: If we add 2 hours to UTC time, the DATE component aligns exactly with the 6am-6am trading day.
// Example: Jan 20, 06:00 Perth -> Jan 19, 22:00 UTC. Add 2hr -> Jan 20, 00:00 UTC. Date = Jan 20.
// Example: Jan 20, 05:59 Perth -> Jan 19, 21:59 UTC. Add 2hr -> Jan 19, 23:59 UTC. Date = Jan 19.
const getTradingDayKey = (ts) => {
    if (!ts) return "Unknown";
    // 2 hours in milliseconds = 7200000
    return new Date(ts + 7200000).toISOString().split('T')[0];
};

// New Helper: Format Date for Display
// This function does not need STATE, it just formats a date string.
const formatDisplayDate = (dateString) => {
    // dateString is in 'YYYY-MM-DD' format
    // Use an arbitrary time like 'T12:00:00' for consistency and to avoid local timezone issues
    // with date interpretation, especially around daylight saving transitions.
    // Specifying a timezone 'Z' (UTC) is generally safest for consistent interpretation from YYYY-MM-DD.
    const date = new Date(dateString + 'T00:00:00Z');
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    return date.toLocaleDateString('en-AU', options); // Or 'en-US' or your preferred locale
};


// --- MISSING FUNCTION: Renders the Setups / Setup Image Library ---
function renderGenericImageLibrary(imagesData, containerElement, libraryType) {
    const images = imagesData || {};
    if (!containerElement) return;

    // Assuming getPerthDateString is globally available or defined elsewhere
    // and correctly accesses STATE if needed.
    const perthTodayStr = getPerthDateString();

    // Helper to generate buttons (this needs STATE.isMasterUser)
    const masterButtonsHtml = (id, fileName) => (STATE.isMasterUser) ? `<button class="delete-library-image" title="Delete Image" data-id="${id}" data-filename="${fileName}" data-library-type="${libraryType}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button><button class="edit-caption-btn" title="Edit Caption" data-id="${id}" data-library-type="${libraryType}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160V416c0 53 43 96 96 96H352c53 0 96-43 96-96V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H96z"/></svg></button>` : '';

    // Sort all images newest first
    const allImageIds = Object.keys(images).sort((a, b) => images[b].timestamp - images[a].timestamp);
    let imagesHtml = '';


    // Helper to create Image HTML (this needs STATE.isMasterUser)
    const createImageHtml = (id, extraClasses = '', extraStyle = '') => {
        const imgData = images[id];
        if (!imgData?.url) return '';

        const caption = imgData.caption || (imgData.timestamp ? new Date(imgData.timestamp).toLocaleString() : ' ');

        // Visibility Logic (Master or < 7 days old)
        const imgTime = imgData.timestamp ? new Date(imgData.timestamp).getTime() : 0;
        const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
        const isRecent = (Date.now() - imgTime) < sevenDaysMs;
        const showCaption = STATE.isMasterUser || (imgTime > 0 && isRecent);
        const captionClass = showCaption ? '' : 'master-only';

        return `<div class="library-image-wrapper ${extraClasses}" ${extraStyle}>${masterButtonsHtml(id, imgData.fileName)}<img src="${imgData.url}" alt="${libraryType} Image" data-full-src="${imgData.url}" data-caption="${caption}"><div class="library-image-caption ${captionClass}" title="${caption}">${caption}</div></div>`;
    };

    if (libraryType === 'setups_images') {
        const paginationControls = document.getElementById('setups-images-pagination-controls');
        const showAllButton = document.getElementById('toggle-all-setups-images');
        const pageInfo = document.getElementById('setups-images-page-info');

        if (STATE.setupsImagesShowAll) {
            // --- PAGINATE BY 6AM TRADING DAYS ---

            // 1. Extract unique Trading Days
            const uniqueDatesSet = new Set();
            allImageIds.forEach(id => {
                const ts = images[id].timestamp;
                if(ts) uniqueDatesSet.add(getTradingDayKey(ts));
            });

            // 2. Sort dates descending (Newest first)
            const sortedUniqueDates = Array.from(uniqueDatesSet).sort((a, b) => b.localeCompare(a));

            // 3. Define Days per Page (1 Day = 6am to 6am view)
            const DAYS_PER_PAGE = 1;

            // 4. Calculate total pages
            const totalPages = Math.ceil(sortedUniqueDates.length / DAYS_PER_PAGE);

            // 5. Handle Boundary Checks
            if (STATE.setupsImagesCurrentPage > totalPages && totalPages > 0) STATE.setupsImagesCurrentPage = totalPages;
            if (STATE.setupsImagesCurrentPage < 1) STATE.setupsImagesCurrentPage = 1;

            // 6. Identify which dates belong to this page
            const startIndex = (STATE.setupsImagesCurrentPage - 1) * DAYS_PER_PAGE;
            const datesForThisPage = sortedUniqueDates.slice(startIndex, startIndex + DAYS_PER_PAGE);

            // 7. Render images with date headers
            let currentDayImagesHtml = '';
            datesForThisPage.forEach(dateKey => {
                const displayDate = formatDisplayDate(dateKey); // formatDisplayDate is now globally accessible
                currentDayImagesHtml += `<h3 class="daily-image-header">${displayDate}</h3>`; // Add the header
                const idsForThisDate = allImageIds.filter(id => getTradingDayKey(images[id].timestamp) === dateKey);
                currentDayImagesHtml += idsForThisDate.map(id => createImageHtml(id)).join('');
            });
            imagesHtml = currentDayImagesHtml;


            // 9. Update Controls
            showAllButton.style.display = 'none';
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                // Removed Date Text as requested, just Page X of Y
                pageInfo.textContent = `Page ${STATE.setupsImagesCurrentPage} of ${totalPages}`;
                document.getElementById('setups-images-prev-page').disabled = (STATE.setupsImagesCurrentPage === 1);
                document.getElementById('setups-images-next-page').disabled = (STATE.setupsImagesCurrentPage === totalPages);
            } else {
                paginationControls.style.display = 'none';
            }
        } else {
            // "Default View" - Show today's images, hide older ones initially
            let hasHistorical = false;
            imagesHtml = allImageIds.map(id => {
                const imgData = images[id];
                const imagePerthDateStr = imgData.timestamp ? getPerthDateString(new Date(imgData.timestamp)) : '';
                const isHistorical = imagePerthDateStr !== perthTodayStr;
                if (isHistorical) hasHistorical = true;
                return createImageHtml(id, isHistorical ? 'historical-entry' : '', isHistorical ? 'style="display: none;"' : '');
            }).join('');

            paginationControls.style.display = 'none';
            showAllButton.style.display = hasHistorical ? 'block' : 'none';
        }
    } else {
        // Standard Library (not setups) - Just show all
        imagesHtml = allImageIds.map(id => createImageHtml(id)).join('');
    }

    containerElement.innerHTML = imagesHtml;
    adjustCollapsibleSize(containerElement);
}


        function handleAttachmentActions(e) {
            const attachBtn = e.target.closest('.attach-image-btn'); if (attachBtn) { handleAttachAttachmentClick(attachBtn.dataset.id, attachBtn.dataset.type); return true; }
            const delImgBtn = e.target.closest('.delete-trade-image'); if (delImgBtn) { const { entryId, entryType, imageId, filename } = delImgBtn.dataset; handleDeleteAttachmentImage(entryId, entryType, imageId, filename); return true; }
            const img = e.target.closest('.trade-image-thumbnails img'); if (img) { handleGenericImageLibraryClick(e); return true; }
            return false;
        }

        function handleAttachAttachmentClick(entryId, entryType) {
            if (!STATE.isMasterUser) return;
            STATE.imageUploadContext = { id: entryId, type: entryType };
            DOM.tradeImageUploader.value = null; DOM.tradeImageUploader.click();
        }

        function handleAttachmentImageUpload(files) {
            if (!STATE.isMasterUser || !files || files.length === 0) return;
            const { id, type } = STATE.imageUploadContext; if (!id || !type) return;
            let dbRefPath, storagePathPrefix;
            switch (type) {
                case 'live': dbRefPath = CONFIG.DB_PATHS.TRADES; storagePathPrefix = `trade_attachments/${id}/`; break;
                case 'completed': dbRefPath = CONFIG.DB_PATHS.COMPLETED_TRADES; storagePathPrefix = `trade_attachments/${id}/`; break;
                default: return;
            }
            const entryDbRef = database.ref(dbRefPath).child(id);
            Array.from(files).forEach((file) => {
                if (!file.type.startsWith('image/')) return;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `${storagePathPrefix}${fileName}`;
                const uploadTask = storage.ref(storagePath).put(file);
                uploadTask.on('state_changed', null, (e) => { alert(`Upload failed for ${file.name}.`); }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        entryDbRef.child('attachedImages').push({ url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP });
                    });
                });
            });
        }

        function handleDeleteAttachmentImage(entryId, entryType, imageId, fileName) {
            if (!STATE.isMasterUser || !entryId || !entryType || !imageId || !fileName) return;
            if (confirm(`Delete this attachment?\n\n${fileName}`)) {
                let dbRefPath, storagePathPrefix;
                switch (entryType) {
                    case 'live': dbRefPath = CONFIG.DB_PATHS.TRADES; storagePathPrefix = `trade_attachments/${entryId}/`; break;
                    case 'completed': dbRefPath = CONFIG.DB_PATHS.COMPLETED_TRADES; storagePathPrefix = `trade_attachments/${entryId}/`; break;
                    default: return;
                }
                const storagePath = `${storagePathPrefix}${fileName}`;
                const imageDbRef = database.ref(dbRefPath).child(entryId).child('attachedImages').child(imageId);
                storage.ref(storagePath).delete().then(() => imageDbRef.remove()).catch((err) => {
                    if (err.code === 'storage/object-not-found') imageDbRef.remove(); else alert('Error deleting attachment.');
                });
            }
        }

        function handleImageDelete(e) {
            const button = e.target.closest('.delete-journal-image'); if (!STATE.isMasterUser || !button) return;
            if (DOM.imageModal.style.display === 'flex' && DOM.modalImageContent.src === button.closest('.journal-image-wrapper').querySelector('img').src) closeModal();
            const { safeSymbol, timeframe, id, filename } = button.dataset;
            if (confirm(`Delete this image?\n\n${filename}`)) {
                const storagePath = `journal_images/${safeSymbol}/${timeframe}/${filename}`;
                const dbPath = `${CONFIG.DB_PATHS.JOURNAL_IMAGES}/${safeSymbol}/${timeframe}/${id}`;
                storage.ref(storagePath).delete().then(() => database.ref(dbPath).remove()).catch((err) => { if (err.code === 'storage/object-not-found') database.ref(dbPath).remove(); });
            }
        }

        function handleFavouriteClick() {
            if (!STATE.isMasterUser) return;
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value), timeframe = DOM.journalTimeframeEl.value;
            const currentText = DOM.journalEntryEl.value.trim();
            const dbFavouriteRef = dbRefs.favourites.child(safeSymbol).child(timeframe);
            if (DOM.favouriteBtn.classList.contains('active')) dbFavouriteRef.remove();
            else { if (!currentText) return alert('Cannot pin an empty note.'); dbFavouriteRef.set(currentText); }
        }

        function resetMergeState() {
            STATE.isMerging = false; STATE.mergeBaseTradeId = null;
            document.body.classList.remove('in-merge-mode');
            document.querySelectorAll('#completed-trades-tbody tr.is-merge-base').forEach(row => row.classList.remove('is-merge-base'));
        }

        function initiateMerge(baseTradeId) {
            if (STATE.isMerging && STATE.mergeBaseTradeId === baseTradeId) { resetMergeState(); alert('Merge cancelled.'); return; }
            resetMergeState(); STATE.isMerging = true; STATE.mergeBaseTradeId = baseTradeId;
            document.body.classList.add('in-merge-mode');
            const baseRow = document.querySelector(`#completed-trades-tbody button[data-id='${baseTradeId}']`).closest('tr');
            if (baseRow) baseRow.classList.add('is-merge-base');
            alert('MERGE MODE: Click another trade to merge into this one. Click "Merge" again to cancel.');
        }

        function executeMerge(baseTradeId, absorbedTradeId) {
            if (!baseTradeId || !absorbedTradeId || baseTradeId === absorbedTradeId) { resetMergeState(); return; }
            
            const completedTradesRef = dbRefs.completedTrades;
            completedTradesRef.once('value', snapshot => {
                const allTrades = snapshot.val();
                const baseTrade = allTrades[baseTradeId];
                const absorbedTrade = allTrades[absorbedTradeId];

                if (!baseTrade || !absorbedTrade) { alert('Error: Could not find one of the trades.'); resetMergeState(); return; }
                if (baseTrade.symbol !== absorbedTrade.symbol || baseTrade.type !== absorbedTrade.type) { alert('Error: Cannot merge trades with different symbols or types.'); resetMergeState(); return; }

                // 1. Calculate Quantities (Coins) based on USD Size and Entry Price
                const baseSize = parseFloat(baseTrade.size); // USD Value
                const baseEntry = parseFloat(baseTrade.entry);
                const baseQty = baseSize / baseEntry;

                const absorbedSize = parseFloat(absorbedTrade.size); // USD Value
                const absorbedEntry = parseFloat(absorbedTrade.entry);
                const absorbedQty = absorbedSize / absorbedEntry;

                // 2. Calculate Totals
                const totalQty = baseQty + absorbedQty;
                const totalSize = baseSize + absorbedSize; // New Total Position Value ($)

                // 3. Calculate Weighted Average Entry
                const mergedEntry = totalSize / totalQty;

                // 4. Calculate Weighted Average Exit Price
                const baseExitPrice = parseFloat(baseTrade.exit_price);
                const absorbedExitPrice = parseFloat(absorbedTrade.exit_price);
                
                // Value returned to wallet upon exit (approximate before fees)
                const baseExitValue = baseQty * baseExitPrice;
                const absorbedExitValue = absorbedQty * absorbedExitPrice;
                
                const mergedExitPrice = (baseExitValue + absorbedExitValue) / totalQty;

                // 5. Merge Arrays and Notes
                const mergedEntryPrices = [...(baseTrade.entry_prices || [baseTrade.entry]), ...(absorbedTrade.entry_prices || [absorbedTrade.entry])];
                const mergedNote = `${baseTrade.note || ''}\n--- MERGED ---\n${absorbedTrade.note || ''}`.trim();

                // 6. Create the Merged Object
                const mergedTrade = {
                    ...baseTrade, 
                    entry: mergedEntry, 
                    size: totalSize, 
                    exit_price: mergedExitPrice, 
                    entry_prices: mergedEntryPrices,
                    // Sum up the financial results
                    net_result: (parseFloat(baseTrade.net_result) || 0) + (parseFloat(absorbedTrade.net_result) || 0),
                    entry_fee: (parseFloat(baseTrade.entry_fee) || 0) + (parseFloat(absorbedTrade.entry_fee) || 0),
                    exit_fee: (parseFloat(baseTrade.exit_fee) || 0) + (parseFloat(absorbedTrade.exit_fee) || 0),
                    // Dates: Opened = Earliest, Closed = Latest
                    date: Math.min(new Date(baseTrade.date).getTime(), new Date(absorbedTrade.date).getTime()),
                    closed_date: Math.max(new Date(baseTrade.closed_date).getTime(), new Date(absorbedTrade.closed_date).getTime()),
                    note: mergedNote,
                };

                // Recalculate metrics (RR, projected profit/loss) based on new averages
                const newMetrics = calculateTradeMetrics(mergedTrade);
                Object.assign(mergedTrade, newMetrics);

                // 7. Atomic Update: Set Base to New, Delete Absorbed
                const updates = { [baseTradeId]: mergedTrade, [absorbedTradeId]: null };
                
                completedTradesRef.update(updates).then(() => { 
                    alert('Trades merged successfully!'); 
                    resetMergeState(); 
                }).catch(e => { 
                    alert(`Error merging trades: ${e.message}`); 
                    resetMergeState(); 
                });
            });
        }

      function subscribeToData() {
            // Live Trades Listener
            dbRefs.trades.on('value', s => { 
                const trades = s.val() || {}; 
                renderLiveTable(trades); 
                DOM.statOpenTrades.textContent = Object.keys(trades).length; 
            });

            // Resting Orders Listener (NEW)
            dbRefs.restingOrders.on('value', s => {
                const orders = s.val() || {};
                renderRestingTable(orders);
            });
dbRefs.dailyNotes.on('value', (s) => {
        STATE.dailyNotes = s.val() || {};
        // Re-render table if data changes (optional, but good for sync)
        if (Object.keys(STATE.allCompletedTrades).length > 0) {
            renderCompletedTable(STATE.allCompletedTrades);
        }
    });

            // Completed Trades Listener
            dbRefs.completedTrades.on('value', s => {
                STATE.allCompletedTrades = s.val() || {};
                const completedData = STATE.allCompletedTrades;
                renderCompletedTable(completedData);

                // Stats calculation
                const resetDateStr = CONFIG.TRADE_SETTINGS.STATS_RESET_DATE;
                const resetTimestamp = resetDateStr ? new Date(resetDateStr).getTime() : 0;

                let wins = 0, losses = 0, grossProfit = 0, grossLoss = 0;

                Object.values(completedData).forEach(trade => {
                    const tradeTimestamp = trade.closed_date ? new Date(trade.closed_date).getTime() : 0;

                    if (tradeTimestamp >= resetTimestamp) {
                        const netResult = trade.net_result || 0;
                        if (netResult > 0) {
                            wins++;
                            grossProfit += netResult;
                        } else {
                            losses++;
                            grossLoss += Math.abs(netResult);
                        }
                    }
                });

                const totalCompleted = wins + losses;
                const winRate = totalCompleted > 0 ? (wins / totalCompleted) * 100 : 0;
                const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : 0;
                const avgWin = wins > 0 ? grossProfit / wins : 0;
                const avgLoss = losses > 0 ? grossLoss / losses : 0;
                const rewardRisk = avgLoss > 0 ? avgWin / avgLoss : 0;
                const totalPL = grossProfit - grossLoss;
                const newBalance = CONFIG.TRADE_SETTINGS.STARTING_BALANCE + totalPL;

                // 1. Update Balance
                DOM.statBalance.textContent = formatCurrency(newBalance);
                DOM.statBalanceAud.textContent = formatCurrency(newBalance * STATE.usdToAudRate, 'A$');

                // 2. Update Total P/L (2 Decimals)
                DOM.statTotalPl.textContent = `${totalPL >= 0 ? '+' : ''}$${totalPL.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                DOM.statTotalPlAud.textContent = `${totalPL >= 0 ? '+' : ''}A$${(totalPL * STATE.usdToAudRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // 3. Update Counts
                DOM.statCompletedTrades.textContent = totalCompleted;
                DOM.statWins.textContent = wins;
                DOM.statLosses.textContent = losses;

                // 4. Update Ratios and Averages
                DOM.statWinRate.textContent = `${winRate.toFixed(1)}%`;
                DOM.statProfitFactor.textContent = profitFactor > 0 ? profitFactor.toFixed(2) : (wins > 0 ? 'âˆž' : 'N/A');
                DOM.statAvgWin.textContent = formatCurrency(avgWin);
                DOM.statAvgLoss.textContent = formatCurrency(avgLoss);
                DOM.statRewardRisk.textContent = rewardRisk > 0 ? `${rewardRisk.toFixed(2)} : 1` : 'N/A';

                dbRefs.bank.set({ currentBalance: newBalance });
            });

           // Listener 1: Text Updates (Pass 'true' to skip rendering images)
// Listener 1: Text Updates (Pass 'true' to skip rendering images)
dbRefs.journalText.on('value', (s) => { 
    STATE.journalText = s.val() || {}; 
    
    // Check if the Journal Tab is active AND if the user is NOT currently typing
    if (DOM.journalTab.classList.contains('active')) {
        // If the user is currently typing in the journal entry, DO NOT update the view.
        // The user already has the latest text (they are typing it), so we don't need to re-render.
        if (document.activeElement === DOM.journalEntryEl) {
            return;
        }
        
        // FIX: Pass true to stop the image section from rebuilding and causing jumps
        updateJournalView(true); 
    }
});
// Listener 2: Image Updates (Pass 'false' or nothing to render images)
dbRefs.journalImages.on('value', (s) => { 
    STATE.journalImages = s.val() || {}; 
    if (DOM.journalTab.classList.contains('active')) {
        // Images changed, so we DO want to render images
        updateJournalView(false); 
    }
});
            dbRefs.setupsImages.on('value', (s) => {
                STATE.allSetupsImages = s.val() || {};
                renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images');
            });
            dbRefs.favourites.on('value', (s) => { STATE.favouriteEntries = s.val() || {}; if (DOM.journalTab.classList.contains('active')) updateJournalView(); });
            dbRefs.setups1.on('value', (s) => { STATE.setupsData1 = s.val() || {}; renderSetupsTable(null, STATE.setupsData1, 'primary-setups-notes'); });
            dbRefs.setups2.on('value', (s) => { STATE.setupsData2 = s.val() || {}; renderSetupsTable(null, STATE.setupsData2, 'secondary-setups-notes'); });
            dbRefs.generalNotes.on('value', (s) => { STATE.generalNotes = s.val() || {}; if (DOM.noteEditModal.style.display === 'none') { renderNotes(STATE.generalNotes); } });
        }

        function openCollapsibleSection(sectionElement) {
            if (!sectionElement || sectionElement.classList.contains('is-open')) return;
            const content = sectionElement.querySelector('.collapsible-content');
            const toggleBtn = sectionElement.querySelector('.collapsible-toggle-btn');
            if (content && toggleBtn) {
                sectionElement.classList.add('is-open'); 
                toggleBtn.textContent = 'âˆ’'; 
                toggleBtn.style.transform = 'rotate(180deg)';
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }, 50);
            }
        }

        function openDefaultSectionsInContainer(containerElement) {
            if (!containerElement) return;
            const sectionsToOpen = ['Resting Limit Orders', 'Live Trades', 'Completed Trades', 'Setups', 'Trading Setups', 'Add New Trade', 'Notes', 'My Notes', 'Charts', 'Misc', 'EMA Snapshot', 'PnL Calendar'];
            containerElement.querySelectorAll('.collapsible-header h2').forEach(h2 => {
                const title = h2.textContent.trim();
                if (sectionsToOpen.includes(title)) {
                    const section = h2.closest('.collapsible-section');
                    if (section && !(section.classList.contains('master-only') && !STATE.isMasterUser)) {
                        openCollapsibleSection(section);
                    }
                }
            });
        }

   function checkMasterMode() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('master') === 'true') {
        // Simple password check
        const password = prompt("Please enter master password:");
        if (password) {
            STATE.isMasterUser = true;
            STATE.masterPassword = password;
            
            // --- THE FIX: Add class to body ---
            document.body.classList.add('is-master');
            
            // Enable Inputs
            DOM.journalEntryEl.readOnly = false;
            document.querySelectorAll('.setups-table .editable-setup-cell')
                .forEach(cell => cell.setAttribute('contenteditable', 'true'));
            DOM.primarySetupsNotes.readOnly = false; 
            DOM.secondarySetupsNotes.readOnly = false;
        }
    }
    
    if (!STATE.isMasterUser) {
        document.body.classList.remove('is-master');
        DOM.journalEntryEl.readOnly = true;
        DOM.primarySetupsNotes.readOnly = true; 
        DOM.secondarySetupsNotes.readOnly = true;
    }
}
// 1. Helper to open a specific section
function openCollapsibleSection(sectionElement) {
    if (!sectionElement || sectionElement.classList.contains('is-open')) return;
    
    const content = sectionElement.querySelector('.collapsible-content');
    const toggleBtn = sectionElement.querySelector('.collapsible-toggle-btn');
    
    if (content && toggleBtn) {
        sectionElement.classList.add('is-open'); 
        toggleBtn.textContent = 'âˆ’'; 
        toggleBtn.style.transform = 'rotate(180deg)';
        
        // Slight delay to ensure DOM render before calculating height
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        }, 50);
    }
}

// 2. Logic to find and open the default sections
function openDefaultSectionsInContainer(containerElement) {
    if (!containerElement) return;
    
    // Exact text of the <h2> titles you want open by default
    const sectionsToOpen = [
        'Add New Trade',
        'Resting Limit Orders', 
        'Live Trades', 
        'Completed Trades', 
        'Trading Setups', 
        'Setups',
        'My Notes'
    ];
    
    containerElement.querySelectorAll('.collapsible-header h2').forEach(h2 => {
        const title = h2.textContent.trim();
        if (sectionsToOpen.includes(title)) {
            const section = h2.closest('.collapsible-section');
            
            // Open it, unless it's a hidden master-only section
            if (section && !(section.classList.contains('master-only') && !STATE.isMasterUser)) {
                openCollapsibleSection(section);
            }
        }
    });
}

// 3. The Init Function (Make sure this calls the open function at the end)
async function initializeApp() {
            checkMasterMode(); 
            getViewerId();
            await fetchLiveConversionRate();

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) { 
                document.documentElement.setAttribute('data-theme', savedTheme); 
                DOM.themeToggle.checked = savedTheme === 'dark'; 
            }
            
            const today = new Date(); 
            today.setUTCHours(0, 0, 0, 0);
            STATE.selectedDate = new Date(today); 
            STATE.centerDate = new Date(today);
            
            setupEventListeners(); 
            subscribeToData();
            renderDateNavigation(); 
            checkMarketAlerts(); 

            // Allow 500ms for data to fetch from Firebase before opening sections
            setTimeout(() => {
                const activeTabContent = document.querySelector('.tab-content.active');
                if (activeTabContent) {
                    openDefaultSectionsInContainer(activeTabContent);
                    activeTabContent.dataset.sectionsInitialized = 'true';
                }
            }, 500);
        }

        initializeApp();
    }); // This closes the DOMContentLoaded listener
</script>
    </body>
    </html>
