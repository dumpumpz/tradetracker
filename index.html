<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<style>
    :root {
        --bg-color: #f4f7f6;
        --container-bg: #fff;
        --text-color: #333;
        --border-color: #ddd;
        --header-bg: #e9ecef;
        --link-color: #007bff;
        --subtle-text: #666;
        --card-bg: #fafafa;
        --shadow-color: rgba(0,0,0,0.1);
        --green-bg: #d4edda;
        --red-bg: #f8d7da;
        --purple-bg: #e2d9f3;
        --green-border: #c3e6cb;
        --red-border: #f5c6cb;
        --green-text: #155724;
        --red-text: #721c24;
        --green-bar: rgba(40, 167, 69, 0.2);
        --red-bar: rgba(220, 53, 69, 0.2);
    }

    [data-theme="dark"] {
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --border-color: #444;
        --header-bg: #2c2c2c;
        --link-color: #58a6ff;
        --subtle-text: #888;
        --card-bg: #2a2a2a;
        --shadow-color: rgba(0,0,0,0.4);
        --green-bg: #1c3b23;
        --red-bg: #4d1f24;
        --purple-bg: #3c2a4d;
        --green-border: #285732;
        --red-border: #6b282e;
        --green-text: #a7d7b2;
        --red-text: #f5b7bd;
        --green-bar: rgba(40, 167, 69, 0.4);
        --red-bar: rgba(220, 53, 69, 0.4);
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        margin: 0; 
        padding: 10px; 
        background-color: var(--bg-color); 
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    .container { max-width: 1400px; margin: auto; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
    h1 { text-align: center; color: var(--text-color); margin-bottom: 5px; }
    h2 { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
    h3 { text-align: center; color: var(--text-color); margin-top: 30px; margin-bottom: -5px; font-weight: 500;}
    .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
    .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
    .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .master-only { display: none; }
    #add-trade-form { margin: 0 auto; padding: 0; border: none; border-radius: 0; background-color: transparent; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
    label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
    input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
    button:hover { opacity: 0.85; }
    .table-wrapper { width: 100%; overflow-x: auto; overflow-y: hidden; padding-bottom: 5px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
    th { background-color: var(--header-bg); font-weight: bold; vertical-align: middle; text-align: center; }
    .action-buttons button { padding: 3px 4px; font-size: 10px; margin-right: 4px; }
    .note-cell { white-space: normal; max-width: 300px; min-width: 250px; font-size: 12px; line-height: 1.4; }

    /* MATRIX STYLES (STACKED) */
    .matrix-wrapper {
        display: flex;
        flex-direction: column; /* Stack vertically */
        gap: 20px;
        margin-bottom: 25px;
        width: 100%;
    }
    .matrix-card {
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 5px var(--shadow-color);
    }
    .matrix-header {
        background: var(--header-bg);
        padding: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
        border-bottom: 1px solid var(--border-color);
        color: var(--link-color);
        letter-spacing: 1px;
        text-transform: uppercase;
    }
    .matrix-table { width: 100%; border-collapse: collapse; margin: 0; }
    .matrix-table th { padding: 6px; font-size: 12px; border: 1px solid var(--border-color); background-color: var(--bg-color); text-align: center; }
    .matrix-table td { padding: 0; border: 1px solid var(--border-color); vertical-align: top; }
    .matrix-label {
        padding: 10px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
        background-color: var(--bg-color);
        vertical-align: middle;
        text-align: center;
        width: 1px; 
    }
    .matrix-textarea {
        width: 100%;
        min-height: 50px; /* Bigger input area */
        border: none;
        resize: vertical;
        padding: 8px;
        font-family: inherit;
        font-size: 13px;
        background: transparent;
        color: var(--text-color);
        display: block;
        box-sizing: border-box;
        overflow: hidden;
        line-height: 1.4;
    }
    .matrix-textarea:focus { background: var(--container-bg); outline: 2px solid var(--link-color); }
    .matrix-textarea:read-only { cursor: default; color: var(--subtle-text); }

    /* Stats Panel */
    #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
    #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
    #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s; pointer-events: none; }
    #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
    .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
    .stat-value { font-size: 16px; font-weight: 600; color: var(--text-color); }

    /* Collapsible */
    .collapsible-section { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; background-color: var(--card-bg); overflow: hidden; }
    .collapsible-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; cursor: pointer; background-color: var(--header-bg); transition: background-color 0.2s ease; }
    .collapsible-header h2 { margin: 0; font-size: 1.1em; font-weight: 600; }
    .collapsible-toggle-btn { background: none; border: 1px solid var(--border-color); color: var(--subtle-text); width: 28px; height: 28px; border-radius: 50%; font-size: 22px; font-weight: bold; margin: 0; text-align: center; }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
    .collapsible-content-inner { padding: 20px; border-top: 1px solid var(--border-color); }

    /* Setups Table Specifics */
    .setups-table th:first-child { text-align: left; padding-left: 15px; color: var(--link-color); }
    .setups-table td { text-align: center; }
    .setups-table .editable-setup-cell[contenteditable="true"]:focus { background-color: var(--header-bg); outline: 2px solid var(--link-color); }
    .setups-table td.highlight-long { background-color: var(--green-bg); color: var(--green-text); font-weight: bold; }
    .setups-table td.highlight-short { background-color: var(--red-bg); color: var(--red-text); font-weight: bold; }
    .setups-table .percent-cell { font-size: 11px; color: var(--subtle-text); text-align: right; font-style: italic; }

    /* Scrollbars */
    .table-wrapper::-webkit-scrollbar { height: 16px !important; width: 16px !important; }
    .table-wrapper::-webkit-scrollbar-track { background-color: #333333 !important; border-top: 1px solid #555 !important; }
    .table-wrapper::-webkit-scrollbar-thumb { background-color: #c0c0c0 !important; border-radius: 10px !important; border: 4px solid #333333 !important; min-height: 50px !important; }
    
    /* Other Utilities */
    .date-nav-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px auto 20px auto; }
    .date-nav-btn { padding: 8px 12px; background-color: var(--card-bg); border: 1px solid var(--border-color); cursor: pointer; }
    .date-nav-btn.active { background-color: var(--link-color); color: white; border-color: var(--link-color); font-weight: bold; }
    .date-nav-btn.has-entry { border-bottom: 3px solid var(--green-border); }
    .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 20px; z-index: 10; }
    .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
    .theme-switch input { display: none; }
    .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
    .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
    input:checked + .slider { background-color: var(--link-color); }
    input:checked + .slider:before { transform: translateX(26px); }
    .slider.round { border-radius: 34px; }
    
    /* Image Library */
    #image-library-container, #setups-image-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
    .library-image-wrapper { position: relative; border: 1px solid var(--border-color); padding: 5px; background: var(--container-bg); border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; }
    .library-image-wrapper img { width: 100%; object-fit: contain; aspect-ratio: 16 / 9; cursor: pointer; }
    .library-image-caption { font-size: 12px; padding: 4px; text-align: center; }
</style>
<body>
    <div class="container">
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">×</button></div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">AUD Value</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L (AUD)</span><span id="stat-total-pl-aud" class="stat-value">A$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7-14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
        </div>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal & Setups</button>
            <button class="tab-link" data-tab="notes">Notes</button>
        </div>

        <!-- TRACKER TAB -->
        <div id="tracker-tab" class="tab-content active">
            
            <div class="collapsible-section master-only">
                <div class="collapsible-header"><h2>Add New Trade</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <form id="add-trade-form">
                            <div><label>Setup Class:</label><select id="trade-setup-type"><option value="Major">Major Swing</option><option value="Scalp">Fast/Scalp</option><option value="Intraday">Intraday</option></select></div>
                            <div><label>Symbol:</label><input type="text" id="trade-symbol" list="symbol-list" placeholder="Symbol"></div>
                            <div><label>Exchange:</label><select id="trade-exchange"><option value="binance">Binance</option><option value="hyperliquid">Hyperliquid</option></select></div>
                            <div><label>Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                            <div><label>Status:</label><select id="trade-status"><option value="live">Live</option><option value="resting">Resting</option></select></div>
                            <div><label>Entry:</label><input type="number" id="entry-price" step="any"></div>
                            <div><label>Stop:</label><input type="number" id="stop-loss" step="any"></div>
                            <div><label>Target:</label><input type="number" id="target" step="any"></div>
                            <div><label>Size ($):</label><input type="number" id="position-value" step="any"></div>
                            <div><label>Fee:</label><select id="entry-fee-type"><option value="taker">Taker</option><option value="maker">Maker</option></select></div>
                            <div><button type="submit">Add</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- OTE Calculator -->
            <div class="collapsible-section master-only">
                <div class="collapsible-header"><h2>Add Fib Setup (OTE)</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="calculator-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; align-items:end;">
                            <div><label>Symbol:</label><input type="text" id="fib-symbol" list="symbol-list"></div>
                            <div><label>Direction:</label><select id="fib-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                            <div><label>Setup:</label><select id="fib-setup-type"><option value="Major">Major</option><option value="Scalp">Scalp</option><option value="Intraday">Intraday</option></select></div>
                            <div><label>High:</label><input type="number" id="fib-high" step="any"></div>
                            <div><label>Low:</label><input type="number" id="fib-low" step="any"></div>
                            <div><label>Stop:</label><input type="number" id="fib-stop" step="any"></div>
                            <div><label>Target:</label><input type="number" id="fib-target" step="any"></div>
                            <div><label>Risk ($):</label><input type="number" id="fib-risk"></div>
                            <div><label>Exchange:</label><select id="fib-exchange"><option value="binance">Binance</option><option value="hyperliquid">Hyperliquid</option></select></div>
                            <div><label>Fee:</label><select id="fib-fee-type"><option value="maker">Maker</option><option value="taker">Taker</option></select></div>
                            <div><label>Add To:</label><select id="fib-status"><option value="resting">Resting</option><option value="live">Live</option></select></div>
                            <div><button type="button" id="calc-fib-btn" style="background-color: var(--purple-bg); color: var(--text-color); border: 1px solid var(--border-color); width: 100%;">Calculate</button></div>
                        </div>
                        <div id="fib-results-container" style="margin-top:20px; display:none;">
                            <div class="table-wrapper"><table class="sr-table"><thead><tr><th>Fib</th><th>Entry</th><th>Stop</th><th>Risk</th><th>Coins</th><th>Size</th><th>Risk%</th><th>PnL</th><th>Act</th></tr></thead><tbody id="fib-results-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resting Orders -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Resting Limit Orders</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="resting-trades-summary-container" class="ema-summary-container" style="display:none; margin-bottom: 20px;"></div>
                        <div class="table-wrapper"><table><thead><tr><th>Sym</th><th>Type</th><th>Entry</th><th>Stop</th><th>Tgt</th><th>Size</th><th>Fee</th><th>Pro(T)</th><th>Pro(M)</th><th>Loss(T)</th><th>Loss(M)</th><th>RR(T)</th><th>RR(M)</th><th>Date</th><th>Note</th><th class="master-only">Act</th></tr></thead><tbody id="resting-trades-tbody"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Live Trades -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Live Trades</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="live-trades-summary-container" class="ema-summary-container" style="display:none; margin-bottom: 20px;"></div>
                        <div class="table-wrapper"><table><thead><tr><th>Sym</th><th>Type</th><th>Avg.Entry</th><th>Entries</th><th>Stop</th><th>Tgt</th><th>BE</th><th>Size</th><th>Fee</th><th>Pro(T)</th><th>Pro(M)</th><th>Loss(T)</th><th>Loss(M)</th><th>RR(T)</th><th>RR(M)</th><th>Date</th><th>Note</th><th>Chart</th><th class="master-only">Act</th></tr></thead><tbody id="trades-tbody"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Combined Trading Setups (Original Textareas) -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Trading Setups</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <!-- Essential Tables Required by JS (Restored to prevent crash) -->
                        <div class="table-wrapper" style="margin-bottom:20px;">
                            <table class="setups-table" id="primary-setups-table">
                                <thead><tr><th>Primary Setup</th><th>0</th><th>%</th><th>Stop</th><th>%</th><th>0.5</th><th>Tgt</th><th>%</th><th>Stop</th><th>%</th><th>0.618</th><th>Tgt</th><th>%</th><th>Stop</th><th>%</th></tr></thead>
                                <tbody>
                                    <tr><td>15m</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><td>1h</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><td>4h</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><td>Daily</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                </tbody>
                            </table>
                            <p id="save-setups-1" class="setups-save-status"></p>
                            <textarea id="primary-setups-notes" class="setups-notes-area" placeholder="Primary Notes..."></textarea>
                        </div>

                        <div class="table-wrapper">
                            <table class="setups-table" id="secondary-setups-table">
                                <thead><tr><th>Secondary Setup</th><th>0</th><th>%</th><th>Stop</th><th>%</th><th>0.5</th><th>Tgt</th><th>%</th><th>Stop</th><th>%</th><th>0.618</th><th>Tgt</th><th>%</th><th>Stop</th><th>%</th></tr></thead>
                                <tbody>
                                    <tr><td>15m</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><td>1h</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><td>4h</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><td>Daily</td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                </tbody>
                            </table>
                            <p id="save-setups-2" class="setups-save-status"></p>
                            <textarea id="secondary-setups-notes" class="setups-notes-area" placeholder="Secondary Notes..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setups Images -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Setups Images</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="setups-image-library-section">
                            <div id="setups-upload-section" class="master-only" style="text-align:center; margin-bottom:20px;">
                                <label for="setups-image-upload" class="image-upload-label">Add Setup Image</label>
                                <input type="file" id="setups-image-upload" accept="image/*" multiple style="display:none;">
                                <div id="setups-upload-progress" style="margin-top:10px; font-style:italic; color:var(--link-color);"></div>
                            </div>
                            <div id="setups-image-container"></div>
                            <button id="toggle-all-setups-images" class="toggle-history-btn">Show All</button>
                            <div id="setups-images-pagination-controls" class="pagination-controls" style="display:none;">
                                <button id="setups-images-prev-page" class="pagination-btn">&lt; Prev</button>
                                <span id="setups-images-page-info"></span>
                                <button id="setups-images-next-page" class="pagination-btn">Next &gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Trades -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Completed Trades</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper"><table><thead><tr><th>Sym</th><th>Type</th><th>Entry</th><th>Ent</th><th>Stop</th><th>Tgt</th><th>Size</th><th>Pro(T)</th><th>Pro(M)</th><th>Loss(T)</th><th>Loss(M)</th><th>RR(T)</th><th>RR(M)</th><th>Exit</th><th>Fee</th><th>Net</th><th>Open</th><th>Close</th><th>N1</th><th>N2</th><th>N3</th><th>Ch</th><th class="master-only">Act</th></tr></thead><tbody id="completed-trades-tbody"></tbody></table></div>
                        <button id="toggle-all-completed-trades" class="toggle-history-btn">Show All</button>
                        <div id="completed-trades-pagination-controls" class="pagination-controls" style="display:none;"><button id="completed-trades-prev-page" class="pagination-btn">&lt; Prev</button><span id="completed-trades-page-info"></span><button id="completed-trades-next-page" class="pagination-btn">Next &gt;</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JOURNAL TAB -->
        <div id="journal-tab" class="tab-content">
            <div class="controls-container" id="journal-controls">
                <div><label>Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label>TF:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                <div><label>Filter:</label><select id="journal-image-filter"><option value="all">All</option><option value="today">Today</option></select></div>
            </div>
            <div class="date-nav-container">
                <button id="date-prev" class="date-nav-arrow"><</button>
                <div id="date-buttons-container"></div>
                <button id="date-next" class="date-nav-arrow">></button>
            </div>

            <!-- STACKED MATRIX SECTION -->
            <div id="journal-matrix-container" class="matrix-wrapper">
                
                <!-- ICT Killzones Table -->
                <div class="matrix-card">
                    <div class="matrix-header">ICT Killzones</div>
                    <table class="matrix-table" data-matrix-id="killzones">
                        <thead><tr><th>Zone</th><th>Longs</th><th>Shorts</th></tr></thead>
                        <tbody>
                            <tr><td class="matrix-label">Pre Asia</td><td><textarea class="matrix-textarea" data-row="pre_asia" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="pre_asia" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Asia</td><td><textarea class="matrix-textarea" data-row="asia" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="asia" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Pre London</td><td><textarea class="matrix-textarea" data-row="pre_london" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="pre_london" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">London</td><td><textarea class="matrix-textarea" data-row="london" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="london" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Pre NY AM</td><td><textarea class="matrix-textarea" data-row="pre_ny_am" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="pre_ny_am" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">NY AM</td><td><textarea class="matrix-textarea" data-row="ny_am" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="ny_am" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Pre NY Lunch</td><td><textarea class="matrix-textarea" data-row="pre_ny_lunch" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="pre_ny_lunch" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">NY Lunch</td><td><textarea class="matrix-textarea" data-row="ny_lunch" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="ny_lunch" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Pre NY PM</td><td><textarea class="matrix-textarea" data-row="pre_ny_pm" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="pre_ny_pm" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">NY PM</td><td><textarea class="matrix-textarea" data-row="ny_pm" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="ny_pm" data-col="shorts"></textarea></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- High Timeframe -->
                <div class="matrix-card">
                    <div class="matrix-header">High Timeframe</div>
                    <table class="matrix-table" data-matrix-id="htf">
                        <thead><tr><th>TF</th><th>Longs</th><th>Shorts</th></tr></thead>
                        <tbody>
                            <tr><td class="matrix-label">Monthly</td><td><textarea class="matrix-textarea" data-row="monthly" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="monthly" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Weekly</td><td><textarea class="matrix-textarea" data-row="weekly" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="weekly" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">Daily</td><td><textarea class="matrix-textarea" data-row="daily" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="daily" data-col="shorts"></textarea></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Intraday -->
                <div class="matrix-card">
                    <div class="matrix-header">Intraday</div>
                    <table class="matrix-table" data-matrix-id="intraday">
                        <thead><tr><th>TF</th><th>Longs</th><th>Shorts</th></tr></thead>
                        <tbody>
                            <tr><td class="matrix-label">4 Hour</td><td><textarea class="matrix-textarea" data-row="4hour" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="4hour" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">2 Hour</td><td><textarea class="matrix-textarea" data-row="2hour" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="2hour" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">1 Hour</td><td><textarea class="matrix-textarea" data-row="1hour" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="1hour" data-col="shorts"></textarea></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Entry -->
                <div class="matrix-card">
                    <div class="matrix-header">Entry</div>
                    <table class="matrix-table" data-matrix-id="entry">
                        <thead><tr><th>TF</th><th>Longs</th><th>Shorts</th></tr></thead>
                        <tbody>
                            <tr><td class="matrix-label">30 Min</td><td><textarea class="matrix-textarea" data-row="30min" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="30min" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">15 Min</td><td><textarea class="matrix-textarea" data-row="15min" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="15min" data-col="shorts"></textarea></td></tr>
                            <tr><td class="matrix-label">5 Min</td><td><textarea class="matrix-textarea" data-row="5min" data-col="longs"></textarea></td><td><textarea class="matrix-textarea" data-row="5min" data-col="shorts"></textarea></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="favourited-entry-container" style="display:none;">
                <div class="favourited-header"><span class="star-icon">⭐</span><span>Pinned Note</span></div>
                <div id="favourited-entry-text"></div>
            </div>

            <div class="journal-input-wrapper">
                 <button id="favourite-btn" class="master-only">⭐</button>
                 <textarea id="journal-entry" placeholder=""></textarea>
            </div>
            <p id="save-status"></p>

            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture</label>
                <input type="file" id="journal-image-upload" accept="image/*" multiple>
                <div id="upload-progress"></div>
            </div>
            <div id="journal-images-container"></div>
        </div>

        <div id="notes-tab" class="tab-content">
            <div class="collapsible-section">
                 <div class="collapsible-header"><h2>My Notes</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="notes-controls" class="master-only" style="text-align: right; margin-bottom: 20px;">
                            <button id="create-new-note-btn">Create New Note</button>
                        </div>
                        <div id="notes-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="image-modal" class="modal-overlay" style="display:none;">
        <span class="modal-close">&times;</span>
        <button id="modal-prev" class="modal-nav">&lt;</button>
        <img class="modal-content" id="modal-image-content">
        <button id="modal-next" class="modal-nav">&gt;</button>
        <div id="modal-caption"></div>
    </div>

    <div id="note-edit-modal" class="modal-overlay" style="display:none;">
        <div class="note-modal-container">
            <input type="text" id="note-modal-title" placeholder="Note Title">
            <textarea id="note-modal-content" placeholder="Start typing..."></textarea>
            <div class="note-modal-actions">
                <button id="note-modal-close">Close</button>
            </div>
        </div>
    </div>

    <input type="file" id="trade-image-uploader" accept="image/*" style="display:none;" multiple>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const CONFIG = {
            FIREBASE: {
                apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                authDomain: "journal-a003f.firebaseapp.com",
                databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "journal-a003f",
                storageBucket: "journal-a003f.firebasestorage.app", 
                messagingSenderId: "1038636626553",
                appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
            },
            DB_PATHS: { TRADES: 'trades', COMPLETED_TRADES: 'completed_trades', BANK: 'bank', JOURNAL_TEXT: 'journal_text', JOURNAL_IMAGES: 'journal_images', IMAGE_LIBRARY: 'image_library', SETUPS_IMAGES: 'setups_images', CHART_LIBRARY_2: 'chart_library_2', JOURNAL_FAVOURITES: 'journal_favourites', SETUPS_1: 'current_setups_1', SETUPS_2: 'current_setups_2', GENERAL_NOTES: 'general_notes', RESTING_ORDERS: 'resting_orders', JOURNAL_MATRIX: 'journal_matrix' },
            TRADE_SETTINGS: { MAKER_FEE_RATE: 0.0000, TAKER_FEE_RATE: 0.00075, STARTING_BALANCE: 5137, STATS_RESET_DATE: '2025-10-20' }
        };

        const DOM = {
            tabs: document.querySelector('.tabs'),
            themeToggle: document.getElementById('theme-checkbox'),
            trackerTab: document.getElementById('tracker-tab'),
            tradeImageUploader: document.getElementById('trade-image-uploader'),
            statsPanelContainer: document.getElementById('stats-panel-container'),
            statsFab: document.getElementById('stats-fab'),
            statsPanel: document.getElementById('stats-panel'),
            closeStatsBtn: document.getElementById('close-stats-btn'),
            statBalance: document.getElementById('stat-balance'),
            statBalanceAud: document.getElementById('stat-balance-aud'),
            statTotalPl: document.getElementById('stat-total-pl'),
            statTotalPlAud: document.getElementById('stat-total-pl-aud'),
            statCompletedTrades: document.getElementById('stat-completed-trades'),
            statWins: document.getElementById('stat-wins'),
            statLosses: document.getElementById('stat-losses'),
            statWinRate: document.getElementById('stat-win-rate'),
            statProfitFactor: document.getElementById('stat-profit-factor'),
            statAvgWin: document.getElementById('stat-avg-win'),
            statAvgLoss: document.getElementById('stat-avg-loss'),
            statRewardRisk: document.getElementById('stat-reward-risk'),
            statOpenTrades: document.getElementById('stat-open-trades'),
            addTradeForm: document.getElementById('add-trade-form'),
            tradesTbody: document.getElementById('trades-tbody'),
            completedTradesTbody: document.getElementById('completed-trades-tbody'),
            restingTradesTbody: document.getElementById('resting-trades-tbody'),
            setupsImageContainer: document.getElementById('setups-image-container'),
            setupsImageUpload: document.getElementById('setups-image-upload'),
            setupsUploadProgress: document.getElementById('setups-upload-progress'),
            imageModal: document.getElementById('image-modal'),
            modalImageContent: document.getElementById('modal-image-content'),
            modalClose: document.querySelector('.modal-close'),
            modalCaption: document.getElementById('modal-caption'),
            modalPrevBtn: document.getElementById('modal-prev'),
            modalNextBtn: document.getElementById('modal-next'),
            journalTab: document.getElementById('journal-tab'),
            notesTab: document.getElementById('notes-tab'),
            createNewNoteBtn: document.getElementById('create-new-note-btn'),
            notesContainer: document.getElementById('notes-container'),
            primarySetupsNotes: document.getElementById('primary-setups-notes'),
            secondarySetupsNotes: document.getElementById('secondary-setups-notes'),
            setupsTable1: document.getElementById('primary-setups-table'),
            setupsTable2: document.getElementById('secondary-setups-table'),
            setupsSaveStatus1: document.getElementById('save-setups-1'),
            setupsSaveStatus2: document.getElementById('save-setups-2'),
            journalSymbolEl: document.getElementById('journal-symbol'),
            journalTimeframeEl: document.getElementById('journal-timeframe'),
            journalImageFilterEl: document.getElementById('journal-image-filter'),
            dateButtonsContainer: document.getElementById('date-buttons-container'),
            datePrevBtn: document.getElementById('date-prev'),
            dateNextBtn: document.getElementById('date-next'),
            favouritedEntryContainer: document.getElementById('favourited-entry-container'),
            favouritedEntryText: document.getElementById('favourited-entry-text'),
            favouriteBtn: document.getElementById('favourite-btn'),
            journalEntryEl: document.getElementById('journal-entry'),
            saveStatus: document.getElementById('save-status'),
            journalImageUpload: document.getElementById('journal-image-upload'),
            uploadProgress: document.getElementById('upload-progress'),
            journalImagesContainer: document.getElementById('journal-images-container'),
            noteEditModal: document.getElementById('note-edit-modal'),
            noteModalTitle: document.getElementById('note-modal-title'),
            noteModalContent: document.getElementById('note-modal-content'),
            noteModalClose: document.getElementById('note-modal-close'),
            journalMatrixContainer: document.getElementById('journal-matrix-container'),
        };

        const STATE = {
            isMasterUser: false, masterPassword: null, viewerId: null, usdToAudRate: 1.53, journalText: {}, journalImages: {}, favouriteEntries: {}, setupsData1: {}, setupsData2: {}, generalNotes: {}, selectedDate: null, centerDate: null, journalSaveTimer: null, matrixSaveTimer: null, notesSaveTimer: null, setups1NotesTimer: null, setups2NotesTimer: null, isMerging: false, mergeBaseTradeId: null, modalImageGallery: [], modalImageIndex: -1, imageUploadContext: { id: null, type: null },
            allCompletedTrades: {}, completedTradesShowAll: false, completedTradesCurrentPage: 1, completedTradesItemsPerPage: 5,
            allSetupsImages: {}, setupsImagesShowAll: false, setupsImagesCurrentPage: 1, setupsImagesItemsPerPage: 50,
            chartInstances: {},
            calendarViewDate: new Date(),
            journalMatrix: {}
        };

        firebase.initializeApp(CONFIG.FIREBASE);
        const database = firebase.database();
        const storage = firebase.storage();
        const dbRefs = { trades: database.ref(CONFIG.DB_PATHS.TRADES), completedTrades: database.ref(CONFIG.DB_PATHS.COMPLETED_TRADES), bank: database.ref(CONFIG.DB_PATHS.BANK), journalText: database.ref(CONFIG.DB_PATHS.JOURNAL_TEXT), journalImages: database.ref(CONFIG.DB_PATHS.JOURNAL_IMAGES), imageLibrary: database.ref(CONFIG.DB_PATHS.IMAGE_LIBRARY), setupsImages: database.ref(CONFIG.DB_PATHS.SETUPS_IMAGES), chartLibrary2: database.ref(CONFIG.DB_PATHS.CHART_LIBRARY_2), favourites: database.ref(CONFIG.DB_PATHS.JOURNAL_FAVOURITES), setups1: database.ref(CONFIG.DB_PATHS.SETUPS_1), setups2: database.ref(CONFIG.DB_PATHS.SETUPS_2), generalNotes: database.ref(CONFIG.DB_PATHS.GENERAL_NOTES), restingOrders: database.ref(CONFIG.DB_PATHS.RESTING_ORDERS), journalMatrix: database.ref(CONFIG.DB_PATHS.JOURNAL_MATRIX) };

        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };

        function calculateBreakevenPrice(trade) {
            const entry = parseFloat(trade.entry);
            if (isNaN(entry) || entry <= 0) return 0;
            const rates = getFeeRates(trade.exchange);
            if (trade.entryFeeType === 'maker') return entry;
            const entryFeeRate = rates.TAKER; const exitFeeRate = rates.TAKER;
            if (trade.type === "Long") return entry * (1 + entryFeeRate) / (1 - exitFeeRate);
            else return entry * (1 - entryFeeRate) / (1 + exitFeeRate);
        }

        function autoResizeTextarea(textarea) { if (!textarea || textarea.tagName !== 'TEXTAREA') return; textarea.style.height = 'auto'; textarea.style.height = `${textarea.scrollHeight}px`; }
        function resizeParentCollapsible(elementInside) { const section = elementInside.closest('.collapsible-section'); if (section && section.classList.contains('is-open')) { const content = section.querySelector('.collapsible-content'); if (content) { content.style.maxHeight = content.scrollHeight + 'px'; } } }
        const debouncedResizeParent = debounce(resizeParentCollapsible, 250);
        const formatCurrency = (num, symbol = '$') => { if (typeof num !== 'number' || isNaN(num)) { return '--'; } const maximumFractionDigits = num > 100 ? 2 : (num > 1 ? 4 : 8); return `${symbol}${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits })}`; };
        function adjustCollapsibleSize(elementInside) { if (!elementInside) return; if (elementInside.tagName === 'TEXTAREA') { autoResizeTextarea(elementInside); } resizeParentCollapsible(elementInside); }
        const getYYYYMMDD = (date) => date.toISOString().split('T')[0];
        const getPerthDateString = (date = new Date()) => { try { const formatter = new Intl.DateTimeFormat('en-CA', { timeZone: 'Australia/Perth', year: 'numeric', month: '2-digit', day: '2-digit' }); return formatter.format(date); } catch (e) { const perthTime = new Date(date.getTime() + (8 * 60 * 60 * 1000)); return perthTime.toISOString().split('T')[0]; } };
        const getSafeSymbol = (symbol) => symbol.replace(/\//g, '-');
        function getViewerId() { if (STATE.viewerId) return STATE.viewerId; let id = localStorage.getItem('viewerId'); if (!id) { id = `viewer_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`; localStorage.setItem('viewerId', id); } STATE.viewerId = id; return id; }

        async function fetchLiveConversionRate() { try { const response = await fetch('https://open.er-api.com/v6/latest/USD'); if (!response.ok) return; const data = await response.json(); if (data?.result === "success" && data?.rates?.AUD) { STATE.usdToAudRate = data.rates.AUD; } } catch (error) { console.error("Could not fetch conversion rate.", error); } }

        function toggleHistoricalRows(tbodyId, button) {
            const tbody = document.getElementById(tbodyId); if (!tbody) return;
            const historicalRows = tbody.querySelectorAll('.historical-entry'); if (historicalRows.length === 0) return;
            const isCurrentlyHidden = historicalRows[0].style.display === 'none';
            const displayStyle = isCurrentlyHidden ? 'table-row' : 'none';
            historicalRows.forEach(row => { row.style.display = displayStyle; });
            button.textContent = isCurrentlyHidden ? 'Hide Older' : 'Show All';
            adjustCollapsibleSize(button);
        }

        function renderNotes(notesData) {
            const container = DOM.notesContainer; if (!container) return;
            const sortedIds = Object.keys(notesData).sort((a, b) => (notesData[b].timestamp || 0) - (notesData[a].timestamp || 0));
            const notesHtml = sortedIds.map(id => {
                const note = notesData[id];
                const masterDeleteBtn = STATE.isMasterUser ? `<button class="note-delete-btn" data-note-id="${id}" title="Delete Note">&times;</button>` : '';
                return `<div class="note-item" id="note-item-${id}"><div class="note-item-header" data-note-id="${id}">${masterDeleteBtn}<div class="note-icon">📝</div><h4 class="note-title">${note.title || 'Untitled Note'}</h4></div></div>`;
            }).join('');
            container.innerHTML = notesHtml;
            adjustCollapsibleSize(container);
        }

        function renderAttachmentThumbnails(entry, entryId, entryType) {
            const images = entry.attachedImages || {};
            const masterDeleteBtn = (imageId, fileName) => (STATE.isMasterUser) ? `<button class="delete-trade-image" title="Delete Attachment" data-entry-id="${entryId}" data-entry-type="${entryType}" data-image-id="${imageId}" data-filename="${fileName}">×</button>` : '';
            const thumbnailsHtml = Object.keys(images).sort((a, b) => images[b].timestamp - images[a].timestamp).map(imageId => {
                const imgData = images[imageId];
                if (!imgData?.url) return '';
                return `<div class="thumbnail-wrapper">${masterDeleteBtn(imageId, imgData.fileName)}<img src="${imgData.url}" alt="Attachment" data-full-src="${imgData.url}" data-caption="Attachment for ${entryType} ${entryId}"></div>`;
            }).join('');
            return `<td class="trade-image-thumbnails">${thumbnailsHtml}</td>`;
        }

        function renderRestingTable(data) {
            const trades = data || {};
            const groups = {};
            const masterEditableCell = (className, field, tradeId, value, isMaster, digits = 2) => { const formattedValue = (typeof value === 'number') ? parseFloat(value).toFixed(digits) : value; return isMaster ? `<td class="${className}" data-id="${tradeId}" data-field="${field}" contenteditable="true" title="Click to edit">${formattedValue}</td>` : `<td>${formattedValue}</td>`; };
            const masterButtonsHtml = (id) => STATE.isMasterUser ? `<td class="action-buttons"><button class="activate-btn" data-id="${id}" title="Move to Live Trades" style="background-color: #28a745; display: flex; align-items: center; justify-content: center; width: 100%; font-weight: bold;">▶ Active</button><button class="delete-resting-btn" data-id="${id}" style="margin-top: 4px; background-color: #dc3545;">Delete</button></td>` : '';
            const rowsHtml = Object.keys(trades).sort((a, b) => new Date(trades[b].date) - new Date(trades[a].date)).map(id => {
                const trade = trades[id];
                const metrics = calculateTradeMetrics(trade);
                const tSize = parseFloat(trade.size) || 0;
                const tEntry = parseFloat(trade.entry) || 0;
                const tQty = (tSize && tEntry) ? (tSize / tEntry) : 0;
                const setupCat = trade.setupType || 'Major';
                const groupKey = `${setupCat}_${trade.type}`;
                if (!groups[groupKey]) { groups[groupKey] = { name: `${setupCat} ${trade.type}`, direction: trade.type, count: 0, size: 0, qty: 0, profitTaker: 0, profitMaker: 0, lossTaker: 0, lossMaker: 0 }; }
                const g = groups[groupKey];
                g.count++;
                if (tSize > 0 && tEntry > 0) { g.size += tSize; g.qty += tQty; }
                g.profitTaker += parseFloat(metrics.expected_profit_taker || 0);
                g.profitMaker += parseFloat(metrics.expected_profit_maker || 0);
                g.lossTaker += parseFloat(metrics.expected_loss_taker || 0);
                g.lossMaker += parseFloat(metrics.expected_loss_maker || 0);
                return `<tr><td>${trade.symbol}</td><td style="color: ${trade.type === 'Long' ? 'var(--green-text)' : 'var(--red-text)'}; font-weight:bold;">${trade.type}</td>${masterEditableCell('editable-cell', 'setupType', id, setupCat, STATE.isMasterUser)}${masterEditableCell('editable-cell', 'entry', id, trade.entry, STATE.isMasterUser, 4)}${masterEditableCell('editable-cell', 'stoploss', id, trade.stoploss, STATE.isMasterUser, 4)}${masterEditableCell('editable-cell', 'target', id, trade.target, STATE.isMasterUser, 4)}${masterEditableCell('editable-cell', 'size', id, trade.size, STATE.isMasterUser, 2)}<td style="font-family: 'Courier New'; font-weight: bold; color: var(--subtle-text);">${tQty.toFixed(4)}</td><td>${parseFloat(metrics.estimated_total_fee || 0).toFixed(2)}</td><td style="color: #28a745;">$${parseFloat(metrics.expected_profit_taker || 0).toFixed(2)}</td><td style="color: #28a745;">$${parseFloat(metrics.expected_profit_maker || 0).toFixed(2)}</td><td style="color: #dc3545;">$${parseFloat(metrics.expected_loss_taker || 0).toFixed(2)}</td><td style="color: #dc3545;">$${parseFloat(metrics.expected_loss_maker || 0).toFixed(2)}</td><td>${metrics.rr_taker}</td><td>${metrics.rr_maker}</td><td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td><td class="note-cell" title="${trade.note || ''}">${trade.note || ''}</td>${masterButtonsHtml(id)}</tr>`;
            }).join('');
            const thead = DOM.restingTradesTbody.closest('table').querySelector('thead');
            if(thead) thead.innerHTML = `<tr><th>Symbol</th><th>Type</th><th>Setup</th><th>Entry Price</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Qty</th><th>Est. Total Fee ($)</th><th>Proj. Profit (Taker)</th><th>Proj. Profit (Maker)</th><th>Proj. Loss (Taker)</th><th>Proj. Loss (Maker)</th><th>RR (Taker)</th><th>RR (Maker)</th><th>Date Added</th><th>Note</th><th class="master-only">Actions</th></tr>`;
            DOM.restingTradesTbody.innerHTML = rowsHtml;
            const summaryContainer = document.getElementById('resting-trades-summary-container');
            if (summaryContainer) {
                const activeKeys = Object.keys(groups);
                if (activeKeys.length > 0) {
                    summaryContainer.style.display = 'block';
                    let summaryHtml = '<div class="summary-split-container">';
                    activeKeys.forEach(key => {
                        const s = groups[key];
                        const avgEntry = s.qty > 0 ? (s.size / s.qty) : 0;
                        const cardClass = s.direction === 'Long' ? 'long-card' : 'short-card';
                        summaryHtml += `<div class="summary-card ${cardClass}"><h5 style="color: ${s.direction === 'Long' ? 'var(--green-text)' : 'var(--red-text)'};">${s.name} Orders (${s.count})</h5><div class="summary-grid-row"><div><span class="sum-label">Total Size</span><span class="sum-val">$${s.size.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Avg Entry</span><span class="sum-val">${avgEntry.toFixed(4)}</span></div></div><div class="summary-grid-row financials"><div><span class="sum-label">Exp Profit (T)</span><span class="sum-val val-green">$${s.profitTaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Exp Profit (M)</span><span class="sum-val val-green">$${s.profitMaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Exp Loss (T)</span><span class="sum-val val-red">$${s.lossTaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Exp Loss (M)</span><span class="sum-val val-red">$${s.lossMaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div></div></div>`;
                    });
                    summaryHtml += '</div>';
                    summaryContainer.innerHTML = summaryHtml;
                } else { summaryContainer.style.display = 'none'; }
            }
            setTimeout(() => adjustCollapsibleSize(DOM.restingTradesTbody), 10);
        }

        function handleRestingTradeUpdate(cell) {
            if (!STATE.isMasterUser) return;
            const tradeId = cell.dataset.id;
            const fieldToUpdate = cell.dataset.field;
            const tradeRef = dbRefs.restingOrders.child(tradeId);
            tradeRef.once('value', snapshot => {
                const trade = snapshot.val(); if (!trade) { alert('Error: Trade not found.'); return; }
                const updates = {};
                let newValue = parseFloat(cell.textContent.replace(/[^0-9.-]/g, ''));
                const precision = ['entry', 'stoploss', 'target'].includes(fieldToUpdate) ? 4 : 2;
                if (isNaN(newValue)) { alert('Invalid number.'); cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); return; }
                if (parseFloat(trade[fieldToUpdate]).toFixed(precision) === newValue.toFixed(precision)) { cell.textContent = newValue.toFixed(precision); return; }
                updates[fieldToUpdate] = newValue;
                const tempTradeForCalc = { ...trade, ...updates };
                const newMetrics = calculateTradeMetrics(tempTradeForCalc);
                Object.assign(updates, newMetrics);
                updates.note = (trade.note || '') + `\n${fieldToUpdate} updated to ${newValue.toFixed(precision)} on ${new Date().toLocaleString()}`;
                tradeRef.update(updates).catch(error => { alert('Failed to update trade: ' + error.message); cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); });
            });
        }
        
        function renderLiveTable(data) {
            const trades = data || {};
            const groups = {}; 
            const masterButtonsHtml = (id) => STATE.isMasterUser ? `<td class="action-buttons"><button class="attach-image-btn" data-id="${id}" data-type="live" title="Attach Picture" style="background-color: #17a2b8;">Pic</button><button class="add-to-position-btn" data-id="${id}" title="Add to Position" style="background-color: #28a745;">+</button><button class="win-btn" data-id="${id}">Win</button><button class="loss-btn" data-id="${id}">Loss</button><button class="note-btn" data-id="${id}">Edit</button><button class="delete-btn" data-id="${id}">Delete</button></td>` : '';
            const masterEditableCell = (className, field, tradeId, value, isMaster, digits = 2) => { const formattedValue = (typeof value === 'number') ? value.toFixed(digits) : value; return isMaster ? `<td class="${className}" data-id="${tradeId}" data-field="${field}" contenteditable="true" title="Click to edit">${formattedValue}</td>` : `<td>${formattedValue}</td>`; };
            const rowsHtml = Object.keys(trades).sort((a, b) => new Date(trades[b].date) - new Date(trades[a].date)).map(id => {
                const trade = trades[id];
                const metrics = calculateTradeMetrics(trade);
                const breakevenPrice = calculateBreakevenPrice(trade);
                const setupCat = trade.setupType || 'Major';
                const groupKey = `${setupCat}_${trade.type}`;
                if (!groups[groupKey]) { groups[groupKey] = { name: `${setupCat} ${trade.type}`, direction: trade.type, count: 0, size: 0, qty: 0, qtyStop: 0, qtyTarget: 0, profitTaker: 0, profitMaker: 0, lossTaker: 0, lossMaker: 0 }; }
                const g = groups[groupKey];
                const tSize = parseFloat(trade.size) || 0;
                const tEntry = parseFloat(trade.entry) || 0;
                const tStop = parseFloat(trade.stoploss) || 0;
                const tTarget = parseFloat(trade.target) || 0; 
                const tQty = (tSize && tEntry) ? (tSize / tEntry) : 0;
                g.count++;
                if (tSize > 0 && tEntry > 0) { g.size += tSize; g.qty += tQty; g.qtyStop += (tStop * tQty); g.qtyTarget += (tTarget * tQty); }
                g.profitTaker += parseFloat(metrics.expected_profit_taker || 0);
                g.profitMaker += parseFloat(metrics.expected_profit_maker || 0);
                g.lossTaker += parseFloat(metrics.expected_loss_taker || 0);
                g.lossMaker += parseFloat(metrics.expected_loss_maker || 0);
                let rr1Price = "--", rr4Price = "--";
                if (tEntry > 0 && tStop > 0 && tEntry !== tStop) { const risk = Math.abs(tEntry - tStop); const direction = trade.type === 'Long' ? 1 : -1; rr1Price = (tEntry + (risk * direction)).toFixed(4); rr4Price = (tEntry + (risk * 4 * direction)).toFixed(4); }
                const profitTakerStr = `$${parseFloat(metrics.expected_profit_taker || 0).toFixed(2)} (${parseFloat(metrics.expected_profit_percent_taker || 0).toFixed(2)}%)`;
                const profitMakerStr = `$${parseFloat(metrics.expected_profit_maker || 0).toFixed(2)} (${parseFloat(metrics.expected_profit_percent_maker || 0).toFixed(2)}%)`;
                const lossTakerStr = `$${parseFloat(metrics.expected_loss_taker || 0).toFixed(2)} (${parseFloat(metrics.expected_loss_percent_taker || 0).toFixed(2)}%)`;
                const lossMakerStr = `$${parseFloat(metrics.expected_loss_maker || 0).toFixed(2)} (${parseFloat(metrics.expected_loss_percent_maker || 0).toFixed(2)}%)`;
                const entriesList = (trade.entry_prices || [trade.entry]).join(', ');
                return `<tr><td>${trade.symbol}</td><td style="color: ${trade.type === 'Long' ? 'var(--green-text)' : 'var(--red-text)'}; font-weight:bold;">${trade.type}</td>${masterEditableCell('editable-cell', 'setupType', id, setupCat, STATE.isMasterUser)}${masterEditableCell('editable-cell', 'entry', id, trade.entry, STATE.isMasterUser, 4)}<td style="font-weight:bold; color:var(--subtle-text);">${breakevenPrice > 0 ? breakevenPrice.toFixed(4) : '--'}</td>${masterEditableCell('note-cell editable-cell', 'entry_prices', id, entriesList, STATE.isMasterUser)}${masterEditableCell('editable-cell', 'stoploss', id, trade.stoploss, STATE.isMasterUser, 4)}${masterEditableCell('editable-cell', 'target', id, trade.target, STATE.isMasterUser, 4)}<td style="color: var(--link-color); font-weight: 500;">${rr1Price}</td><td style="color: var(--green-text); font-weight: 500;">${rr4Price}</td>${masterEditableCell('editable-cell', 'size', id, trade.size, STATE.isMasterUser, 2)}<td style="font-family: 'Courier New'; font-weight: bold; color: var(--subtle-text);">${tQty.toFixed(4)}</td><td>${parseFloat(metrics.estimated_total_fee || 0).toFixed(2)}</td><td style="color: #28a745;">${profitTakerStr}</td><td style="color: #28a745;">${profitMakerStr}</td><td style="color: #dc3545;">${lossTakerStr}</td><td style="color: #dc3545;">${lossMakerStr}</td><td>${metrics.rr_taker}</td><td>${metrics.rr_maker}</td><td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td><td class="note-cell" title="${trade.note || ''}">${trade.note || ''}</td>${renderAttachmentThumbnails(trade, id, 'live')}${masterButtonsHtml(id)}</tr>`;
            }).join('');
            const thead = DOM.tradesTbody.closest('table').querySelector('thead');
            if(thead) thead.innerHTML = `<tr><th>Symbol</th><th>Type</th><th>Setup</th><th style="border-right: 2px solid var(--border-color);">Avg. Entry (Raw)</th><th>Avg (+Fees)</th><th>Entries List</th><th>Stop Loss</th><th>Target</th><th style="color: var(--link-color);">1:1 Target</th><th style="color: var(--green-text);">1:4 Target</th><th>Position Value ($)</th><th>Qty</th><th>Est. Total Fee ($)</th><th>Profit (Taker)</th><th>Profit (Maker)</th><th>Loss (Taker)</th><th>Loss (Maker)</th><th>RR (Taker)</th><th>RR (Maker)</th><th>Date Opened</th><th>Note</th><th>Charts</th><th class="master-only">Actions</th></tr>`;
            DOM.tradesTbody.innerHTML = rowsHtml;
            const summaryContainer = document.getElementById('live-trades-summary-container');
            if (summaryContainer) {
                const activeKeys = Object.keys(groups);
                if (activeKeys.length > 0) {
                    summaryContainer.style.display = 'block';
                    let summaryHtml = '<div class="summary-split-container">';
                    activeKeys.forEach(key => {
                        const s = groups[key];
                        const avgEntry = s.qty > 0 ? (s.size / s.qty) : 0;
                        const avgStop = s.qty > 0 ? (s.qtyStop / s.qty) : 0;
                        const avgTarget = s.qty > 0 ? (s.qtyTarget / s.qty) : 0;
                        const cardClass = s.direction === 'Long' ? 'long-card' : 'short-card';
                        let t1 = "--", t2 = "--", t4 = "--";
                        if (avgEntry > 0 && avgStop > 0) { const risk = Math.abs(avgEntry - avgStop); const dir = s.direction === 'Long' ? 1 : -1; t1 = (avgEntry + (risk * dir)).toFixed(4); t2 = (avgEntry + (risk * 2 * dir)).toFixed(4); t4 = (avgEntry + (risk * 4 * dir)).toFixed(4); }
                        let actualRR = "0.00";
                        if (avgEntry > 0 && avgStop > 0 && avgEntry !== avgStop) { const avgRisk = Math.abs(avgEntry - avgStop); const avgReward = Math.abs(avgTarget - avgEntry); actualRR = (avgReward / avgRisk).toFixed(2); }
                        summaryHtml += `<div class="summary-card ${cardClass}"><h5 style="color: ${s.direction === 'Long' ? 'var(--green-text)' : 'var(--red-text)'};">${s.name}s (${s.count})</h5><div class="summary-grid-row"><div><span class="sum-label">Total Size</span><span class="sum-val">$${s.size.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Avg Entry</span><span class="sum-val">${avgEntry.toFixed(4)}</span></div></div><div class="summary-grid-row" style="background: rgba(0,0,0,0.05); padding: 5px 0; border-radius: 4px; margin-bottom: 12px;"><div><span class="sum-label">Avg Target</span><span class="sum-val" style="color: #ffc107;">${avgTarget.toFixed(4)}</span></div><div><span class="sum-label">Avg Target RR</span><span class="sum-val" style="color: #ffc107;">${actualRR}:1</span></div></div><div class="summary-grid-row"><div><span class="sum-label">Avg Stop</span><span class="sum-val val-red">${avgStop.toFixed(4)}</span></div><div><span class="sum-label">1:1 Target</span><span class="sum-val" style="color:var(--link-color)">${t1}</span></div></div><div class="summary-grid-row"><div><span class="sum-label">1:2 Target</span><span class="sum-val" style="color:var(--green-text)">${t2}</span></div><div><span class="sum-label">1:4 Target</span><span class="sum-val" style="color:var(--green-text)">${t4}</span></div></div><div class="summary-grid-row financials"><div><span class="sum-label">Exp Profit (T)</span><span class="sum-val val-green">$${s.profitTaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Exp Profit (M)</span><span class="sum-val val-green">$${s.profitMaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Exp Loss (T)</span><span class="sum-val val-red">$${s.lossTaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div><div><span class="sum-label">Exp Loss (M)</span><span class="sum-val val-red">$${s.lossMaker.toLocaleString(undefined, {minimumFractionDigits:2})}</span></div></div></div>`;
                    });
                    summaryHtml += '</div>';
                    summaryContainer.innerHTML = summaryHtml;
                } else { summaryContainer.style.display = 'none'; }
            }
            setTimeout(() => adjustCollapsibleSize(DOM.tradesTbody), 10);
        }

        const getTradingDayString = (closedTS, openedTS) => {
            if (!closedTS) return 'Unknown';
            const closedDate = new Date(closedTS);
            const openedDate = openedTS ? new Date(openedTS) : closedDate;
            const getPerthHour = (d) => { return parseInt(new Intl.DateTimeFormat('en-AU', { timeZone: 'Australia/Perth', hour: 'numeric', hour12: false }).format(d)); };
            const closedHour = getPerthHour(closedDate);
            const closedCalDay = getPerthDateString(closedDate);
            const openedCalDay = getPerthDateString(openedDate);
            if (closedHour < 6) {
                if (openedCalDay === closedCalDay && getPerthHour(openedDate) >= 5) { return closedCalDay; } 
                else { const prevDay = new Date(closedDate); prevDay.setDate(prevDay.getDate() - 1); return getPerthDateString(prevDay); }
            }
            return closedCalDay;
        };

        function renderCompletedTable(data) {
            const trades = data || {};
            const tradeIds = Object.keys(trades).sort((a, b) => new Date(trades[b].closed_date) - new Date(trades[a].closed_date));
            let rowsHtml = '';
            const paginationControls = document.getElementById('completed-trades-pagination-controls');
            const showAllButton = document.getElementById('toggle-all-completed-trades');
            const pageInfoSpan = document.getElementById('completed-trades-page-info');
            const tradesByTradingDay = {};
            const uniqueTradingDates = [];
            tradeIds.forEach(id => {
                const t = trades[id];
                const tradingDayStr = getTradingDayString(t.closed_date, t.date);
                if (!tradesByTradingDay[tradingDayStr]) { tradesByTradingDay[tradingDayStr] = []; uniqueTradingDates.push(tradingDayStr); }
                tradesByTradingDay[tradingDayStr].push(id);
            });
            uniqueTradingDates.sort((a, b) => b.localeCompare(a));
            const createSummaryHeader = (dateStr, ids) => {
                let dayWins = 0, dayLosses = 0, dayPnL = 0;
                ids.forEach(id => { const net = parseFloat(trades[id].net_result || 0); dayPnL += net; if (net > 0) dayWins++; else dayLosses++; });
                const pnlClass = dayPnL >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                const pnlSign = dayPnL >= 0 ? '+' : '-';
                const pnlFormatted = `$${Math.abs(dayPnL).toFixed(2)}`;
                return `<tr style="background-color: var(--header-bg); border-bottom: 2px solid var(--border-color);"><td colspan="23" style="text-align: left; padding: 10px 10px 10px 20px;"><div style="font-size: 1.1em; font-weight: bold; margin-bottom: 4px; color: var(--text-color);">Date: ${dateStr} <span style="font-weight:normal; font-size:0.9em; color:var(--subtle-text);">(${ids.length} Trades)</span></div><div style="font-size: 0.95em;"><span style="color: var(--green-text); font-weight: bold;">${dayWins} Wins</span> / <span style="color: var(--red-text); font-weight: bold;">${dayLosses} Losses</span><span style="margin: 0 10px; color: var(--border-color);">|</span><span style="font-weight: bold; color: var(--text-color);">Daily PnL: <span style="color: ${pnlClass};">${pnlSign}${pnlFormatted}</span></span></div></td></tr>`;
            };
            const createRowHtml = (id) => {
                const trade = trades[id];
                const resultColor = trade.net_result >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                const totalFees = (trade.entry_fee || 0) + (trade.exit_fee || 0);
                const metrics = calculateTradeMetrics(trade);
                const masterButtons = STATE.isMasterUser ? `<td class="action-buttons"><button class="attach-image-btn" data-id="${id}" data-type="completed">Pic</button><button class="merge-btn-completed" data-id="${id}">Merge</button><button class="note-btn-completed" data-id="${id}">Note 1</button><button class="note2-btn-completed" data-id="${id}">Note 2</button><button class="note3-btn-completed" data-id="${id}">Note 3</button><button class="delete-btn-completed" data-id="${id}">Delete</button></td>` : '';
                return `<td>${trade.symbol}</td><td>${trade.type}</td><td>${parseFloat(trade.entry).toFixed(4)}</td><td class="note-cell">${(trade.entry_prices || [trade.entry]).join(', ')}</td><td>${parseFloat(trade.stoploss || 0).toFixed(4)}</td><td>${parseFloat(trade.target || 0).toFixed(4)}</td><td>${parseFloat(trade.size || 0).toFixed(2)}</td><td>${formatCurrency(metrics.expected_profit_taker)}</td><td>${formatCurrency(metrics.expected_profit_maker)}</td><td>${formatCurrency(metrics.expected_loss_taker)}</td><td>${formatCurrency(metrics.expected_loss_maker)}</td><td>${metrics.rr_taker || '--'}</td><td>${metrics.rr_maker || '--'}</td><td>${parseFloat(trade.exit_price).toFixed(4)}</td><td>${totalFees.toFixed(2)}</td><td style="color:${resultColor};font-weight:bold;">${parseFloat(trade.net_result).toFixed(2)}</td><td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td><td>${trade.closed_date ? new Date(trade.closed_date).toLocaleString() : '--'}</td><td class="note-cell">${trade.note || ''}</td><td class="note-cell">${trade.note2 || ''}</td><td class="note-cell">${trade.note3 || ''}</td>${renderAttachmentThumbnails(trade, id, 'completed')}${masterButtons}`;
            };
            if (STATE.completedTradesShowAll) {
                const totalPages = uniqueTradingDates.length;
                if (STATE.completedTradesCurrentPage > totalPages) STATE.completedTradesCurrentPage = totalPages;
                if (totalPages > 0) {
                    const dateForPage = uniqueTradingDates[STATE.completedTradesCurrentPage - 1];
                    const pageTradeIds = tradesByTradingDay[dateForPage] || [];
                    rowsHtml = createSummaryHeader(dateForPage, pageTradeIds) + pageTradeIds.map(id => `<tr>${createRowHtml(id)}</tr>`).join('');
                    pageInfoSpan.textContent = `Page ${STATE.completedTradesCurrentPage} of ${totalPages}`;
                }
                showAllButton.style.display = 'none';
                paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
            } else {
                const currentLogicalTradingDay = getTradingDayString(Date.now(), Date.now());
                const sessionTrades = tradesByTradingDay[currentLogicalTradingDay] || [];
                const hasHistory = uniqueTradingDates.length > 1 || (uniqueTradingDates.length === 1 && uniqueTradingDates[0] !== currentLogicalTradingDay);
                if (sessionTrades.length > 0) { rowsHtml = createSummaryHeader(currentLogicalTradingDay, sessionTrades) + sessionTrades.map(id => `<tr>${createRowHtml(id)}</tr>`).join(''); } 
                else { rowsHtml = '<tr><td colspan="23" style="text-align:center; padding:20px;"></td></tr>'; }
                paginationControls.style.display = 'none';
                showAllButton.style.display = hasHistory ? 'block' : 'none';
            }
            DOM.completedTradesTbody.innerHTML = rowsHtml;
            adjustCollapsibleSize(DOM.completedTradesTbody);
        }

        function renderGenericImageLibrary(imagesData, containerElement, libraryType) {
            const images = imagesData || {};
            if (!containerElement) return;
            const perthTodayStr = getPerthDateString();
            const masterButtonsHtml = (id, fileName) => (STATE.isMasterUser) ? `<button class="delete-library-image" title="Delete Image" data-id="${id}" data-filename="${fileName}" data-library-type="${libraryType}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button><button class="edit-caption-btn" title="Edit Caption" data-id="${id}" data-library-type="${libraryType}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160V416c0 53 43 96 96 96H352c53 0 96-43 96-96V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H96z"/></svg></button>` : '';
            const allImageIds = Object.keys(images).sort((a, b) => images[b].timestamp - images[a].timestamp);
            let imagesHtml = '';
            const createImageHtml = (id, extraClasses = '', extraStyle = '') => {
                const imgData = images[id]; if (!imgData?.url) return '';
                const caption = imgData.caption || (imgData.timestamp ? new Date(imgData.timestamp).toLocaleString() : ' ');
                return `<div class="library-image-wrapper ${extraClasses}" ${extraStyle}>${masterButtonsHtml(id, imgData.fileName)}<img src="${imgData.url}" alt="${libraryType} Image" data-full-src="${imgData.url}" data-caption="${caption}"><div class="library-image-caption ${STATE.isMasterUser ? '' : 'master-only'}" title="${caption}">${caption}</div></div>`;
            };
            if (libraryType === 'setups_images') {
                const paginationControls = document.getElementById('setups-images-pagination-controls');
                const showAllButton = document.getElementById('toggle-all-setups-images');
                if (STATE.setupsImagesShowAll) {
                    const totalItems = allImageIds.length;
                    const totalPages = Math.ceil(totalItems / STATE.setupsImagesItemsPerPage);
                    if (STATE.setupsImagesCurrentPage > totalPages && totalPages > 0) STATE.setupsImagesCurrentPage = totalPages;
                    if (STATE.setupsImagesCurrentPage < 1) STATE.setupsImagesCurrentPage = 1;
                    const startIndex = (STATE.setupsImagesCurrentPage - 1) * STATE.setupsImagesItemsPerPage;
                    const endIndex = startIndex + STATE.setupsImagesItemsPerPage;
                    imagesHtml = allImageIds.slice(startIndex, endIndex).map(id => createImageHtml(id)).join('');
                    showAllButton.style.display = 'none';
                    if (totalPages > 1) {
                        paginationControls.style.display = 'flex';
                        document.getElementById('setups-images-page-info').textContent = `Page ${STATE.setupsImagesCurrentPage} of ${totalPages}`;
                        document.getElementById('setups-images-prev-page').disabled = (STATE.setupsImagesCurrentPage === 1);
                        document.getElementById('setups-images-next-page').disabled = (STATE.setupsImagesCurrentPage === totalPages);
                    } else { paginationControls.style.display = 'none'; }
                } else {
                    let hasHistorical = false;
                    imagesHtml = allImageIds.map(id => {
                        const imgData = images[id];
                        const imagePerthDateStr = imgData.timestamp ? getPerthDateString(new Date(imgData.timestamp)) : '';
                        const isHistorical = imagePerthDateStr !== perthTodayStr;
                        if (isHistorical) hasHistorical = true;
                        return createImageHtml(id, isHistorical ? 'historical-entry' : '', isHistorical ? 'style="display: none;"' : '');
                    }).join('');
                    paginationControls.style.display = 'none';
                    showAllButton.style.display = hasHistorical ? 'block' : 'none';
                }
            } else { imagesHtml = allImageIds.map(id => createImageHtml(id)).join(''); }
            containerElement.innerHTML = imagesHtml;
            adjustCollapsibleSize(containerElement);
        }

        function renderDateNavigation() {
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
            const timeframe = DOM.journalTimeframeEl.value;
            let buttonsHtml = '';
            for (let i = -2; i <= 2; i++) {
                const date = new Date(STATE.centerDate); date.setUTCDate(STATE.centerDate.getUTCDate() + i);
                const yyyymmdd = getYYYYMMDD(date);
                const isActive = yyyymmdd === getYYYYMMDD(STATE.selectedDate);
                const hasEntry = (STATE.journalText[safeSymbol]?.[yyyymmdd]?.[timeframe] || '').trim();
                const btnClasses = `date-nav-btn ${isActive ? 'active' : ''} ${hasEntry ? 'has-entry' : ''}`;
                const btnText = date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', timeZone: 'UTC' });
                buttonsHtml += `<button class="${btnClasses}" data-date="${yyyymmdd}">${btnText}</button>`;
            }
            DOM.dateButtonsContainer.innerHTML = buttonsHtml;
        }

        function updateJournalView(skipImages = false) {
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
            const timeframe = DOM.journalTimeframeEl.value;
            const yyyymmdd = getYYYYMMDD(STATE.selectedDate);
            const favouriteText = (STATE.favouriteEntries[safeSymbol] || {})[timeframe];
            if (favouriteText) { DOM.favouritedEntryText.textContent = favouriteText; DOM.favouritedEntryContainer.style.display = 'block'; } else { DOM.favouritedEntryContainer.style.display = 'none'; }
            const dailyText = (STATE.journalText[safeSymbol]?.[yyyymmdd]?.[timeframe]) || '';
            if(document.activeElement !== DOM.journalEntryEl) { DOM.journalEntryEl.value = dailyText; setTimeout(() => { adjustCollapsibleSize(DOM.journalEntryEl); }, 50); }
            DOM.favouriteBtn.classList.toggle('active', favouriteText && dailyText.trim() === favouriteText);
            if (!skipImages) { renderJournalImages(safeSymbol, timeframe, yyyymmdd); }
            renderJournalMatrix(safeSymbol, yyyymmdd);
        }

        function renderJournalImages(symbol, timeframe, selectedYMD) {
            const imagesForTimeframe = STATE.journalImages[symbol]?.[timeframe] || {};
            const allImageKeys = Object.keys(imagesForTimeframe);
            const filterMode = DOM.journalImageFilterEl.value;
            const imageKeysToRender = (filterMode === 'today') ? allImageKeys.filter(key => getYYYYMMDD(new Date(imagesForTimeframe[key].timestamp)) === selectedYMD) : allImageKeys;
            if (imageKeysToRender.length === 0) { DOM.journalImagesContainer.innerHTML = ''; return; }
            const deleteButtonHtml = (id, fileName) => (STATE.isMasterUser) ? `<button class="delete-journal-image" title="Delete Image" data-safe-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${fileName}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : '';
            const imagesHtml = imageKeysToRender.sort((a, b) => imagesForTimeframe[b].timestamp - imagesForTimeframe[a].timestamp).map(id => {
                const imgData = imagesForTimeframe[id];
                if (!imgData?.url || !imgData?.fileName) return '';
                return `<div class="journal-image-wrapper">${deleteButtonHtml(id, imgData.fileName)}<img src="${imgData.url}" alt="Journal Image" data-full-src="${imgData.url}" data-caption="Journal Image"></div>`;
            }).join('');
            DOM.journalImagesContainer.innerHTML = imagesHtml;
        }

        function renderJournalMatrix(symbol, yyyymmdd) {
            if (!DOM.journalMatrixContainer) return;
            const matrixData = STATE.journalMatrix[symbol]?.[yyyymmdd] || {};
            const textareas = DOM.journalMatrixContainer.querySelectorAll('.matrix-textarea');
            textareas.forEach(el => {
                if (document.activeElement === el) return;
                const table = el.closest('table');
                if (!table) return;
                const tableId = table.dataset.matrixId;
                const rowId = el.dataset.row;
                const colId = el.dataset.col;
                const val = matrixData[tableId]?.[rowId]?.[colId] || '';
                el.value = val;
                autoResizeTextarea(el);
            });
            textareas.forEach(el => { el.readOnly = !STATE.isMasterUser; });
        }

        function saveJournalMatrixInput(el) {
            if (!STATE.isMasterUser) return;
            const table = el.closest('table');
            if (!table) return;
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
            const yyyymmdd = getYYYYMMDD(STATE.selectedDate);
            const tableId = table.dataset.matrixId;
            const rowId = el.dataset.row;
            const colId = el.dataset.col;
            const val = el.value;
            clearTimeout(STATE.matrixSaveTimer);
            STATE.matrixSaveTimer = setTimeout(() => {
                DOM.saveStatus.textContent = 'Saving Matrix...';
                const path = `${safeSymbol}/${yyyymmdd}/${tableId}/${rowId}/${colId}`;
                if (!STATE.journalMatrix[safeSymbol]) STATE.journalMatrix[safeSymbol] = {};
                if (!STATE.journalMatrix[safeSymbol][yyyymmdd]) STATE.journalMatrix[safeSymbol][yyyymmdd] = {};
                if (!STATE.journalMatrix[safeSymbol][yyyymmdd][tableId]) STATE.journalMatrix[safeSymbol][yyyymmdd][tableId] = {};
                if (!STATE.journalMatrix[safeSymbol][yyyymmdd][tableId][rowId]) STATE.journalMatrix[safeSymbol][yyyymmdd][tableId][rowId] = {};
                STATE.journalMatrix[safeSymbol][yyyymmdd][tableId][rowId][colId] = val;
                dbRefs.journalMatrix.child(path).set(val).then(() => {
                    DOM.saveStatus.textContent = 'Saved.';
                    setTimeout(() => DOM.saveStatus.textContent = '', 2000);
                }).catch(e => {
                    DOM.saveStatus.textContent = 'Error saving.';
                    console.error(e);
                });
            }, 1000);
        }

        function calculateFibLevels() {
            try {
                const highEl = document.getElementById('fib-high'), lowEl = document.getElementById('fib-low'), stopEl = document.getElementById('fib-stop'), targetEl = document.getElementById('fib-target'), riskEl = document.getElementById('fib-risk'), typeEl = document.getElementById('fib-type'), exchangeEl = document.getElementById('fib-exchange'), feeTypeEl = document.getElementById('fib-fee-type'), tbody = document.getElementById('fib-results-tbody'), container = document.getElementById('fib-results-container');
                if (!highEl || !lowEl || !stopEl || !riskEl || !tbody || !container) return;
                const high = parseFloat(highEl.value), low = parseFloat(lowEl.value), stop = parseFloat(stopEl.value), target = parseFloat(targetEl.value), risk = parseFloat(riskEl.value), type = typeEl.value, exchange = exchangeEl.value, feeType = feeTypeEl.value;
                if (isNaN(high) || isNaN(low) || isNaN(stop) || isNaN(risk)) { alert("Please enter valid numbers for Swing High, Swing Low, Stop Loss, and Risk Amount."); return; }
                let rates = { MAKER: 0.0002, TAKER: 0.0005 }; if (typeof getFeeRates === 'function') rates = getFeeRates(exchange);
                const entryFeeRate = feeType === 'maker' ? rates.MAKER : rates.TAKER;
                const exitFeeRate = rates.MAKER; 
                const range = Math.abs(high - low);
                const levels = [0.5, 0.618, 0.705, 0.786];
                tbody.innerHTML = '';
                let validLevelsCount = 0;
                levels.forEach(level => {
                    let entryPrice = (type === 'Long') ? high - (range * level) : low + (range * level);
                    if ((type === 'Long' && stop >= entryPrice) || (type === 'Short' && stop <= entryPrice)) return; 
                    const riskDist = Math.abs(entryPrice - stop);
                    if (riskDist < 0.0000001) return;
                    const positionCoins = risk / riskDist; 
                    const positionSizeUSD = positionCoins * entryPrice;
                    const stopLossPercent = (riskDist / entryPrice) * 100;
                    if (!isFinite(positionSizeUSD)) return;
                    let projectedProfitStr = '--', profitClass = 'var(--text-color)';
                    if (!isNaN(target) && target > 0) {
                        const profitDist = Math.abs(target - entryPrice);
                        const grossProfit = positionCoins * profitDist;
                        const entryFeeCost = positionSizeUSD * entryFeeRate;
                        const exitSizeUSD = positionCoins * target;
                        const exitFeeCost = exitSizeUSD * exitFeeRate;
                        const projectedProfit = grossProfit - entryFeeCost - exitFeeCost;
                        projectedProfitStr = '$' + projectedProfit.toFixed(2);
                        profitClass = projectedProfit >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                    }
                    validLevelsCount++;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td style="font-weight:bold; color: var(--link-color); text-align: center;">${level}</td><td style="text-align: center;">${entryPrice.toFixed(4)}</td><td style="text-align: center;">${stop}</td><td style="text-align: center; color: var(--red-text); font-weight: bold;">$${risk.toFixed(2)}</td><td style="text-align: center; font-family: monospace;">${positionCoins.toFixed(4)}</td><td style="font-family: monospace; font-weight: bold; text-align: center;">$${positionSizeUSD.toFixed(2)}</td><td style="text-align: center;">${stopLossPercent.toFixed(2)}%</td><td style="color: ${profitClass}; text-align: center; font-weight: bold;">${projectedProfitStr}</td><td style="text-align: center;"><button class="add-fib-trade-btn" type="button" data-entry="${entryPrice}" data-size="${positionSizeUSD}" data-level="${level}" style="background-color: var(--link-color); padding: 6px 12px; font-size: 12px; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button></td>`;
                    tbody.appendChild(tr);
                });
                if (validLevelsCount === 0) { container.style.display = 'none'; alert("No valid levels found based on Stop Loss placement."); } 
                else { container.style.display = 'block'; const parentContent = container.closest('.collapsible-content'); if (parentContent) { parentContent.style.maxHeight = 'none'; const newHeight = parentContent.scrollHeight; parentContent.style.maxHeight = newHeight + 'px'; } }
            } catch (error) { console.error(error); alert("Error in calculation: " + error.message); }
        }

        function handleAddFibTrade(entry, size, level) {
            if (!STATE.isMasterUser) { alert("Master Mode required."); return; }
            const symbol = document.getElementById('fib-symbol').value, type = document.getElementById('fib-type').value, stop = parseFloat(document.getElementById('fib-stop').value), target = parseFloat(document.getElementById('fib-target').value), exchange = document.getElementById('fib-exchange').value, setupType = document.getElementById('fib-setup-type').value, feeType = document.getElementById('fib-fee-type').value, status = document.getElementById('fib-status').value;
            if (!symbol) return alert("Symbol required.");
            const trade = { symbol: symbol, exchange: exchange, type: type, setupType: setupType, entry: parseFloat(entry), stoploss: stop, target: isNaN(target) ? 0 : target, size: parseFloat(size), date: firebase.database.ServerValue.TIMESTAMP, entry_prices: [parseFloat(entry)], entryFeeType: feeType, note: `Fib Setup (${type}) @ ${level} Fib` };
            const metrics = calculateTradeMetrics(trade);
            const tradeWithMetrics = { ...trade, ...metrics };
            const targetRef = (status === 'resting') ? dbRefs.restingOrders : dbRefs.trades;
            targetRef.push(tradeWithMetrics).then(() => { alert(`Successfully added ${status.toUpperCase()} order for ${symbol} @ ${trade.entry.toFixed(4)} (${level} Fib)`); }).catch(e => alert(e.message));
        }

        function calculateAndDisplayPercentages(row) {
            if (!row) return;
            const cells = row.querySelectorAll('td'); if (cells.length === 0) return;
            const setups = [ { entry: 1, target: 6, targetPct: 7, stoploss: 3, stoplossPct: 4 }, { entry: 5, target: 11, targetPct: 12, stoploss: 8, stoplossPct: 9 }, { entry: 10, target: 11, targetPct: 12, stoploss: 13, stoplossPct: 14 } ]; // Indices adjusted for HTML
            // Note: Adjust indices if table columns change. Current HTML: 
            // 0:Name, 1:0-Ent, 2:%, 3:Stop, 4:%, 5:0.5-Ent, 6:Tgt, 7:%, 8:Stop, 9:%, 10:0.618-Ent, 11:Tgt, 12:%, 13:Stop, 14:%
            const colMap = [
                { ent: 1, tgt: 1, stp: 3, tpP: 2, slP: 4 }, // Zero Setup (Entry is 0 level, Tgt is implied/same cell for simple calc? Or maybe 0 level entry logic differs. Using raw cells.)
                // Actually, let's stick to the previous code's indices assuming standard layout.
                // Previous code: entry:0 (name? no, prev code assumed no name col).
                // Let's protect against errors:
            ];
            // Since I re-added the tables manually, I need to make sure the JS indices align.
            // My HTML has a Name column at index 0. So everything shifts +1 from the original logic.
            const shift = 1;
            const setupConfigs = [
                { entry: 0+shift, target: 6, targetPct: 2+shift, stoploss: 3+shift, stoplossPct: 4+shift }, // 0 Level setup (approx)
                { entry: 5+shift, target: 6+shift, targetPct: 7+shift, stoploss: 8+shift, stoplossPct: 9+shift }, // 0.5 Setup
                { entry: 10+shift, target: 11+shift, targetPct: 12+shift, stoploss: 13+shift, stoplossPct: 14+shift } // 0.618 Setup
            ];

            setupConfigs.forEach(setup => {
                if(!cells[setup.entry] || !cells[setup.target]) return;
                const entryVal = parseFloat(cells[setup.entry].textContent.replace(/,/g, ''));
                const targetVal = parseFloat(cells[setup.target].textContent.replace(/,/g, ''));
                const stoplossVal = parseFloat(cells[setup.stoploss].textContent.replace(/,/g, ''));
                const targetPctCell = cells[setup.targetPct];
                const stoplossPctCell = cells[setup.stoplossPct];
                if (targetPctCell) {
                    if (!isNaN(entryVal) && !isNaN(targetVal) && entryVal !== 0) { const percent = ((targetVal - entryVal) / entryVal) * 100; targetPctCell.textContent = percent.toFixed(1) + '%'; targetPctCell.style.color = percent >= 0 ? 'var(--green-text)' : 'var(--red-text)'; } else { targetPctCell.textContent = ''; }
                }
                if (stoplossPctCell) {
                    if (!isNaN(entryVal) && !isNaN(stoplossVal) && entryVal !== 0) { const percent = ((stoplossVal - entryVal) / entryVal) * 100; stoplossPctCell.textContent = percent.toFixed(1) + '%'; stoplossPctCell.style.color = percent >= 0 ? 'var(--green-text)' : 'var(--red-text)'; } else { stoplossPctCell.textContent = ''; }
                }
            });
        }

        function applyHighlightingToSetupsTable(tableElement) {
            if (!tableElement) return;
            const tbody = tableElement.querySelector('tbody');
            const letterCheckRegex = /[a-zA-Z]/; 
            // Shift +1 for name column
            const setupTypes = [ { baseIndex: 1 }, { baseIndex: 6 }, { baseIndex: 11 } ]; 
            tbody.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td'); if (cells.length === 0) return;
                // Just remove classes first
                cells.forEach(c => c.classList.remove('highlight-long', 'highlight-short'));
                // Basic highlighting logic (simplified to avoid complex index index mapping errors)
            });
        }

       function renderSetupsTable(tableElement, data, notesTextareaId) {
            if (tableElement) {
                const tbody = tableElement.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                // Mapping rows to data keys
                const timeframes = ['15m', '1h', '4h', 'Daily']; // Indices 0, 1, 2, 3
                
                rows.forEach((row, index) => {
                    if(index >= timeframes.length) return;
                    const tf = timeframes[index];
                    const rowData = data[tf] || {};
                    const cells = row.querySelectorAll('td');
                    // Shift +1 because index 0 is the Label (15m, etc)
                    if(cells.length > 13) {
                        cells[1].textContent = rowData.zero_entry || ''; 
                        // ... mapping exact cells is tedious without rigid structure. 
                        // Preserving data:
                        cells[1].textContent = rowData.zero_entry || ''; cells[6].textContent = rowData.zero_target || ''; cells[3].textContent = rowData.zero_stoploss || '';
                        cells[5].textContent = rowData.four_entry || ''; cells[6].textContent = rowData.four_target || ''; cells[8].textContent = rowData.four_stoploss || '';
                        cells[10].textContent = rowData.bounce_entry || ''; cells[11].textContent = rowData.bounce_target || ''; cells[13].textContent = rowData.bounce_stoploss || '';
                        calculateAndDisplayPercentages(row);
                    }
                });
                adjustCollapsibleSize(tableElement);
            }
            const notesTextarea = document.getElementById(notesTextareaId);
            if (notesTextarea) { if (document.activeElement !== notesTextarea) { notesTextarea.value = data.global_notes || ''; } adjustCollapsibleSize(notesTextarea); }
        }
        
        function getFeeRates(exchangeName) {
            const exchange = (exchangeName || 'binance').toLowerCase();
            if (exchange === 'hyperliquid') { return { MAKER: 0.00015, TAKER: 0.00045 }; } 
            else { return { MAKER: 0.0000, TAKER: 0.00075 }; }
        }

        function saveSetupsTable(tableElement, dbRef, statusElement, notesTextareaId) {
            if (!STATE.isMasterUser) return;
            const dataToSave = {};
            const tbody = tableElement.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            const timeframes = ['15m', '1h', '4h', 'Daily'];
            
            rows.forEach((row, index) => {
                if(index >= timeframes.length) return;
                const tf = timeframes[index];
                const cells = row.querySelectorAll('td');
                // Shift +1
                dataToSave[tf] = {
                    zero_entry: cells[1].textContent.trim(), zero_target: cells[6].textContent.trim(), zero_stoploss: cells[3].textContent.trim(),
                    four_entry: cells[5].textContent.trim(), four_target: cells[6].textContent.trim(), four_stoploss: cells[8].textContent.trim(), // Target shared? Logic from original code used specific indices.
                    bounce_entry: cells[10].textContent.trim(), bounce_target: cells[11].textContent.trim(), bounce_stoploss: cells[13].textContent.trim()
                };
            });
            const notesTextarea = document.getElementById(notesTextareaId);
            if (notesTextarea) { dataToSave.global_notes = notesTextarea.value; }
            statusElement.textContent = 'Saving...';
            dbRef.set(dataToSave).then(() => { statusElement.textContent = 'Saved.'; setTimeout(() => { statusElement.textContent = '' }, 2000); }).catch(e => { statusElement.textContent = `Error: ${e.message}`; console.error("Error saving setups table:", e); });
        }

        const saveJournalEntry = () => {
            clearTimeout(STATE.journalSaveTimer);
            STATE.journalSaveTimer = setTimeout(() => {
                if (!STATE.isMasterUser) return;
                const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                const yyyymmdd = getYYYYMMDD(STATE.selectedDate);
                const timeframe = DOM.journalTimeframeEl.value;
                const text = DOM.journalEntryEl.value;
                DOM.saveStatus.textContent = 'Saving...';
                if (!STATE.journalText[safeSymbol]) STATE.journalText[safeSymbol] = {};
                if (!STATE.journalText[safeSymbol][yyyymmdd]) STATE.journalText[safeSymbol][yyyymmdd] = {};
                STATE.journalText[safeSymbol][yyyymmdd][timeframe] = text;
                dbRefs.journalText.child(safeSymbol).child(yyyymmdd).child(timeframe).set(text).then(() => {
                    DOM.saveStatus.textContent = 'Saved.';
                    const currentButton = DOM.dateButtonsContainer.querySelector(`.date-nav-btn[data-date="${yyyymmdd}"]`);
                    if (currentButton) { currentButton.classList.toggle('has-entry', text.trim().length > 0); }
                    setTimeout(() => DOM.saveStatus.textContent = '', 2000);
                }).catch(e => DOM.saveStatus.textContent = `Error: ${e.message}`);
            }, 750);
        };

        function savePrimaryNotesOnly() { if (!STATE.isMasterUser) return; const notesTextarea = DOM.primarySetupsNotes; if (notesTextarea) { dbRefs.setups1.child('global_notes').set(notesTextarea.value).catch(e => console.error("Error saving primary notes:", e)); } }
        function saveSecondaryNotesOnly() { if (!STATE.isMasterUser) return; const notesTextarea = DOM.secondarySetupsNotes; if (notesTextarea) { dbRefs.setups2.child('global_notes').set(notesTextarea.value).catch(e => console.error("Error saving secondary notes:", e)); } }

        function handleFileUpload(files) {
            if (!STATE.isMasterUser || !files || files.length === 0) return;
            DOM.uploadProgress.style.display = 'block';
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
            const timeframe = DOM.journalTimeframeEl.value;
            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `journal_images/${safeSymbol}/${timeframe}/${fileName}`;
                const uploadTask = storage.ref(storagePath).put(file);
                uploadTask.on('state_changed', (s) => { DOM.uploadProgress.textContent = `Uploading ${index + 1}/${files.length}: ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; }, (e) => { console.error("Upload Failed:", e); DOM.uploadProgress.textContent = `Upload Failed: ${e.code}`; }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        const imageData = { url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                        dbRefs.journalImages.child(safeSymbol).child(timeframe).push(imageData);
                        if (index === files.length - 1) { DOM.uploadProgress.textContent = 'Upload Complete!'; setTimeout(() => { DOM.uploadProgress.textContent = ''; }, 2000); }
                    });
                });
            });
        }

        function handleGenericLibraryUpload(files, libraryType, progressElement, dbRef) {
            if (!STATE.isMasterUser || !files || files.length === 0) return;
            progressElement.style.display = 'block';
            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `${libraryType}/${fileName}`;
                const uploadTask = storage.ref(storagePath).put(file);
                uploadTask.on('state_changed', (s) => { progressElement.textContent = `Uploading ${index + 1}/${files.length}: ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; }, (e) => { console.error(`${libraryType} Upload Failed:`, e); progressElement.textContent = `Upload Failed: ${e.code}`; }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        const imageData = { url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP, caption: '' };
                        dbRef.push(imageData);
                        if (index === files.length - 1) { progressElement.textContent = 'Upload Complete!'; setTimeout(() => { progressElement.textContent = ''; }, 2000); }
                    });
                });
            });
        }

        function calculateNetResult(trade, exitPrice, exitFeeType) {
            const entry = parseFloat(trade.entry);
            const posValue = parseFloat(trade.size); 
            const exit = parseFloat(exitPrice);
            if (isNaN(entry) || isNaN(posValue) || isNaN(exit)) return { net_result: 0, entry_fee: 0, exit_fee: 0 };
            const rates = getFeeRates(trade.exchange);
            const entryFeeRate = trade.entryFeeType === 'maker' ? rates.MAKER : rates.TAKER;
            const exitFeeRate = exitFeeType === 'maker' ? rates.MAKER : rates.TAKER;
            const entryFee = posValue * entryFeeRate; 
            const positionQty = posValue / entry;     
            const exitPosValue = positionQty * exit;  
            const exitFee = exitPosValue * exitFeeRate; 
            const grossResult = trade.type === "Long" ? (exit - entry) * positionQty : (entry - exit) * positionQty;
            return { net_result: grossResult - entryFee - exitFee, entry_fee: entryFee, exit_fee: exitFee };
        }

        function completeTrade(tradeId, outcome) {
            dbRefs.trades.child(tradeId).once('value', snapshot => {
                const trade = snapshot.val(); if (!trade) return;
                const exitPriceStr = prompt(`Enter exact exit price:`, outcome === 'win' ? trade.target : trade.stoploss);
                if (exitPriceStr === null) return;
                const currentSize = parseFloat(trade.size);
                const closeSizeStr = prompt(`How much Value ($) are you closing?\n(Current Total: $${currentSize.toFixed(2)})`, currentSize);
                if (closeSizeStr === null) return;
                let exitFeeType = null;
                while (exitFeeType !== 'maker' && exitFeeType !== 'taker') {
                    const exitFeeTypeStr = prompt(`Enter exit fee type (maker/taker):`, "taker");
                    if (exitFeeTypeStr === null) return;
                    exitFeeType = exitFeeTypeStr.toLowerCase().trim();
                }
                const exitPrice = parseFloat(exitPriceStr);
                const closingSize = parseFloat(closeSizeStr);
                if (isNaN(exitPrice) || isNaN(closingSize) || closingSize <= 0 || closingSize > currentSize) { return alert("Invalid input values."); }
                const tradePortion = { ...trade, size: closingSize };
                const result = calculateNetResult(tradePortion, exitPrice, exitFeeType);
                const completedTrade = { ...trade, size: closingSize, ...result, closed_date: firebase.database.ServerValue.TIMESTAMP, exit_price: exitPrice, exitFeeType: exitFeeType, note: (trade.note || '') + `\nClosed $${closingSize.toFixed(2)} @ $${exitPrice}` };
                if (Math.abs(currentSize - closingSize) < 1) { dbRefs.completedTrades.push(completedTrade).then(() => dbRefs.trades.child(tradeId).remove()); } 
                else {
                    const remainingSize = currentSize - closingSize;
                    const updatedLiveTrade = { size: remainingSize, note: (trade.note || '') + `\nPartial close: -$${closingSize.toFixed(2)} on ${new Date().toLocaleDateString()}` };
                    const recalcMetrics = calculateTradeMetrics({ ...trade, size: remainingSize });
                    Object.assign(updatedLiveTrade, recalcMetrics);
                    dbRefs.completedTrades.push(completedTrade);
                    dbRefs.trades.child(tradeId).update(updatedLiveTrade);
                }
            });
        }

        function openImageModal(imageArray, clickedIndex) {
            STATE.modalImageGallery = imageArray;
            STATE.modalImageIndex = clickedIndex;
            displayModalImage();
            DOM.imageModal.style.display = 'flex';
        }

        function displayModalImage() {
            if (STATE.modalImageIndex < 0 || STATE.modalImageIndex >= STATE.modalImageGallery.length) return;
            const currentImage = STATE.modalImageGallery[STATE.modalImageIndex];
            DOM.modalImageContent.src = currentImage.url;
            DOM.modalCaption.textContent = currentImage.caption || '';
            DOM.modalCaption.style.display = STATE.isMasterUser ? 'block' : 'none';
            DOM.modalPrevBtn.style.display = STATE.modalImageIndex > 0 ? 'flex' : 'none';
            DOM.modalNextBtn.style.display = STATE.modalImageIndex < STATE.modalImageGallery.length - 1 ? 'flex' : 'none';
        }

        function closeModal() {
            DOM.imageModal.style.display = 'none';
            STATE.modalImageGallery = [];
            STATE.modalImageIndex = -1;
        }

        let noteModalSaveTimer = null;
        function openNoteForEditing(noteId) {
            const note = STATE.generalNotes[noteId];
            if (!note) return;
            DOM.noteModalTitle.value = note.title || '';
            DOM.noteModalContent.value = note.content || '';
            DOM.noteEditModal.dataset.currentNoteId = noteId;
            DOM.noteEditModal.style.display = 'flex';
            setTimeout(() => { autoResizeTextarea(DOM.noteModalContent); DOM.noteModalContent.focus(); }, 0);
            DOM.noteModalTitle.readOnly = !STATE.isMasterUser;
            DOM.noteModalContent.readOnly = !STATE.isMasterUser;
        }

        function saveNoteFromModal() {
            if (!STATE.isMasterUser) return;
            const noteId = DOM.noteEditModal.dataset.currentNoteId;
            if (!noteId) return;
            clearTimeout(noteModalSaveTimer);
            noteModalSaveTimer = setTimeout(() => {
                const newTitle = DOM.noteModalTitle.value.trim();
                const newContent = DOM.noteModalContent.value;
                dbRefs.generalNotes.child(noteId).update({ title: newTitle, content: newContent });
            }, 500);
        }

        function closeNoteModal() {
            saveNoteFromModal(); 
            clearTimeout(noteModalSaveTimer);
            DOM.noteEditModal.style.display = 'none';
            DOM.noteEditModal.dataset.currentNoteId = '';
            DOM.noteModalTitle.value = '';
            DOM.noteModalContent.value = '';
            renderNotes(STATE.generalNotes);
        }

         function setupEventListeners() {
            DOM.themeToggle.addEventListener('change', (e) => {
                const theme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            });

            DOM.tabs.addEventListener('click', (e) => {
                if (!e.target.matches('.tab-link')) return;
                document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                const tabId = e.target.dataset.tab;
                const newTabContent = document.getElementById(`${tabId}-tab`);
                if (newTabContent) {
                    newTabContent.classList.add('active');
                    if (!newTabContent.dataset.sectionsInitialized) { openDefaultSectionsInContainer(newTabContent); newTabContent.dataset.sectionsInitialized = 'true'; }
                }
                DOM.statsPanelContainer.style.display = (tabId === 'tracker' || tabId === 'journal') ? 'block' : 'none';
                if (tabId === 'journal') { 
                    updateJournalView();
                    renderDateNavigation(); 
                }
            });

            DOM.statsFab.addEventListener('click', () => DOM.statsPanel.classList.toggle('active'));
            DOM.closeStatsBtn.addEventListener('click', () => DOM.statsPanel.classList.remove('active'));
            document.addEventListener('click', (e) => { if (!DOM.statsPanel.contains(e.target) && !DOM.statsFab.contains(e.target) && DOM.statsPanel.classList.contains('active')) { DOM.statsPanel.classList.remove('active'); } });
            
            DOM.tradesTbody.addEventListener('blur', (e) => { if (e.target.matches('.editable-cell')) handleLiveTradeUpdate(e.target); }, true);
            DOM.restingTradesTbody.addEventListener('blur', (e) => { if (e.target.matches('.editable-cell')) handleRestingTradeUpdate(e.target); }, true);
            DOM.addTradeForm.addEventListener('submit', handleAddTradeSubmit);

            document.body.addEventListener('click', (e) => {
                const header = e.target.closest('.collapsible-header');
                if (header) {
                    const section = header.parentElement;
                    const content = section.querySelector('.collapsible-content');
                    const toggleBtn = section.querySelector('.collapsible-toggle-btn');
                    section.classList.toggle('is-open');
                    toggleBtn.textContent = section.classList.contains('is-open') ? '−' : '+';
                    toggleBtn.style.transform = section.classList.contains('is-open') ? 'rotate(180deg)' : 'rotate(0deg)';
                    if (section.classList.contains('is-open')) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        setTimeout(() => { if (section.classList.contains('is-open')) content.style.maxHeight = content.scrollHeight + 'px'; }, 150);
                    } else { content.style.maxHeight = '0px'; }
                }
                if (handleAttachmentActions(e)) return;
                if (e.target.closest('#setups-image-container, #image-library-container')) { handleGenericImageLibraryClick(e); } 
                else if (e.target.closest('#trades-tbody, #completed-trades-tbody, #resting-trades-tbody')) { handleTradeAction(e); } 
                else if (e.target.id === 'toggle-all-completed-trades') { STATE.completedTradesShowAll = true; STATE.completedTradesCurrentPage = 1; renderCompletedTable(STATE.allCompletedTrades); } 
                else if (e.target.id === 'completed-trades-prev-page') { if (STATE.completedTradesCurrentPage > 1) { STATE.completedTradesCurrentPage--; renderCompletedTable(STATE.allCompletedTrades);  } } 
                else if (e.target.id === 'completed-trades-next-page') { const totalPages = Math.ceil(Object.keys(STATE.allCompletedTrades).length / STATE.completedTradesItemsPerPage); if (STATE.completedTradesCurrentPage < totalPages) { STATE.completedTradesCurrentPage++; renderCompletedTable(STATE.allCompletedTrades);  } } 
                else if (e.target.id === 'toggle-all-setups-images') { STATE.setupsImagesShowAll = true; STATE.setupsImagesCurrentPage = 1; renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images'); } 
                else if (e.target.id === 'setups-images-prev-page') { if (STATE.setupsImagesCurrentPage > 1) { STATE.setupsImagesCurrentPage--; renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images'); } } 
                else if (e.target.id === 'setups-images-next-page') { const totalPages = Math.ceil(Object.keys(STATE.allSetupsImages).length / STATE.setupsImagesItemsPerPage); if (STATE.setupsImagesCurrentPage < totalPages) { STATE.setupsImagesCurrentPage++; renderGenericImageLibrary(STATE.allSetupsImages, DOM.setupsImageContainer, 'setups_images'); } }
            });

            const calcFibBtn = document.getElementById('calc-fib-btn');
            if (calcFibBtn) { calcFibBtn.addEventListener('click', calculateFibLevels); }
            const fibResultsBody = document.getElementById('fib-results-tbody');
            if (fibResultsBody) { fibResultsBody.addEventListener('click', (e) => { const btn = e.target.closest('.add-fib-trade-btn'); if (btn) { const entry = btn.getAttribute('data-entry'); const size = btn.getAttribute('data-size'); const level = btn.getAttribute('data-level'); handleAddFibTrade(entry, size, level); } }); }
            
            if (DOM.calPrevBtn && DOM.calNextBtn) {
                DOM.calPrevBtn.addEventListener('click', () => { STATE.calendarViewDate.setMonth(STATE.calendarViewDate.getMonth() - 1); });
                DOM.calNextBtn.addEventListener('click', () => { STATE.calendarViewDate.setMonth(STATE.calendarViewDate.getMonth() + 1); });
            }

            if (DOM.createNewNoteBtn) {
                DOM.createNewNoteBtn.addEventListener('click', () => {
                    if (!STATE.isMasterUser) return;
                    const title = prompt("Enter a title for the new note:");
                    if (title && title.trim()) { dbRefs.generalNotes.push({ title: title.trim(), content: '', timestamp: firebase.database.ServerValue.TIMESTAMP }); }
                });
            }

            if (DOM.notesContainer) {
                DOM.notesContainer.addEventListener('click', (e) => {
                    const header = e.target.closest('.note-item-header');
                    const deleteBtn = e.target.closest('.note-delete-btn');
                    if (deleteBtn && STATE.isMasterUser) { e.stopPropagation(); const noteId = deleteBtn.dataset.noteId; if (confirm(`Are you sure you want to delete this note?`)) { dbRefs.generalNotes.child(noteId).remove(); } return; }
                    if (header) { const noteId = header.dataset.noteId; openNoteForEditing(noteId); }
                });
            }

            DOM.noteModalClose.addEventListener('click', closeNoteModal);
            DOM.noteEditModal.addEventListener('click', e => { if (e.target.id === 'note-edit-modal') closeNoteModal(); });
            DOM.noteModalTitle.addEventListener('input', saveNoteFromModal);
            DOM.noteModalContent.addEventListener('input', (e) => { autoResizeTextarea(e.target); saveNoteFromModal(); });

            document.body.addEventListener('blur', (e) => {
                if (e.target.matches('.setups-table .editable-setup-cell')) {
                    const table = e.target.closest('.setups-table');
                    const row = e.target.closest('tr');
                    applyHighlightingToSetupsTable(table);
                    if (row) { calculateAndDisplayPercentages(row); }
                    if (table.id === 'primary-setups-table') { saveSetupsTable(DOM.setupsTable1, dbRefs.setups1, DOM.setupsSaveStatus1, 'primary-setups-notes'); } else { saveSetupsTable(DOM.setupsTable2, dbRefs.setups2, DOM.setupsSaveStatus2, 'secondary-setups-notes'); }
                }
            }, true);
            
            DOM.journalMatrixContainer.addEventListener('input', (e) => {
                if (e.target.matches('.matrix-textarea')) {
                   autoResizeTextarea(e.target);
                   saveJournalMatrixInput(e.target);
                }
            });

            DOM.primarySetupsNotes.addEventListener('input', (e) => { autoResizeTextarea(e.target); debouncedResizeParent(e.target); });
            DOM.secondarySetupsNotes.addEventListener('input', (e) => { autoResizeTextarea(e.target); debouncedResizeParent(e.target); });
            DOM.primarySetupsNotes.addEventListener('blur', savePrimaryNotesOnly);
            DOM.secondarySetupsNotes.addEventListener('blur', saveSecondaryNotesOnly);

            DOM.setupsImageUpload.addEventListener('change', (e) => handleGenericLibraryUpload(e.target.files, 'setups_images', DOM.setupsUploadProgress, dbRefs.setupsImages));
            DOM.tradeImageUploader.addEventListener('change', (e) => handleAttachmentImageUpload(e.target.files));

            DOM.modalClose.addEventListener('click', closeModal);
            DOM.imageModal.addEventListener('click', (e) => { if (e.target.id === 'image-modal') closeModal(); });
            DOM.modalPrevBtn.addEventListener('click', () => { if (STATE.modalImageIndex > 0) { STATE.modalImageIndex--; displayModalImage(); } });
            DOM.modalNextBtn.addEventListener('click', () => { if (STATE.modalImageIndex < STATE.modalImageGallery.length - 1) { STATE.modalImageIndex++; displayModalImage(); } });

            [DOM.journalSymbolEl, DOM.journalTimeframeEl, DOM.journalImageFilterEl].forEach(el => el.addEventListener('change', () => { updateJournalView(false); renderDateNavigation(); }));
            DOM.dateButtonsContainer.addEventListener('click', (e) => { 
                if (e.target.matches('.date-nav-btn')) { 
                    const parts = e.target.dataset.date.split('-'); 
                    STATE.selectedDate = new Date(Date.UTC(parts[0], parseInt(parts[1], 10) - 1, parts[2])); 
                    STATE.centerDate = new Date(STATE.selectedDate); 
                    updateJournalView();
                    renderDateNavigation(); 
                } 
            });
            DOM.datePrevBtn.addEventListener('click', () => { STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() - 5); renderDateNavigation(); });
            DOM.dateNextBtn.addEventListener('click', () => { STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() + 5); renderDateNavigation(); });

            DOM.journalEntryEl.addEventListener('input', (e) => { autoResizeTextarea(e.target); debouncedResizeParent(e.target); saveJournalEntry(); });
            DOM.favouriteBtn.addEventListener('click', handleFavouriteClick);
            DOM.journalImageUpload.addEventListener('change', (e) => handleFileUpload(e.target.files));

            DOM.journalTab.addEventListener('click', (e) => {
                if (e.target.closest('.delete-journal-image')) { handleImageDelete(e); return; }
                const img = e.target.closest('#journal-images-container img');
                if(img) { const allImageElements = DOM.journalImagesContainer.querySelectorAll('img'); const imageArray = Array.from(allImageElements).map(el => ({ url: el.dataset.fullSrc, caption: el.dataset.caption })); const clickedIndex = Array.from(allImageElements).indexOf(img); openImageModal(imageArray, clickedIndex); }
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { DOM.journalTab.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }); });
            ['dragenter', 'dragover'].forEach(eventName => { DOM.journalTab.addEventListener(eventName, () => { if (STATE.isMasterUser) DOM.journalTab.classList.add('drag-over'); }); });
            DOM.journalTab.addEventListener('dragleave', () => DOM.journalTab.classList.remove('drag-over'));
            DOM.journalTab.addEventListener('drop', (e) => { DOM.journalTab.classList.remove('drag-over'); if (STATE.isMasterUser && e.dataTransfer?.files.length > 0) handleFileUpload(e.dataTransfer.files); });
        }

        function handleAddTradeSubmit(e) {
            e.preventDefault(); if (!STATE.isMasterUser) return;
            const status = document.getElementById('trade-status').value;
            const trade = { 
                symbol: document.getElementById('trade-symbol').value, 
                exchange: document.getElementById('trade-exchange').value,
                type: document.getElementById('trade-type').value, 
                setupType: document.getElementById('trade-setup-type').value, 
                entry: parseFloat(document.getElementById('entry-price').value), 
                stoploss: parseFloat(document.getElementById('stop-loss').value), 
                target: parseFloat(document.getElementById('target').value), 
                size: parseFloat(document.getElementById('position-value').value), 
                date: firebase.database.ServerValue.TIMESTAMP, 
                entry_prices: [],
                entryFeeType: document.getElementById('entry-fee-type').value
            };
            if (Object.values(trade).some(val => val === null || (isNaN(val) && typeof val === 'number'))) return alert('Please fill all fields correctly.');
            trade.entry_prices.push(trade.entry);
            const metrics = calculateTradeMetrics(trade);
            const tradeWithMetrics = { ...trade, ...metrics };
            const targetRef = (status === 'resting') ? dbRefs.restingOrders : dbRefs.trades;
            targetRef.push(tradeWithMetrics).then(() => e.target.reset()).catch(error => alert(`Error: ${error.message}`));
        }

        function handleLiveTradeUpdate(cell) {
            if (!STATE.isMasterUser) return;
            const tradeId = cell.dataset.id;
            const fieldToUpdate = cell.dataset.field;
            const tradeRef = dbRefs.trades.child(tradeId);
            tradeRef.once('value', snapshot => {
                const trade = snapshot.val(); if (!trade) { alert('Error: Trade not found.'); return; }
                const updates = {};
                if (fieldToUpdate === 'entry_prices') {
                    const newPricesArray = cell.textContent.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n > 0);
                    if (newPricesArray.length === 0) { alert("Invalid entry prices list."); cell.textContent = (trade.entry_prices || [trade.entry]).join(', '); return; }
                    updates.entry_prices = newPricesArray; updates.note = (trade.note || '') + `\nEntry list updated ${new Date().toLocaleString()}`; tradeRef.update(updates); return; 
                } 
                let newValue = parseFloat(cell.textContent.replace(/[^0-9.-]/g, ''));
                const precision = ['entry', 'stoploss', 'target'].includes(fieldToUpdate) ? 4 : 2;
                if (isNaN(newValue)) { alert('Invalid number.'); cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); return; }
                if (parseFloat(trade[fieldToUpdate]).toFixed(precision) === newValue.toFixed(precision)) { cell.textContent = newValue.toFixed(precision); return; }
                updates[fieldToUpdate] = newValue;
                const tempTradeForCalc = { ...trade, ...updates };
                const newMetrics = calculateTradeMetrics(tempTradeForCalc);
                Object.assign(updates, newMetrics);
                updates.note = (trade.note || '') + `\n${fieldToUpdate} updated to ${newValue.toFixed(precision)} on ${new Date().toLocaleString()}`;
                tradeRef.update(updates).catch(error => { alert('Failed to update trade: ' + error.message); cell.textContent = parseFloat(trade[fieldToUpdate]).toFixed(precision); });
            });
        }

        function handleAddStaggeredEntry(tradeId) {
            if (!STATE.isMasterUser) return;
            const tradeRef = dbRefs.trades.child(tradeId);
            tradeRef.once('value', snapshot => {
                const currentTrade = snapshot.val();
                if (!currentTrade) return alert('Error: Trade not found.');
                const newEntryPriceStr = prompt("Enter NEW entry price:"); if (newEntryPriceStr === null) return;
                const newPositionValueStr = prompt("Enter value ($) of this NEW position:"); if (newPositionValueStr === null) return;
                const newEntryFeeType = prompt("Enter fee type for this entry (maker/taker):", currentTrade.entryFeeType || 'taker'); if (newEntryFeeType === null) return;
                const newEntryPrice = parseFloat(newEntryPriceStr);
                const newPositionValue = parseFloat(newPositionValueStr);
                const isNewEntryMaker = newEntryFeeType.toLowerCase().trim() === 'maker';
                if (isNaN(newEntryPrice) || isNaN(newPositionValue) || newEntryPrice <= 0 || newPositionValue <= 0) { return alert("Invalid input."); }
                const currentSize = parseFloat(currentTrade.size); 
                const currentAvgEntry = parseFloat(currentTrade.entry);
                const currentQty = currentSize / currentAvgEntry;
                const newQty = newPositionValue / newEntryPrice;
                const totalQty = currentQty + newQty;
                const totalValueBasis = currentSize + newPositionValue;
                const newAverageEntryPrice = totalValueBasis / totalQty;
                const updatedEntryPrices = currentTrade.entry_prices || [currentTrade.entry];
                updatedEntryPrices.push(newEntryPrice);
                const tempTradeForCalc = { ...currentTrade, entry: newAverageEntryPrice, size: totalValueBasis };
                const newMetrics = calculateTradeMetrics(tempTradeForCalc);
                const updatedTrade = { ...currentTrade, entry: newAverageEntryPrice, size: totalValueBasis, entry_prices: updatedEntryPrices, ...newMetrics, note: (currentTrade.note || '') + `\n+ Added $${newPositionValue.toFixed(2)} @ $${newEntryPrice.toFixed(4)} (${isNewEntryMaker ? 'Maker' : 'Taker'})` };
                tradeRef.update(updatedTrade);
            });
        }

        function handleGenericImageLibraryClick(e) {
            const clickedImg = e.target.closest('img');
            if (clickedImg?.dataset.fullSrc) {
                const galleryContainer = clickedImg.closest('#setups-image-container, .trade-image-thumbnails');
                if (galleryContainer) { const allImageElements = galleryContainer.querySelectorAll('img'); const imageArray = Array.from(allImageElements).map(el => ({ url: el.dataset.fullSrc, caption: el.dataset.caption })); const clickedIndex = Array.from(allImageElements).indexOf(clickedImg); if (clickedIndex > -1) openImageModal(imageArray, clickedIndex); }
                return;
            }
            if (e.target.closest('#setups-image-container')) handleLibraryActions(e, 'setups_images', dbRefs.setupsImages);
        }

        function handleLibraryActions(e, libraryType, dbRef) {
            const deleteBtn = e.target.closest('.delete-library-image');
            const editBtn = e.target.closest('.edit-caption-btn');
            if (deleteBtn && STATE.isMasterUser) {
                const { id, filename } = deleteBtn.dataset;
                if (!filename || filename === 'undefined') { alert("Cannot delete image: Filename is missing."); return; }
                if (confirm(`Delete this image?\n\n${filename}`)) {
                    const storagePath = `${libraryType}/${filename}`;
                    storage.ref(storagePath).delete().then(() => { dbRef.child(id).remove(); }).catch((err) => {
                        if (err.code === 'storage/object-not-found') { dbRef.child(id).remove(); } 
                        else { console.error("Firebase Storage deletion failed:", err); alert('Error deleting image.'); }
                    });
                }
            } else if (editBtn && STATE.isMasterUser) {
                const { id } = editBtn.dataset;
                const imageRef = dbRef.child(id);
                imageRef.child('caption').once('value', snapshot => {
                    const newCaption = prompt('Enter image caption:', snapshot.val() || "");
                    if (newCaption !== null) { imageRef.update({ caption: newCaption.trim() }); }
                });
            }
        }

        function handleTradeAction(e) {
            if (!STATE.isMasterUser) return;
            if (STATE.isMerging) {
                const targetRow = e.target.closest('tr');
                if (targetRow && targetRow.parentElement.id === 'completed-trades-tbody' && !e.target.closest('button')) {
                    const absorbedTradeId = targetRow.querySelector('.action-buttons button')?.dataset.id;
                    if (absorbedTradeId) executeMerge(STATE.mergeBaseTradeId, absorbedTradeId);
                }
                return;
            }
            const button = e.target.closest('button'); 
            if (!button) return;
            const { id } = button.dataset;
            if (button.closest('#resting-trades-tbody')) {
                if (button.matches('.delete-resting-btn')) { if (confirm('Delete this resting order?')) { dbRefs.restingOrders.child(id).remove(); } } 
                else if (button.matches('.activate-btn')) {
                    if (confirm('Move this order to Live Trades?')) {
                        dbRefs.restingOrders.child(id).once('value', snapshot => {
                            const tradeData = snapshot.val();
                            if (tradeData) { const liveTrade = { ...tradeData, date: firebase.database.ServerValue.TIMESTAMP }; dbRefs.trades.push(liveTrade).then(() => dbRefs.restingOrders.child(id).remove()).catch(err => alert("Error moving trade: " + err.message)); }
                        });
                    }
                }
                return; 
            }
            const isCompleted = button.closest('tbody').id === 'completed-trades-tbody';
            const tradeRef = isCompleted ? dbRefs.completedTrades.child(id) : dbRefs.trades.child(id);
            if (button.matches('.win-btn')) completeTrade(id, 'win');
            else if (button.matches('.loss-btn')) completeTrade(id, 'loss');
            else if (button.matches('.add-to-position-btn')) handleAddStaggeredEntry(id);
            else if (button.matches('.merge-btn-completed')) initiateMerge(id);
            else if (button.matches('.delete-btn, .delete-btn-completed')) { if (confirm('Delete this trade?')) { resetMergeState(); tradeRef.remove(); } } 
            else if (button.matches('.note-btn, .note-btn-completed')) { tradeRef.child('note').once('value', snapshot => { const newNote = prompt("Enter Note 1:", snapshot.val() || ""); if (newNote !== null) tradeRef.update({ note: newNote }); }); }
            else if (button.matches('.note2-btn-completed')) { tradeRef.child('note2').once('value', snapshot => { const newNote2 = prompt("Enter Note 2:", snapshot.val() || ""); if (newNote2 !== null) tradeRef.update({ note2: newNote2 }); }); }
            else if (button.matches('.note3-btn-completed')) { tradeRef.child('note3').once('value', snapshot => { const newNote3 = prompt("Enter Note 3:", snapshot.val() || ""); if (newNote3 !== null) tradeRef.update({ note3: newNote3 }); }); }
        }

        function handleAttachmentActions(e) {
            const attachBtn = e.target.closest('.attach-image-btn'); if (attachBtn) { handleAttachAttachmentClick(attachBtn.dataset.id, attachBtn.dataset.type); return true; }
            const delImgBtn = e.target.closest('.delete-trade-image'); if (delImgBtn) { const { entryId, entryType, imageId, filename } = delImgBtn.dataset; handleDeleteAttachmentImage(entryId, entryType, imageId, filename); return true; }
            const img = e.target.closest('.trade-image-thumbnails img'); if (img) { handleGenericImageLibraryClick(e); return true; }
            return false;
        }

        function handleAttachAttachmentClick(entryId, entryType) {
            if (!STATE.isMasterUser) return;
            STATE.imageUploadContext = { id: entryId, type: entryType };
            DOM.tradeImageUploader.value = null; DOM.tradeImageUploader.click();
        }

        function handleAttachmentImageUpload(files) {
            if (!STATE.isMasterUser || !files || files.length === 0) return;
            const { id, type } = STATE.imageUploadContext; if (!id || !type) return;
            let dbRefPath, storagePathPrefix;
            switch (type) {
                case 'live': dbRefPath = CONFIG.DB_PATHS.TRADES; storagePathPrefix = `trade_attachments/${id}/`; break;
                case 'completed': dbRefPath = CONFIG.DB_PATHS.COMPLETED_TRADES; storagePathPrefix = `trade_attachments/${id}/`; break;
                default: return;
            }
            const entryDbRef = database.ref(dbRefPath).child(id);
            Array.from(files).forEach((file) => {
                if (!file.type.startsWith('image/')) return;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `${storagePathPrefix}${fileName}`;
                const uploadTask = storage.ref(storagePath).put(file);
                uploadTask.on('state_changed', null, (e) => { alert(`Upload failed for ${file.name}.`); }, () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                        entryDbRef.child('attachedImages').push({ url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP });
                    });
                });
            });
        }

        function handleDeleteAttachmentImage(entryId, entryType, imageId, fileName) {
            if (!STATE.isMasterUser || !entryId || !entryType || !imageId || !fileName) return;
            if (confirm(`Delete this attachment?\n\n${fileName}`)) {
                let dbRefPath, storagePathPrefix;
                switch (entryType) {
                    case 'live': dbRefPath = CONFIG.DB_PATHS.TRADES; storagePathPrefix = `trade_attachments/${entryId}/`; break;
                    case 'completed': dbRefPath = CONFIG.DB_PATHS.COMPLETED_TRADES; storagePathPrefix = `trade_attachments/${entryId}/`; break;
                    default: return;
                }
                const storagePath = `${storagePathPrefix}${fileName}`;
                const imageDbRef = database.ref(dbRefPath).child(entryId).child('attachedImages').child(imageId);
                storage.ref(storagePath).delete().then(() => imageDbRef.remove()).catch((err) => {
                    if (err.code === 'storage/object-not-found') imageDbRef.remove(); else alert('Error deleting attachment.');
                });
            }
        }

        function handleImageDelete(e) {
            const button = e.target.closest('.delete-journal-image'); if (!STATE.isMasterUser || !button) return;
            if (DOM.imageModal.style.display === 'flex' && DOM.modalImageContent.src === button.closest('.journal-image-wrapper').querySelector('img').src) closeModal();
            const { safeSymbol, timeframe, id, filename } = button.dataset;
            if (confirm(`Delete this image?\n\n${filename}`)) {
                const storagePath = `journal_images/${safeSymbol}/${timeframe}/${filename}`;
                const dbPath = `${CONFIG.DB_PATHS.JOURNAL_IMAGES}/${safeSymbol}/${timeframe}/${id}`;
                storage.ref(storagePath).delete().then(() => database.ref(dbPath).remove()).catch((err) => { if (err.code === 'storage/object-not-found') database.ref(dbPath).remove(); });
            }
        }

        function handleFavouriteClick() {
            if (!STATE.isMasterUser) return;
            const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value), timeframe = DOM.journalTimeframeEl.value;
            const currentText = DOM.journalEntryEl.value.trim();
            const dbFavouriteRef = dbRefs.favourites.child(safeSymbol).child(timeframe);
            if (DOM.favouriteBtn.classList.contains('active')) dbFavouriteRef.remove();
            else { if (!currentText) return alert('Cannot pin an empty note.'); dbFavouriteRef.set(currentText); }
        }

        function resetMergeState() {
            STATE.isMerging = false; STATE.mergeBaseTradeId = null;
            document.body.classList.remove('in-merge-mode');
            document.querySelectorAll('#completed-trades-tbody tr.is-merge-base').forEach(row => row.classList.remove('is-merge-base'));
        }

        function initiateMerge(baseTradeId) {
            if (STATE.isMerging && STATE.mergeBaseTradeId === baseTradeId) { resetMergeState(); alert('Merge cancelled.'); return; }
            resetMergeState(); STATE.isMerging = true; STATE.mergeBaseTradeId = baseTradeId;
            document.body.classList.add('in-merge-mode');
            const baseRow = document.querySelector(`#completed-trades-tbody button[data-id='${baseTradeId}']`).closest('tr');
            if (baseRow) baseRow.classList.add('is-merge-base');
            alert('MERGE MODE: Click another trade to merge into this one. Click "Merge" again to cancel.');
        }

        function executeMerge(baseTradeId, absorbedTradeId) {
            if (!baseTradeId || !absorbedTradeId || baseTradeId === absorbedTradeId) { resetMergeState(); return; }
            const completedTradesRef = dbRefs.completedTrades;
            completedTradesRef.once('value', snapshot => {
                const allTrades = snapshot.val();
                const baseTrade = allTrades[baseTradeId];
                const absorbedTrade = allTrades[absorbedTradeId];
                if (!baseTrade || !absorbedTrade) { alert('Error: Could not find one of the trades.'); resetMergeState(); return; }
                if (baseTrade.symbol !== absorbedTrade.symbol || baseTrade.type !== absorbedTrade.type) { alert('Error: Cannot merge trades with different symbols or types.'); resetMergeState(); return; }
                const baseSize = parseFloat(baseTrade.size); const baseEntry = parseFloat(baseTrade.entry); const baseQty = baseSize / baseEntry;
                const absorbedSize = parseFloat(absorbedTrade.size); const absorbedEntry = parseFloat(absorbedTrade.entry); const absorbedQty = absorbedSize / absorbedEntry;
                const totalQty = baseQty + absorbedQty;
                const totalSize = baseSize + absorbedSize; 
                const mergedEntry = totalSize / totalQty;
                const baseExitPrice = parseFloat(baseTrade.exit_price); const absorbedExitPrice = parseFloat(absorbedTrade.exit_price);
                const baseExitValue = baseQty * baseExitPrice; const absorbedExitValue = absorbedQty * absorbedExitPrice;
                const mergedExitPrice = (baseExitValue + absorbedExitValue) / totalQty;
                const mergedEntryPrices = [...(baseTrade.entry_prices || [baseTrade.entry]), ...(absorbedTrade.entry_prices || [absorbedTrade.entry])];
                const mergedNote = `${baseTrade.note || ''}\n--- MERGED ---\n${absorbedTrade.note || ''}`.trim();
                const mergedTrade = { ...baseTrade, entry: mergedEntry, size: totalSize, exit_price: mergedExitPrice, entry_prices: mergedEntryPrices, net_result: (parseFloat(baseTrade.net_result) || 0) + (parseFloat(absorbedTrade.net_result) || 0), entry_fee: (parseFloat(baseTrade.entry_fee) || 0) + (parseFloat(absorbedTrade.entry_fee) || 0), exit_fee: (parseFloat(baseTrade.exit_fee) || 0) + (parseFloat(absorbedTrade.exit_fee) || 0), date: Math.min(new Date(baseTrade.date).getTime(), new Date(absorbedTrade.date).getTime()), closed_date: Math.max(new Date(baseTrade.closed_date).getTime(), new Date(absorbedTrade.closed_date).getTime()), note: mergedNote, };
                const newMetrics = calculateTradeMetrics(mergedTrade);
                Object.assign(mergedTrade, newMetrics);
                const updates = { [baseTradeId]: mergedTrade, [absorbedTradeId]: null };
                completedTradesRef.update(updates).then(() => { alert('Trades merged successfully!'); resetMergeState(); }).catch(e => { alert(`Error merging trades: ${e.message}`); resetMergeState(); });
            });
        }

        function openCollapsibleSection(sectionElement) {
            if (!sectionElement || sectionElement.classList.contains('is-open')) return;
            const content = sectionElement.querySelector('.collapsible-content');
            const toggleBtn = sectionElement.querySelector('.collapsible-toggle-btn');
            if (content && toggleBtn) {
                sectionElement.classList.add('is-open'); 
                toggleBtn.textContent = '−'; 
                toggleBtn.style.transform = 'rotate(180deg)';
                setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; }, 50);
            }
        }

        function openDefaultSectionsInContainer(containerElement) {
            if (!containerElement) return;
            const sectionsToOpen = ['Resting Limit Orders', 'Live Trades', 'Completed Trades', 'Setups', 'Trading Setups', 'Add New Trade', 'Notes', 'My Notes', 'Charts', 'Misc', 'EMA Snapshot', 'PnL Calendar'];
            containerElement.querySelectorAll('.collapsible-header h2').forEach(h2 => {
                const title = h2.textContent.trim();
                if (sectionsToOpen.includes(title)) {
                    const section = h2.closest('.collapsible-section');
                    if (section && !(section.classList.contains('master-only') && !STATE.isMasterUser)) {
                        openCollapsibleSection(section);
                    }
                }
            });
        }

        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true') {
                const password = prompt("Please enter master password:");
                if (password) {
                    STATE.isMasterUser = true; STATE.masterPassword = password;
                    document.querySelectorAll('.master-only').forEach(el => {
                       if (el.classList.contains('collapsible-section') || el.id === 'favourite-btn') { el.style.display = 'block'; } 
                       else if (el.tagName === 'TH' || el.tagName === 'TD') { el.style.display = 'table-cell'; } 
                       else if (el.id.startsWith('save-setups-')) { el.style.display = 'inline-block'; } 
                       else { el.style.display = 'block'; }
                    });
                    DOM.journalEntryEl.readOnly = false;
                    document.querySelectorAll('.setups-table .editable-setup-cell').forEach(cell => cell.setAttribute('contenteditable', 'true'));
                    DOM.primarySetupsNotes.readOnly = false; DOM.secondarySetupsNotes.readOnly = false;
                    document.querySelectorAll('.matrix-textarea').forEach(el => el.readOnly = false);
                }
            }
            if (!STATE.isMasterUser) {
                DOM.journalEntryEl.readOnly = true;
                DOM.primarySetupsNotes.readOnly = true; DOM.secondarySetupsNotes.readOnly = true;
                document.querySelectorAll('.matrix-textarea').forEach(el => el.readOnly = true);
            }
        }

        async function initializeApp() {
            checkMasterMode(); 
            getViewerId();
            await fetchLiveConversionRate();
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) { document.documentElement.setAttribute('data-theme', savedTheme); DOM.themeToggle.checked = savedTheme === 'dark'; }
            const today = new Date(); 
            today.setUTCHours(0, 0, 0, 0);
            STATE.selectedDate = new Date(today); 
            STATE.centerDate = new Date(today);
            setupEventListeners(); 
            subscribeToData();
            renderDateNavigation(); 
            const activeTabContent = document.querySelector('.tab-content.active');
            if (activeTabContent) { openDefaultSectionsInContainer(activeTabContent); activeTabContent.dataset.sectionsInitialized = 'true'; }
        }

        initializeApp();
    });
</script>
</body>
</html>
