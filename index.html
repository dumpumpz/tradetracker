<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Link to your new stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">

        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">×</button></div>
                <div class="stats-grid">
                    <!-- Core Balance Stats -->
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">AUD Value (est.)</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L (AUD)</span><span id="stat-total-pl-aud" class="stat-value">A$0.00</span></div>

                    <hr style="grid-column: 1 / -1; border: 0; border-top: 1px solid var(--border-color); margin: 5px 0;">

                    <!-- Performance Metrics -->
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item">
                        <span class="stat-label">Wins / Losses</span>
                        <div><span id="stat-wins" class="stat-value" style="color: var(--green-text);">0</span> / <span id="stat-losses" class="stat-value" style="color: var(--red-text);">0</span></div>
                    </div>
                    <div class="stat-item"><span class="stat-label">Win Rate</span><span id="stat-win-rate" class="stat-value">0.0%</span></div>
                    <div class="stat-item"><span class="stat-label">Profit Factor</span><span id="stat-profit-factor" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Win</span><span id="stat-avg-win" class="stat-value" style="color: var(--green-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Loss</span><span id="stat-avg-loss" class="stat-value" style="color: var(--red-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Reward:Risk Ratio</span><span id="stat-reward-risk" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7-14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
        </div>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal & Setups</button>
            <button class="tab-link" data-tab="sr-levels">S/R Levels</button>
            <button class="tab-link" data-tab="charts">Charts</button>
            <button class="tab-link" data-tab="notes">Notes</button>
            <button class="tab-link" data-tab="options-oi">Options OI</button>
        </div>

        <div id="tracker-tab" class="tab-content active">

            <!-- Tracker Scratchpad Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Notes</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <textarea id="tracker-scratchpad" placeholder="Tracker scratchpad..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Add New Trade Section -->
            <div class="collapsible-section master-only">
                <div class="collapsible-header">
                    <h2>Add New Trade</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <form id="add-trade-form">
                            <div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                            <div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                            <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                            <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                            <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                            <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                            <div><button type="submit">Add Trade</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Live Trades Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Live Trades</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <!-- MODIFIED: Added RR column -->
                                    <tr><th>Symbol</th><th>Type</th><th>Avg. Entry</th><th>Entries</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Est. Total Fee ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>RR</th><th>Date Opened</th><th>Note</th><th>Charts</th><th class="master-only">Actions</th></tr>
                                </thead>
                                <tbody id="trades-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sentiment Log Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Sentiment Log</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="asset-sentiment-container">
                            <div class="sentiment-trackers-wrapper" style="margin-top: 0;">
                                <div class="sentiment-tracker master-only" id="sentiment-tracker-btc">
                                    <h4>BTC/USDT</h4>
                                    <div class="sentiment-buttons">
                                        <button data-asset="BTC/USDT" data-sentiment="long">Long</button>
                                        <button data-asset="BTC/USDT" data-sentiment="neutral">Neutral</button>
                                        <button data-asset="BTC/USDT" data-sentiment="short">Short</button>
                                    </div>
                                </div>
                                <div class="sentiment-tracker master-only" id="sentiment-tracker-eth">
                                    <h4>ETH/USDT</h4>
                                    <div class="sentiment-buttons">
                                        <button data-asset="ETH/USDT" data-sentiment="long">Long</button>
                                        <button data-asset="ETH/USDT" data-sentiment="neutral">Neutral</button>
                                        <button data-asset="ETH/USDT" data-sentiment="short">Short</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h4 style="text-align:center; margin-top:30px;">Sentiment History</h4>
                        <div class="table-wrapper">
                            <table id="sentiment-receipts-table">
                                <thead>
                                    <tr>
                                        <th>Asset</th><th>Sentiment</th><th class="note-header">Note</th><th>Charts</th><th>Timestamp</th><th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sentiment-receipts-tbody"></tbody>
                            </table>
                        </div>
                        <button id="toggle-all-sentiments" class="toggle-history-btn">Show All</button>
                        <div id="sentiment-pagination-controls" class="pagination-controls" style="display: none;">
                            <button id="sentiment-prev-page" class="pagination-btn">&lt; Prev</button>
                            <span id="sentiment-page-info"></span>
                            <button id="sentiment-next-page" class="pagination-btn">Next &gt;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Market Opens Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Levels</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="key-opens-container">
                            <div class="key-open-asset">
                                <h4>BTC/USDT</h4>
                                <table class="key-open-table">
                                    <tr>
                                        <td class="key-open-label">Daily:</td>
                                        <td id="btc-daily-open" class="key-open-price">--</td>
                                        <td class="key-open-note-cell"><textarea id="btc-daily-note" class="key-open-note" placeholder="" rows="1"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td class="key-open-label">Weekly:</td>
                                        <td id="btc-weekly-open" class="key-open-price">--</td>
                                        <td class="key-open-note-cell"><textarea id="btc-weekly-note" class="key-open-note" placeholder="" rows="1"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td class="key-open-label">Monthly:</td>
                                        <td id="btc-monthly-open" class="key-open-price">--</td>
                                        <td class="key-open-note-cell"><textarea id="btc-monthly-note" class="key-open-note" placeholder="" rows="1"></textarea></td>
                                    </tr>
                                </table>
                            </div>
                             <div class="key-open-asset">
                                <h4>ETH/USDT</h4>
                                <table class="key-open-table">
                                    <tr>
                                        <td class="key-open-label">Daily:</td>
                                        <td id="eth-daily-open" class="key-open-price">--</td>
                                        <td class="key-open-note-cell"><textarea id="eth-daily-note" class="key-open-note" placeholder="" rows="1"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td class="key-open-label">Weekly:</td>
                                        <td id="eth-weekly-open" class="key-open-price">--</td>
                                        <td class="key-open-note-cell"><textarea id="eth-weekly-note" class="key-open-note" placeholder="" rows="1"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td class="key-open-label">Monthly:</td>
                                        <td id="eth-monthly-open" class="key-open-price">--</td>
                                        <td class="key-open-note-cell"><textarea id="eth-monthly-note" class="key-open-note" placeholder="" rows="1"></textarea></td>
                                    </tr>
                                </table>
                            </div>
                            <div id="key-opens-last-updated">Last Updated: <span>--</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Setups Section (Combined) -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Trading Setups</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p class="ema-last-updated" id="crossover-signals-last-updated" style="margin-bottom: 25px;">Fetching signal data...</p>
                        <textarea id="primary-setups-notes" class="setups-notes-area" placeholder="Notes for Primary Setups..."></textarea>
                        
                        <div id="eth-crossover-signal-container" style="margin-bottom: 20px;"></div>
       
                        <div class="table-wrapper">
                            <table id="primary-setups-table" class="setups-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2">ETH</th>
                                        <th colspan="5">0-Candle</th>
                                        <th colspan="5">4-Candle</th>
                                        <th colspan="5">0-Candle Bounce</th>
                                    </tr>
                                    <tr>
                                        <th>Entry</th><th>Target</th><th>Tgt %</th><th>Stoploss</th><th>SL %</th>
                                        <th>Entry</th><th>Target</th><th>Tgt %</th><th>Stoploss</th><th>SL %</th>
                                        <th>Entry</th><th>Target</th><th>Tgt %</th><th>Stoploss</th><th>SL %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><th>1hour</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>2hour</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>4hour</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>daily</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>weekly</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>monthly</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                </tbody>
                            </table>
                        </div>

                
                        <div class="table-wrapper">
                             <table id="secondary-setups-table" class="setups-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2">BTC</th>
                                        <th colspan="5">0-Candle</th>
                                        <th colspan="5">4-Candle</th>
                                        <th colspan="5">0-Candle Bounce</th>
                                    </tr>
                                    <tr>
                                        <th>Entry</th><th>Target</th><th>Tgt %</th><th>Stoploss</th><th>SL %</th>
                                        <th>Entry</th><th>Target</th><th>Tgt %</th><th>Stoploss</th><th>SL %</th>
                                        <th>Entry</th><th>Target</th><th>Tgt %</th><th>Stoploss</th><th>SL %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><th>1hour</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>2hour</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>4hour</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>daily</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>weekly</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                    <tr><th>monthly</th><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td><td class="editable-setup-cell"></td><td class="percent-cell"></td></tr>
                                </tbody>
                            </table>
                       </div>

                       <div id="btc-crossover-signal-container" style="margin-top: 20px;"></div>

                       <textarea id="secondary-setups-notes" class="setups-notes-area" placeholder="Notes for Secondary Setups..."></textarea>

                        <div class="setups-controls">
                            <button id="save-setups-1-btn" class="master-only">Save Primary Setups</button>
                            <button id="save-setups-2-btn" class="master-only">Save Secondary Setups</button>
                            <p id="setups-save-status-1" class="setups-save-status"></p>
                            <p id="setups-save-status-2" class="setups-save-status"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setups Image Library Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Setups</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="setups-image-library-section">
                            <div id="setups-upload-section" class="master-only" style="text-align: center; margin-bottom: 20px;">
                                <label for="setups-image-upload" class="image-upload-label">Add Setup Image</label>
                                <input type="file" id="setups-image-upload" accept="image/*" multiple style="display:none;">
                                <div id="setups-upload-progress" style="margin-top: 10px; font-style: italic; color: var(--link-color);"></div>
                            </div>
                            <div id="setups-image-container"></div>
                            <button id="toggle-old-setups-images" class="toggle-history-btn">Show All</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Trades Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Completed Trades</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <!-- MODIFIED: Added RR column -->
                                    <tr><th>Symbol</th><th>Type</th><th>Avg. Entry</th><th>Entries</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Est. Profit ($)</th><th>Est. Loss ($)</th><th>RR</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th>Note</th><th>Charts</th><th class="master-only">Actions</th></tr>
                                </thead>
                                <tbody id="completed-trades-tbody"></tbody>
                            </table>
                        </div>
                        <button id="toggle-old-trades" class="toggle-history-btn">Show All</button>
                    </div>
                </div>
            </div>

            <!-- EMA Snapshot Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>
                        EMA Snapshot
                        <div class="pill-button-group">
                            <button class="ema-pill-btn active" data-symbol="BTC-USDT">BTC</button>
                            <button class="ema-pill-btn" data-symbol="ETH-USDT">ETH</button>
                        </div>
                    </h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner" id="ema-snapshot-container">
                        <p>Loading EMA data...</p>
                    </div>
                </div>
            </div>

        </div>

        <div id="journal-tab" class="tab-content">
            
            <!-- Persistent Notes Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Persistent Notes</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                         <textarea id="persistent-notes-entry" placeholder="Persistent scratchpad..."></textarea>
                    </div>
                </div>
            </div>

            <div class="controls-container" id="journal-controls">
                <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                <div>
                    <label for="journal-image-filter">Filter Images:</label>
                    <select id="journal-image-filter">
                        <option value="all" selected>All for Timeframe</option>
                        <option value="today">Selected Day Only</option>
                    </select>
                </div>
            </div>
            <div class="date-nav-container">
                <button id="date-prev" class="date-nav-arrow"><</button>
                <div id="date-buttons-container"></div>
                <button id="date-next" class="date-nav-arrow">></button>
            </div>

            <div id="favourited-entry-container" style="display: none;">
                <div class="favourited-header">
                    <span class="star-icon">⭐</span>
                    <span>Pinned Note for this Timeframe</span>
                </div>
                <div id="favourited-entry-text"></div>
            </div>

            <div class="journal-input-wrapper">
                 <button id="favourite-btn" class="master-only" title="Pin this note for this timeframe on all days">⭐</button>
                 <textarea id="journal-entry" placeholder="Select a symbol, timeframe, and date to view or add a journal entry."></textarea>
            </div>

            <p id="save-status" style="text-align:center;font-style:italic;color:#666;height:1em"></p>

            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture</label>
                <input type="file" id="journal-image-upload" accept="image/*" multiple>
                <div id="upload-progress"></div>
            </div>

            <div id="journal-images-container"></div>

            <div id="ema-key-container">
                <h4>Chart Key</h4>
                <div class="ema-key-list">
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #FFFFFF;"></span><span class="key-label">13 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #000000;"></span><span class="key-label">49 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #FF0000;"></span><span class="key-label">100 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #008000;"></span><span class="key-label">200 EMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #800080;"></span><span class="key-label">500 EMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #0000FF;"></span><span class="key-label">1000 EMA</span></div>
                </div>
            </div>

        </div>

        <div id="sr-levels-tab" class="tab-content">
            <div id="sr-legend-container">
                <div id="sr-legend-header" class="collapsed">
                    <h4>S/R Levels Key & Methodology</h4>
                    <button id="sr-legend-toggle-btn" title="Toggle Details">+</button>
                </div>
                <div id="sr-legend-content" style="display: none;">
                    <div id="sr-metadata-container">
                        <div class="metadata-item">
                            <span class="metadata-label">Lookback & Volatility:</span>
                            <span id="sr-metadata-dates" class="metadata-value">--</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Timeframes Analyzed:</span>
                            <span id="sr-metadata-timeframes" class="metadata-value">--</span>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Base Pivot Windows:</span>
                            <span id="sr-metadata-windows" class="metadata-value">--</span>
                        </div>
                    </div>
                    <div class="methodology-breakdown">
                        <div class="methodology-card">
                            <h4>1. Pivot Scoring</h4>
                             <div class="weight-group">
                                <p class="weight-group-title">Base Score Factors</p>
                                <div class="weight-item"><span>Timeframe:</span> <span>1.0x to 2.5x</span></div>
                                <div class="weight-item"><span>Pivot Source (Close):</span> <span>1.5x</span></div>
                                <div class="weight-item"><span>Pivot Source (Wick):</span> <span>1.0x</span></div>
                            </div>
                            <div class="weight-group">
                                <p class="weight-group-title">Strength Modifiers</p>
                                <div class="weight-item"><span>Recency Weight:</span> <span>45-Day Half-Life</span></div>
                                <div class="weight-item"><span>Volume Weight:</span> <span>1.0x to 2.0x</span></div>
                            </div>
                        </div>
                        <div class="methodology-card">
                            <h4>2. Clustering & Filtering</h4>
                            <ul class="card-description">
                                <li>Pivots are grouped into price clusters using DBSCAN.</li>
                                <li>The pivot-finding windows adapt to recent volatility (ATR).</li>
                                <li>A cluster is only considered valid if it passes two key filters:</li>
                                <li style="margin-left: 20px;"><strong>Liquidity:</strong> Must contain at least one pivot with high volume (>1.2x average).</li>
                                <li style="margin-left: 20px;"><strong>Reversal:</strong> Must contain at least one pivot candle that shows a price rejection.</li>
                            </ul>
                        </div>
                         <div class="methodology-card">
                            <h4>3. Final Zone Score</h4>
                             <p class="card-description" style="text-align: center;">
                                The final "Score" for each zone is the sum of the weighted strength scores of all individual pivots within that valid cluster.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-container">
                <div><label for="sr-symbol">Symbol:</label><select id="sr-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div>
                    <label for="sr-lookback">Lookback:</label>
                    <select id="sr-lookback">
                        <option value="60d">60 Days</option><option value="30d">30 Days</option><option value="21d">21 Days</option><option value="14d">14 Days</option><option value="7d">7 Days</option><option value="3d">3 Days</option><option value="2d">2 Days</option>
                    </select>
                </div>
            </div>

            <div id="sr-summary-zones-container" class="setups-container" style="margin-top: 25px; display: none;">
                <h3 style="text-align: center; margin-top: 0; margin-bottom: 15px;">Top Support & Resistance Zone</h3>
                <div class="table-wrapper">
                    <table id="sr-summary-table" class="sr-table">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding-left: 15px;">Lookback</th>
                                <th style="color: var(--green-text);">Top Support</th>
                                <th style="color: var(--red-text);">Top Resistance</th>
                            </tr>
                        </thead>
                        <tbody id="sr-summary-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <p class="ema-last-updated">Last Updated: <span id="sr-last-updated-time">--</span></p>

            <div id="sr-levels-container">
                <div class="sr-column support">
                    <h3>Top Support Zones</h3>
                    <div class="table-wrapper">
                        <table class="sr-table">
                            <thead>
                                <tr><th>Zone ($)</th><th>Center ($)</th><th>Score</th><th>Pivots</th></tr>
                            </thead>
                            <tbody id="support-levels-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="sr-column resistance">
                    <h3>Top Resistance Zones</h3>
                     <div class="table-wrapper">
                        <table class="sr-table">
                            <thead>
                                <tr><th>Zone ($)</th><th>Center ($)</th><th>Score</th><th>Pivots</th></tr>
                            </thead>
                            <tbody id="resistance-levels-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>

        <div id="charts-tab" class="tab-content">
            <!-- CHART LIBRARY 2 SECTION -->
            <div class="collapsible-section">
                 <div class="collapsible-header">
                    <h2>Charts</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="chart-library-2-section">
                            <div id="chart-library-2-container"></div>
                            <div id="chart-library-2-preview-section">
                                <h3 style="text-align: center; margin-top: 0; padding-top: 20px; border-top: 1px dashed var(--border-color);">Latest Uploads</h3>
                                <div id="chart-library-2-preview-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IMAGE LIBRARY SECTION -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Misc</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="image-library-section">
                            <div id="library-upload-section" class="master-only" style="text-align: center; margin-bottom: 20px;">
                                <label for="library-image-upload" class="image-upload-label">Add to Library</label>
                                <input type="file" id="library-image-upload" accept="image/*" multiple>
                                <div id="library-upload-progress" style="margin-top: 10px; font-style: italic; color: var(--link-color);"></div>
                            </div>
                            <div id="image-library-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notes-tab" class="tab-content">
            <div class="collapsible-section">
                 <div class="collapsible-header">
                    <h2>My Notes</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="notes-controls" class="master-only" style="text-align: right; margin-bottom: 20px;">
                            <button id="create-new-note-btn">Create New Note</button>
                        </div>
                        <div id="notes-container">
                        </div>
                    </div>
                </div>
            </div>
        </div>
     <div id="options-oi-tab" class="tab-content">
    
    <!-- Market Summary Dashboard -->
    <div id="market-summary-dashboard">
        <div class="dashboard-header">
            <h3>Market Structure Overview</h3>
            <p id="options-last-updated">Last Updated: --</p>
        </div>

        <!-- Key Metrics Grid -->
        <div class="summary-metrics-grid">
            <div class="summary-metric-card">
                <span class="label"><span class="tooltip">BTC Index Price<span class="tooltiptext">The current spot price of the underlying asset (BTC).</span></span></span>
                <span class="value" id="btc-index-price-value">--</span>
            </div>
            <div class="summary-metric-card">
                <span class="label"><span class="tooltip">Gamma Flip Level<span class="tooltiptext">The critical price level where dealer gamma exposure is estimated to flip from negative to positive. Price BELOW this level encourages volatility. Price ABOVE this level tends to suppress volatility.</span></span></span>
                <span class="value" id="gamma-flip-level-value">--</span>
            </div>
            <div class="summary-metric-card">
                <span class="label"><span class="tooltip">Market-Wide Max Pain<span class="tooltiptext">The strike price where the most options (puts & calls combined) would expire worthless. A theoretical point of 'financial gravity' for the market.</span></span></span>
                <span class="value" id="market-max-pain-value">--</span>
            </div>
            <div class="summary-metric-card">
                <span class="label"><span class="tooltip">Total Short Gamma<span class="tooltiptext">The total negative gamma exposure. A larger negative number indicates higher potential for volatile, reflexive market moves as dealers hedge.</span></span></span>
                <span class="value" id="total-short-gamma-value">--</span>
            </div>
        </div>

        <!-- OI Walls Section -->
        <div class="summary-walls-container">
            <div class="wall-column puts">
                <h4><span class="tooltip">Top Put Walls (Support)<span class="tooltiptext">The strikes with the most Put open interest across all expiries, acting as potential support levels.</span></span></h4>
                <div class="table-wrapper">
                    <table class="wall-table">
                        <thead><tr><th>Strike</th><th>OI (BTC)</th></tr></thead>
                        <tbody id="market-put-walls-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="wall-column calls">
                <h4><span class="tooltip">Top Call Walls (Resistance)<span class="tooltiptext">The strikes with the most Call open interest across all expiries, acting as potential resistance levels.</span></span></h4>
                <div class="table-wrapper">
                    <table class="wall-table">
                         <thead><tr><th>Strike</th><th>OI (BTC)</th></tr></thead>
                        <tbody id="market-call-walls-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Charts Section -->
    <h3 style="text-align: center; margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px;">Historical Context</h3>
    <p id="last-updated-charts">Loading chart data...</p>

    <div class="chart-container">
        <canvas id="priceGammaChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="gammaExposureChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="sentimentChart"></canvas>
    </div>
</div>
</div>
    <div id="image-modal" class="modal-overlay" style="display: none;">
        <span class="modal-close">&times;</span>
        <button id="modal-prev" class="modal-nav">&lt;</button>
        <img class="modal-content" id="modal-image-content">
        <button id="modal-next" class="modal-nav">&gt;</button>
        <div id="modal-caption"></div>
    </div>

    <div id="note-edit-modal" class="modal-overlay" style="display: none;">
        <div class="note-modal-container">
            <input type="text" id="note-modal-title" placeholder="Note Title">
            <textarea id="note-modal-content" placeholder="Start typing..."></textarea>
            <div class="note-modal-actions">
                <button id="note-modal-close">Close</button>
            </div>
        </div>
    </div>

    <input type="file" id="trade-image-uploader" accept="image/*" style="display:none;" multiple>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Link to your new script file -->
    <script src="script.js"></script>
</body>
</html>
