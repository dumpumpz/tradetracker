<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        h2 {
            margin-top: 40px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        p.subtitle {
            text-align: center;
            font-style: italic;
            margin-top: 0;
            color: #666;
        }

        .master-only {
            display: none;
        }

        #add-trade-form {
            max-width: 950px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }
        #add-trade-form div {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        input, select, button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 5px;
        }
        button.delete-btn, button.delete-btn-completed { background-color: #dc3545; }
        button.win-btn { background-color: #28a745; }
        button.loss-btn { background-color: #ffc107; color: #333; }

        button:hover { opacity: 0.85; }

        .action-buttons button {
            display: inline-block;
            width: auto;
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .table-wrapper { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        tr:nth-child(even) { background-color: #f9f9f9; }
        #loading-state, #loading-state-completed {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #777;
        }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; }
            h1 { font-size: 24px; }
            #add-trade-form { grid-template-columns: 1fr; }
            table, th, td { font-size: 12px; padding: 6px; }
        }
        @media (max-width: 480px) {
            table, th, td { font-size: 11px; padding: 4px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Live Trade Journal</h1>
        <p class="subtitle">Data updates in real-time for all viewers.</p>

        <form id="add-trade-form" class="master-only">
             <div>
                <label for="trade-symbol">Symbol:</label>
                <select id="trade-symbol">
                    <option value="BTCUSDT">BTCUSDT</option>
                    <option value="ETHUSDT">ETHUSDT</option>
                </select>
            </div>
            <div>
                <label for="trade-type">Trade Type:</label>
                <select id="trade-type">
                    <option value="Long">Long</option>
                    <option value="Short">Short</option>
                </select>
            </div>
            <div>
                <label for="entry-price">Entry Price:</label>
                <input type="number" id="entry-price" step="any" required>
            </div>
            <div>
                <label for="stop-loss">Stop Loss:</label>
                <input type="number" id="stop-loss" step="any" required>
            </div>
            <div>
                <label for="target">Target:</label>
                <input type="number" id="target" step="any" required>
            </div>
            <div>
                <label for="position-value">Position Value ($):</label>
                <input type="number" id="position-value" step="any" required>
            </div>
            <div>
                 <button type="submit">Add Trade</button>
            </div>
        </form>

        <h2>Live Trades</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Entry Price</th>
                        <th>Stop Loss</th>
                        <th>Target</th>
                        <th>Position Value ($)</th>
                        <th>Net Profit Est. ($)</th>
                        <th>Net Loss Est. ($)</th>
                        <th>Date Opened</th>
                        <th class="master-only">Actions</th>
                    </tr>
                </thead>
                <tbody id="trades-tbody">
                    <tr id="loading-state"><td colspan="9">Connecting to database...</td></tr>
                </tbody>
            </table>
        </div>

        <h2>Completed Trades</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Entry Price</th>
                        <th>Exit Price</th>
                        <th>Fees ($)</th>
                        <th>Net Result ($)</th>
                        <th>Date Opened</th>
                        <th>Date Closed</th>
                        <th class="master-only">Actions</th>
                    </tr>
                </thead>
                <tbody id="completed-trades-tbody">
                    <tr id="loading-state-completed"><td colspan="8">Loading completed trades...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
        authDomain: "journal-a003f.firebaseapp.com",
        databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "journal-a003f",
        storageBucket: "journal-a003f.appspot.com",
        messagingSenderId: "1038636626553",
        appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const tradesRef = database.ref('trades');
    const completedTradesRef = database.ref('completed_trades');
    const FEE_RATE = 0.00075; // 0.075%

    document.addEventListener('DOMContentLoaded', function () {
        let isMasterUser = false;

        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true') {
                isMasterUser = true;
                const form = document.getElementById('add-trade-form');
                if (form) form.style.display = 'grid';
                
                document.querySelectorAll('.master-only').forEach(el => {
                    el.style.display = 'table-cell';
                });

                document.getElementById('loading-state')?.firstElementChild?.setAttribute("colspan", "10");
                document.getElementById('loading-state-completed')?.firstElementChild?.setAttribute("colspan", "9");
            } else {
                document.getElementById('loading-state')?.firstElementChild?.setAttribute("colspan", "9");
                document.getElementById('loading-state-completed')?.firstElementChild?.setAttribute("colspan", "8");
            }
        }

        checkMasterMode();

        const addForm = document.getElementById('add-trade-form');
        const tradesTbody = document.getElementById('trades-tbody');
        const completedTradesTbody = document.getElementById('completed-trades-tbody');

        function renderLiveTable(tradesData) {
            tradesTbody.innerHTML = '';
            const colspan = isMasterUser ? 10 : 9;

            if (!tradesData) {
                tradesTbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">No live trades.</td></tr>`;
                return;
            }

            const tradeIds = Object.keys(tradesData).sort((a, b) => new Date(tradesData[b].date) - new Date(tradesData[a].date));
            tradeIds.forEach(tradeId => {
                const trade = tradesData[tradeId];
                const row = document.createElement('tr');
                row.setAttribute('data-id', tradeId);

                let masterColumn = '';
                if (isMasterUser) {
                    masterColumn = `
                    <td class="action-buttons">
                        <button class="win-btn" data-id="${tradeId}">Win</button>
                        <button class="loss-btn" data-id="${tradeId}">Loss</button>
                        <button class="delete-btn" data-id="${tradeId}">Delete</button>
                    </td>`;
                }

                row.innerHTML = `
                    <td>${trade.symbol}</td>
                    <td>${trade.type}</td>
                    <td>${parseFloat(trade.entry).toFixed(2)}</td>
                    <td>${parseFloat(trade.stoploss).toFixed(2)}</td>
                    <td>${parseFloat(trade.target).toFixed(2)}</td>
                    <td>${parseFloat(trade.size).toFixed(2)}</td>
                    <td style="color: #28a745;">${parseFloat(trade.expected_profit).toFixed(2)}</td>
                    <td style="color: #dc3545;">${parseFloat(trade.expected_loss).toFixed(2)}</td>
                    <td>${trade.date}</td>
                    ${masterColumn}
                `;
                tradesTbody.appendChild(row);
            });
        }
        
        function renderCompletedTable(tradesData) {
            completedTradesTbody.innerHTML = '';
            const colspan = isMasterUser ? 9 : 8;

            if (!tradesData) {
                completedTradesTbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">No completed trades yet.</td></tr>`;
                return;
            }

            const tradeIds = Object.keys(tradesData).sort((a, b) => new Date(tradesData[b].closed_date) - new Date(tradesData[a].closed_date));
            tradeIds.forEach(tradeId => {
                const trade = tradesData[tradeId];
                const row = document.createElement('tr');
                const resultColor = trade.net_result >= 0 ? '#28a745' : '#dc3545';
                
                let masterColumn = '';
                if (isMasterUser) {
                    masterColumn = `<td class="action-buttons"><button class="delete-btn-completed" data-id="${tradeId}">Delete</button></td>`;
                }
                
                const totalFees = (trade.entry_fee || 0) + (trade.exit_fee || 0);

                row.innerHTML = `
                    <td>${trade.symbol}</td>
                    <td>${trade.type}</td>
                    <td>${parseFloat(trade.entry).toFixed(2)}</td>
                    <td>${parseFloat(trade.exit_price).toFixed(2)}</td>
                    <td>${totalFees.toFixed(2)}</td>
                    <td style="color: ${resultColor}; font-weight: bold;">${parseFloat(trade.net_result).toFixed(2)}</td>
                    <td>${trade.date}</td>
                    <td>${trade.closed_date}</td>
                    ${masterColumn}
                `;
                completedTradesTbody.appendChild(row);
            });
        }

        function calculateNetResult(trade, exitPrice) {
            const entry = parseFloat(trade.entry);
            const posValue = parseFloat(trade.size);
            const exit = parseFloat(exitPrice);

            if (isNaN(entry) || isNaN(posValue) || isNaN(exit)) return { net_result: 0, entry_fee: 0, exit_fee: 0 };

            const entryFee = posValue * FEE_RATE;
            const exitPosValue = (exit / entry) * posValue;
            const exitFee = exitPosValue * FEE_RATE;

            let grossResult;
            if (trade.type === "Long") {
                grossResult = (exit - entry) * (posValue / entry);
            } else { // Short
                grossResult = (entry - exit) * (posValue / entry);
            }

            const netResult = grossResult - entryFee - exitFee;
            return { net_result: netResult, entry_fee: entryFee, exit_fee: exitFee };
        }

        function completeTrade(tradeId, outcome) {
            database.ref('trades/' + tradeId).once('value', (snapshot) => {
                const trade = snapshot.val();
                if (!trade) return;

                const defaultExit = outcome === 'win' ? trade.target : trade.stoploss;
                const exitPriceStr = prompt(`Enter the exact exit price:`, defaultExit);

                if (exitPriceStr === null || isNaN(parseFloat(exitPriceStr))) {
                    alert("Invalid exit price. Action cancelled.");
                    return;
                }
                const exitPrice = parseFloat(exitPriceStr);
                
                const { net_result, entry_fee, exit_fee } = calculateNetResult(trade, exitPrice);

                const completedTrade = {
                    ...trade,
                    closed_date: new Date().toLocaleString(),
                    exit_price: exitPrice,
                    net_result: net_result,
                    entry_fee: entry_fee,
                    exit_fee: exit_fee
                };
                
                // Remove unwanted properties from old trade
                delete completedTrade.expected_profit;
                delete completedTrade.expected_loss;

                completedTradesRef.push(completedTrade)
                    .then(() => {
                        database.ref('trades/' + tradeId).remove();
                    });
            });
        }
        
        // Listeners
        tradesRef.on('value', (snapshot) => renderLiveTable(snapshot.val()));
        completedTradesRef.on('value', (snapshot) => renderCompletedTable(snapshot.val()));

        addForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!isMasterUser) return;

            const newTrade = {
                symbol: document.getElementById('trade-symbol').value,
                date: new Date().toLocaleString(),
                type: document.getElementById('trade-type').value,
                entry: document.getElementById('entry-price').value,
                stoploss: document.getElementById('stop-loss').value,
                target: document.getElementById('target').value,
                size: document.getElementById('position-value').value
            };

            const profitCalc = calculateNetResult(newTrade, newTrade.target);
            const lossCalc = calculateNetResult(newTrade, newTrade.stoploss);
            
            newTrade.expected_profit = profitCalc.net_result;
            newTrade.expected_loss = lossCalc.net_result; // This will be negative

            tradesRef.push(newTrade);
            addForm.reset();
        });

        tradesTbody.addEventListener('click', function (e) {
            if (!isMasterUser) return;
            const target = e.target;
            const tradeId = target.dataset.id;
            if (!tradeId) return;

            if (target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to permanently delete this live trade?')) {
                    database.ref('trades/' + tradeId).remove();
                }
            } else if (target.classList.contains('win-btn')) {
                completeTrade(tradeId, 'win');
            } else if (target.classList.contains('loss-btn')) {
                completeTrade(tradeId, 'loss');
            }
        });

        completedTradesTbody.addEventListener('click', function (e) {
            if (!isMasterUser || !e.target.classList.contains('delete-btn-completed')) return;
            
            const tradeId = e.target.dataset.id;
            if (!tradeId) return;

            if (confirm('Are you sure you want to delete this completed trade? This cannot be undone.')) {
                completedTradesRef.child(tradeId).remove();
            }
        });
    });
</script>

</body>
</html>
