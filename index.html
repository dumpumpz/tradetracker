<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #333;
            --border-color: #ddd;
            --header-bg: #e9ecef;
            --link-color: #007bff;
            --subtle-text: #666;
            --card-bg: #fafafa;
            --shadow-color: rgba(0,0,0,0.1);
            --green-bg: #d4edda;
            --red-bg: #f8d7da;
            --purple-bg: #e2d9f3;
            --green-border: #c3e6cb;
            --red-border: #f5c6cb;
            --green-text: #155724;
            --red-text: #721c24;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --header-bg: #2c2c2c;
            --link-color: #58a6ff;
            --subtle-text: #888;
            --card-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.4);
            --green-bg: #1c3b23;
            --red-bg: #4d1f24;
            --purple-bg: #3c2a4d;
            --green-border: #285732;
            --red-border: #6b282e;
            --green-text: #a7d7b2;
            --red-text: #f5b7bd;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: auto; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
        h1 { text-align: center; color: var(--text-color); margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        h3 { text-align: center; color: var(--text-color); margin-top: 30px; margin-bottom: -5px; font-weight: 500;}
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: var(--subtle-text); }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .master-only { display: none; }
        #add-trade-form { max-width: 950px; margin: 20px auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--card-bg); grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button:hover { opacity: 0.85; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
        th { background-color: var(--header-bg); font-weight: bold; vertical-align: middle; text-align: center; }
        .action-buttons button { padding: 5px 8px; font-size: 12px; margin-right: 4px; }

        .note-cell { white-space: normal; max-width: 300px; min-width: 150px; font-size: 12px; line-height: 1.4; }

        #journal-tab, #snapshot-tab, #sr-levels-tab { position: relative; }
        .controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin: 20px auto; }
        .controls-container > div { display: flex; align-items: center; gap: 8px; }
        
        #journal-entry, #persistent-notes-entry {
            width: 100%; 
            resize: vertical;
            line-height: 1.6;
            margin-top: 5px;
            overflow-y: hidden; 
            min-height: 120px; 
        }
        
        #journal-entry:read-only, #persistent-notes-entry:read-only { 
            background-color: var(--card-bg); 
            cursor: not-allowed; 
        }
        
        #image-upload-section { margin-top: 20px; border-top: 1px dashed var(--border-color); padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload, #library-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: var(--link-color); }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid var(--border-color); padding: 5px; background: var(--card-bg); border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; border-radius: 2px; }
        
        .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; opacity: 0.7; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .journal-image-wrapper:hover .delete-journal-image { opacity: 1; transform: scale(1.1); }
        .delete-journal-image svg { width: 16px; height: 16px; fill: white; }

        #ema-key-container { margin: 25px auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); max-width: 80%; }
        #ema-key-container h4 { text-align: center; margin-top: 0; margin-bottom: 15px; color: var(--subtle-text); }
        .ema-key-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px 25px; }
        .key-item { display: flex; align-items: center; }
        .key-color-swatch { width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; border: 1px solid var(--border-color); }
        .key-label { font-size: 14px; }

        #journal-tab.drag-over { border: 3px dashed var(--link-color); background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: var(--link-color); z-index: 999; pointer-events: none; }
        
        #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
        #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        #stats-fab:hover { transform: scale(1.1); }
        #stats-fab svg { width: 28px; height: 28px; fill: white; }
        #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s; pointer-events: none; }
        #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .stats-header h3 { margin: 0; font-size: 18px; color: var(--text-color); }
        #close-stats-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 5px; line-height: 1; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
        .stat-label { font-size: 14px; color: var(--subtle-text); }
        .stat-value { font-size: 16px; font-weight: 600; color: var(--text-color); }
        #stat-balance-aud { font-size: 14px; color: var(--subtle-text); }
        
        .date-nav-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px auto 20px auto; }
        #date-buttons-container { display: flex; gap: 8px; }
        .date-nav-btn { padding: 8px 12px; font-size: 14px; background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--subtle-text); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; }

        .date-nav-btn.active { background-color: var(--link-color); color: white; border-color: var(--link-color); font-weight: bold; }
        .date-nav-btn.has-entry { border-bottom: 3px solid var(--green-border); }
        .date-nav-arrow { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 10px; }


        #ema-data-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        #ema-data-section h2 { margin-top: 0; border-top: none; text-align: center; }
        .ema-last-updated { text-align: center; font-style: italic; color: var(--subtle-text); font-size: 14px; margin-bottom: 20px; }
        .ema-table-container { margin-bottom: 30px; }
        .ema-table-container h4 { font-size: 11px; margin-bottom: 5px; text-align: center; }
        .ema-table-container .current-price-display { text-align: center; font-size: 11px; color: var(--text-color); }
        .price-value { font-weight: bold; }
        .ema-table th, .ema-table td { font-family: inherit; font-size: 11px; padding: 10px 8px; }
        .ema-table th { font-weight: bold; background-color: var(--header-bg); color: var(--subtle-text); }
        .ema-table td:first-child { font-weight: bold; text-align: left; color: var(--link-color); padding-left: 15px; }

        .ema-summary-container {
            font-size: 13px;
            padding: 8px 12px;
            margin: 0 auto 15px auto;
            max-width: 95%;
            border-radius: 6px;
            background-color: var(--bg-color);
        }
        .ema-level-summary {
            line-height: 1.5;
        }

        .ema-level-summary ul {
            margin: 5px 0 0 0;
            padding-left: 20px;
            list-style-type: disc;
        }
        .ema-level-summary li {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        .ema-level-summary strong {
            font-weight: 600;
        }
        .ema-level-summary .support { color: var(--green-text); }
        .ema-level-summary .resistance { color: var(--red-text); }


        #snapshot-images-container { display: flex; flex-direction: column; align-items: center; gap: 25px; margin-top: 20px; }
        .snapshot-image-item { width: 100%; max-width: 900px; }
        .snapshot-image-item h4 { text-align: center; margin-bottom: 8px; font-size: 18px; color: var(--subtle-text); text-transform: capitalize; }
        .snapshot-image-item .journal-image-wrapper { max-width: 100%; margin: auto; }

        #sr-legend-container {
            margin: 0 auto 10px auto;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        #sr-legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }
        #sr-legend-header.collapsed {
            border-bottom-color: transparent;
        }
        #sr-legend-header h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
        }
        #sr-legend-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            font-weight: bold;
            margin: 0;
            transition: transform 0.3s ease, color 0.2s, border-color 0.2s;
        }
        #sr-legend-header:hover #sr-legend-toggle-btn {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        #sr-legend-content {
            padding: 15px;
            display: block;
        }
        #sr-metadata-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            padding: 0;
            margin: 0;
            background-color: transparent;
            border: none;
            text-align: center;
        }
        #sr-levels-tab .controls-container {
            margin-bottom: 25px;
            padding: 10px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .metadata-item { font-size: 14px; }
        .metadata-label { font-weight: bold; color: var(--subtle-text); display: block; margin-bottom: 4px; }
        .metadata-value { font-family: 'Courier New', Courier, monospace; color: var(--text-color); }
        .rating-explanation { text-align: left; margin-top: 5px; font-size: 13px; line-height: 1.5; white-space: pre; }
        
        #sr-levels-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .sr-column h3 { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid; }
        .sr-column.support h3 { color: #28a745; border-color: #28a745; }
        .sr-column.resistance h3 { color: #dc3545; border-color: #dc3545; }
        .sr-level-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; background-color: var(--card-bg); }
        .sr-level-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--header-bg); }
        .sr-level-price-range { font-size: 18px; font-weight: bold; font-family: 'Courier New', Courier, monospace; }
        .sr-level-strength { font-size: 14px; font-weight: 500; color: #fff; padding: 4px 10px; border-radius: 12px; }
        .sr-column.support .sr-level-strength { background-color: #28a745; }
        .sr-column.resistance .sr-level-strength { background-color: #dc3545; }
        .sr-level-pivots { padding: 15px; font-size: 13px; color: var(--subtle-text); }
        .sr-level-pivots span { font-weight: 600; color: var(--text-color); }
        .sr-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            text-align: center;
            font-size: 14px;
            color: var(--subtle-text);
        }
        .sr-summary span {
            font-weight: bold;
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
        }

        .price-above { color: #dc3545 !important; }
        .price-below { color: #28a745 !important; }

        .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 20px; z-index: 10; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: var(--link-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .journal-input-wrapper {
            position: relative;
        }
        #favourite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            padding: 0;
            margin: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: #ccc; 
            cursor: pointer;
            display: none; 
            transition: all 0.2s ease;
            z-index: 5;
        }
        #favourite-btn:hover {
            border-color: #ffc107;
            color: #ffc107;
        }
        #favourite-btn.active {
            color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }
        #favourited-entry-container {
            background-color: var(--purple-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .favourited-header {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 14px;
        }
        .favourited-header .star-icon {
            font-size: 18px;
            margin-right: 8px;
            color: #ffc107;
        }
        #favourited-entry-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
        }
        
        .setups-table th:first-child { text-align: left; padding-left: 15px; color: var(--link-color); }
        .setups-table td { text-align: center; }
        .setups-table td[contenteditable="true"]:focus {
            background-color: var(--header-bg);
            outline: 2px solid var(--link-color);
            box-shadow: 0 0 5px var(--shadow-color);
        }
        
        .setups-container {
            margin-bottom: 30px; 
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        .setups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            cursor: pointer;
        }
        .setups-header h2 {
            margin: 0;
            font-size: 18px;
            padding: 0;
            border: none;
        }
        .setups-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            font-weight: bold;
            margin: 0;
            transition: transform 0.3s ease, color 0.2s, border-color 0.2s;
        }
        .setups-header:hover .setups-toggle-btn {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .setups-controls {
            text-align: center;
            margin-top: 15px;
        }
        .setups-save-status {
            text-align:center;
            font-style:italic;
            color:var(--subtle-text);
            height:1em;
        }

        /* --- UPDATED: Asset Sentiment Styles --- */
        #asset-sentiment-container {
            max-width: 950px;
            margin: 20px auto 10px auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        #asset-sentiment-container h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 5px;
            border: none;
            padding: 0;
        }
        .sentiment-trackers-wrapper {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .sentiment-tracker {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
            text-align: center;
        }
        .sentiment-tracker h4 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--subtle-text);
        }
        .sentiment-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .sentiment-buttons button {
            flex: 1;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .sentiment-buttons button:hover {
            opacity: 1;
            border-color: var(--link-color);
        }
        .sentiment-buttons button:active {
            transform: scale(0.95);
            background-color: var(--header-bg);
        }

        .sentiment-note-cell {
            white-space: normal; /* Allow text to wrap */
            max-width: 250px;
            font-size: 13px;
        }

        #sentiment-receipts-table td:nth-child(2) {
            text-transform: capitalize;
            font-weight: bold;
        }

        .delete-sentiment-btn {
            background: none;
            border: none;
            color: var(--red-text);
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
            margin: 0;
            line-height: 1;
            opacity: 0.6;
        }
        .delete-sentiment-btn:hover {
            opacity: 1;
        }
        .edit-sentiment-note-btn {
            background-color: var(--subtle-text);
            color: var(--container-bg);
            border: none;
        }
        .edit-sentiment-note-btn:hover {
            background-color: var(--link-color);
        }

        /* --- NEW: Image Library Styles --- */
        #image-library-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
        }
        .library-image-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            padding: 5px;
            background: var(--container-bg);
            border-radius: 4px;
            aspect-ratio: 16 / 9;
            overflow: hidden;
        }
        .library-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .library-image-wrapper:hover img {
            transform: scale(1.05);
        }
        .delete-library-image {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(220, 53, 69, 0.85);
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease-in-out;
            opacity: 0;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .library-image-wrapper:hover .delete-library-image {
            opacity: 1;
            transform: scale(1.1);
        }
        .delete-library-image svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        /* --- NEW: Image Modal Styles --- */
        .modal-overlay {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            animation-name: fadeIn;
            animation-duration: 0.3s;
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90vw;
            max-height: 90vh;
            animation-name: zoomIn;
            animation-duration: 0.4s;
        }
        @keyframes fadeIn {
            from {opacity: 0}
            to {opacity: 1}
        }
        @keyframes zoomIn {
            from {transform:scale(0.1)}
            to {transform:scale(1)}
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        @media (max-width: 768px) { 
            .container { padding: 10px; } 
            #add-trade-form { grid-template-columns: 1fr; } 
            .section-header { flex-direction: column; } 
            .backup-controls { position: static; margin-top: 10px; } 
            .journal-image-wrapper { max-width: 100%; } 
            th, td { font-size: 12px; padding: 6px; } 
            .action-buttons button { font-size: 11px; padding: 4px 8px; } 
            #stats-panel-container { bottom: 10px; left: 10px; }
            #stats-fab { width: 50px; height: 50px; }
            #stats-panel { width: calc(100vw - 40px); }
            #sr-levels-container { grid-template-columns: 1fr; }
            #sr-metadata-container { flex-direction: column; }
            .theme-switch-wrapper { top: 8px; right: 10px; }
        }

                /* --- Add these new rules to your <style> block --- */

        .library-image-wrapper {
            /* Add this to make room for the caption */
            display: flex;
            flex-direction: column;
        }

        .library-image-wrapper img {
            /* Make image fill the available space */
            flex-grow: 1;
            min-height: 0; /* Important for flexbox shrinking */
        }
        
        .library-image-caption {
            font-size: 12px;
            color: var(--subtle-text);
            padding: 6px 4px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

       .edit-caption-btn {
            position: absolute;
            top: 8px;   /* MOVED to top */
            left: 8px;  /* MOVED to left */
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(0, 123, 255, 0.85); /* Blue */
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease-in-out;
            opacity: 0;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .library-image-wrapper:hover .edit-caption-btn {
            opacity: 1;
            transform: scale(1.1);
        }
        .edit-caption-btn svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        #modal-caption {
            text-align: center;
            color: #ccc;
            padding: 15px 0;
            font-size: 18px;
            line-height: 1.4;
            max-width: 80vw;
        }








                /* --- Replace the old rules with these corrected ones --- */

        .library-image-wrapper {
            position: relative;
            border: 1px solid var(--border-color);
            padding: 5px;
            background: var(--container-bg);
            border-radius: 4px;
            /* Adjusting aspect ratio to be slightly taller to better accommodate captions */
            aspect-ratio: 4 / 3; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .library-image-caption {
            font-size: 12px;
            line-height: 1.4; /* Improves readability for wrapped text */
            color: var(--subtle-text);
            padding: 4px;
            text-align: center;
            /* REMOVED white-space: nowrap to allow wrapping */
            /* The parent flex container handles the rest */
        }

        .edit-caption-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(0, 123, 255, 0.85); /* Blue */
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease-in-out;
            opacity: 0;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">√ó</button></div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">AUD Value (est.)</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <!-- Added AUD PNL -->
                    <div class="stat-item"><span class="stat-label">Total P/L (AUD)</span><span id="stat-total-pl-aud" class="stat-value">A$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
        </div>

    
        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal & Setups</button>
            <button class="tab-link" data-tab="snapshot">Snapshot</button>
            <button class="tab-link" data-tab="sr-levels">S/R Levels</button>
        </div>
        
        <div id="tracker-tab" class="tab-content active">
            <form id="add-trade-form" class="master-only">
                <div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                <div><button type="submit">Add Trade</button></div>
            </form>

            <div id="asset-sentiment-container">
               <h4>Sentiment Log üëÄ</h4>
                <div class="sentiment-trackers-wrapper">
                    <div class="sentiment-tracker" id="sentiment-tracker-btc">
                        <h4>BTC/USDT</h4>
                        <div class="sentiment-buttons">
                            <button data-asset="BTC/USDT" data-sentiment="long">Long</button>
                            <button data-asset="BTC/USDT" data-sentiment="neutral">Neutral</button>
                            <button data-asset="BTC/USDT" data-sentiment="short">Short</button>
                        </div>
                    </div>
                    <div class="sentiment-tracker" id="sentiment-tracker-eth">
                        <h4>ETH/USDT</h4>
                        <div class="sentiment-buttons">
                            <button data-asset="ETH/USDT" data-sentiment="long">Long</button>
                            <button data-asset="ETH/USDT" data-sentiment="neutral">Neutral</button>
                            <button data-asset="ETH/USDT" data-sentiment="short">Short</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-header"><h2>Sentiment Log</h2></div>
            <div class="table-wrapper">
                <table id="sentiment-receipts-table">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Sentiment</th>
                            <th class="note-header">Note</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sentiment-receipts-tbody"></tbody>
                </table>
            </div>

            <!-- NEW IMAGE LIBRARY SECTION -->
            <div id="image-library-section">
                <div class="section-header">
                    <h2>Chart Library</h2>
                </div>
                <div id="library-upload-section" class="master-only" style="text-align: center; margin-bottom: 20px;">
                    <label for="library-image-upload" class="image-upload-label">Add to Library</label>
                    <input type="file" id="library-image-upload" accept="image/*" multiple>
                    <div id="library-upload-progress" style="margin-top: 10px; font-style: italic; color: var(--link-color);"></div>
                </div>
                <div id="image-library-container">
                    <!-- Thumbnails will be rendered here by JavaScript -->
                </div>
            </div>

            <div class="section-header"><h2>Live Trades</h2></div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Est. Total Fee ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>Date Opened</th><th>Note</th><th class="master-only">Actions</th></tr>
                    </thead>
                    <tbody id="trades-tbody"></tbody>
                </table>
            </div>
            <div class="section-header"><h2>Completed Trades</h2></div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <!-- Added Target column -->
                        <tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Target</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th>Note</th><th class="master-only">Actions</th></tr>
                    </thead>
                    <tbody id="completed-trades-tbody"></tbody>
                </table>
            </div>
        </div>

        <div id="journal-tab" class="tab-content">
            
        
            <div style="margin-bottom: 25px;">
                <textarea id="persistent-notes-entry" placeholder="Persistent scratchpad..."></textarea>
            </div>

            <div class="setups-container">
                <div class="setups-header" data-target="#setups-table-wrapper-1">
                    <h2>Primary Setups</h2>
                    <button class="setups-toggle-btn">‚àí</button>
                </div>
                <div class="table-wrapper" id="setups-table-wrapper-1">
                    <table id="current-setups-table-1" class="setups-table">
                        <thead>
                            <tr>
                                <th rowspan="2">TF</th>
                                <th colspan="3">0-Candle</th>
                                <th colspan="3">4-Candle</th>
                            </tr>
                            <tr>
                                <th>Entry</th>
                                <th>Target</th>
                                <th>Stoploss</th>
                                <th>Entry</th>
                                <th>Target</th>
                                <th>Stoploss</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><th>5min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>15min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>30min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>1hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>2hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>4hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>daily</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>weekly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>monthly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="setups-controls">
                    <button id="save-setups-1-btn" class="master-only">Save Primary Setups</button>
                    <p id="setups-save-status-1" class="setups-save-status"></p>
                </div>
            </div>

            <div class="setups-container">
                <div class="setups-header" data-target="#setups-table-wrapper-2">
                    <h2>Secondary Setups</h2>
                    <button class="setups-toggle-btn">‚àí</button>
                </div>
                <div class="table-wrapper" id="setups-table-wrapper-2">
                     <table id="current-setups-table-2" class="setups-table">
                        <thead>
                            <tr>
                                <th rowspan="2">TF</th>
                                <th colspan="3">0-Candle</th>
                                <th colspan="3">4-Candle</th>
                            </tr>
                            <tr>
                                <th>Entry</th>
                                <th>Target</th>
                                <th>Stoploss</th>
                                <th>Entry</th>
                                <th>Target</th>
                                <th>Stoploss</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><th>5min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>15min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>30min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>1hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>2hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>4hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>daily</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>weekly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><th>monthly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
                 <div class="setups-controls">
                    <button id="save-setups-2-btn" class="master-only">Save Secondary Setups</button>
                    <p id="setups-save-status-2" class="setups-save-status"></p>
                </div>
            </div>
            
            <div class="controls-container" id="journal-controls">
                <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                <div>
                    <label for="journal-image-filter">Filter Images:</label>
                    <select id="journal-image-filter">
                        <option value="all" selected>All for Timeframe</option>
                        <option value="today">Selected Day Only</option>
                    </select>
                </div>
            </div>
            <div class="date-nav-container">
                <button id="date-prev" class="date-nav-arrow"><</button>
                <div id="date-buttons-container"></div>
                <button id="date-next" class="date-nav-arrow">></button>
            </div>
            
            <div id="favourited-entry-container" style="display: none;">
                <div class="favourited-header">
                    <span class="star-icon">‚≠ê</span>
                    <span>Pinned Note for this Timeframe</span>
                </div>
                <div id="favourited-entry-text"></div>
            </div>

            <div class="journal-input-wrapper">
                 <button id="favourite-btn" class="master-only" title="Pin this note for this timeframe on all days">‚≠ê</button>
                 <textarea id="journal-entry" placeholder="Select a symbol, timeframe, and date to view or add a journal entry."></textarea>
            </div>

            <p id="save-status" style="text-align:center;font-style:italic;color:#666;height:1em"></p>
            
            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture</label>
                <input type="file" id="journal-image-upload" accept="image/*" multiple>
                <div id="upload-progress"></div>
            </div>
            
            <div id="journal-images-container"></div>

            <div id="ema-key-container">
                <h4>Chart Key</h4>
                <div class="ema-key-list">
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #FFFFFF;"></span><span class="key-label">13 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #000000;"></span><span class="key-label">49 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #FF0000;"></span><span class="key-label">100 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #008000;"></span><span class="key-label">200 EMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #800080;"></span><span class="key-label">500 EMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #0000FF;"></span><span class="key-label">1000 EMA</span></div>
                </div>
            </div>
            
            <div id="ema-data-section">
                
                <p class="ema-last-updated">Last Updated: <span id="ema-last-updated-time">--</span></p>
                <div id="ema-tables-container"></div>
            </div>
        </div>
        
        <div id="snapshot-tab" class="tab-content">
            <div class="controls-container" id="snapshot-controls">
                <div><label for="snapshot-symbol">Symbol:</label><select id="snapshot-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
            </div>
            <div id="snapshot-images-container"></div>
        </div>

        <div id="sr-levels-tab" class="tab-content">
            <div id="sr-legend-container">
                <div id="sr-legend-header">
                    <h4>S/R Levels Key</h4>
                    <button id="sr-legend-toggle-btn" title="Toggle Details">‚àí</button>
                </div>
                <div id="sr-legend-content">
                    <div id="sr-metadata-container">
                        <div class="metadata-item"><span class="metadata-label">Lookback Period</span><span id="sr-metadata-dates" class="metadata-value">--</span></div>
                        <div class="metadata-item"><span class="metadata-label">Timeframes Analyzed</span><span id="sr-metadata-timeframes" class="metadata-value">--</span></div>
                        <div class="metadata-item"><span class="metadata-label">Pivot Windows</span><span id="sr-metadata-windows" class="metadata-value">--</span></div>
                        <div class="metadata-item"><span class="metadata-label">Pivot Sources</span><span class="metadata-value">Wick High, Wick Low</span></div>
                        <div class="metadata-item">
                            <span class="metadata-label">Strength Score Weights</span>
                            <div class="rating-explanation metadata-value">'15m': 1.0,
'30m': 1.2,
'1h': 1.5,
'2h': 2.0,
'4h': 2.5</div>
                        </div>
                        <div class="metadata-item">
                            <span class="metadata-label">Source Weights</span>
                            <span class="metadata-value">Wick (1.0), Close (1.5)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls-container">
                <div><label for="sr-symbol">Symbol:</label><select id="sr-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div>
                    <label for="sr-lookback">Lookback:</label>
                    <select id="sr-lookback">
                        <option value="60d">60 Days</option><option value="30d">30 Days</option><option value="21d">21 Days</option><option value="14d">14 Days</option><option value="7d">7 Days</option><option value="3d">3 Days</option><option value="2d">2 Days</option>
                    </select>
                </div>
            </div>

            <p class="ema-last-updated">Last Updated: <span id="sr-last-updated-time">--</span></p>

            <div id="sr-levels-container">
                <div class="sr-column support">
                    <h3>Top Support Zones</h3>
                    <div id="support-levels-container"></div>
                    <div id="support-summary" class="sr-summary"></div>
                </div>
                <div class="sr-column resistance">
                    <h3>Top Resistance Zones</h3>
                    <div id="resistance-levels-container"></div>
                    <div id="resistance-summary" class="sr-summary"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- NEW IMAGE MODAL -->
    <div id="image-modal" class="modal-overlay" style="display: none;">
      <span class="modal-close">&times;</span>
      <img class="modal-content" id="modal-image-content">
              <div id="modal-caption"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

      <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const CONFIG = {
                FIREBASE: {
                    apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                    authDomain: "journal-a003f.firebaseapp.com",
                    databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "journal-a003f",
                    storageBucket: "journal-a003f.firebasestorage.app",
                    messagingSenderId: "1038636626553",
                    appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
                },
                DB_PATHS: {
                    TRADES: 'trades',
                    COMPLETED_TRADES: 'completed_trades',
                    BANK: 'bank',
                    JOURNAL_TEXT: 'journal_text',
                    JOURNAL_IMAGES: 'journal_images',
                    IMAGE_LIBRARY: 'image_library',
                    JOURNAL_FAVOURITES: 'journal_favourites',
                    SETUPS_1: 'current_setups_1',
                    SETUPS_2: 'current_setups_2',
                    PERSISTENT_NOTES: 'persistent_notes',
                    SENTIMENT_RECEIPTS: 'sentiment_receipts'
                },
                TRADE_SETTINGS: {
                    FEE_RATE: 0.00075,
                    STARTING_BALANCE: 3881,
                    USD_TO_AUD_RATE: 1.53
                },
                EMA_ANALYSIS: {
                    SYMBOLS: ['BTC-USDT', 'ETH-USDT'],
                    TIMEFRAMES: ['15min', '30min', '1hour', '2hour', '4hour', 'daily'],
                    PERIODS: [13, 49, 100, 200, 500, 1000],
                    SHORT_NAMES: {'15min': '15m', '30min': '30m', '1hour': '1H', '2hour': '2H', '4hour': '4H', 'daily': '1D', 'weekly': '1W', 'monthly': '1M'}
                },
                SNAPSHOT_TIMEFRAMES: ['15min', '30min', '1hour', '2hour', '4hour', 'daily', 'weekly', 'monthly']
            };

            // --- DOM ELEMENT CACHE ---
            const DOM = {
                // General
                tabs: document.querySelector('.tabs'),
                themeToggle: document.getElementById('theme-checkbox'),
                trackerTab: document.getElementById('tracker-tab'),
                // Stats Panel
                statsPanelContainer: document.getElementById('stats-panel-container'),
                statsFab: document.getElementById('stats-fab'),
                statsPanel: document.getElementById('stats-panel'),
                closeStatsBtn: document.getElementById('close-stats-btn'),
                statBalance: document.getElementById('stat-balance'),
                statBalanceAud: document.getElementById('stat-balance-aud'),
                statTotalPl: document.getElementById('stat-total-pl'),
                statTotalPlAud: document.getElementById('stat-total-pl-aud'),
                statCompletedTrades: document.getElementById('stat-completed-trades'),
                statOpenTrades: document.getElementById('stat-open-trades'),
                // Trade Tracker
                addTradeForm: document.getElementById('add-trade-form'),
                tradesTbody: document.getElementById('trades-tbody'),
                completedTradesTbody: document.getElementById('completed-trades-tbody'),
                assetSentimentContainer: document.getElementById('asset-sentiment-container'),
                sentimentReceiptsTbody: document.getElementById('sentiment-receipts-tbody'),
                // Image Library
                imageLibraryContainer: document.getElementById('image-library-container'),
                libraryImageUpload: document.getElementById('library-image-upload'),
                libraryUploadProgress: document.getElementById('library-upload-progress'),
                imageModal: document.getElementById('image-modal'),
                modalImageContent: document.getElementById('modal-image-content'),
                modalClose: document.querySelector('.modal-close'),
                modalCaption: document.getElementById('modal-caption'),
                // Journal & Setups
                journalTab: document.getElementById('journal-tab'),
                persistentNotesEl: document.getElementById('persistent-notes-entry'),
                setupsTable1: document.getElementById('current-setups-table-1'),
                setupsTable2: document.getElementById('current-setups-table-2'),
                saveSetups1Btn: document.getElementById('save-setups-1-btn'),
                saveSetups2Btn: document.getElementById('save-setups-2-btn'),
                setupsSaveStatus1: document.getElementById('setups-save-status-1'),
                setupsSaveStatus2: document.getElementById('setups-save-status-2'),
                journalSymbolEl: document.getElementById('journal-symbol'),
                journalTimeframeEl: document.getElementById('journal-timeframe'),
                journalImageFilterEl: document.getElementById('journal-image-filter'),
                dateButtonsContainer: document.getElementById('date-buttons-container'),
                datePrevBtn: document.getElementById('date-prev'),
                dateNextBtn: document.getElementById('date-next'),
                favouritedEntryContainer: document.getElementById('favourited-entry-container'),
                favouritedEntryText: document.getElementById('favourited-entry-text'),
                favouriteBtn: document.getElementById('favourite-btn'),
                journalEntryEl: document.getElementById('journal-entry'),
                saveStatus: document.getElementById('save-status'),
                journalImageUpload: document.getElementById('journal-image-upload'),
                uploadProgress: document.getElementById('upload-progress'),
                journalImagesContainer: document.getElementById('journal-images-container'),
                emaLastUpdatedTime: document.getElementById('ema-last-updated-time'),
                emaTablesContainer: document.getElementById('ema-tables-container'),
                // Snapshot
                snapshotTab: document.getElementById('snapshot-tab'),
                snapshotSymbolEl: document.getElementById('snapshot-symbol'),
                snapshotImagesContainer: document.getElementById('snapshot-images-container'),
                // S/R Levels
                srLevelsTab: document.getElementById('sr-levels-tab'),
                srLegendHeader: document.getElementById('sr-legend-header'),
                srLegendContent: document.getElementById('sr-legend-content'),
                srLegendToggleBtn: document.getElementById('sr-legend-toggle-btn'),
                srLastUpdatedTime: document.getElementById('sr-last-updated-time'),
                srMetadataDates: document.getElementById('sr-metadata-dates'),
                srMetadataTimeframes: document.getElementById('sr-metadata-timeframes'),
                srMetadataWindows: document.getElementById('sr-metadata-windows'),
                srSymbolEl: document.getElementById('sr-symbol'),
                srLookbackEl: document.getElementById('sr-lookback'),
                supportLevelsContainer: document.getElementById('support-levels-container'),
                resistanceLevelsContainer: document.getElementById('resistance-levels-container'),
                supportSummary: document.getElementById('support-summary'),
                resistanceSummary: document.getElementById('resistance-summary'),
            };

            // --- APPLICATION STATE ---
            const STATE = {
                isMasterUser: false,
                masterPassword: null,
                viewerId: null,
                journalText: {},
                journalImages: {},
                emaData: {},
                srData: {},
                favouriteEntries: {},
                persistentNotes: '',
                setupsData1: {},
                setupsData2: {},
                selectedDate: null,
                centerDate: null,
                journalSaveTimer: null,
                notesSaveTimer: null,
            };

            // --- INITIALIZE FIREBASE ---
            firebase.initializeApp(CONFIG.FIREBASE);
            const database = firebase.database();
            const storage = firebase.storage();

            const dbRefs = {
                trades: database.ref(CONFIG.DB_PATHS.TRADES),
                completedTrades: database.ref(CONFIG.DB_PATHS.COMPLETED_TRADES),
                bank: database.ref(CONFIG.DB_PATHS.BANK),
                journalText: database.ref(CONFIG.DB_PATHS.JOURNAL_TEXT),
                journalImages: database.ref(CONFIG.DB_PATHS.JOURNAL_IMAGES),
                imageLibrary: database.ref(CONFIG.DB_PATHS.IMAGE_LIBRARY),
                favourites: database.ref(CONFIG.DB_PATHS.JOURNAL_FAVOURITES),
                setups1: database.ref(CONFIG.DB_PATHS.SETUPS_1),
                setups2: database.ref(CONFIG.DB_PATHS.SETUPS_2),
                persistentNotes: database.ref(CONFIG.DB_PATHS.PERSISTENT_NOTES),
                sentimentReceipts: database.ref(CONFIG.DB_PATHS.SENTIMENT_RECEIPTS)
            };

            // --- HELPER FUNCTIONS ---
            const formatCurrency = (num, symbol = '$') => `${symbol}${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            function autoResizeTextarea(element) {
                if (!element) return;
                element.style.height = 'auto';
                element.style.height = `${element.scrollHeight}px`;
            }
            const getYYYYMMDD = (date) => date.toISOString().split('T')[0];
            const getSafeSymbol = (symbol) => symbol.replace(/\//g, '-');
            
            function getViewerId() {
                if (STATE.viewerId) return STATE.viewerId;
                let id = localStorage.getItem('viewerId');
                if (!id) {
                    id = `viewer_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;
                    localStorage.setItem('viewerId', id);
                }
                STATE.viewerId = id;
                return id;
            }

            // --- DATA FETCHING ---
            async function fetchEmaData() {
                try {
                    const response = await fetch(`ma_analysis.json?cache_bust=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    STATE.emaData = await response.json();
                    renderEmaData();
                } catch (error) {
                    console.error("Could not fetch ma_analysis.json:", error);
                    DOM.emaTablesContainer.innerHTML = '<p style="color: red; text-align: center;">Error loading EMA data.</p>';
                }
            }

            async function fetchSrData() {
                try {
                    const response = await fetch(`sr_levels_analysis.json?cache_bust=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    STATE.srData = await response.json();
                    if (DOM.srLevelsTab.classList.contains('active')) {
                        renderSrLevels();
                    }
                } catch (error) {
                    console.error("Could not fetch sr_levels_analysis.json:", error);
                    DOM.supportLevelsContainer.parentElement.innerHTML = '<p style="color: red; text-align: center;">Error loading S/R data.</p>';
                }
            }

            // --- RENDERING FUNCTIONS ---
            function renderSentimentReceipts(receiptsData) {
                const tbody = DOM.sentimentReceiptsTbody;
                if (!tbody) return;

                const currentViewerId = getViewerId();
                const receipts = receiptsData || {};
                const receiptIds = Object.keys(receipts);

                receiptIds.sort().reverse();

                const rowsHtml = receiptIds.map(id => {
                    const receipt = receipts[id];
                    if (!receipt) return '';
                    
                    const sentimentClass = (receipt.sentiment || '').toLowerCase();
                    let sentimentColor = 'var(--text-color)';
                    if (sentimentClass === 'long') sentimentColor = 'var(--green-text)';
                    if (sentimentClass === 'short') sentimentColor = 'var(--red-text)';

                    const ownerActionsHtml = (receipt.viewerId === currentViewerId)
                        ? `<button class="edit-sentiment-note-btn" data-id="${id}">Note</button>
                           <button class="delete-sentiment-btn" data-id="${id}" title="Delete Entry">√ó</button>`
                        : '';

                    let displayTimestamp;
                    if (typeof receipt.timestamp === 'number') {
                        displayTimestamp = new Date(receipt.timestamp).toLocaleString();
                    } else {
                        displayTimestamp = receipt.timestamp || '--';
                    }

                    return `
                        <tr>
                            <td>${receipt.asset || '--'}</td>
                            <td style="color: ${sentimentColor};">${receipt.sentiment || '--'}</td>
                            <td class="sentiment-note-cell">${receipt.note || ''}</td>
                            <td>${displayTimestamp}</td>
                            <td class="action-buttons">${ownerActionsHtml}</td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rowsHtml;
            }
            
            function renderLiveTable(data) {
                const trades = data || {};
                const masterButtonsHtml = (id) => STATE.isMasterUser ? `
                    <td class="action-buttons">
                        <button class="win-btn" data-id="${id}">Win</button>
                        <button class="loss-btn" data-id="${id}">Loss</button>
                        <button class="note-btn" data-id="${id}">Edit</button>
                        <button class="delete-btn" data-id="${id}">Delete</button>
                    </td>` : '';
                
                const rowsHtml = Object.keys(trades)
                    .sort((a, b) => new Date(trades[b].date) - new Date(trades[a].date))
                    .map(id => {
                        const trade = trades[id];
                        const noteText = trade.note || '';
                        const profitString = `$${parseFloat(trade.expected_profit || 0).toFixed(2)} (${parseFloat(trade.expected_profit_percent || 0).toFixed(2)}%)`;
                        const lossString = `$${parseFloat(trade.expected_loss || 0).toFixed(2)} (${parseFloat(trade.expected_loss_percent || 0).toFixed(2)}%)`;

                        return `
                            <tr>
                                <td>${trade.symbol}</td>
                                <td>${trade.type}</td>
                                <td>${parseFloat(trade.entry).toFixed(2)}</td>
                                <td>${parseFloat(trade.stoploss).toFixed(2)}</td>
                                <td>${parseFloat(trade.target).toFixed(2)}</td>
                                <td>${parseFloat(trade.size).toFixed(2)}</td>
                                <td>${parseFloat(trade.estimated_total_fee || 0).toFixed(2)}</td>
                                <td style="color: #28a745;">${profitString}</td>
                                <td style="color: #dc3545;">${lossString}</td>
                                <td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td>                                <td class="note-cell" title="${noteText}">${noteText}</td>
                                ${masterButtonsHtml(id)}
                            </tr>`;
                    }).join('');
                
                DOM.tradesTbody.innerHTML = rowsHtml;
            }

            function renderCompletedTable(data) {
                const trades = data || {};
                const masterButtonsHtml = (id) => STATE.isMasterUser ? `
                    <td class="action-buttons">
                        <button class="note-btn-completed" data-id="${id}">Edit</button>
                        <button class="delete-btn-completed" data-id="${id}">Delete</button>
                    </td>` : '';

                const rowsHtml = Object.keys(trades)
                    .sort((a, b) => new Date(trades[b].closed_date) - new Date(trades[a].date))
                    .map(id => {
                        const trade = trades[id];
                        const resultColor = trade.net_result >= 0 ? '#28a745' : '#dc3545';
                        const totalFees = (trade.entry_fee || 0) + (trade.exit_fee || 0);
                        const noteText = trade.note || '';
                        return `
                            <tr>
                                <td>${trade.symbol}</td>
                                <td>${trade.type}</td>
                                <td>${parseFloat(trade.entry).toFixed(2)}</td>
                                <td>${parseFloat(trade.target || 0).toFixed(2)}</td>
                                <td>${parseFloat(trade.exit_price).toFixed(2)}</td>
                                <td>${totalFees.toFixed(2)}</td>
                                <td style="color:${resultColor};font-weight:bold;">${parseFloat(trade.net_result).toFixed(2)}</td>
                                <td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td>                                <td>${trade.closed_date ? new Date(trade.closed_date).toLocaleString() : '--'}</td>
                                <td class="note-cell" title="${noteText}">${noteText}</td>
                                ${masterButtonsHtml(id)}
                            </tr>`;
                    }).join('');
                
                DOM.completedTradesTbody.innerHTML = rowsHtml;
            }

            function renderImageLibrary(imagesData) {
                const images = imagesData || {};
                if (!DOM.imageLibraryContainer) return;

                const masterButtonsHtml = (id, fileName) => (STATE.isMasterUser) ? `
                    <button class="delete-library-image" title="Delete Image" data-id="${id}" data-filename="${fileName}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </button>
                    <button class="edit-caption-btn" title="Edit Caption" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160V416c0 53 43 96 96 96H352c53 0 96-43 96-96V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H96z"/></svg>
                    </button>` : '';

                const imagesHtml = Object.keys(images)
                    .sort((a, b) => images[b].timestamp - images[a].timestamp)
                    .map(id => {
                        const imgData = images[id];
                        if (!imgData?.url) return '';
                        return `
                            <div class="library-image-wrapper">
                                <div style="position: relative; flex-grow: 1;">
                                    ${masterButtonsHtml(id, imgData.fileName)}
                                    <img src="${imgData.url}" alt="Library Image" data-full-src="${imgData.url}" data-caption="${imgData.caption || ''}">
                                </div>
                                <div class="library-image-caption" title="${imgData.caption || ''}">${imgData.caption || '¬†'}</div>
                            </div>`;
                    }).join('');

                DOM.imageLibraryContainer.innerHTML = imagesHtml;
            }
            
            function renderDateNavigation() {
                const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                const timeframe = DOM.journalTimeframeEl.value;
                let buttonsHtml = '';

                for (let i = -2; i <= 2; i++) {
                    const date = new Date(STATE.centerDate);
                    date.setUTCDate(STATE.centerDate.getUTCDate() + i);
                    
                    const yyyymmdd = getYYYYMMDD(date);
                    const isActive = yyyymmdd === getYYYYMMDD(STATE.selectedDate);
                    const hasEntry = (STATE.journalText[safeSymbol]?.[yyyymmdd]?.[timeframe] || '').trim();
                    
                    const btnClasses = `date-nav-btn ${isActive ? 'active' : ''} ${hasEntry ? 'has-entry' : ''}`;
                    const btnText = date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', timeZone: 'UTC' });
                    
                    buttonsHtml += `<button class="${btnClasses}" data-date="${yyyymmdd}">${btnText}</button>`;
                }
                DOM.dateButtonsContainer.innerHTML = buttonsHtml;
            }

            function updateJournalView() {
                const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                const timeframe = DOM.journalTimeframeEl.value;
                const yyyymmdd = getYYYYMMDD(STATE.selectedDate);

                const favouriteText = (STATE.favouriteEntries[safeSymbol] || {})[timeframe];
                if (favouriteText) {
                    DOM.favouritedEntryText.textContent = favouriteText;
                    DOM.favouritedEntryContainer.style.display = 'block';
                } else {
                    DOM.favouritedEntryContainer.style.display = 'none';
                }

                const dailyText = (STATE.journalText[safeSymbol]?.[yyyymmdd]?.[timeframe]) || '';
                DOM.journalEntryEl.value = dailyText;
                
                DOM.persistentNotesEl.value = STATE.persistentNotes;

                setTimeout(() => {
                    autoResizeTextarea(DOM.journalEntryEl);
                    autoResizeTextarea(DOM.persistentNotesEl);
                }, 0);

                DOM.favouriteBtn.classList.toggle('active', favouriteText && dailyText.trim() === favouriteText);

                renderJournalImages(safeSymbol, timeframe, yyyymmdd);
                renderDateNavigation();
            }
            
            function renderJournalImages(symbol, timeframe, selectedYMD) {
                const imagesForSymbol = STATE.journalImages[symbol] || {};
                const imagesForTimeframe = imagesForSymbol[timeframe] || {};
                const allImageKeys = Object.keys(imagesForTimeframe);
                
                const filterMode = DOM.journalImageFilterEl.value;
                let imageKeysToRender;

                if (filterMode === 'today') {
                    imageKeysToRender = allImageKeys.filter(key => {
                        const imgData = imagesForTimeframe[key];
                        if (!imgData?.timestamp) return false;
                        return getYYYYMMDD(new Date(imgData.timestamp)) === selectedYMD;
                    });
                } else {
                    imageKeysToRender = allImageKeys;
                }

                if (imageKeysToRender.length === 0) {
                    DOM.journalImagesContainer.innerHTML = '';
                    return;
                }
                
                const deleteButtonHtml = (id, fileName) => (STATE.isMasterUser) ? `
                    <button class="delete-journal-image" title="Delete Image" data-safe-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${fileName}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </button>` : '';

                const imagesHtml = imageKeysToRender
                    .sort((a, b) => imagesForTimeframe[b].timestamp - imagesForTimeframe[a].timestamp)
                    .map(id => {
                        const imgData = imagesForTimeframe[id];
                        if (!imgData?.url || !imgData?.fileName) return '';
                        return `
                            <div class="journal-image-wrapper">
                                ${deleteButtonHtml(id, imgData.fileName)}
                                <img src="${imgData.url}" alt="Journal Image for ${imgData.fileName}">
                            </div>`;
                    }).join('');

                DOM.journalImagesContainer.innerHTML = imagesHtml;
            }

            function renderEmaData() {
                if (!STATE.emaData.data) return;
                
                const lastUpdated = STATE.emaData.last_updated ? new Date(STATE.emaData.last_updated).toLocaleString() : '--';
                DOM.emaLastUpdatedTime.textContent = lastUpdated;

                const { SYMBOLS, TIMEFRAMES, PERIODS, SHORT_NAMES } = CONFIG.EMA_ANALYSIS;
                
                const tablesHtml = SYMBOLS.map(safeSymbol => {
                    const symbolEmaData = STATE.emaData.data[safeSymbol] || {};
                    const currentPrice = symbolEmaData['15min']?.price || 0;
                    
                    const priceDisplayHtml = `
                        <div class="current-price-display">
                            Current Price (15m): <span class="price-value">${currentPrice > 0 ? formatCurrency(currentPrice) : '--'}</span>
                        </div>`;

                    const tableRowsHtml = TIMEFRAMES.map(tf => {
                        const tfData = symbolEmaData[tf];
                        const cellsHtml = PERIODS.flatMap(period => ['EMA', 'SMA'].map(type => {
                            const value = tfData?.[`${type}_${period}`];
                            if (value !== undefined) {
                                const priceClass = currentPrice > 0 ? (value > currentPrice ? 'price-above' : 'price-below') : '';
                                return `<td class="${priceClass}">${Math.round(value).toLocaleString()}</td>`;
                            }
                            return '<td>...</td>';
                        })).join('');
                        return `<tr><td>${SHORT_NAMES[tf] || tf}</td>${cellsHtml}</tr>`;
                    }).join('');

                    const tableHtml = `
                        <div class="table-wrapper">
                            <table class="ema-table">
                                <thead><tr><th>TF</th>${PERIODS.flatMap(p => [`<th>EMA ${p}</th>`, `<th>SMA ${p}</th>`]).join('')}</tr></thead>
                                <tbody>${tableRowsHtml}</tbody>
                            </table>
                        </div>`;

                    let summaryHtml = '';
                    if (currentPrice > 0) {
                        const levels = [];
                        TIMEFRAMES.forEach(tf => {
                            const tfData = symbolEmaData[tf];
                            if (tfData) {
                                PERIODS.forEach(period => ['EMA', 'SMA'].forEach(type => {
                                    const val = tfData[`${type}_${period}`];
                                    if (val !== undefined) {
                                        levels.push({
                                            label: `${SHORT_NAMES[tf]} ${type} ${period}`,
                                            value: val,
                                            isSupport: val < currentPrice,
                                            distance: Math.abs(currentPrice - val)
                                        });
                                    }
                                }));
                            }
                        });

                        const supports = levels.filter(l => l.isSupport).sort((a,b) => a.distance - b.distance).slice(0, 10);
                        const resistances = levels.filter(l => !l.isSupport).sort((a,b) => a.distance - b.distance).slice(0, 10);
                        const formatLevel = (level) => `<li>${level.label} (${Math.round(level.value).toLocaleString()})</li>`;
                        
                        summaryHtml = `
                            <div class="ema-summary-container">
                                <div class="ema-level-summary"><strong><span class="support">Support:</span></strong><ul>${supports.map(formatLevel).join('') || 'None found.'}</ul></div>
                                <div class="ema-level-summary"><strong><span class="resistance">Resistance:</span></strong><ul>${resistances.map(formatLevel).join('') || 'None found.'}</ul></div>
                            </div>`;
                    }
                    
                    const symbolHtml = `
                        <div class="ema-table-container">
                            <h4>${safeSymbol.replace('-', '/')} Snapshot</h4>
                            ${priceDisplayHtml}
                            ${safeSymbol === 'ETH-USDT' ? tableHtml + summaryHtml : summaryHtml + tableHtml}
                        </div>`;
                    
                    return symbolHtml;
                }).join('');
                
                DOM.emaTablesContainer.innerHTML = tablesHtml;
            }
            
            function renderSetupsTable(tableElement, data) {
                if (!tableElement) return;
                const tbody = tableElement.querySelector('tbody');
                tbody.querySelectorAll('tr').forEach(row => {
                    const timeframe = row.firstElementChild.textContent.trim();
                    const rowData = data[timeframe] || {};
                    const cells = row.querySelectorAll('td');
                    cells[0].textContent = rowData.zero_entry || '';
                    cells[1].textContent = rowData.zero_target || '';
                    cells[2].textContent = rowData.zero_stoploss || '';
                    cells[3].textContent = rowData.four_entry || '';
                    cells[4].textContent = rowData.four_target || '';
                    cells[5].textContent = rowData.four_stoploss || '';
                });
            }
            
            function renderSnapshotView() {
                const selectedSymbol = getSafeSymbol(DOM.snapshotSymbolEl.value);
                const symbolImageData = STATE.journalImages[selectedSymbol] || {};
                
                const itemsHtml = CONFIG.SNAPSHOT_TIMEFRAMES.map(tf => {
                    const imagesForTimeframe = symbolImageData[tf];
                    if (!imagesForTimeframe || Object.keys(imagesForTimeframe).length === 0) return '';
                    
                    const latestImage = Object.values(imagesForTimeframe).sort((a, b) => b.timestamp - a.timestamp)[0];
                    if (latestImage) {
                        return `
                            <div class="snapshot-image-item">
                                <h4>${tf.replace('min', 'm').replace('hour', 'H')}</h4>
                                <div class="journal-image-wrapper">
                                    <img src="${latestImage.url}" alt="Latest image for ${tf}">
                                </div>
                            </div>`;
                    }
                    return '';
                }).join('');
                
                DOM.snapshotImagesContainer.innerHTML = itemsHtml;
            }

            function renderSrLevels() {
                const selectedSymbol = getSafeSymbol(DOM.srSymbolEl.value);
                const selectedLookback = DOM.srLookbackEl.value;
                const lookbackData = STATE.srData.data?.[selectedSymbol]?.[selectedLookback] || {};
                const analysisParams = lookbackData.analysis_params || {};

                DOM.srLastUpdatedTime.textContent = STATE.srData.last_updated ? new Date(STATE.srData.last_updated).toLocaleString() : '--';
                DOM.srMetadataTimeframes.textContent = (analysisParams.timeframes_analyzed || []).join(', ') || '--';
                DOM.srMetadataWindows.textContent = (analysisParams.pivot_windows || []).join(', ') || '--';
                DOM.srMetadataDates.textContent = (analysisParams.oldest_pivot_date && analysisParams.newest_pivot_date) 
                    ? `${analysisParams.oldest_pivot_date} to ${analysisParams.newest_pivot_date}` : '--';

                const buildLevelCard = (level) => `
                    <div class="sr-level-card">
                        <div class="sr-level-header">
                            <span class="sr-level-price-range">$${Math.round(level['Price Start'])} - $${Math.round(level['Price End'])}</span>
                            <span class="sr-level-strength">Score: ${level['Strength Score']}</span>
                        </div>
                        <div class="sr-level-pivots">Based on <span>${level['Pivot Count']}</span> pivots.</div>
                    </div>`;

                const supportLevels = lookbackData.support || [];
                DOM.supportLevelsContainer.innerHTML = supportLevels.map(buildLevelCard).join('');
                if (supportLevels.length > 0) {
                    const lowest = Math.min(...supportLevels.map(l => l['Price Start']));
                    const highest = Math.max(...supportLevels.map(l => l['Price End']));
                    DOM.supportSummary.innerHTML = `Full Range: <span>$${Math.round(lowest)}</span> - <span>$${Math.round(highest)}</span>`;
                } else {
                    DOM.supportSummary.innerHTML = '';
                }
                
                const resistanceLevels = lookbackData.resistance || [];
                DOM.resistanceLevelsContainer.innerHTML = resistanceLevels.map(buildLevelCard).join('');
                if (resistanceLevels.length > 0) {
                    const lowest = Math.min(...resistanceLevels.map(l => l['Price Start']));
                    const highest = Math.max(...resistanceLevels.map(l => l['Price End']));
                    DOM.resistanceSummary.innerHTML = `Full Range: <span>$${Math.round(lowest)}</span> - <span>$${Math.round(highest)}</span>`;
                } else {
                    DOM.resistanceSummary.innerHTML = '';
                }
            }


            // --- DATA HANDLING AND SAVING ---
            function saveSetupsTable(tableElement, dbRef, statusElement) {
                if (!STATE.isMasterUser) return;
                const dataToSave = {};
                const tbody = tableElement.querySelector('tbody');
                
                tbody.querySelectorAll('tr').forEach(row => {
                    const timeframe = row.firstElementChild.textContent.trim();
                    const cells = row.querySelectorAll('td');
                    dataToSave[timeframe] = {
                        zero_entry: cells[0].textContent.trim(),
                        zero_target: cells[1].textContent.trim(),
                        zero_stoploss: cells[2].textContent.trim(),
                        four_entry: cells[3].textContent.trim(),
                        four_target: cells[4].textContent.trim(),
                        four_stoploss: cells[5].textContent.trim(),
                    };
                });
                
                statusElement.textContent = 'Saving...';
                dbRef.set(dataToSave).then(() => {
                    statusElement.textContent = 'Saved.';
                    setTimeout(() => { statusElement.textContent = '' }, 2000);
                }).catch(e => {
                    statusElement.textContent = `Error: ${e.message}`;
                    console.error("Error saving setups table:", e);
                });
            }

            const saveJournalEntry = () => {
                clearTimeout(STATE.journalSaveTimer);
                STATE.journalSaveTimer = setTimeout(() => {
                    if (!STATE.isMasterUser) return;
                    const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                    const yyyymmdd = getYYYYMMDD(STATE.selectedDate);
                    const timeframe = DOM.journalTimeframeEl.value;
                    const text = DOM.journalEntryEl.value;
                    
                    DOM.saveStatus.textContent = 'Saving...';
                    
                    if (!STATE.journalText[safeSymbol]) STATE.journalText[safeSymbol] = {};
                    if (!STATE.journalText[safeSymbol][yyyymmdd]) STATE.journalText[safeSymbol][yyyymmdd] = {};
                    STATE.journalText[safeSymbol][yyyymmdd][timeframe] = text;
                    
                    dbRefs.journalText.child(safeSymbol).child(yyyymmdd).child(timeframe).set(text)
                        .then(() => {
                            DOM.saveStatus.textContent = 'Saved.';
                            renderDateNavigation(); 
                            setTimeout(() => DOM.saveStatus.textContent = '', 2000);
                        })
                        .catch(e => DOM.saveStatus.textContent = `Error: ${e.message}`);
                }, 750);
            };
            
            const savePersistentNotes = () => {
                clearTimeout(STATE.notesSaveTimer);
                STATE.notesSaveTimer = setTimeout(() => {
                    if (!STATE.isMasterUser) return;
                    const text = DOM.persistentNotesEl.value;
                    STATE.persistentNotes = text;
                    dbRefs.persistentNotes.set(text)
                        .catch(e => console.error("Error saving persistent notes:", e));
                }, 750);
            };
            
            function handleFileUpload(files) {
                if (!STATE.isMasterUser || !files || files.length === 0) return;
                
                DOM.uploadProgress.style.display = 'block';
                const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                const timeframe = DOM.journalTimeframeEl.value;
                
                Array.from(files).forEach((file, index) => {
                    if (!file.type.startsWith('image/')) return;
                    
                    const fileName = `${Date.now()}_${file.name}`;
                    const storagePath = `journal_images/${safeSymbol}/${timeframe}/${fileName}`;
                    const fileRef = storage.ref(storagePath);
                    const metadata = { customMetadata: { 'owner': 'master' } };
                    const uploadTask = fileRef.put(file, metadata);

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            DOM.uploadProgress.textContent = `Uploading ${index + 1}/${files.length}: ${progress}%`;
                        },
                        (error) => {
                            console.error("Upload Failed:", error);
                            DOM.uploadProgress.textContent = `Upload Failed: ${error.code}`;
                        },
                        () => {
                            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                const imageData = {
                                    url: downloadURL,
                                    fileName: fileName,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP
                                };
                                dbRefs.journalImages.child(safeSymbol).child(timeframe).push(imageData);
                                if (index === files.length - 1) {
                                    DOM.uploadProgress.textContent = 'Upload Complete!';
                                    setTimeout(() => { DOM.uploadProgress.textContent = ''; }, 2000);
                                }
                            });
                        }
                    );
                });
            }

            function handleLibraryImageUpload(files) {
                if (!STATE.isMasterUser || !files || files.length === 0) return;
                
                DOM.libraryUploadProgress.style.display = 'block';
                
                Array.from(files).forEach((file, index) => {
                    if (!file.type.startsWith('image/')) return;
                    
                    const fileName = `${Date.now()}_${file.name}`;
                    const storagePath = `image_library/${fileName}`;
                    const fileRef = storage.ref(storagePath);
                    
                    const metadata = { customMetadata: { 'owner': 'master' } };
                    const uploadTask = fileRef.put(file, metadata);

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            DOM.libraryUploadProgress.textContent = `Uploading ${index + 1}/${files.length}: ${progress}%`;
                        },
                        (error) => {
                            console.error("Library Upload Failed:", error);
                            DOM.libraryUploadProgress.textContent = `Upload Failed: ${error.code}`;
                        },
                        () => {
                            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                const imageData = {
                                    url: downloadURL,
                                    fileName: fileName,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP
                                };
                                dbRefs.imageLibrary.push(imageData);
                                if (index === files.length - 1) {
                                    DOM.libraryUploadProgress.textContent = 'Upload Complete!';
                                    setTimeout(() => { DOM.libraryUploadProgress.textContent = ''; }, 2000);
                                }
                            });
                        }
                    );
                });
            }

            function calculateNetResult(trade, exitPrice) {
                const entry = parseFloat(trade.entry);
                const posValue = parseFloat(trade.size);
                const exit = parseFloat(exitPrice);
                const { FEE_RATE } = CONFIG.TRADE_SETTINGS;

                if (isNaN(entry) || isNaN(posValue) || isNaN(exit)) {
                    return { net_result: 0, entry_fee: 0, exit_fee: 0 };
                }

                const entryFee = posValue * FEE_RATE;
                const exitPosValue = (exit / entry) * posValue;
                const exitFee = exitPosValue * FEE_RATE;
                const positionQty = posValue / entry;

                const grossResult = trade.type === "Long"
                    ? (exit - entry) * positionQty
                    : (entry - exit) * positionQty;

                return {
                    net_result: grossResult - entryFee - exitFee,
                    entry_fee: entryFee,
                    exit_fee: exitFee
                };
            }
            
            function completeTrade(tradeId, outcome) {
                dbRefs.trades.child(tradeId).once('value', snapshot => {
                    const trade = snapshot.val();
                    if (!trade) return;

                    const defaultExit = outcome === 'win' ? trade.target : trade.stoploss;
                    const exitPriceStr = prompt(`Enter exact exit price:`, defaultExit);
                    if (exitPriceStr === null) return;

                    const exitPrice = parseFloat(exitPriceStr);
                    if (isNaN(exitPrice)) return alert("Invalid exit price.");

                    const result = calculateNetResult(trade, exitPrice);
                    const completedTrade = {
                        ...trade,
                        ...result,
                        closed_date: firebase.database.ServerValue.TIMESTAMP,                        exit_price: exitPrice,
                    };
                    delete completedTrade.expected_profit;
                    delete completedTrade.expected_loss;

                    dbRefs.completedTrades.push(completedTrade)
                        .then(() => dbRefs.trades.child(tradeId).remove());
                });
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                DOM.themeToggle.addEventListener('change', (e) => {
                    const theme = e.target.checked ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                });

                DOM.tabs.addEventListener('click', (e) => {
                    if (!e.target.matches('.tab-link')) return;
                    
                    document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    const tabId = e.target.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    DOM.statsPanelContainer.style.display = (tabId === 'tracker') ? 'block' : 'none';
                    
                    if (tabId === 'journal') updateJournalView();
                    if (tabId === 'snapshot') renderSnapshotView();
                    if (tabId === 'sr-levels') renderSrLevels();
                });
                
                DOM.statsFab.addEventListener('click', () => DOM.statsPanel.classList.toggle('active'));
                DOM.closeStatsBtn.addEventListener('click', () => DOM.statsPanel.classList.remove('active'));
                document.addEventListener('click', (e) => {
                    if (!DOM.statsPanel.contains(e.target) && !DOM.statsFab.contains(e.target) && DOM.statsPanel.classList.contains('active')) {
                        DOM.statsPanel.classList.remove('active');
                    }
                });

                DOM.addTradeForm.addEventListener('submit', handleAddTradeSubmit);
                
                DOM.trackerTab.addEventListener('click', (e) => {
                    if (e.target.closest('.sentiment-buttons button')) {
                        handleSentimentLog(e);
                    }
                    if (e.target.matches('.delete-sentiment-btn')) {
                        handleSentimentDelete(e);
                    }
                    if (e.target.matches('.edit-sentiment-note-btn')) {
                        handleSentimentNoteEdit(e);
                    }
                    if (e.target.closest('#trades-tbody')) {
                        handleTradeAction(e);
                    }
                    if (e.target.closest('#completed-trades-tbody')) {
                        handleTradeAction(e);
                    }
                    if (e.target.closest('#image-library-container')) {
                        handleImageLibraryClick(e);
                    }
                });
                
                DOM.libraryImageUpload.addEventListener('change', (e) => handleLibraryImageUpload(e.target.files));
                DOM.modalClose.addEventListener('click', () => DOM.imageModal.style.display = 'none');
                DOM.imageModal.addEventListener('click', (e) => {
                    if (e.target.id === 'image-modal') {
                        DOM.imageModal.style.display = 'none';
                    }
                });

                [DOM.journalSymbolEl, DOM.journalTimeframeEl, DOM.journalImageFilterEl].forEach(el => {
                    el.addEventListener('change', updateJournalView);
                });
                
                DOM.dateButtonsContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.date-nav-btn')) {
                        const dateStr = e.target.dataset.date;
                        const parts = dateStr.split('-');
                        STATE.selectedDate = new Date(Date.UTC(parts[0], parseInt(parts[1], 10) - 1, parts[2]));
                        STATE.centerDate = new Date(STATE.selectedDate);
                        updateJournalView();
                    }
                });
                DOM.datePrevBtn.addEventListener('click', () => {
                    STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() - 5);
                    renderDateNavigation();
                });
                DOM.dateNextBtn.addEventListener('click', () => {
                    STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() + 5);
                    renderDateNavigation();
                });

                DOM.journalEntryEl.addEventListener('input', () => {
                    autoResizeTextarea(DOM.journalEntryEl);
                    saveJournalEntry();
                });
                DOM.persistentNotesEl.addEventListener('input', () => {
                    autoResizeTextarea(DOM.persistentNotesEl);
                    savePersistentNotes();
                });

                DOM.favouriteBtn.addEventListener('click', handleFavouriteClick);

                DOM.journalImageUpload.addEventListener('change', (e) => handleFileUpload(e.target.files));
                DOM.journalImagesContainer.addEventListener('click', handleImageDelete);
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    DOM.journalTab.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    DOM.journalTab.addEventListener(eventName, () => {
                        if (STATE.isMasterUser) DOM.journalTab.classList.add('drag-over');
                    });
                });
                DOM.journalTab.addEventListener('dragleave', () => DOM.journalTab.classList.remove('drag-over'));
                DOM.journalTab.addEventListener('drop', (e) => {
                    DOM.journalTab.classList.remove('drag-over');
                    if (STATE.isMasterUser && e.dataTransfer?.files.length > 0) {
                        handleFileUpload(e.dataTransfer.files);
                    }
                });
                
                DOM.saveSetups1Btn.addEventListener('click', () => saveSetupsTable(DOM.setupsTable1, dbRefs.setups1, DOM.setupsSaveStatus1));
                DOM.saveSetups2Btn.addEventListener('click', () => saveSetupsTable(DOM.setupsTable2, dbRefs.setups2, DOM.setupsSaveStatus2));
                
                DOM.journalTab.addEventListener('click', (e) => {
                    const header = e.target.closest('.setups-header');
                    if (header) {
                        const targetWrapper = document.querySelector(header.dataset.target);
                        const toggleBtn = header.querySelector('.setups-toggle-btn');
                        if (targetWrapper && toggleBtn) {
                            const isCollapsed = targetWrapper.style.display === 'none';
                            targetWrapper.style.display = isCollapsed ? 'block' : 'none';
                            toggleBtn.textContent = isCollapsed ? '‚àí' : '+';
                        }
                    }
                });

                DOM.snapshotSymbolEl.addEventListener('change', renderSnapshotView);
                DOM.srSymbolEl.addEventListener('change', renderSrLevels);
                DOM.srLookbackEl.addEventListener('change', renderSrLevels);
                DOM.srLegendHeader.addEventListener('click', () => {
                    const isCollapsed = DOM.srLegendContent.style.display === 'none';
                    DOM.srLegendContent.style.display = isCollapsed ? 'block' : 'none';
                    DOM.srLegendHeader.classList.toggle('collapsed', !isCollapsed);
                    DOM.srLegendToggleBtn.textContent = isCollapsed ? '‚àí' : '+';
                    DOM.srLegendToggleBtn.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
                });
            }
            
            // --- EVENT HANDLER LOGIC ---
            function handleAddTradeSubmit(e) {
                e.preventDefault();
                if (!STATE.isMasterUser) return alert('You do not have permission to add trades.');
                
                const { FEE_RATE } = CONFIG.TRADE_SETTINGS;

                const trade = {
                    symbol: document.getElementById('trade-symbol').value,
                    type: document.getElementById('trade-type').value,
                    entry: parseFloat(document.getElementById('entry-price').value),
                    stoploss: parseFloat(document.getElementById('stop-loss').value),
                    target: parseFloat(document.getElementById('target').value),
                    size: parseFloat(document.getElementById('position-value').value),
                    date: firebase.database.ServerValue.TIMESTAMP
                };

                if (Object.values(trade).some(val => val === null || isNaN(val) && typeof val === 'number')) {
                    return alert('Please ensure all numeric fields are filled correctly.');
                }
                
                if (trade.type === 'Long') {
                    if (trade.target <= trade.entry) { return alert('Validation Error: For a Long trade, the Target must be higher than the Entry Price.'); }
                    if (trade.stoploss >= trade.entry) { return alert('Validation Error: For a Long trade, the Stop Loss must be lower than the Entry Price.'); }
                } else { // Short
                    if (trade.target >= trade.entry) { return alert('Validation Error: For a Short trade, the Target must be lower than the Entry Price.'); }
                    if (trade.stoploss <= trade.entry) { return alert('Validation Error: For a Short trade, the Stop Loss must be higher than the Entry Price.'); }
                }

                const positionQty = trade.size / trade.entry;
                const entryFee = trade.size * FEE_RATE;
                const exitValueAtTarget = (trade.target / trade.entry) * trade.size;
                const exitFeeAtTarget = exitValueAtTarget * FEE_RATE;
                const exitValueAtStop = (trade.stoploss / trade.entry) * trade.size;
                const exitFeeAtStop = exitValueAtStop * FEE_RATE;
                const totalFeeAtTarget = entryFee + exitFeeAtTarget;
                const totalFeeAtStop = entryFee + exitFeeAtStop;

                let potentialProfit, potentialLoss;
                if (trade.type === 'Long') {
                    potentialProfit = positionQty * (trade.target - trade.entry);
                    potentialLoss = positionQty * (trade.entry - trade.stoploss);
                } else { // Short
                    potentialProfit = positionQty * (trade.entry - trade.target);
                    potentialLoss = positionQty * (trade.stoploss - trade.entry);
                }
                
                trade.estimated_total_fee = totalFeeAtTarget;
                trade.expected_profit = potentialProfit - totalFeeAtTarget;
                trade.expected_loss = potentialLoss + totalFeeAtStop; 
                trade.expected_profit_percent = (trade.expected_profit / trade.size) * 100;
                trade.expected_loss_percent = (trade.expected_loss / trade.size) * 100;

                dbRefs.trades.push(trade)
                    .then(() => e.target.reset())
                    .catch(error => alert(`Error adding trade: ${error.message}`));
            }

            function handleSentimentLog(e) {
                const button = e.target.closest('.sentiment-buttons button');
                if (!button) return;

                const { asset, sentiment } = button.dataset;
                if (!asset || !sentiment) return;
                
                const receipt = {
                    asset: asset,
                    sentiment: sentiment,
                    timestamp: firebase.database.ServerValue.TIMESTAMP, 
                    viewerId: getViewerId()
                };

                dbRefs.sentimentReceipts.push(receipt)
                    .catch(error => {
                        console.error("Failed to log sentiment receipt:", error);
                        alert("Could not log your sentiment. Please try again.");
                    });
            }

            function handleSentimentDelete(e) {
                const button = e.target;
                const receiptId = button.dataset.id;
                if (!receiptId) return;

                if (confirm('Are you sure you want to delete this log entry?')) {
                    dbRefs.sentimentReceipts.child(receiptId).remove()
                        .catch(error => {
                            console.error('Failed to delete sentiment entry:', error);
                            alert('Could not delete the entry. Please try again.');
                        });
                }
            }

            function handleSentimentNoteEdit(e) {
                const button = e.target;
                const receiptId = button.dataset.id;
                if (!receiptId) return;

                const receiptRef = dbRefs.sentimentReceipts.child(receiptId);
                receiptRef.child('note').once('value', snapshot => {
                    const currentNote = snapshot.val() || '';
                    const newNote = prompt('Enter a note for this entry:', currentNote);
                    
                    if (newNote !== null) {
                        receiptRef.update({ note: newNote })
                            .catch(error => {
                                console.error('Failed to update sentiment note:', error);
                                alert('Could not save the note. Please try again.');
                            });
                    }
                });
            }

            function handleImageLibraryClick(e) {
                const deleteBtn = e.target.closest('.delete-library-image');
                const editBtn = e.target.closest('.edit-caption-btn');
                const img = e.target.closest('img');

                if (deleteBtn && STATE.isMasterUser) {
                    const { id, filename } = deleteBtn.dataset;
                    if (confirm(`Delete this image from the library?\n\n${filename}`)) {
                        const storagePath = `image_library/${filename}`;
                        storage.ref(storagePath).delete()
                            .then(() => dbRefs.imageLibrary.child(id).remove())
                            .catch((err) => {
                                console.warn("Storage deletion failed, maybe already gone. Deleting DB entry.", err.code);
                                if (err.code === 'storage/object-not-found') {
                                    dbRefs.imageLibrary.child(id).remove();
                                } else {
                                    alert('Error deleting image.');
                                }
                            });
                    }
                } else if (editBtn && STATE.isMasterUser) {
                    handleEditCaption(editBtn.dataset.id);
                } else if (img) {
                    DOM.modalImageContent.src = img.dataset.fullSrc;
                    DOM.modalCaption.textContent = img.dataset.caption || '';
                    DOM.imageModal.style.display = 'flex';
                }
            }
            
            function handleEditCaption(id) {
                if (!id || !STATE.isMasterUser) return;
                
                const imageRef = dbRefs.imageLibrary.child(id);
                
                imageRef.child('caption').once('value', snapshot => {
                    const currentCaption = snapshot.val() || '';
                    const newCaption = prompt('Enter image caption:', currentCaption);

                    if (newCaption !== null) {
                        imageRef.update({ caption: newCaption.trim() })
                            .catch(error => {
                                console.error('Failed to update caption:', error);
                                alert('Could not save the caption. Please try again.');
                            });
                    }
                });
            }

            function handleTradeAction(e) {
                if (!STATE.isMasterUser) return;
                const button = e.target.closest('button');
                if (!button) return;
                
                const { id } = button.dataset;
                const tradeRef = button.closest('tbody').id === 'completed-trades-tbody'
                    ? dbRefs.completedTrades.child(id) 
                    : dbRefs.trades.child(id);

                if (button.matches('.win-btn')) completeTrade(id, 'win');
                else if (button.matches('.loss-btn')) completeTrade(id, 'loss');
                else if (button.matches('.delete-btn, .delete-btn-completed')) {
                    if (confirm('Are you sure you want to delete this trade?')) tradeRef.remove();
                } 
                else if (button.matches('.note-btn, .note-btn-completed')) {
                    tradeRef.child('note').once('value', snapshot => {
                        const newNote = prompt("Enter note:", snapshot.val() || "");
                        if (newNote !== null) tradeRef.update({ note: newNote });
                    });
                }
            }
            
            function handleImageDelete(e) {
                const button = e.target.closest('.delete-journal-image');
                if (!STATE.isMasterUser || !button) return;
                
                const { safeSymbol, timeframe, id, filename } = button.dataset;
                if (confirm(`Delete this image?\n\n${filename}`)) {
                    const storagePath = `journal_images/${safeSymbol}/${timeframe}/${filename}`;
                    const dbPath = `${CONFIG.DB_PATHS.JOURNAL_IMAGES}/${safeSymbol}/${timeframe}/${id}`;
                    
                    storage.ref(storagePath).delete()
                        .then(() => database.ref(dbPath).remove())
                        .catch((err) => {
                            console.warn("Storage deletion failed, maybe already gone. Deleting DB entry.", err.code);
                            if (err.code === 'storage/object-not-found') {
                                database.ref(dbPath).remove();
                            }
                        });
                }
            }
            
            function handleFavouriteClick() {
                if (!STATE.isMasterUser) return;
                const safeSymbol = getSafeSymbol(DOM.journalSymbolEl.value);
                const timeframe = DOM.journalTimeframeEl.value;
                const currentText = DOM.journalEntryEl.value.trim();

                const dbFavouriteRef = dbRefs.favourites.child(safeSymbol).child(timeframe);

                if (DOM.favouriteBtn.classList.contains('active')) {
                    dbFavouriteRef.remove();
                } else {
                    if (!currentText) return alert('Cannot pin an empty note.');
                    dbFavouriteRef.set(currentText);
                }
            }

            // --- FIREBASE DATA SUBSCRIPTIONS ---
            function subscribeToData() {
                dbRefs.trades.on('value', snapshot => {
                    const liveTrades = snapshot.val() || {};
                    renderLiveTable(liveTrades);
                    DOM.statOpenTrades.textContent = Object.keys(liveTrades).length;
                });
                
                dbRefs.completedTrades.on('value', snapshot => {
                    const completedData = snapshot.val() || {};
                    renderCompletedTable(completedData);

                    const { STARTING_BALANCE, USD_TO_AUD_RATE } = CONFIG.TRADE_SETTINGS;
                    const totalProfitLoss = Object.values(completedData).reduce((sum, trade) => sum + (trade.net_result || 0), 0);
                    const totalProfitLossAud = totalProfitLoss * USD_TO_AUD_RATE;
                    const newBalance = STARTING_BALANCE + totalProfitLoss;

                    DOM.statBalance.textContent = formatCurrency(newBalance);
                    DOM.statBalanceAud.textContent = formatCurrency(newBalance * USD_TO_AUD_RATE, 'A$');
                    
                    DOM.statTotalPl.textContent = `${totalProfitLoss >= 0 ? '+' : ''}${formatCurrency(totalProfitLoss)}`;
                    DOM.statTotalPl.style.color = totalProfitLoss >= 0 ? '#28a745' : '#dc3545';
                    
                    DOM.statTotalPlAud.textContent = `${totalProfitLossAud >= 0 ? '+' : ''}${formatCurrency(totalProfitLossAud, 'A$')}`;
                    DOM.statTotalPlAud.style.color = totalProfitLossAud >= 0 ? '#28a745' : '#dc3545';

                    DOM.statCompletedTrades.textContent = Object.keys(completedData).length;

                    dbRefs.bank.set({ currentBalance: newBalance });
                });

                dbRefs.journalText.on('value', (s) => {
                    STATE.journalText = s.val() || {};
                    if (DOM.journalTab.classList.contains('active')) updateJournalView();
                });
                
                dbRefs.journalImages.on('value', (s) => {
                    STATE.journalImages = s.val() || {};
                    if (DOM.journalTab.classList.contains('active')) updateJournalView();
                    if (DOM.snapshotTab.classList.contains('active')) renderSnapshotView();
                });

                dbRefs.imageLibrary.on('value', (s) => {
                    renderImageLibrary(s.val());
                });
                
                dbRefs.favourites.on('value', (s) => {
                    STATE.favouriteEntries = s.val() || {};
                    if (DOM.journalTab.classList.contains('active')) updateJournalView();
                });

                dbRefs.setups1.on('value', (s) => {
                    STATE.setupsData1 = s.val() || {};
                    renderSetupsTable(DOM.setupsTable1, STATE.setupsData1);
                });
                dbRefs.setups2.on('value', (s) => {
                    STATE.setupsData2 = s.val() || {};
                    renderSetupsTable(DOM.setupsTable2, STATE.setupsData2);
                });
                
                dbRefs.persistentNotes.on('value', (s) => {
                    STATE.persistentNotes = s.val() || '';
                    if (DOM.journalTab.classList.contains('active')) {
                         DOM.persistentNotesEl.value = STATE.persistentNotes;
                         autoResizeTextarea(DOM.persistentNotesEl);
                    }
                });

                dbRefs.sentimentReceipts.on('value', (s) => {
                    renderSentimentReceipts(s.val());
                });
            }

            // --- INITIALIZATION ---
            function checkMasterMode() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('master') === 'true') {
                    const password = prompt("Please enter master password:");
                    if (password) {
                        STATE.isMasterUser = true;
                        STATE.masterPassword = password;
                        document.querySelectorAll('.master-only').forEach(el => {
                            if (el.id === 'add-trade-form') el.style.display = 'grid';
                            else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                            else if (el.id === 'favourite-btn') el.style.display = 'block';
                            else if (el.id.startsWith('save-setups-')) el.style.display = 'inline-block';
                            else el.style.display = 'block';
                        });
                        DOM.journalEntryEl.readOnly = false;
                        DOM.persistentNotesEl.readOnly = false;
                        document.querySelectorAll('.setups-table td').forEach(cell => {
                            cell.setAttribute('contenteditable', 'true');
                        });
                    }
                }
                 if (!STATE.isMasterUser) {
                    DOM.journalEntryEl.readOnly = true;
                    DOM.persistentNotesEl.readOnly = true;
                }
            }

            function initializeApp() {
                checkMasterMode();
                getViewerId();
                
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    DOM.themeToggle.checked = savedTheme === 'dark';
                }
                
                const today = new Date();
                today.setUTCHours(0, 0, 0, 0);
                STATE.selectedDate = new Date(today);
                STATE.centerDate = new Date(today);
                
                setupEventListeners();
                subscribeToData();
                
                fetchEmaData();
                fetchSrData();
                
                renderDateNavigation();
            }

            initializeApp();
        });
    </script>
</body>
</html>
