<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h2 {
            margin-top: 40px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .section-header {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .backup-controls {
            position: absolute;
            right: 0;
            display: flex;
            gap: 10px;
        }
        .backup-controls button, .backup-controls label {
            font-size: 12px;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #6c757d;
            border: none;
            color: white;
            border-radius: 4px;
        }
        .backup-controls input[type="file"] { display: none; }

        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: #666; }
        
        /* --- Tabs --- */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px; /* Align with container border */
        }
        .tab-link.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        #bank-balance-container {
            text-align: center;
            margin: 10px auto 25px auto;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 8px;
            max-width: 400px;
        }
        #bank-balance-value { font-weight: bolder; }

        .master-only { display: none; }

        #add-trade-form {
            max-width: 950px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }
        #add-trade-form div { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 5px;
        }
        button.delete-btn, button.delete-btn-completed { background-color: #dc3545; }
        button.win-btn { background-color: #28a745; }
        button.loss-btn { background-color: #ffc107; color: #333; }

        button:hover { opacity: 0.85; }

        .action-buttons button {
            display: inline-block;
            width: auto;
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        th { background-color: #e9ecef; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        #loading-state, #loading-state-completed { text-align: center; padding: 40px; font-size: 18px; color: #777; }
        
        /* --- Journal Styles --- */
        #journal-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 500px;
            margin: 20px auto;
        }
        #journal-entry {
            width: 100%;
            height: 60vh;
            resize: vertical;
            line-height: 1.6;
            margin-top: 10px;
        }
        #journal-entry:read-only {
            background-color: #f8f9fa;
            cursor: not-allowed;
            color: #555;
        }


        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; }
            h1 { font-size: 24px; }
            #add-trade-form { grid-template-columns: 1fr; }
            table, th, td { font-size: 12px; padding: 6px; }
            .section-header { flex-direction: column; }
            .backup-controls { position: static; margin-top: 10px; }
        }
        @media (max-width: 480px) { table, th, td { font-size: 11px; padding: 4px; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Live Trade & Journal Tracker</h1>
        <p class="subtitle">Data updates in real-time for all viewers.</p>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal</button>
        </div>
        
        <!-- Tab 1: Trade Tracker -->
        <div id="tracker-tab" class="tab-content active">
            <div id="bank-balance-container">
                Current Balance: <span id="bank-balance-value">$0.00</span>
            </div>

            <form id="add-trade-form" class="master-only">
                 <div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTCUSDT">BTCUSDT</option><option value="ETHUSDT">ETHUSDT</option></select></div>
                 <div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                 <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                 <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                 <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                 <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                 <div><button type="submit">Add Trade</button></div>
            </form>

            <div class="section-header">
                <h2>Live Trades</h2>
                <div class="backup-controls master-only">
                    <button id="save-live-btn">Save JSON</button>
                    <label for="load-live-input">Load JSON</label>
                    <input type="file" id="load-live-input" accept=".json">
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th><th>Type</th><th>Entry Price</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>Date Opened</th><th class="master-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trades-tbody"><tr id="loading-state"><td colspan="9">Connecting to database...</td></tr></tbody>
                </table>
            </div>

            <div class="section-header">
                <h2>Completed Trades</h2>
                <div class="backup-controls master-only">
                    <button id="save-completed-btn">Save JSON</button>
                    <label for="load-completed-input">Load JSON</label>
                    <input type="file" id="load-completed-input" accept=".json">
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th><th>Type</th><th>Entry Price</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th class="master-only">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="completed-trades-tbody"><tr id="loading-state-completed"><td colspan="8">Loading completed trades...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Journal -->
        <div id="journal-tab" class="tab-content">
            <h2>Text Journal</h2>
            <div id="journal-controls">
                <label for="journal-timeframe">Select Entry:</label>
                <select id="journal-timeframe">
                    <option value="15min">15min</option>
                    <option value="30min">30min</option>
                    <option value="1hour">1hour</option>
                    <option value="2hour">2hour</option>
                    <option value="4hour">4hour</option>
                    <option value="daily">Daily</option>
                </select>
            </div>
            <textarea id="journal-entry" placeholder="Select a timeframe and start typing your journal entry... (View only for non-master users)"></textarea>
            <p id="save-status" style="text-align:center; font-style:italic; color:#666; height: 1em;"></p>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
        authDomain: "journal-a003f.firebaseapp.com",
        databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "journal-a003f",
        storageBucket: "journal-a003f.appspot.com",
        messagingSenderId: "1038636626553",
        appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const tradesRef = database.ref('trades');
    const completedTradesRef = database.ref('completed_trades');
    const bankRef = database.ref('bank');
    const journalRef = database.ref('journal'); // New reference for the journal
    const FEE_RATE = 0.00075;
    const STARTING_BALANCE = 4000;

    document.addEventListener('DOMContentLoaded', function () {
        let isMasterUser = false;
        let allJournalEntries = {}; // To cache journal data
        
        const bankValueEl = document.getElementById('bank-balance-value');
        const journalTimeframeEl = document.getElementById('journal-timeframe');
        const journalEntryEl = document.getElementById('journal-entry');
        const saveStatusEl = document.getElementById('save-status');


        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true') {
                isMasterUser = true;
                document.querySelectorAll('.master-only').forEach(el => {
                    if (el.id === 'add-trade-form') el.style.display = 'grid';
                    else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                    else el.style.display = 'flex';
                });
                document.getElementById('loading-state')?.firstElementChild?.setAttribute("colspan", "10");
                document.getElementById('loading-state-completed')?.firstElementChild?.setAttribute("colspan", "9");
                journalEntryEl.readOnly = false; // Allow editing for master
            } else {
                document.getElementById('loading-state')?.firstElementChild?.setAttribute("colspan", "9");
                document.getElementById('loading-state-completed')?.firstElementChild?.setAttribute("colspan", "8");
                journalEntryEl.readOnly = true; // Make read-only for viewers
            }
        }
        
        checkMasterMode();

        // --- Utility ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // --- Tab Switching Logic ---
        document.querySelector('.tabs').addEventListener('click', (e) => {
            if (e.target.matches('.tab-link')) {
                document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab + '-tab').classList.add('active');
            }
        });
        
        // --- Journal Logic ---
        function updateJournalView() {
            const selectedTimeframe = journalTimeframeEl.value;
            journalEntryEl.value = allJournalEntries[selectedTimeframe] || '';
        }

        const saveJournalEntry = debounce(() => {
            if (!isMasterUser) return;
            const selectedTimeframe = journalTimeframeEl.value;
            const newText = journalEntryEl.value;
            saveStatusEl.textContent = 'Saving...';
            journalRef.child(selectedTimeframe).set(newText)
                .then(() => {
                    setTimeout(() => saveStatusEl.textContent = 'Saved.', 200);
                    setTimeout(() => saveStatusEl.textContent = '', 2000);
                })
                .catch(err => saveStatusEl.textContent = `Error: ${err.message}`);
        }, 750); // Save 750ms after user stops typing

        journalTimeframeEl.addEventListener('change', updateJournalView);
        journalEntryEl.addEventListener('input', saveJournalEntry);
        
        journalRef.on('value', (snapshot) => {
            allJournalEntries = snapshot.val() || {};
            // If the journal tab is active, update the view immediately
            if (document.getElementById('journal-tab').classList.contains('active')) {
                updateJournalView();
            }
        });

        // --- Render functions (unchanged) ---
        function renderLiveTable(tradesData) {
            const tradesTbody = document.getElementById('trades-tbody');
            tradesTbody.innerHTML = '';
            const colspan = isMasterUser ? 10 : 9;
            if (!tradesData) {
                tradesTbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">No live trades.</td></tr>`;
                return;
            }
            const tradeIds = Object.keys(tradesData).sort((a, b) => new Date(tradesData[b].date) - new Date(tradesData[a].date));
            tradeIds.forEach(tradeId => {
                const trade = tradesData[tradeId];
                const row = document.createElement('tr');
                let masterColumn = isMasterUser ? `<td class="action-buttons"><button class="win-btn" data-id="${tradeId}">Win</button><button class="loss-btn" data-id="${tradeId}">Loss</button><button class="delete-btn" data-id="${tradeId}">Delete</button></td>` : '';
                row.innerHTML = `<td>${trade.symbol}</td><td>${trade.type}</td><td>${parseFloat(trade.entry).toFixed(2)}</td><td>${parseFloat(trade.stoploss).toFixed(2)}</td><td>${parseFloat(trade.target).toFixed(2)}</td><td>${parseFloat(trade.size).toFixed(2)}</td><td style="color: #28a745;">${parseFloat(trade.expected_profit).toFixed(2)}</td><td style="color: #dc3545;">${parseFloat(trade.expected_loss).toFixed(2)}</td><td>${trade.date}</td>${masterColumn}`;
                tradesTbody.appendChild(row);
            });
        }
        
        function renderCompletedTable(tradesData) {
            const completedTbody = document.getElementById('completed-trades-tbody');
            completedTbody.innerHTML = '';
            const colspan = isMasterUser ? 9 : 8;
            if (!tradesData) {
                completedTbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">No completed trades yet.</td></tr>`;
                return;
            }
            const tradeIds = Object.keys(tradesData).sort((a, b) => new Date(tradesData[b].closed_date) - new Date(tradesData[a].closed_date));
            tradeIds.forEach(tradeId => {
                const trade = tradesData[tradeId];
                const row = document.createElement('tr');
                const resultColor = trade.net_result >= 0 ? '#28a745' : '#dc3545';
                let masterColumn = isMasterUser ? `<td class="action-buttons"><button class="delete-btn-completed" data-id="${tradeId}">Delete</button></td>` : '';
                const totalFees = (trade.entry_fee || 0) + (trade.exit_fee || 0);
                row.innerHTML = `<td>${trade.symbol}</td><td>${trade.type}</td><td>${parseFloat(trade.entry).toFixed(2)}</td><td>${parseFloat(trade.exit_price).toFixed(2)}</td><td>${totalFees.toFixed(2)}</td><td style="color: ${resultColor}; font-weight: bold;">${parseFloat(trade.net_result).toFixed(2)}</td><td>${trade.date}</td><td>${trade.closed_date}</td>${masterColumn}`;
                completedTbody.appendChild(row);
            });
        }
        
        // --- Calculation and Firebase interaction functions (unchanged) ---
        function calculateNetResult(trade, exitPrice) {
            const entry = parseFloat(trade.entry), posValue = parseFloat(trade.size), exit = parseFloat(exitPrice);
            if (isNaN(entry) || isNaN(posValue) || isNaN(exit)) return { net_result: 0, entry_fee: 0, exit_fee: 0 };
            const entryFee = posValue * FEE_RATE, exitPosValue = (exit / entry) * posValue, exitFee = exitPosValue * FEE_RATE;
            const grossResult = trade.type === "Long" ? (exit - entry) * (posValue / entry) : (entry - exit) * (posValue / entry);
            return { net_result: grossResult - entryFee - exitFee, entry_fee: entryFee, exit_fee: exitFee };
        }

        function completeTrade(tradeId, outcome) {
            database.ref('trades/' + tradeId).once('value', snapshot => {
                const trade = snapshot.val();
                if (!trade) return;
                const defaultExit = outcome === 'win' ? trade.target : trade.stoploss;
                const exitPriceStr = prompt(`Enter the exact exit price:`, defaultExit);
                if (exitPriceStr === null) return;
                const exitPrice = parseFloat(exitPriceStr);
                if (isNaN(exitPrice)) return alert("Invalid exit price. Action cancelled.");
                const { net_result, entry_fee, exit_fee } = calculateNetResult(trade, exitPrice);
                const completedTrade = { ...trade, closed_date: new Date().toLocaleString(), exit_price: exitPrice, net_result, entry_fee, exit_fee };
                delete completedTrade.expected_profit;
                delete completedTrade.expected_loss;
                completedTradesRef.push(completedTrade).then(() => tradesRef.child(tradeId).remove());
            });
        }
        
        function saveToJSON(ref, fileNamePrefix) {
            ref.once('value', snapshot => {
                const data = snapshot.val();
                if (!data) return alert("No data available to save.");
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileNamePrefix}_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                a.remove();
            });
        }

        function loadFromJSON(event, ref, sectionName) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm(`Are you sure you want to restore ${sectionName} trades? This will OVERWRITE all current ${sectionName} data.`)) {
                event.target.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    ref.set(data).then(() => alert(`${sectionName} trades restored.`)).catch(err => alert(`Error: ${err.message}`));
                } catch (err) { alert(`Error parsing JSON: ${err.message}`); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- EVENT LISTENERS (unchanged part) ---
        completedTradesRef.on('value', snapshot => {
            const completedData = snapshot.val();
            renderCompletedTable(completedData);
            let totalNetProfitLoss = 0;
            if (completedData) {
                totalNetProfitLoss = Object.values(completedData).reduce((sum, trade) => sum + (trade.net_result || 0), 0);
            }
            const newBalance = STARTING_BALANCE + totalNetProfitLoss;
            bankRef.set({ currentBalance: newBalance });
        });

        bankRef.on('value', snapshot => {
            let currentBalance = STARTING_BALANCE;
            if (snapshot.exists() && snapshot.val().currentBalance !== null) {
                currentBalance = snapshot.val().currentBalance;
            }
            bankValueEl.textContent = `$${parseFloat(currentBalance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            bankValueEl.style.color = currentBalance >= STARTING_BALANCE ? '#28a745' : '#dc3545';
        });
        
        tradesRef.on('value', snapshot => renderLiveTable(snapshot.val()));

        document.getElementById('add-trade-form').addEventListener('submit', e => {
            e.preventDefault(); if (!isMasterUser) return;
            const newTrade = { symbol: document.getElementById('trade-symbol').value, date: new Date().toLocaleString(), type: document.getElementById('trade-type').value, entry: document.getElementById('entry-price').value, stoploss: document.getElementById('stop-loss').value, target: document.getElementById('target').value, size: document.getElementById('position-value').value };
            const profitCalc = calculateNetResult(newTrade, newTrade.target);
            const lossCalc = calculateNetResult(newTrade, newTrade.stoploss);
            newTrade.expected_profit = profitCalc.net_result;
            newTrade.expected_loss = lossCalc.net_result;
            tradesRef.push(newTrade);
            e.target.reset();
        });

        document.getElementById('trades-tbody').addEventListener('click', e => {
            if (!isMasterUser) return;
            const { classList, dataset } = e.target;
            if (!dataset.id) return;
            if (classList.contains('delete-btn')) if (confirm('Delete this live trade?')) tradesRef.child(dataset.id).remove();
            if (classList.contains('win-btn')) completeTrade(dataset.id, 'win');
            if (classList.contains('loss-btn')) completeTrade(dataset.id, 'loss');
        });

        document.getElementById('completed-trades-tbody').addEventListener('click', e => {
            if (!isMasterUser || !e.target.classList.contains('delete-btn-completed')) return;
            if (confirm('Delete this completed trade? This CANNOT be undone.')) completedTradesRef.child(e.target.dataset.id).remove();
        });

        document.getElementById('save-live-btn').addEventListener('click', () => saveToJSON(tradesRef, 'live_trades_backup'));
        document.getElementById('load-live-input').addEventListener('change', e => loadFromJSON(e, tradesRef, 'Live'));
        document.getElementById('save-completed-btn').addEventListener('click', () => saveToJSON(completedTradesRef, 'completed_trades_backup'));
        document.getElementById('load-completed-input').addEventListener('change', e => loadFromJSON(e, completedTradesRef, 'Completed'));
    });
</script>

</body>
</html>
