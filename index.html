<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #333;
            --border-color: #e0e6ed;
            --header-bg: #f8f9fa;
            --link-color: #007bff;
            --subtle-text: #6c757d;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --shadow-color-hover: rgba(0, 0, 0, 0.1);
            --green-bg: #d4edda;
            --red-bg: #f8d7da;
            --purple-bg: #e2d9f3;
            --green-border: #c3e6cb;
            --red-border: #f5c6cb;
            --green-text: #155724;
            --red-text: #721c24;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #343a40;
            --header-bg: #2c2c2c;
            --link-color: #58a6ff;
            --subtle-text: #888;
            --card-bg: #212529;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --shadow-color-hover: rgba(0, 0, 0, 0.3);
            --green-bg: #1c3b23;
            --red-bg: #4d1f24;
            --purple-bg: #3c2a4d;
            --green-border: #285732;
            --red-border: #6b282e;
            --green-text: #a7d7b2;
            --red-text: #f5b7bd;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            background: transparent; 
            padding: 0; 
        }
        
        /* REVAMP: Beautiful Page Title */
        .page-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }
        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-color);
        }
        .page-header p.subtitle {
            margin-top: 5px;
            font-size: 1rem;
            color: var(--subtle-text);
        }

        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
        .tab-link { padding: 12px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 1rem; font-weight: 500; color: var(--subtle-text); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: color 0.2s, border-color 0.2s; }
        .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
        .tab-content { display: none; }
        .tab-content.active { display: grid; gap: 20px; }
        
        .master-only { display: none; }
        
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; font-weight: 500;}
        button:hover { opacity: 0.85; }
        
        /* REVAMP: Collapsible Section Card Styling */
        .section-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            transition: box-shadow 0.2s ease-in-out;
            overflow: hidden;
        }
        .section-card:hover {
            box-shadow: 0 10px 15px -3px var(--shadow-color-hover);
        }
        .section-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .section-card.collapsed .section-card-header {
            border-bottom-color: transparent;
        }
        .section-card h2, .section-card h3 {
            margin: 0;
            padding: 0;
            border: none;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .toggle-section-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 24px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            font-weight: bold;
            margin: 0;
            transition: transform 0.3s ease, color 0.2s, border-color 0.2s;
        }
        .section-card-header:hover .toggle-section-btn {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .section-card.collapsed .toggle-section-btn {
            transform: rotate(45deg);
        }
        .section-card-content {
            padding: 20px;
            max-height: 5000px; /* Arbitrarily large number */
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, opacity 0.5s ease;
            opacity: 1;
        }
        .section-card.collapsed .section-card-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
            opacity: 0;
        }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
        th { background-color: var(--header-bg); font-weight: 600; vertical-align: middle; text-align: center; }
        .action-buttons button { padding: 5px 8px; font-size: 12px; margin-right: 4px; }
        .note-cell { white-space: normal; max-width: 300px; min-width: 150px; font-size: 12px; line-height: 1.4; }

        #add-trade-form { max-width: 100%; margin: 0; padding: 0; border: none; background-color: transparent; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        #journal-entry, #persistent-notes-entry, #tracker-scratchpad {
            width: 100%; 
            resize: vertical;
            line-height: 1.6;
            margin-top: 5px;
            overflow-y: hidden; 
            min-height: 120px; 
            background-color: var(--bg-color);
        }

        #stats-panel-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        #stats-fab:hover { transform: scale(1.1); }
        #stats-fab svg { width: 28px; height: 28px; fill: white; }
        #stats-panel { position: absolute; bottom: 80px; right: 0; width: 320px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 20px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; border: 1px solid var(--border-color); }
        #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .stats-header h3 { margin: 0; font-size: 18px; font-weight: 600; color: var(--text-color); }
        .stat-value { font-weight: 600; }
        
        .page-header .theme-switch-wrapper {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 0;
        }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: var(--link-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .cl2-folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
        }
        .cl2-folder-card {
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .cl2-folder-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px var(--shadow-color-hover); border-color: var(--link-color); }
        .cl2-folder-icon { font-size: 32px; color: var(--link-color); }
        .cl2-folder-card h4 { margin: 8px 0 2px 0; font-size: 14px; font-weight: 500; }
        .cl2-folder-count { font-size: 11px; color: var(--subtle-text); }
        .cl2-folder-card.drag-over { border-style: dashed; transform: scale(1.05); }

        .setups-table td[contenteditable="true"]:focus { background-color: var(--header-bg); outline: 2px solid var(--link-color); }
        .setups-controls { text-align: right; margin-top: 15px; }
        .setups-save-status { text-align:right; font-style:italic; color:var(--subtle-text); height:1em; margin-top: 5px; }

        .editable-cell[contenteditable="true"]:focus { background-color: var(--header-bg); outline: 2px solid var(--link-color); box-shadow: 0 0 5px var(--shadow-color); }
        .toggle-history-btn {
            font-size: 12px;
            padding: 4px 10px;
            cursor: pointer;
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            border-radius: 4px;
            display: none;
        }
        
        .in-merge-mode #completed-trades-tbody tr { cursor: crosshair; }
        .in-merge-mode #completed-trades-tbody tr:hover { background-color: var(--header-bg); }
        #completed-trades-tbody tr.is-merge-base { background-color: var(--purple-bg) !important; color: var(--text-color); }
        #completed-trades-tbody tr.is-merge-base td { font-weight: bold; }

        #journal-images-container { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;}
        .journal-image-wrapper { position: relative; width: 100%; border: 1px solid var(--border-color); padding: 5px; background: var(--bg-color); border-radius: 8px; }
        .journal-image-wrapper img { width: 100%; height: auto; display: block; border-radius: 4px; cursor: pointer; aspect-ratio: 16/9; object-fit: cover;}
        .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s; opacity: 0; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .journal-image-wrapper:hover .delete-journal-image { opacity: 1; }
        .delete-journal-image svg { width: 14px; height: 14px; fill: white; }

        #image-library-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .library-image-wrapper { position: relative; border: 1px solid var(--border-color); padding: 5px; background: var(--bg-color); border-radius: 4px; aspect-ratio: 16 / 9; overflow: hidden; display: flex; flex-direction: column; }
        .library-image-wrapper img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 2px; cursor: pointer; transition: transform 0.2s; }
        .library-image-wrapper:hover img { transform: scale(1.05); }

        .modal-overlay { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { margin: auto; display: block; max-width: 90vw; max-height: 85vh; }
        .modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 2002; }
        .modal-nav { position: fixed; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; background-color: rgba(255, 255, 255, 0.2); color: #fff; border: none; border-radius: 50%; font-size: 28px; cursor: pointer; z-index: 2001; }
        #modal-prev { left: 20px; }
        #modal-next { right: 20px; }
        #modal-caption { text-align: center; color: #ccc; padding: 15px 0; font-size: 18px; }

        .date-nav-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px auto 20px auto; }
        #date-buttons-container { display: flex; gap: 8px; }
        .date-nav-btn { padding: 8px 12px; font-size: 14px; background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--subtle-text); border-radius: 6px; cursor: pointer; }
        .date-nav-btn.active { background-color: var(--link-color); color: white; border-color: var(--link-color); font-weight: bold; }
        .date-nav-btn.has-entry { border-bottom: 3px solid var(--green-border); }
        .date-nav-arrow { background: none; border: none; font-size: 24px; color: var(--subtle-text); cursor: pointer; padding: 0 10px; }

        @media (max-width: 768px) { 
            body { padding: 10px; }
            .page-header { text-align: left; padding-left: 10px; }
            .page-header h1 { font-size: 1.8rem; }
            .page-header .theme-switch-wrapper { right: 10px; }
            th, td { font-size: 12px; padding: 6px; } 
            .action-buttons button { font-size: 11px; padding: 4px 8px; } 
            #stats-panel-container { bottom: 10px; right: 10px; }
            #stats-fab { width: 50px; height: 50px; }
            #stats-panel { width: calc(100vw - 40px); }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
             <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-checkbox">
                    <input type="checkbox" id="theme-checkbox" />
                    <div class="slider round"></div>
                </label>
            </div>
            <h1>Trade Tracker</h1>
            <p class="subtitle">A Comprehensive Dashboard for Journaling and Analysis</p>
        </div>
        
        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">×</button></div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                     <hr style="grid-column: 1 / -1; border: 0; border-top: 1px solid var(--border-color); margin: 5px 0;">
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item">
                        <span class="stat-label">Wins / Losses</span>
                        <div><span id="stat-wins" class="stat-value" style="color: var(--green-text);">0</span> / <span id="stat-losses" class="stat-value" style="color: var(--red-text);">0</span></div>
                    </div>
                    <div class="stat-item"><span class="stat-label">Win Rate</span><span id="stat-win-rate" class="stat-value">0.0%</span></div>
                    <div class="stat-item"><span class="stat-label">Profit Factor</span><span id="stat-profit-factor" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Win</span><span id="stat-avg-win" class="stat-value" style="color: var(--green-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Loss</span><span id="stat-avg-loss" class="stat-value" style="color: var(--red-text);">$0.00</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z" fill="white"/></svg></button>
        </div>
    
        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal & Setups</button>
            <button class="tab-link" data-tab="snapshot">Snapshot</button>
            <button class="tab-link" data-tab="sr-levels">S/R Levels</button>
        </div>
        
        <div id="tracker-tab" class="tab-content active">
            <div class="section-card collapsed master-only">
                <div class="section-card-header">
                    <h2>Add New Trade</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                     <form id="add-trade-form">
                        <div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                        <div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                        <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                        <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                        <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                        <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                        <div><button type="submit">Add Trade</button></div>
                    </form>
                </div>
            </div>

            <div class="section-card">
                <div class="section-card-header">
                    <h2>Live Trades</h2>
                    <button class="toggle-section-btn">−</button>
                </div>
                <div class="section-card-content">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th>Symbol</th><th>Type</th><th>Avg. Entry</th><th>Entries</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Est. Total Fee ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>Date Opened</th><th>Note</th><th class="master-only">Actions</th></tr>
                            </thead>
                            <tbody id="trades-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section-card collapsed">
                <div class="section-card-header">
                    <h2>Completed Trades</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                    <div style="text-align: right; margin-bottom: 10px;">
                        <button id="toggle-old-trades" class="toggle-history-btn">Show All</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th>Symbol</th><th>Type</th><th>Avg. Entry</th><th>Entries</th><th>Target</th><th>Position Value ($)</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th>Note</th><th class="master-only">Actions</th></tr>
                            </thead>
                            <tbody id="completed-trades-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section-card collapsed">
                <div class="section-card-header">
                    <h2>Chart Library</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                    <div id="chart-library-2-container" class="cl2-folder-grid"></div>
                    <h3 style="text-align:center; margin-top: 30px;">Latest Previews</h3>
                    <div id="chart-library-2-preview-container" style="background:transparent; border:none; padding:0;"></div>
                </div>
            </div>

            <div class="section-card collapsed">
                <div class="section-card-header">
                    <h2>Sentiment Log</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                    <div id="asset-sentiment-container" style="max-width:100%; padding:0; border:none; background:transparent;">
                        <div class="sentiment-trackers-wrapper">
                            <div class="sentiment-tracker" id="sentiment-tracker-btc">
                                <h4>BTC/USDT</h4>
                                <div class="sentiment-buttons">
                                    <button data-asset="BTC/USDT" data-sentiment="long">Long</button>
                                    <button data-asset="BTC/USDT" data-sentiment="neutral">Neutral</button>
                                    <button data-asset="BTC/USDT" data-sentiment="short">Short</button>
                                </div>
                            </div>
                            <div class="sentiment-tracker" id="sentiment-tracker-eth">
                                <h4>ETH/USDT</h4>
                                <div class="sentiment-buttons">
                                    <button data-asset="ETH/USDT" data-sentiment="long">Long</button>
                                    <button data-asset="ETH/USDT" data-sentiment="neutral">Neutral</button>
                                    <button data-asset="ETH/USDT" data-sentiment="short">Short</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right; margin: 20px 0 10px 0;">
                        <button id="toggle-old-sentiments" class="toggle-history-btn">Show All</button>
                    </div>
                    <div class="table-wrapper">
                        <table id="sentiment-receipts-table">
                            <thead><tr><th>Asset</th><th>Sentiment</th><th class="note-header">Note</th><th>Timestamp</th><th>Actions</th></tr></thead>
                            <tbody id="sentiment-receipts-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section-card collapsed">
                <div class="section-card-header">
                    <h2>Tracker Scratchpad</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                    <textarea id="tracker-scratchpad" placeholder="Quick notes for the tracker tab..."></textarea>
                </div>
            </div>
        </div>

        <div id="journal-tab" class="tab-content">
            <div class="section-card">
                 <div class="section-card-header">
                    <h2>Journal Entry</h2>
                    <button class="toggle-section-btn">−</button>
                </div>
                <div class="section-card-content">
                    <div class="controls-container" id="journal-controls">
                        <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                        <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                        <div>
                            <label for="journal-image-filter">Filter Images:</label>
                            <select id="journal-image-filter"><option value="all" selected>All for Timeframe</option><option value="today">Selected Day Only</option></select>
                        </div>
                    </div>
                    <div class="date-nav-container">
                       <button id="date-prev" class="date-nav-arrow"><</button>
                       <div id="date-buttons-container"></div>
                       <button id="date-next" class="date-nav-arrow">></button>
                    </div>
                    <div class="journal-input-wrapper">
                        <button id="favourite-btn" class="master-only" title="Pin this note">⭐</button>
                        <textarea id="journal-entry" placeholder="Select symbol, timeframe, and date to add an entry."></textarea>
                    </div>
                    <p id="save-status" style="text-align:center;font-style:italic;color:#666;height:1em"></p>
                    <div id="image-upload-section" class="master-only" style="text-align: center;">
                        <label for="journal-image-upload" class="image-upload-label" style="background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: inline-block;">Add Picture</label>
                        <input type="file" id="journal-image-upload" accept="image/*" multiple style="display:none;">
                        <div id="upload-progress"></div>
                    </div>
                    <div id="journal-images-container"></div>
                </div>
            </div>

            <div class="section-card collapsed">
                <div class="section-card-header">
                    <h2>Persistent Scratchpad</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                     <textarea id="persistent-notes-entry" placeholder="Persistent scratchpad..."></textarea>
                </div>
            </div>
            
             <div class="section-card collapsed">
                 <div class="section-card-header">
                    <h2>Primary Setups</h2>
                    <button class="toggle-section-btn">+</button>
                </div>
                <div class="section-card-content">
                     <div class="table-wrapper">
                        <table id="current-setups-table-1" class="setups-table">
                            <thead>
                                <tr><th rowspan="2">TF</th><th colspan="3">0-Candle</th><th colspan="3">4-Candle</th></tr>
                                <tr><th>Entry</th><th>Target</th><th>Stoploss</th><th>Entry</th><th>Target</th><th>Stoploss</th></tr>
                            </thead>
                            <tbody>
                                <tr><th>5min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>15min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>30min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>1hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>2hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>4hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>daily</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>weekly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                                <tr><th>monthly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="setups-controls">
                        <p id="setups-save-status-1" class="setups-save-status"></p>
                        <button id="save-setups-1-btn" class="master-only">Save Primary Setups</button>
                    </div>
                </div>
            </div>
            
            <div class="section-card collapsed">
                <div class="section-card-header">
                   <h2>Secondary Setups</h2>
                   <button class="toggle-section-btn">+</button>
               </div>
               <div class="section-card-content">
                    <div class="table-wrapper">
                       <table id="current-setups-table-2" class="setups-table">
                            <thead>
                                <tr><th rowspan="2">TF</th><th colspan="3">0-Candle</th><th colspan="3">4-Candle</th></tr>
                                <tr><th>Entry</th><th>Target</th><th>Stoploss</th><th>Entry</th><th>Target</th><th>Stoploss</th></tr>
                            </thead>
                           <tbody>
                               <tr><th>5min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>15min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>30min</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>1hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>2hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>4hour</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>daily</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>weekly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                               <tr><th>monthly</th><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                           </tbody>
                       </table>
                   </div>
                    <div class="setups-controls">
                       <p id="setups-save-status-2" class="setups-save-status"></p>
                       <button id="save-setups-2-btn" class="master-only">Save Secondary Setups</button>
                   </div>
               </div>
           </div>

           <div class="section-card collapsed">
            <div class="section-card-header">
               <h3>EMA Data</h3>
               <button class="toggle-section-btn">+</button>
           </div>
           <div class="section-card-content">
                <p class="ema-last-updated" style="text-align:center;">Last Updated: <span id="ema-last-updated-time">--</span></p>
                <div id="ema-tables-container"></div>
           </div>
       </div>

        </div>

        <div id="snapshot-tab" class="tab-content">
             <div class="section-card">
                 <div class="section-card-header">
                    <h2>Market Snapshot</h2>
                    <button class="toggle-section-btn">−</button>
                </div>
                <div class="section-card-content">
                    <div class="controls-container" id="snapshot-controls" style="padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                        <div><label for="snapshot-symbol">Symbol:</label><select id="snapshot-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                    </div>
                    <div id="snapshot-images-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top:20px;"></div>
                </div>
            </div>
        </div>

        <div id="sr-levels-tab" class="tab-content">
            <div class="section-card">
                 <div class="section-card-header">
                    <h2>S/R Level Analysis</h2>
                    <button class="toggle-section-btn">−</button>
                </div>
                <div class="section-card-content">
                    <div id="sr-legend-container" style="border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px;">
                        <div id="sr-legend-header" class="section-card-header" style="border:none;">
                            <h4>S/R Levels Key</h4>
                            <button id="sr-legend-toggle-btn" class="toggle-section-btn">−</button>
                        </div>
                        <div id="sr-legend-content" class="section-card-content" style="padding-top:0;">
                           ...
                        </div>
                    </div>
                    <div class="controls-container" style="padding: 15px; background-color: var(--bg-color); border-radius: 8px;">
                        <div><label for="sr-symbol">Symbol:</label><select id="sr-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                        <div>
                            <label for="sr-lookback">Lookback:</label>
                            <select id="sr-lookback"><option value="60d">60 Days</option></select>
                        </div>
                    </div>
                    <p class="ema-last-updated" style="text-align:center; margin-top:20px;">Last Updated: <span id="sr-last-updated-time">--</span></p>
                    <div id="sr-levels-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="sr-column support">
                            <h3 style="text-align:center; color: #28a745;">Top Support Zones</h3>
                            <div id="support-levels-container"></div>
                        </div>
                        <div class="sr-column resistance">
                            <h3 style="text-align:center; color: #dc3545;">Top Resistance Zones</h3>
                            <div id="resistance-levels-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="image-modal" class="modal-overlay">
        <span class="modal-close">×</span>
        <button id="modal-prev" class="modal-nav"><</button>
        <img class="modal-content" id="modal-image-content">
        <button id="modal-next" class="modal-nav">></button>
        <div id="modal-caption"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            function setupCollapsibleSections() {
                const container = document.querySelector('.container');
                container.addEventListener('click', function(e) {
                    const header = e.target.closest('.section-card-header');
                    if (!header) return;

                    const card = header.closest('.section-card');
                    if (!card) return;

                    // Prevent toggling when clicking on a button inside the header
                    if (e.target.closest('button') && e.target !== header.querySelector('.toggle-section-btn')) {
                       // This allows history toggle buttons to work without collapsing the card
                       if(!e.target.matches('.toggle-section-btn')) return;
                    }

                    card.classList.toggle('collapsed');
                    
                    const toggleButton = header.querySelector('.toggle-section-btn');
                    if (toggleButton) {
                        toggleButton.textContent = card.classList.contains('collapsed') ? '+' : '−';
                    }
                });
            }

            // --- CONFIGURATION ---
            const CONFIG = {
                FIREBASE: {
                    apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                    authDomain: "journal-a003f.firebaseapp.com",
                    databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "journal-a003f",
                    storageBucket: "journal-a003f.firebasestorage.app",
                    messagingSenderId: "1038636626553",
                    appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
                },
                DB_PATHS: {
                    TRADES: 'trades',
                    COMPLETED_TRADES: 'completed_trades',
                    BANK: 'bank',
                    JOURNAL_TEXT: 'journal_text',
                    JOURNAL_IMAGES: 'journal_images',
                    IMAGE_LIBRARY: 'image_library',
                    CHART_LIBRARY_2: 'chart_library_2',
                    JOURNAL_FAVOURITES: 'journal_favourites',
                    SETUPS_1: 'current_setups_1',
                    SETUPS_2: 'current_setups_2',
                    PERSISTENT_NOTES: 'persistent_notes',
                    TRACKER_SCRATCHPAD: 'tracker_scratchpad',
                    SENTIMENT_RECEIPTS: 'sentiment_receipts'
                },
                TRADE_SETTINGS: {
                    FEE_RATE: 0.00075,
                    STARTING_BALANCE: 3881,
                    USD_TO_AUD_RATE: 1.53
                },
                EMA_ANALYSIS: {
                    SYMBOLS: ['BTC-USDT', 'ETH-USDT'],
                    TIMEFRAMES: ['15min', '30min', '1hour', '2hour', '4hour', 'daily'],
                    PERIODS: [13, 49, 100, 200, 500, 1000],
                    SHORT_NAMES: {'15min': '15m', '30min': '30m', '1hour': '1H', '2hour': '2H', '4hour': '4H', 'daily': '1D', 'weekly': '1W', 'monthly': '1M'}
                },
                SNAPSHOT_TIMEFRAMES: ['15min', '30min', '1hour', '2hour', '4hour', 'daily', 'weekly', 'monthly']
            };
            
            const CL2_FOLDERS = ['monthly', 'weekly', 'daily', '4hour', '2hour', '1hour', '30min', '15min', '5min'];

            // --- DOM ELEMENT CACHE ---
            const DOM = {
                // General
                tabs: document.querySelector('.tabs'),
                themeToggle: document.getElementById('theme-checkbox'),
                trackerTab: document.getElementById('tracker-tab'),
                // Stats Panel
                statsPanelContainer: document.getElementById('stats-panel-container'),
                statsFab: document.getElementById('stats-fab'),
                statsPanel: document.getElementById('stats-panel'),
                closeStatsBtn: document.getElementById('close-stats-btn'),
                statBalance: document.getElementById('stat-balance'),
                statTotalPl: document.getElementById('stat-total-pl'),
                statCompletedTrades: document.getElementById('stat-completed-trades'),
                statOpenTrades: document.getElementById('stat-open-trades'),
                statWins: document.getElementById('stat-wins'),
                statLosses: document.getElementById('stat-losses'),
                statWinRate: document.getElementById('stat-win-rate'),
                statProfitFactor: document.getElementById('stat-profit-factor'),
                statAvgWin: document.getElementById('stat-avg-win'),
                statAvgLoss: document.getElementById('stat-avg-loss'),
                // Trade Tracker
                trackerScratchpadEl: document.getElementById('tracker-scratchpad'),
                addTradeForm: document.getElementById('add-trade-form'),
                tradesTbody: document.getElementById('trades-tbody'),
                completedTradesTbody: document.getElementById('completed-trades-tbody'),
                sentimentReceiptsTbody: document.getElementById('sentiment-receipts-tbody'),
                chartLibrary2Container: document.getElementById('chart-library-2-container'),
                chartLibrary2PreviewContainer: document.getElementById('chart-library-2-preview-container'),
                toggleOldTradesBtn: document.getElementById('toggle-old-trades'),
                toggleOldSentimentsBtn: document.getElementById('toggle-old-sentiments'),
                imageModal: document.getElementById('image-modal'),
                modalImageContent: document.getElementById('modal-image-content'),
                modalClose: document.querySelector('.modal-close'),
                modalCaption: document.getElementById('modal-caption'),
                modalPrevBtn: document.getElementById('modal-prev'),
                modalNextBtn: document.getElementById('modal-next'),
                // Journal & Setups
                journalTab: document.getElementById('journal-tab'),
                persistentNotesEl: document.getElementById('persistent-notes-entry'),
                setupsTable1: document.getElementById('current-setups-table-1'),
                setupsTable2: document.getElementById('current-setups-table-2'),
                saveSetups1Btn: document.getElementById('save-setups-1-btn'),
                saveSetups2Btn: document.getElementById('save-setups-2-btn'),
                setupsSaveStatus1: document.getElementById('setups-save-status-1'),
                setupsSaveStatus2: document.getElementById('setups-save-status-2'),
                journalSymbolEl: document.getElementById('journal-symbol'),
                journalTimeframeEl: document.getElementById('journal-timeframe'),
                journalImageFilterEl: document.getElementById('journal-image-filter'),
                dateButtonsContainer: document.getElementById('date-buttons-container'),
                datePrevBtn: document.getElementById('date-prev'),
                dateNextBtn: document.getElementById('date-next'),
                favouriteBtn: document.getElementById('favourite-btn'),
                journalEntryEl: document.getElementById('journal-entry'),
                saveStatus: document.getElementById('save-status'),
                journalImageUpload: document.getElementById('journal-image-upload'),
                uploadProgress: document.getElementById('upload-progress'),
                journalImagesContainer: document.getElementById('journal-images-container'),
                emaLastUpdatedTime: document.getElementById('ema-last-updated-time'),
                emaTablesContainer: document.getElementById('ema-tables-container'),
                // Snapshot
                snapshotTab: document.getElementById('snapshot-tab'),
                snapshotSymbolEl: document.getElementById('snapshot-symbol'),
                snapshotImagesContainer: document.getElementById('snapshot-images-container'),
                // S/R Levels
                srLevelsTab: document.getElementById('sr-levels-tab'),
                srLegendHeader: document.getElementById('sr-legend-header'),
                srLegendContent: document.getElementById('sr-legend-content'),
                srLegendToggleBtn: document.getElementById('sr-legend-toggle-btn'),
                srLastUpdatedTime: document.getElementById('sr-last-updated-time'),
                srSymbolEl: document.getElementById('sr-symbol'),
                srLookbackEl: document.getElementById('sr-lookback'),
                supportLevelsContainer: document.getElementById('support-levels-container'),
                resistanceLevelsContainer: document.getElementById('resistance-levels-container'),
            };

            // --- APPLICATION STATE ---
            const STATE = {
                isMasterUser: false,
                masterPassword: null,
                viewerId: null,
                journalText: {},
                journalImages: {},
                chartLibrary2Data: {}, 
                currentCl2Folder: null,
                emaData: {},
                srData: {},
                favouriteEntries: {},
                persistentNotes: '',
                trackerScratchpadText: '',
                setupsData1: {},
                setupsData2: {},
                selectedDate: null,
                centerDate: null,
                journalSaveTimer: null,
                notesSaveTimer: null,
                trackerSaveTimer: null,
                isMerging: false,
                mergeBaseTradeId: null,
                modalImageGallery: [],
                modalImageIndex: -1,
            };

            // --- INITIALIZE FIREBASE ---
            firebase.initializeApp(CONFIG.FIREBASE);
            const database = firebase.database();
            const storage = firebase.storage();
            const dbRefs = {
                trades: database.ref(CONFIG.DB_PATHS.TRADES),
                completedTrades: database.ref(CONFIG.DB_PATHS.COMPLETED_TRADES),
                bank: database.ref(CONFIG.DB_PATHS.BANK),
                journalText: database.ref(CONFIG.DB_PATHS.JOURNAL_TEXT),
                journalImages: database.ref(CONFIG.DB_PATHS.JOURNAL_IMAGES),
                chartLibrary2: database.ref(CONFIG.DB_PATHS.CHART_LIBRARY_2),
                favourites: database.ref(CONFIG.DB_PATHS.JOURNAL_FAVOURITES),
                setups1: database.ref(CONFIG.DB_PATHS.SETUPS_1),
                setups2: database.ref(CONFIG.DB_PATHS.SETUPS_2),
                persistentNotes: database.ref(CONFIG.DB_PATHS.PERSISTENT_NOTES),
                trackerScratchpad: database.ref(CONFIG.DB_PATHS.TRACKER_SCRATCHPAD),
                sentimentReceipts: database.ref(CONFIG.DB_PATHS.SENTIMENT_RECEIPTS)
            };

            // --- HELPER FUNCTIONS ---
            const formatCurrency = (num, symbol = '$') => `${symbol}${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            function autoResizeTextarea(element) {
                if (!element) return;
                element.style.height = 'auto';
                element.style.height = `${element.scrollHeight}px`;
            }
            const getYYYYMMDD = (date) => date.toISOString().split('T')[0];
            const getSafeSymbol = (symbol) => symbol.replace(/\//g, '-');
            function getViewerId() {
                if (STATE.viewerId) return STATE.viewerId;
                let id = localStorage.getItem('viewerId');
                if (!id) {
                    id = `viewer_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;
                    localStorage.setItem('viewerId', id);
                }
                STATE.viewerId = id;
                return id;
            }

            // --- DATA FETCHING ---
            async function fetchEmaData() { /* ... unchanged ... */ }
            async function fetchSrData() { /* ... unchanged ... */ }
            
            // --- HISTORY TOGGLE LOGIC ---
            function updateToggleButtonsVisibility() {
                if (DOM.sentimentReceiptsTbody && DOM.toggleOldSentimentsBtn) {
                    const hasHistoricalSentiments = DOM.sentimentReceiptsTbody.querySelector('.historical-entry');
                    DOM.toggleOldSentimentsBtn.style.display = hasHistoricalSentiments ? 'inline-block' : 'none';
                }
                if (DOM.completedTradesTbody && DOM.toggleOldTradesBtn) {
                    const hasHistoricalTrades = DOM.completedTradesTbody.querySelector('.historical-entry');
                    DOM.toggleOldTradesBtn.style.display = hasHistoricalTrades ? 'inline-block' : 'none';
                }
            }
            function toggleHistoricalRows(tbodyId, button) {
                const tbody = document.getElementById(tbodyId);
                if (!tbody) return;
                const historicalRows = tbody.querySelectorAll('.historical-entry');
                if (historicalRows.length === 0) return;
                const isCurrentlyHidden = historicalRows[0].style.display === 'none';
                const displayStyle = isCurrentlyHidden ? 'table-row' : 'none';
                historicalRows.forEach(row => { row.style.display = displayStyle; });
                button.textContent = isCurrentlyHidden ? 'Hide Older' : 'Show All';
            }

            // --- RENDERING FUNCTIONS ---
            function renderSentimentReceipts(receiptsData) {
                const tbody = DOM.sentimentReceiptsTbody;
                if (!tbody) return;
                const todayStr = getYYYYMMDD(new Date());
                const currentViewerId = getViewerId();
                const receipts = receiptsData || {};
                const receiptIds = Object.keys(receipts).sort().reverse();
                tbody.innerHTML = receiptIds.map(id => {
                    const receipt = receipts[id];
                    if (!receipt) return '';
                    let sentimentColor = 'var(--text-color)';
                    if ((receipt.sentiment || '').toLowerCase() === 'long') sentimentColor = 'var(--green-text)';
                    if ((receipt.sentiment || '').toLowerCase() === 'short') sentimentColor = 'var(--red-text)';
                    const ownerActionsHtml = (receipt.viewerId === currentViewerId)
                        ? `<button class="edit-sentiment-note-btn" data-id="${id}">Note</button><button class="delete-sentiment-btn" data-id="${id}" title="Delete Entry">×</button>` : '';
                    let displayTimestamp, receiptDateStr, isHistorical;
                    if (typeof receipt.timestamp === 'number') {
                        const receiptDate = new Date(receipt.timestamp);
                        displayTimestamp = receiptDate.toLocaleString();
                        receiptDateStr = getYYYYMMDD(receiptDate);
                        isHistorical = receiptDateStr !== todayStr;
                    } else {
                        displayTimestamp = receipt.timestamp || '--';
                        isHistorical = true;
                    }
                    return `<tr class="${isHistorical ? 'historical-entry' : ''}" style="${isHistorical ? 'display: none;' : ''}" data-date="${receiptDateStr || ''}">
                            <td>${receipt.asset || '--'}</td><td style="color: ${sentimentColor};">${receipt.sentiment || '--'}</td><td class="sentiment-note-cell">${receipt.note || ''}</td>
                            <td>${displayTimestamp}</td><td class="action-buttons">${ownerActionsHtml}</td></tr>`;
                }).join('');
                updateToggleButtonsVisibility();
            }
            
            function renderLiveTable(data) {
                const trades = data || {};
                const masterButtonsHtml = (id) => STATE.isMasterUser ? `<td class="action-buttons"><button class="add-to-position-btn" data-id="${id}">+</button><button class="win-btn" data-id="${id}">W</button><button class="loss-btn" data-id="${id}">L</button><button class="note-btn" data-id="${id}">N</button><button class="delete-btn" data-id="${id}">D</button></td>` : '';
                const masterEditableCell = (className, field, tradeId, value, isMaster) => {
                    const formattedValue = parseFloat(value).toFixed(2);
                    return `<td class="${isMaster ? className : ''}" data-id="${tradeId}" data-field="${field}" ${isMaster ? 'contenteditable="true"' : ''} title="Click to edit">${formattedValue}</td>`;
                };
                DOM.tradesTbody.innerHTML = Object.keys(trades).sort((a, b) => new Date(trades[b].date) - new Date(trades[a].date)).map(id => {
                    const trade = trades[id];
                    const profitString = `$${parseFloat(trade.expected_profit || 0).toFixed(2)} (${parseFloat(trade.expected_profit_percent || 0).toFixed(2)}%)`;
                    const lossString = `$${parseFloat(trade.expected_loss || 0).toFixed(2)} (${parseFloat(trade.expected_loss_percent || 0).toFixed(2)}%)`;
                    const entriesList = (trade.entry_prices || [trade.entry]).map(p => p.toLocaleString()).join(', ');
                    return `<tr><td>${trade.symbol}</td><td>${trade.type}</td><td>${parseFloat(trade.entry).toFixed(4)}</td><td class="note-cell">${entriesList}</td>
                        ${masterEditableCell('editable-cell', 'stoploss', id, trade.stoploss, STATE.isMasterUser)}
                        ${masterEditableCell('editable-cell', 'target', id, trade.target, STATE.isMasterUser)}
                        <td>${parseFloat(trade.size).toFixed(2)}</td><td>${parseFloat(trade.estimated_total_fee || 0).toFixed(2)}</td>
                        <td style="color: #28a745;">${profitString}</td><td style="color: #dc3545;">${lossString}</td>
                        <td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td><td class="note-cell" title="${trade.note || ''}">${trade.note || ''}</td>
                        ${masterButtonsHtml(id)}</tr>`;
                }).join('');
            }
            
            function renderCompletedTable(data) {
                const trades = data || {};
                const todayStr = getYYYYMMDD(new Date());
                const masterButtonsHtml = (id) => STATE.isMasterUser ? `<td class="action-buttons"><button class="merge-btn-completed" data-id="${id}">M</button><button class="note-btn-completed" data-id="${id}">N</button><button class="delete-btn-completed" data-id="${id}">D</button></td>` : '';
                DOM.completedTradesTbody.innerHTML = Object.keys(trades).sort((a, b) => new Date(trades[b].closed_date) - new Date(trades[a].closed_date)).map(id => {
                    const trade = trades[id];
                    const resultColor = (trade.net_result || 0) >= 0 ? '#28a745' : '#dc3545';
                    const totalFees = (trade.entry_fee || 0) + (trade.exit_fee || 0);
                    const entriesList = (trade.entry_prices || [trade.entry]).map(p => p.toLocaleString()).join(', ');
                    const closedDate = trade.closed_date ? new Date(trade.closed_date) : null;
                    const isHistorical = closedDate ? getYYYYMMDD(closedDate) !== todayStr : true;
                    return `<tr class="${isHistorical ? 'historical-entry' : ''}" style="${isHistorical ? 'display: none;' : ''}"><td>${trade.symbol}</td><td>${trade.type}</td>
                        <td>${parseFloat(trade.entry).toFixed(4)}</td><td class="note-cell">${entriesList}</td><td>${parseFloat(trade.target || 0).toFixed(2)}</td>
                        <td>${parseFloat(trade.size || 0).toFixed(2)}</td><td>${parseFloat(trade.exit_price).toFixed(2)}</td><td>${totalFees.toFixed(2)}</td>
                        <td style="color:${resultColor};font-weight:bold;">${parseFloat(trade.net_result || 0).toFixed(2)}</td>
                        <td>${trade.date ? new Date(trade.date).toLocaleString() : '--'}</td><td>${closedDate ? closedDate.toLocaleString() : '--'}</td>
                        <td class="note-cell" title="${trade.note || ''}">${trade.note || ''}</td>${masterButtonsHtml(id)}</tr>`;
                }).join('');
                updateToggleButtonsVisibility();
            }

            function renderChartLibrary2Folders() {
                if (!DOM.chartLibrary2Container) return;
                DOM.chartLibrary2Container.innerHTML = CL2_FOLDERS.map(folder => {
                    const imageCount = STATE.chartLibrary2Data[folder] ? Object.keys(STATE.chartLibrary2Data[folder]).length : 0;
                    return `<div class="cl2-folder-card" data-folder="${folder}"><div class="cl2-folder-icon">📁</div><h4>${folder}</h4><div class="cl2-folder-count">${imageCount} image${imageCount !== 1 ? 's' : ''}</div></div>`;
                }).join('');
                if (STATE.isMasterUser) {
                    document.querySelectorAll('.cl2-folder-card').forEach(folderEl => {
                        folderEl.addEventListener('dragover', (e) => { e.preventDefault(); folderEl.classList.add('drag-over'); });
                        folderEl.addEventListener('dragleave', (e) => { e.preventDefault(); folderEl.classList.remove('drag-over'); });
                        folderEl.addEventListener('drop', (e) => { e.preventDefault(); folderEl.classList.remove('drag-over'); handleChartLibrary2Upload(e.dataTransfer.files, folderEl.dataset.folder); });
                    });
                }
            }
            function renderFolderContents(folderName) { /* ... unchanged ... */ }
            function renderChartLibrary2Preview() { /* ... unchanged ... */ }
            function renderDateNavigation() { /* ... unchanged ... */ }
            function updateJournalView() { /* ... unchanged ... */ }
            function renderJournalImages(symbol, timeframe, selectedYMD) { /* ... unchanged ... */ }
            function renderEmaData() { /* ... unchanged ... */ }
            function renderSetupsTable(tableElement, data) { /* ... unchanged ... */ }
            function renderSnapshotView() { /* ... unchanged ... */ }
            function renderSrLevels() { /* ... unchanged ... */ }

            // --- DATA HANDLING AND SAVING ---
            function saveSetupsTable(tableElement, dbRef, statusElement) { /* ... unchanged ... */ }
            const saveJournalEntry = () => { /* ... unchanged ... */ };
            const savePersistentNotes = () => { /* ... unchanged ... */ };
            const saveTrackerScratchpad = () => { /* ... unchanged ... */ };
            function handleFileUpload(files) { /* ... unchanged ... */ }
            function handleChartLibrary2Upload(files, folderName) { /* ... unchanged ... */ }
            function calculateNetResult(trade, exitPrice) { /* ... unchanged ... */ }
            function completeTrade(tradeId, outcome) { /* ... unchanged ... */ }
            
            // --- MODAL LOGIC ---
            function openImageModal(imageArray, clickedIndex) {
                STATE.modalImageGallery = imageArray;
                STATE.modalImageIndex = clickedIndex;
                displayModalImage();
                DOM.imageModal.classList.add('active');
            }
            function displayModalImage() {
                if (STATE.modalImageIndex < 0 || STATE.modalImageIndex >= STATE.modalImageGallery.length) return;
                const currentImage = STATE.modalImageGallery[STATE.modalImageIndex];
                DOM.modalImageContent.src = currentImage.url;
                DOM.modalCaption.textContent = currentImage.caption || '';
                DOM.modalPrevBtn.style.display = STATE.modalImageIndex > 0 ? 'flex' : 'none';
                DOM.modalNextBtn.style.display = STATE.modalImageIndex < STATE.modalImageGallery.length - 1 ? 'flex' : 'none';
            }
            function closeModal() {
                DOM.imageModal.classList.remove('active');
                STATE.modalImageGallery = [];
                STATE.modalImageIndex = -1;
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                DOM.themeToggle.addEventListener('change', (e) => {
                    const theme = e.target.checked ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                });
                DOM.tabs.addEventListener('click', (e) => {
                    if (!e.target.matches('.tab-link')) return;
                    document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    const tabId = e.target.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    DOM.statsPanelContainer.style.display = (tabId === 'tracker') ? 'block' : 'none';
                    if (tabId === 'journal') updateJournalView();
                    if (tabId === 'snapshot') renderSnapshotView();
                    if (tabId === 'sr-levels') renderSrLevels();
                });
                DOM.statsFab.addEventListener('click', () => DOM.statsPanel.classList.toggle('active'));
                DOM.closeStatsBtn.addEventListener('click', () => DOM.statsPanel.classList.remove('active'));
                document.addEventListener('click', (e) => {
                    if (!DOM.statsPanel.contains(e.target) && !DOM.statsFab.contains(e.target) && DOM.statsPanel.classList.contains('active')) {
                        DOM.statsPanel.classList.remove('active');
                    }
                });
                DOM.addTradeForm.addEventListener('submit', handleAddTradeSubmit);
                DOM.trackerTab.addEventListener('click', (e) => {
                    if (e.target.closest('.sentiment-buttons button')) handleSentimentLog(e);
                    if (e.target.matches('.delete-sentiment-btn')) handleSentimentDelete(e);
                    if (e.target.matches('.edit-sentiment-note-btn')) handleSentimentNoteEdit(e);
                    if (e.target.closest('#trades-tbody')) handleTradeAction(e);
                    if (e.target.closest('#completed-trades-tbody')) handleTradeAction(e);
                    if (e.target.matches('#toggle-old-sentiments')) toggleHistoricalRows('sentiment-receipts-tbody', e.target);
                    if (e.target.matches('#toggle-old-trades')) toggleHistoricalRows('completed-trades-tbody', e.target);
                    if (e.target.closest('#chart-library-2-container, #chart-library-2-preview-container')) handleChartLibrary2Click(e);
                });
                DOM.trackerScratchpadEl.addEventListener('input', () => { autoResizeTextarea(DOM.trackerScratchpadEl); saveTrackerScratchpad(); });
                DOM.modalClose.addEventListener('click', closeModal);
                DOM.imageModal.addEventListener('click', (e) => { if (e.target === DOM.imageModal) closeModal(); });
                DOM.modalPrevBtn.addEventListener('click', () => { if (STATE.modalImageIndex > 0) { STATE.modalImageIndex--; displayModalImage(); } });
                DOM.modalNextBtn.addEventListener('click', () => { if (STATE.modalImageIndex < STATE.modalImageGallery.length - 1) { STATE.modalImageIndex++; displayModalImage(); } });
                DOM.tradesTbody.addEventListener('blur', (e) => { if (e.target.matches('.editable-cell')) handleLiveTradeUpdate(e.target); }, true);
                [DOM.journalSymbolEl, DOM.journalTimeframeEl, DOM.journalImageFilterEl].forEach(el => el.addEventListener('change', updateJournalView));
                DOM.dateButtonsContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.date-nav-btn')) {
                        const dateStr = e.target.dataset.date;
                        const parts = dateStr.split('-');
                        STATE.selectedDate = new Date(Date.UTC(parts[0], parseInt(parts[1], 10) - 1, parts[2]));
                        STATE.centerDate = new Date(STATE.selectedDate);
                        updateJournalView();
                    }
                });
                DOM.datePrevBtn.addEventListener('click', () => { STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() - 5); renderDateNavigation(); });
                DOM.dateNextBtn.addEventListener('click', () => { STATE.centerDate.setUTCDate(STATE.centerDate.getUTCDate() + 5); renderDateNavigation(); });
                DOM.journalEntryEl.addEventListener('input', () => { autoResizeTextarea(DOM.journalEntryEl); saveJournalEntry(); });
                DOM.persistentNotesEl.addEventListener('input', () => { autoResizeTextarea(DOM.persistentNotesEl); savePersistentNotes(); });
                DOM.favouriteBtn.addEventListener('click', handleFavouriteClick);
                DOM.journalImageUpload.addEventListener('change', (e) => handleFileUpload(e.target.files));
                DOM.journalTab.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-journal-image')) { handleImageDelete(e); return; }
                    const img = e.target.closest('#journal-images-container img');
                    if (img) {
                        const allImageElements = DOM.journalImagesContainer.querySelectorAll('img');
                        const imageArray = Array.from(allImageElements).map(el => ({ url: el.dataset.fullSrc, caption: el.dataset.caption }));
                        openImageModal(imageArray, Array.from(allImageElements).indexOf(img));
                    }
                });
                DOM.snapshotTab.addEventListener('click', (e) => {
                    const img = e.target.closest('#snapshot-images-container img');
                    if(img) {
                       const allImageElements = DOM.snapshotImagesContainer.querySelectorAll('img');
                       const imageArray = Array.from(allImageElements).map(el => ({ url: el.dataset.fullSrc, caption: el.dataset.caption }));
                       openImageModal(imageArray, Array.from(allImageElements).indexOf(img));
                    }
                });
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    DOM.journalTab.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    DOM.journalTab.addEventListener(eventName, () => { if (STATE.isMasterUser) DOM.journalTab.classList.add('drag-over'); });
                });
                DOM.journalTab.addEventListener('dragleave', () => DOM.journalTab.classList.remove('drag-over'));
                DOM.journalTab.addEventListener('drop', (e) => {
                    DOM.journalTab.classList.remove('drag-over');
                    if (STATE.isMasterUser && e.dataTransfer?.files.length > 0) handleFileUpload(e.dataTransfer.files);
                });
                DOM.saveSetups1Btn.addEventListener('click', () => saveSetupsTable(DOM.setupsTable1, dbRefs.setups1, DOM.setupsSaveStatus1));
                DOM.saveSetups2Btn.addEventListener('click', () => saveSetupsTable(DOM.setupsTable2, dbRefs.setups2, DOM.setupsSaveStatus2));
                DOM.srSymbolEl.addEventListener('change', renderSrLevels);
                DOM.srLookbackEl.addEventListener('change', renderSrLevels);
            }
            
            // --- EVENT HANDLER LOGIC ---
            function handleAddTradeSubmit(e) { /* ... unchanged ... */ }
            function handleLiveTradeUpdate(cell) { /* ... unchanged ... */ }
            function handleSentimentLog(e) { /* ... unchanged ... */ }
            function handleSentimentDelete(e) { /* ... unchanged ... */ }
            function handleSentimentNoteEdit(e) { /* ... unchanged ... */ }
            function handleAddStaggeredEntry(tradeId) { /* ... unchanged ... */ }
            function handleChartLibrary2Click(e) { /* ... unchanged ... */ }
            function handleImageDelete(e) { /* ... unchanged ... */ }
            function handleFavouriteClick() { /* ... unchanged ... */ }
            function handleTradeAction(e) { /* ... unchanged ... */ }
            function resetMergeState() { /* ... unchanged ... */ }
            function initiateMerge(baseTradeId) { /* ... unchanged ... */ }
            function executeMerge(baseTradeId, absorbedTradeId) { /* ... unchanged ... */ }

            // --- FIREBASE DATA SUBSCRIPTIONS ---
            function subscribeToData() {
                dbRefs.trades.on('value', snapshot => {
                    const liveTrades = snapshot.val() || {};
                    renderLiveTable(liveTrades);
                    DOM.statOpenTrades.textContent = Object.keys(liveTrades).length;
                });
                dbRefs.completedTrades.on('value', snapshot => {
                    const completedData = snapshot.val() || {};
                    renderCompletedTable(completedData);
                    let wins = 0, losses = 0, grossProfit = 0, grossLoss = 0;
                    const allTrades = Object.values(completedData);
                    allTrades.forEach(trade => {
                        const netResult = trade.net_result || 0;
                        if (netResult > 0) { wins++; grossProfit += netResult; } else { losses++; grossLoss += Math.abs(netResult); }
                    });
                    const totalCompletedTrades = wins + losses;
                    const winRate = totalCompletedTrades > 0 ? (wins / totalCompletedTrades) * 100 : 0;
                    const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : Infinity;
                    const avgWin = wins > 0 ? grossProfit / wins : 0;
                    const avgLoss = losses > 0 ? grossLoss / losses : 0;
                    const totalProfitLoss = grossProfit - grossLoss;
                    const newBalance = CONFIG.TRADE_SETTINGS.STARTING_BALANCE + totalProfitLoss;
                    DOM.statBalance.textContent = formatCurrency(newBalance);
                    DOM.statTotalPl.textContent = `${totalProfitLoss >= 0 ? '+' : ''}${formatCurrency(totalProfitLoss)}`;
                    DOM.statTotalPl.style.color = totalProfitLoss >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                    DOM.statCompletedTrades.textContent = totalCompletedTrades;
                    DOM.statWins.textContent = wins;
                    DOM.statLosses.textContent = losses;
                    DOM.statWinRate.textContent = `${winRate.toFixed(1)}%`;
                    DOM.statProfitFactor.textContent = isFinite(profitFactor) ? profitFactor.toFixed(2) : (wins > 0 ? '∞' : 'N/A');
                    DOM.statAvgWin.textContent = formatCurrency(avgWin);
                    DOM.statAvgLoss.textContent = formatCurrency(avgLoss);
                    dbRefs.bank.set({ currentBalance: newBalance });
                });
                dbRefs.journalText.on('value', s => { STATE.journalText = s.val() || {}; if (DOM.journalTab.classList.contains('active')) updateJournalView(); });
                dbRefs.journalImages.on('value', s => { STATE.journalImages = s.val() || {}; if (DOM.journalTab.classList.contains('active')) updateJournalView(); if (DOM.snapshotTab.classList.contains('active')) renderSnapshotView(); });
                dbRefs.chartLibrary2.on('value', s => { STATE.chartLibrary2Data = s.val() || {}; if (STATE.currentCl2Folder) renderFolderContents(STATE.currentCl2Folder); else renderChartLibrary2Folders(); renderChartLibrary2Preview(); });
                dbRefs.favourites.on('value', s => { STATE.favouriteEntries = s.val() || {}; if (DOM.journalTab.classList.contains('active')) updateJournalView(); });
                dbRefs.setups1.on('value', s => { STATE.setupsData1 = s.val() || {}; renderSetupsTable(DOM.setupsTable1, STATE.setupsData1); });
                dbRefs.setups2.on('value', s => { STATE.setupsData2 = s.val() || {}; renderSetupsTable(DOM.setupsTable2, STATE.setupsData2); });
                dbRefs.persistentNotes.on('value', s => { STATE.persistentNotes = s.val() || ''; if (DOM.journalTab.classList.contains('active')) { DOM.persistentNotesEl.value = STATE.persistentNotes; autoResizeTextarea(DOM.persistentNotesEl); }});
                dbRefs.trackerScratchpad.on('value', s => { STATE.trackerScratchpadText = s.val() || ''; if (DOM.trackerTab.classList.contains('active')) { DOM.trackerScratchpadEl.value = STATE.trackerScratchpadText; autoResizeTextarea(DOM.trackerScratchpadEl); }});
                dbRefs.sentimentReceipts.on('value', s => renderSentimentReceipts(s.val()));
            }

            // --- INITIALIZATION ---
            function checkMasterMode() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('master') === 'true') {
                    const password = prompt("Please enter master password:");
                    if (password) {
                        STATE.isMasterUser = true;
                        STATE.masterPassword = password;
                        document.querySelectorAll('.master-only').forEach(el => {
                            if (el.matches('form') || el.matches('.section-card')) {
                                el.style.display = 'block'; // Show the card/form container
                            } else {
                                el.style.display = 'initial'; // Show other elements
                            }
                        });
                        DOM.journalEntryEl.readOnly = false;
                        DOM.persistentNotesEl.readOnly = false;
                        DOM.trackerScratchpadEl.readOnly = false;
                        document.querySelectorAll('.setups-table td').forEach(cell => cell.setAttribute('contenteditable', 'true'));
                    }
                }
                 if (!STATE.isMasterUser) {
                    DOM.journalEntryEl.readOnly = true;
                    DOM.persistentNotesEl.readOnly = true;
                    DOM.trackerScratchpadEl.readOnly = true;
                }
            }
            function initializeApp() {
                setupCollapsibleSections();
                checkMasterMode();
                getViewerId();
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    DOM.themeToggle.checked = savedTheme === 'dark';
                }
                const today = new Date();
                today.setUTCHours(0, 0, 0, 0);
                STATE.selectedDate = new Date(today);
                STATE.centerDate = new Date(today);
                setupEventListeners();
                subscribeToData();
                fetchEmaData();
                fetchSrData();
                renderDateNavigation();
                renderChartLibrary2Folders();
                renderChartLibrary2Preview();
                DOM.trackerScratchpadEl.value = STATE.trackerScratchpadText;
                autoResizeTextarea(DOM.trackerScratchpadEl);
            }

            initializeApp();
        });
    </script>
</body>
</html>
