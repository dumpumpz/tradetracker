<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; }
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: #666; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: #007bff; border-bottom-color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #bank-balance-container { text-align: center; margin: 10px auto 25px auto; font-size: 24px; font-weight: bold; color: #333; padding: 10px; background-color: #e9ecef; border-radius: 8px; max-width: 400px; }
        #bank-balance-value { font-weight: bolder; }
        .master-only { display: none; }
        #add-trade-form { max-width: 950px; margin: 20px auto; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        #add-trade-form div { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button.delete-btn, button.delete-btn-completed, button.delete-journal-image { background-color: #dc3545; }
        button:hover { opacity: 0.85; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        th { background-color: #e9ecef; font-weight: bold; }
        #journal-tab { position: relative; }
        #journal-controls { display: flex; align-items: center; gap: 15px; max-width: 500px; margin: 20px auto; }
        #journal-entry { width: 100%; height: 40vh; resize: vertical; line-height: 1.6; }
        #journal-entry:read-only { background-color: #f8f9fa; cursor: not-allowed; color: #555; }
        #image-upload-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: #007bff; }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid #ddd; padding: 5px; background: #fafafa; border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; }
        .delete-journal-image { position: absolute; top: 10px; right: 10px; padding: 4px 8px; font-size: 12px; z-index: 10; }
        #journal-tab.drag-over { border: 3px dashed #007bff; background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #007bff; z-index: 999; pointer-events: none; }
        @media (max-width: 768px) { .container { padding: 10px; } #add-trade-form { grid-template-columns: 1fr; } .section-header { flex-direction: column; } .backup-controls { position: static; margin-top: 10px; } .journal-image-wrapper { max-width: 100%; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Live Trade & Journal Tracker</h1>
        <p class="subtitle">Data updates in real-time for all viewers.</p>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal</button>
        </div>
        
        <div id="tracker-tab" class="tab-content active">
            <div id="bank-balance-container">Current Balance: <span id="bank-balance-value">$0.00</span></div>
            <form id="add-trade-form" class="master-only"><div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTCUSDT">BTCUSDT</option><option value="ETHUSDT">ETHUSDT</option></select></div><div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div><div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div><div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div><div><label for="target">Target:</label><input type="number" id="target" step="any" required></div><div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div><div><button type="submit">Add Trade</button></div></form>
            <div class="section-header"><h2>Live Trades</h2><div class="backup-controls master-only"><button id="save-live-btn">Save JSON</button><label for="load-live-input">Load JSON</label><input type="file" id="load-live-input" accept=".json"></div></div>
            <div class="table-wrapper"><table><thead><tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>Date Opened</th><th class="master-only">Actions</th></tr></thead><tbody id="trades-tbody"></tbody></table></div>
            <div class="section-header"><h2>Completed Trades</h2><div class="backup-controls master-only"><button id="save-completed-btn">Save JSON</button><label for="load-completed-input">Load JSON</label><input type="file" id="load-completed-input" accept=".json"></div></div>
            <div class="table-wrapper"><table><thead><tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th class="master-only">Actions</th></tr></thead><tbody id="completed-trades-tbody"></tbody></table></div>
        </div>

        <div id="journal-tab" class="tab-content">
            <h2>Text & Image Journal</h2>
            <div id="journal-controls">
                <label for="journal-timeframe">Select Entry:</label>
                <select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option></select>
            </div>
            <textarea id="journal-entry" placeholder="Select a timeframe to view entry. Master access required to edit."></textarea>
            <p id="save-status" style="text-align:center; font-style:italic; color:#666; height: 1em;"></p>
            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture to this Timeframe</label>
                <input type="file" id="journal-image-upload" accept="image/*">
                <div id="upload-progress" style="display: none;"></div>
            </div>
            <div id="journal-images-container"></div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
        authDomain: "journal-a003f.firebaseapp.com",
        databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "journal-a003f",
        storageBucket: "journal-a003f.appspot.com",
        messagingSenderId: "1038636626553",
        appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();
    const tradesRef = database.ref('trades');
    const completedTradesRef = database.ref('completed_trades');
    const bankRef = database.ref('bank');
    const journalRef = database.ref('journal_text'); 
    const journalImagesRef = database.ref('journal_images'); 
    const FEE_RATE = 0.00075;
    const STARTING_BALANCE = 4000;

    document.addEventListener('DOMContentLoaded', function () {
        let isMasterUser = false;
        let masterPassword = null; // This is now the key to all master actions
        let allJournalEntries = {}, allJournalImages = {};
        
        const journalTab = document.getElementById('journal-tab');
        const journalTimeframeEl = document.getElementById('journal-timeframe');
        const journalEntryEl = document.getElementById('journal-entry');
        const saveStatusEl = document.getElementById('save-status');
        const journalImageUploadEl = document.getElementById('journal-image-upload');
        const uploadProgressEl = document.getElementById('upload-progress');
        const journalImagesContainer = document.getElementById('journal-images-container');

        // REVISED: This function is now much stricter
        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true') {
                const password = prompt("Please enter the master password:");
                // ONLY set master status if a non-empty password is provided
                if (password) { 
                    isMasterUser = true;
                    masterPassword = password;
                    
                    document.querySelectorAll('.master-only').forEach(el => {
                         if (el.id === 'add-trade-form') el.style.display = 'grid';
                         else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                         else if (el.classList.contains('backup-controls')) el.style.display = 'flex';
                         else el.style.display = 'block';
                    });
                    journalEntryEl.readOnly = false; // Allow editing
                }
            }
            // If not master, or password prompt is cancelled/empty, everything remains read-only by default.
            if (!isMasterUser) {
                 journalEntryEl.readOnly = true;
            }
        }
        checkMasterMode(); 

        // SECURED: Upload function now relies on the masterPassword variable set during login
        function handleFileUpload(file) {
            if (!isMasterUser || !masterPassword) {
                alert("You do not have permission to upload files.");
                return;
            }
            if (!file || !file.type.startsWith('image/')) {
                if (file) alert('Only image files can be uploaded.');
                return;
            }

            const selectedTimeframe = journalTimeframeEl.value;
            const fileName = `${Date.now()}_${file.name}`;
            const metadata = { customMetadata: { 'password': masterPassword } };
            
            const uploadTask = storage.ref(`journal_images/${selectedTimeframe}/${fileName}`).put(file, metadata);
            
            uploadProgressEl.style.display = 'block';
            uploadTask.on('state_changed', 
                (snapshot) => { uploadProgressEl.textContent = `Uploading... ${Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100)}%`; }, 
                (error) => { 
                    console.error("Upload error:", error);
                    if (error.code === 'storage/unauthorized') {
                        uploadProgressEl.textContent = 'Upload failed. Permission denied (check password).';
                    } else {
                        uploadProgressEl.textContent = `Upload failed: ${error.code}`;
                    }
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const imageData = { url: downloadURL, fileName: fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                        journalImagesRef.child(selectedTimeframe).push(imageData);
                        uploadProgressEl.textContent = 'Upload complete!';
                        setTimeout(() => { uploadProgressEl.style.display = 'none'; }, 2000);
                    });
                }
            );
        }

        const saveJournalEntry = (() => { let t; return () => { clearTimeout(t); t = setTimeout(() => { 
            if (!isMasterUser || !masterPassword) return; // SECURED
            saveStatusEl.textContent = 'Saving...'; journalRef.child(journalTimeframeEl.value).set(journalEntryEl.value).then(() => { saveStatusEl.textContent = 'Saved.'; setTimeout(() => saveStatusEl.textContent = '', 2000); }).catch(e => saveStatusEl.textContent = `Error: ${e.message}`); 
        }, 750); }; })();
        
        // --- EVENT LISTENERS (NOW SECURED) ---
        document.getElementById('add-trade-form').addEventListener('submit', e => {
            e.preventDefault();
            if (!isMasterUser || !masterPassword) return; // SECURED
            // ... rest of the function is the same
            const newTrade = { symbol: document.getElementById('trade-symbol').value, date: new Date().toLocaleString(), type: document.getElementById('trade-type').value, entry: document.getElementById('entry-price').value, stoploss: document.getElementById('stop-loss').value, target: document.getElementById('target').value, size: document.getElementById('position-value').value }; const profitCalc = calculateNetResult(newTrade, newTrade.target); const lossCalc = calculateNetResult(newTrade, newTrade.stoploss); newTrade.expected_profit = profitCalc.net_result; newTrade.expected_loss = lossCalc.net_result; tradesRef.push(newTrade); e.target.reset();
        });

        document.getElementById('trades-tbody').addEventListener('click', e => {
            if (!isMasterUser || !masterPassword) return; // SECURED
            const { classList, dataset } = e.target;
            if (!dataset.id) return;
            if (classList.contains('delete-btn')) if (confirm('Delete this live trade?')) tradesRef.child(dataset.id).remove();
            if (classList.contains('win-btn') || classList.contains('loss-btn')) completeTrade(dataset.id, classList.contains('win-btn') ? 'win' : 'loss');
        });

        document.getElementById('completed-trades-tbody').addEventListener('click', e => {
            if (!isMasterUser || !masterPassword || !e.target.classList.contains('delete-btn-completed')) return; // SECURED
            if (confirm('Delete this completed trade? This CANNOT be undone.')) completedTradesRef.child(e.target.dataset.id).remove();
        });

        journalImageUploadEl.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        journalImagesContainer.addEventListener('click', (e) => {
            if (!isMasterUser || !masterPassword || !e.target.classList.contains('delete-journal-image')) return; // SECURED
            const { timeframe, id, filename } = e.target.dataset;
            if (confirm('Delete this image?')) storage.ref(`journal_images/${timeframe}/${filename}`).delete().then(() => journalImagesRef.child(timeframe).child(id).remove()).catch((err) => { console.error(err); if (err.code === 'storage/object-not-found') journalImagesRef.child(timeframe).child(id).remove(); });
        });
        
        journalEntryEl.addEventListener('input', saveJournalEntry);
        
        // --- UNSECURED LISTENERS (DRAG-DROP VISUALS, TAB SWITCHING) ---
        document.querySelector('.tabs').addEventListener('click', (e) => { if (e.target.matches('.tab-link')) { document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(e.target.dataset.tab + '-tab').classList.add('active'); } });
        ['dragenter','dragover','dragleave','drop'].forEach(ev=>journalTab.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
        ['dragenter','dragover'].forEach(ev=>journalTab.addEventListener(ev,()=>(isMasterUser && masterPassword) && journalTab.classList.add('drag-over')));
        ['dragleave','drop'].forEach(ev=>journalTab.addEventListener(ev,()=>(isMasterUser && masterPassword) && journalTab.classList.remove('drag-over')));
        journalTab.addEventListener('drop', (e) => { if (isMasterUser && e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]); });

        // --- DATA RENDERING FUNCTIONS (NO CHANGES) ---
        // These just display data, they don't need to be secured.
        function calculateNetResult(trade, exitPrice) { const entry = parseFloat(trade.entry), posValue = parseFloat(trade.size), exit = parseFloat(exitPrice); if (isNaN(entry) || isNaN(posValue) || isNaN(exit)) return { net_result: 0, entry_fee: 0, exit_fee: 0 }; const entryFee = posValue * FEE_RATE, exitPosValue = (exit / entry) * posValue, exitFee = exitPosValue * FEE_RATE; const grossResult = trade.type === "Long" ? (exit - entry) * (posValue / entry) : (entry - exit) * (posValue / entry); return { net_result: grossResult - entryFee - exitFee, entry_fee: entryFee, exit_fee: exitFee }; }
        function completeTrade(tradeId, outcome) { database.ref('trades/' + tradeId).once('value', snapshot => { const trade = snapshot.val(); if (!trade) return; const defaultExit = outcome === 'win' ? trade.target : trade.stoploss; const exitPriceStr = prompt(`Enter the exact exit price:`, defaultExit); if (exitPriceStr === null) return; const exitPrice = parseFloat(exitPriceStr); if (isNaN(exitPrice)) return alert("Invalid exit price. Action cancelled."); const { net_result, entry_fee, exit_fee } = calculateNetResult(trade, exitPrice); const completedTrade = { ...trade, closed_date: new Date().toLocaleString(), exit_price: exitPrice, net_result, entry_fee, exit_fee }; delete completedTrade.expected_profit; delete completedTrade.expected_loss; completedTradesRef.push(completedTrade).then(() => tradesRef.child(tradeId).remove()); }); }
        function renderLiveTable(tradesData) { const tbody = document.getElementById('trades-tbody'); tbody.innerHTML = ''; if (!tradesData) return; Object.keys(tradesData).sort((a,b)=>new Date(tradesData[b].date)-new Date(tradesData[a].date)).forEach(id=>{ const t = tradesData[id]; const row = document.createElement('tr'); row.innerHTML = `<td>${t.symbol}</td><td>${t.type}</td><td>${parseFloat(t.entry).toFixed(2)}</td><td>${parseFloat(t.stoploss).toFixed(2)}</td><td>${parseFloat(t.target).toFixed(2)}</td><td>${parseFloat(t.size).toFixed(2)}</td><td style="color: #28a745;">${parseFloat(t.expected_profit).toFixed(2)}</td><td style="color: #dc3545;">${parseFloat(t.expected_loss).toFixed(2)}</td><td>${t.date}</td>${isMasterUser?`<td class="action-buttons"><button class="win-btn" data-id="${id}">Win</button><button class="loss-btn" data-id="${id}">Loss</button><button class="delete-btn" data-id="${id}">Delete</button></td>`:''}`; tbody.appendChild(row); });}
        function renderCompletedTable(tradesData) { const tbody = document.getElementById('completed-trades-tbody'); tbody.innerHTML = ''; if (!tradesData) return; Object.keys(tradesData).sort((a,b)=>new Date(tradesData[b].closed_date)-new Date(tradesData[a].closed_date)).forEach(id=>{ const t=tradesData[id]; const row=document.createElement('tr'); const resultColor=t.net_result>=0?'#28a745':'#dc3545'; const totalFees=(t.entry_fee||0)+(t.exit_fee||0); row.innerHTML=`<td>${t.symbol}</td><td>${t.type}</td><td>${parseFloat(t.entry).toFixed(2)}</td><td>${parseFloat(t.exit_price).toFixed(2)}</td><td>${totalFees.toFixed(2)}</td><td style="color:${resultColor};font-weight:bold;">${parseFloat(t.net_result).toFixed(2)}</td><td>${t.date}</td><td>${t.closed_date}</td>${isMasterUser?`<td class="action-buttons"><button class="delete-btn-completed" data-id="${id}">Delete</button></td>`:''}`; tbody.appendChild(row); });}
        function renderJournalImages(timeframe) { journalImagesContainer.innerHTML = ''; const images = allJournalImages[timeframe]; if (!images) return; Object.keys(images).sort((a,b)=>images[a].timestamp - images[b].timestamp).forEach(id => { const img=images[id]; const w=document.createElement('div'); w.className='journal-image-wrapper'; w.innerHTML=`${(isMasterUser && masterPassword) ? `<button class="delete-journal-image" data-timeframe="${timeframe}" data-id="${id}" data-filename="${img.fileName}">Delete</button>`:''}<img src="${img.url}" alt="Journal Image">`; journalImagesContainer.appendChild(w); }); }
        function updateJournalView() { renderJournalImages(journalTimeframeEl.value); journalEntryEl.value = allJournalEntries[journalTimeframeEl.value] || ''; }
        journalTimeframeEl.addEventListener('change', updateJournalView);
        tradesRef.on('value', snapshot => renderLiveTable(snapshot.val()));
        completedTradesRef.on('value', snapshot => { const data = snapshot.val(); renderCompletedTable(data); let totalNet = 0; if (data) totalNet = Object.values(data).reduce((s,t)=>s+(t.net_result||0),0); const newBalance=STARTING_BALANCE+totalNet; bankRef.set({currentBalance:newBalance}); });
        bankRef.on('value', s=>{ let bal=STARTING_BALANCE; if(s.exists()&&s.val().currentBalance!==null)bal=s.val().currentBalance; document.getElementById('bank-balance-value').textContent=`$${parseFloat(bal).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`; document.getElementById('bank-balance-value').style.color=bal>=STARTING_BALANCE?'#28a745':'#dc3545'; });
        journalRef.on('value', (s) => { allJournalEntries = s.val() || {}; if (journalTab.classList.contains('active')) updateJournalView(); });
        journalImagesRef.on('value', (s) => { allJournalImages = s.val() || {}; if (journalTab.classList.contains('active')) renderJournalImages(journalTimeframeEl.value); });
    });
</script>

</body>
</html>
