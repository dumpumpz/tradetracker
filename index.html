<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #fff;
            --text-color: #333;
            --border-color: #ddd;
            --header-bg: #e9ecef;
            --link-color: #007bff;
            --subtle-text: #666;
            --card-bg: #fafafa;
            --shadow-color: rgba(0,0,0,0.1);
            --green-bg: #d4edda;
            --red-bg: #f8d7da;
            --purple-bg: #e2d9f3;
            --green-border: #c3e6cb;
            --red-border: #f5c6cb;
            --green-text: #155724;
            --red-text: #721c24;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --header-bg: #2c2c2c;
            --link-color: #58a6ff;
            --subtle-text: #888;
            --card-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.4);
            --green-bg: #1c3b23;
            --red-bg: #4d1f24;
            --purple-bg: #3c2a4d;
            --green-border: #285732;
            --red-border: #6b282e;
            --green-text: #a7d7b2;
            --red-text: #f5b7bd;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: auto; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
        h1 { text-align: center; color: var(--text-color); margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: var(--subtle-text); }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .master-only { display: none; }
        #add-trade-form { max-width: 950px; margin: 20px auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--card-bg); grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button:hover { opacity: 0.85; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
        th { background-color: var(--header-bg); font-weight: bold; }
        .action-buttons button { padding: 5px 8px; font-size: 12px; margin-right: 4px; }

        .note-cell { white-space: normal; max-width: 300px; min-width: 150px; font-size: 12px; line-height: 1.4; }

        #journal-tab, #snapshot-tab, #sr-levels-tab { position: relative; }
        .controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin: 20px auto; }
        .controls-container > div { display: flex; align-items: center; gap: 8px; }
        
        #journal-entry { width: 100%; min-height: 25vh; resize: vertical; line-height: 1.6; margin-top: 5px; overflow-y: hidden; }
        #journal-entry:read-only { background-color: var(--card-bg); cursor: not-allowed; }
        
        #image-upload-section { margin-top: 20px; border-top: 1px dashed var(--border-color); padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: var(--link-color); }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid var(--border-color); padding: 5px; background: var(--card-bg); border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; border-radius: 2px; }
        
        .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; opacity: 0.7; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .journal-image-wrapper:hover .delete-journal-image { opacity: 1; transform: scale(1.1); }
        .delete-journal-image svg { width: 16px; height: 16px; fill: white; }

        #ema-key-container { margin: 25px auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); max-width: 80%; }
        #ema-key-container h4 { text-align: center; margin-top: 0; margin-bottom: 15px; color: var(--subtle-text); }
        .ema-key-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px 25px; }
        .key-item { display: flex; align-items: center; }
        .key-color-swatch { width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; border: 1px solid var(--border-color); }
        .key-label { font-size: 14px; }

        #journal-tab.drag-over { border: 3px dashed var(--link-color); background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: var(--link-color); z-index: 999; pointer-events: none; }
        
        #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
        #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        #stats-fab:hover { transform: scale(1.1); }
        #stats-fab svg { width: 28px; height: 28px; fill: white; }
        #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s; pointer-events: none; }
        #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .stats-header h3 { margin: 0; font-size: 18px; color: var(--text-color); }
        #close-stats-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 5px; line-height: 1; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
        .stat-label { font-size: 14px; color: var(--subtle-text); }
        .stat-value { font-size: 16px; font-weight: 600; color: var(--text-color); }
        #stat-balance-aud { font-size: 14px; color: var(--subtle-text); }
        
        .date-nav-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px auto 20px auto; }
        #date-buttons-container { display: flex; gap: 8px; }
        .date-nav-btn { padding: 8px 12px; font-size: 14px; background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--subtle-text); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .date-nav-btn:hover { border-color: var(--link-color); color: var(--link-color); }
        .date-nav-btn.active { background-color: var(--link-color); color: white; border-color: var(--link-color); font-weight: bold; }
        .date-nav-arrow { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 10px; }
        .date-nav-arrow:hover { color: var(--link-color); }

        #ema-data-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        #ema-data-section h2 { margin-top: 0; border-top: none; text-align: center; }
        .current-price-display { text-align: center; font-size: 18px; margin-bottom: 5px; color: var(--text-color); }
        .price-value { font-weight: bold; font-family: inherit; }
        .ema-last-updated { text-align: center; font-style: italic; color: var(--subtle-text); font-size: 14px; margin-bottom: 20px; }
        #ema-table { text-align: right; width: 100%; }
        #ema-table th, #ema-table td { font-family: inherit; font-size: 14px; padding: 10px 8px; }
        #ema-table th { font-weight: bold; background-color: var(--header-bg); color: var(--subtle-text); }
        #ema-table td:first-child { font-weight: bold; text-align: left; color: var(--link-color); padding-left: 15px; }

        #snapshot-images-container { display: flex; flex-direction: column; align-items: center; gap: 25px; margin-top: 20px; }
        .snapshot-image-item { width: 100%; max-width: 900px; }
        .snapshot-image-item h4 { text-align: center; margin-bottom: 8px; font-size: 18px; color: var(--subtle-text); text-transform: capitalize; }
        .snapshot-image-item .journal-image-wrapper { max-width: 100%; margin: auto; }

        #sr-legend-container {
            margin: 0 auto 10px auto;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        #sr-legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }
        #sr-legend-header.collapsed {
            border-bottom-color: transparent;
        }
        #sr-legend-header h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text-color);
            font-weight: 500;
        }
        #sr-legend-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            font-weight: bold;
            margin: 0;
            transition: transform 0.3s ease, color 0.2s, border-color 0.2s;
        }
        #sr-legend-header:hover #sr-legend-toggle-btn {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        #sr-legend-content {
            padding: 15px;
            display: block;
        }
        #sr-metadata-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            padding: 0;
            margin: 0;
            background-color: transparent;
            border: none;
            text-align: center;
        }
        #sr-levels-tab .controls-container {
            margin-bottom: 25px;
            padding: 10px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .metadata-item { font-size: 14px; }
        .metadata-label { font-weight: bold; color: var(--subtle-text); display: block; margin-bottom: 4px; }
        .metadata-value { font-family: 'Courier New', Courier, monospace; color: var(--text-color); }
        .rating-explanation { text-align: left; margin-top: 5px; font-size: 13px; line-height: 1.5; }
        
        #sr-levels-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .sr-column h3 { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid; }
        .sr-column.support h3 { color: #28a745; border-color: #28a745; }
        .sr-column.resistance h3 { color: #dc3545; border-color: #dc3545; }
        .sr-level-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; background-color: var(--card-bg); }
        .sr-level-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--header-bg); }
        .sr-level-price-range { font-size: 18px; font-weight: bold; font-family: 'Courier New', Courier, monospace; }
        .sr-level-strength { font-size: 14px; font-weight: 500; color: #fff; padding: 4px 10px; border-radius: 12px; }
        .sr-column.support .sr-level-strength { background-color: #28a745; }
        .sr-column.resistance .sr-level-strength { background-color: #dc3545; }
        .sr-level-pivots { padding: 15px; font-size: 13px; color: var(--subtle-text); }
        .sr-level-pivots span { font-weight: 600; color: var(--text-color); }
        .sr-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            text-align: center;
            font-size: 14px;
            color: var(--subtle-text);
        }
        .sr-summary span {
            font-weight: bold;
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
        }

        .price-above { color: #dc3545 !important; }
        .price-below { color: #28a745 !important; }

        .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 20px; z-index: 10; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: var(--link-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .journal-input-wrapper {
            position: relative;
        }
        #favourite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            padding: 0;
            margin: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: #ccc; 
            cursor: pointer;
            display: none; 
            transition: all 0.2s ease;
            z-index: 5;
        }
        #favourite-btn:hover {
            border-color: #ffc107;
            color: #ffc107;
        }
        #favourite-btn.active {
            color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }
        #favourited-entry-container {
            background-color: var(--purple-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .favourited-header {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 14px;
        }
        .favourited-header .star-icon {
            font-size: 18px;
            margin-right: 8px;
            color: #ffc107;
        }
        #favourited-entry-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
        }
        
        /* --- NEW STYLES FOR ANALYSIS TABLE --- */
        #analysis-tab table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 5px;
            margin-top: 20px;
        }
        #analysis-tab th {
            background-color: var(--header-bg);
            font-weight: bold;
            padding: 10px;
            text-transform: capitalize;
        }
        #analysis-tab td {
            border: 1px solid var(--border-color);
            padding: 5px;
            vertical-align: middle;
            text-align: center;
        }
        #analysis-tab .timeframe-cell {
            text-align: left;
            padding-left: 10px;
            font-weight: 500;
            background-color: var(--card-bg);
        }
        #analysis-tab .clickable-cell {
            font-weight: 500;
            border: 2px outset;
            border-color: #ccc #888 #888 #ccc;
            border-radius: 4px;
            min-height: 40px; /* Give cells height */
            padding: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        
        /* --- MODIFIED: Add cursor style for master user --- */
        #analysis-tab table.interactive .clickable-cell {
            cursor: pointer;
            user-select: none;
        }

        [data-theme="dark"] #analysis-tab .clickable-cell {
            border-color: #555 #111 #111 #555;
        }
        #analysis-tab input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            border: 2px inset var(--border-color);
            text-align: center;
        }
        /* --- END OF NEW STYLES --- */

        @media (max-width: 768px) { 
            .container { padding: 10px; } 
            #add-trade-form { grid-template-columns: 1fr; } 
            .section-header { flex-direction: column; } 
            .backup-controls { position: static; margin-top: 10px; } 
            .journal-image-wrapper { max-width: 100%; } 
            th, td { font-size: 12px; padding: 6px; } 
            .action-buttons button { font-size: 11px; padding: 4px 8px; } 
            #stats-panel-container { bottom: 10px; left: 10px; }
            #stats-fab { width: 50px; height: 50px; }
            #stats-panel { width: calc(100vw - 40px); }
            #sr-levels-container { grid-template-columns: 1fr; }
            #sr-metadata-container { flex-direction: column; }
            .theme-switch-wrapper { top: 8px; right: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">×</button></div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">AUD Value (est.)</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
        </div>

    
        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal</button>
            <button class="tab-link" data-tab="snapshot">Snapshot</button>
            <button class="tab-link" data-tab="sr-levels">S/R Levels</button>
            <button class="tab-link" data-tab="analysis">Current Setups</button>
        </div>
        
        <div id="tracker-tab" class="tab-content active">
            <form id="add-trade-form" class="master-only"><div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div><div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div><div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div><div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div><div><label for="target">Target:</label><input type="number" id="target" step="any" required></div><div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div><div><button type="submit">Add Trade</button></div></form><div class="section-header"><h2>Live Trades</h2></div><div class="table-wrapper"><table><thead><tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>Date Opened</th><th>Note</th><th class="master-only">Actions</th></tr></thead><tbody id="trades-tbody"></tbody></table></div><div class="section-header"><h2>Completed Trades</h2></div><div class="table-wrapper"><table><thead><tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th>Note</th><th class="master-only">Actions</th></tr></thead><tbody id="completed-trades-tbody"></tbody></table></div>
        </div>

        <div id="journal-tab" class="tab-content">
            <div class="controls-container" id="journal-controls">
                <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                <div>
                    <label for="journal-image-filter">Filter Images:</label>
                    <select id="journal-image-filter">
                        <option value="all" selected>All for Timeframe</option>
                        <option value="today">Selected Day Only</option>
                    </select>
                </div>
            </div>
            <div class="date-nav-container">
                <button id="date-prev" class="date-nav-arrow"><</button>
                <div id="date-buttons-container"></div>
                <button id="date-next" class="date-nav-arrow">></button>
            </div>
            
            <div id="favourited-entry-container" style="display: none;">
                <div class="favourited-header">
                    <span class="star-icon">⭐</span>
                    <span>Pinned Note for this Timeframe</span>
                </div>
                <div id="favourited-entry-text"></div>
            </div>

            <div class="journal-input-wrapper">
                 <textarea id="journal-entry" placeholder="Select a symbol, timeframe, and date to view or add a journal entry."></textarea>
                 <button id="favourite-btn" class="master-only" title="Pin this note for this timeframe on all days">⭐</button>
            </div>

            <p id="save-status" style="text-align:center;font-style:italic;color:#666;height:1em"></p>
            
            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture</label>
                <input type="file" id="journal-image-upload" accept="image/*">
                <div id="upload-progress"></div>
            </div>
            
            <div id="journal-images-container"></div>

            <div id="ema-key-container">
                <h4>Chart Key</h4>
                <div class="ema-key-list">
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #FFFFFF;"></span><span class="key-label">13 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #000000;"></span><span class="key-label">49 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #FF0000;"></span><span class="key-label">100 EMA/SMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #008000;"></span><span class="key-label">200 EMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #800080;"></span><span class="key-label">500 EMA</span></div>
                    <div class="key-item"><span class="key-color-swatch" style="background-color: #0000FF;"></span><span class="key-label">1000 EMA</span></div>
                </div>
            </div>
            
            <div id="ema-data-section">
                <h2>Market Snapshot</h2>
                <div class="current-price-display">Current Price (15m): <span id="ema-current-price" class="price-value">--</span></div>
                <p class="ema-last-updated">Last Updated: <span id="ema-last-updated-time">--</span></p>
                <div class="table-wrapper">
                    <table id="ema-table">
                        <thead>
                            <tr>
                                <th>TF</th>
                                <th>EMA 13</th><th>SMA 13</th><th>EMA 49</th><th>SMA 49</th><th>EMA 100</th><th>SMA 100</th>
                                <th>EMA 200</th><th>SMA 200</th><th>EMA 500</th><th>SMA 500</th><th>EMA 1000</th><th>SMA 1000</th>
                            </tr>
                        </thead>
                        <tbody id="ema-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="snapshot-tab" class="tab-content">
            <div class="controls-container" id="snapshot-controls">
                <div><label for="snapshot-symbol">Symbol:</label><select id="snapshot-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
            </div>
            <div id="snapshot-images-container"></div>
        </div>

        <div id="sr-levels-tab" class="tab-content">
            <div id="sr-legend-container">
                <div id="sr-legend-header">
                    <h4>S/R Levels Key</h4>
                    <button id="sr-legend-toggle-btn" title="Toggle Details">−</button>
                </div>
                <div id="sr-legend-content">
                    <div id="sr-metadata-container">
                        <div class="metadata-item"><span class="metadata-label">Lookback Period</span><span id="sr-metadata-dates" class="metadata-value">--</span></div>
                        <div class="metadata-item"><span class="metadata-label">Timeframes Analyzed</span><span id="sr-metadata-timeframes" class="metadata-value">--</span></div>
                        <div class="metadata-item"><span class="metadata-label">Pivot Windows</span><span id="sr-metadata-windows" class="metadata-value">--</span></div>
                        <div class="metadata-item"><span class="metadata-label">Pivot Sources</span><span class="metadata-value">Wick High, Wick Low</span></div>
                        <div class="metadata-item"><span class="metadata-label">Strength Score</span><div class="rating-explanation"><span class="metadata-value">    '15m': 1.0,
            '30m': 1.2,
            '1h': 1.5,
            '2h': 2.0,
            '4h': 2.5</span></div>
                                             <p>  <div class="metadata-item"><span class="metadata-label">Source Weights</span><span class="metadata-value">Wick (1.0), Close (1.5)</span></div>
</div></p>
                    </div>
                </div>
            </div>

            <div class="controls-container">
                <div><label for="sr-symbol">Symbol:</label><select id="sr-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="sr-lookback">Lookback:</label><select id="sr-lookback"><option value="60d">60 Days</option><option value="30d">30 Days</option><option value="21d">21 Days</option><option value="14d">14 Days</option><option value="7d">7 Days</option>  <option value="3d">3 Days</option>
    <option value="2d">2 Days</option></select></div>
            </div>

            <p class="ema-last-updated">Last Updated: <span id="sr-last-updated-time">--</span></p>

            <div id="sr-levels-container">
                <div class="sr-column support">
                    <h3>Top Support Zones</h3>
                    <div id="support-levels-container"></div>
                    <div id="support-summary" class="sr-summary"></div>
                </div>
                <div class="sr-column resistance">
                    <h3>Top Resistance Zones</h3>
                    <div id="resistance-levels-container"></div>
                    <div id="resistance-summary" class="sr-summary"></div>
                </div>
            </div>
        </div>
        
        <div id="analysis-tab" class="tab-content">
            <!-- The interactive table will be generated here by JavaScript -->
        </div>

    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>

const firebaseConfig = {
    apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
    authDomain: "journal-a003f.firebaseapp.com",
    databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "journal-a003f",
    storageBucket: "journal-a003f.firebasestorage.app",
    messagingSenderId: "1038636626553",
    appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();
const tradesRef = database.ref('trades');
const completedTradesRef = database.ref('completed_trades');
const bankRef = database.ref('bank');
const journalRef = database.ref('journal_text'); 
const journalImagesRef = database.ref('journal_images'); 
const favouritesRef = database.ref('journal_favourites');

const FEE_RATE = 0.00075;
const STARTING_BALANCE = 3881;
const USD_TO_AUD_RATE = 1.53;

document.addEventListener('DOMContentLoaded', function () {
    let isMasterUser = false, masterPassword = null, allJournalText = {}, allJournalImages = {}, allEmaData = {}, allSrData = {}, currentPrice = 0, allFavouriteEntries = {};
    let selectedDate = new Date();
    let centerDate = new Date();
    
    const addTradeForm = document.getElementById('add-trade-form');
    const statsFab = document.getElementById('stats-fab');
    const statsPanel = document.getElementById('stats-panel');
    const closeStatsBtn = document.getElementById('close-stats-btn');
    const journalSymbolEl = document.getElementById('journal-symbol');
    const journalTimeframeEl = document.getElementById('journal-timeframe');
    const journalEntryEl = document.getElementById('journal-entry');
    const journalImagesContainer = document.getElementById('journal-images-container');
    const tradesTbody = document.getElementById('trades-tbody');
    const completedTradesTbody = document.getElementById('completed-trades-tbody');
    const journalTab = document.getElementById('journal-tab');
    const snapshotSymbolEl = document.getElementById('snapshot-symbol');
    const snapshotImagesContainer = document.getElementById('snapshot-images-container');
    const srSymbolEl = document.getElementById('sr-symbol');
    const srLookbackEl = document.getElementById('sr-lookback');
    const themeToggle = document.getElementById('theme-checkbox');
    const dateButtonsContainer = document.getElementById('date-buttons-container');
    const datePrevBtn = document.getElementById('date-prev');
    const dateNextBtn = document.getElementById('date-next');
    const journalImageFilterEl = document.getElementById('journal-image-filter');

    const favouriteBtn = document.getElementById('favourite-btn');
    const favouritedEntryContainer = document.getElementById('favourited-entry-container');
    const favouritedEntryText = document.getElementById('favourited-entry-text');

    const srLegendHeader = document.getElementById('sr-legend-header');
    const srLegendContent = document.getElementById('sr-legend-content');
    const srLegendToggleBtn = document.getElementById('sr-legend-toggle-btn');

    function getYYYYMMDD(date) { return date.toISOString().split('T')[0]; }
    function autoResizeTextarea(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }
    function getSafeSymbol(symbol) { return symbol.replace(/\//g, '-'); }
    
    async function fetchEmaData() {
        try {
            const response = await fetch('ma_analysis.json?cache_bust=' + new Date().getTime());
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            allEmaData = await response.json();
            if (document.getElementById('journal-tab').classList.contains('active')) {
                updateJournalView(); 
            }
        } catch (error) {
            console.error("Could not fetch ma_analysis.json:", error);
            document.getElementById('ema-tbody').innerHTML = '<tr><td colspan="13" style="color: red; text-align: center;">Error loading EMA data. Make sure ma_analysis.json is in the correct folder.</td></tr>';
        }
    }

    async function fetchSrData() {
        try {
            const response = await fetch('sr_levels_analysis.json?cache_bust=' + new Date().getTime());
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            allSrData = await response.json();
            if (document.getElementById('sr-levels-tab').classList.contains('active')) {
                renderSrLevels();
            }
        } catch (error) {
            console.error("Could not fetch sr_levels_analysis.json:", error);
            document.getElementById('sr-levels-container').innerHTML = '<p style="color: red; text-align: center;">Error: Could not load S/R levels data. Make sure sr_levels_analysis.json is in the correct folder.</p>';
        }
    }

    function renderDateNavigation() {
        dateButtonsContainer.innerHTML = '';
        for (let i = -2; i <= 2; i++) {
            const date = new Date(centerDate);
            date.setDate(centerDate.getDate() + i);
            const btn = document.createElement('button');
            btn.className = 'date-nav-btn';
            btn.textContent = date.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });
            btn.dataset.date = getYYYYMMDD(date);
            if (getYYYYMMDD(date) === getYYYYMMDD(selectedDate)) {
                btn.classList.add('active');
            }
            dateButtonsContainer.appendChild(btn);
        }
    }
    
    function updateJournalView() { 
        const safeSymbol = getSafeSymbol(journalSymbolEl.value); 
        const yyyymmdd = getYYYYMMDD(selectedDate);
        const timeframe = journalTimeframeEl.value; 

        // 1. Handle pinned note display
        const favouriteText = (allFavouriteEntries[safeSymbol] || {})[timeframe];
        if (favouriteText) {
            favouritedEntryText.textContent = favouriteText;
            favouritedEntryContainer.style.display = 'block';
        } else {
            favouritedEntryContainer.style.display = 'none';
        }

        // 2. Load daily note
        const dailyText = (allJournalText[safeSymbol]?.[yyyymmdd]?.[timeframe]) || '';
        journalEntryEl.value = dailyText; 
        autoResizeTextarea(journalEntryEl); 

        // 3. Set star state: star is active (yellow) if the current day's text IS the pinned text.
        if (favouriteText && dailyText.trim() && favouriteText === dailyText.trim()) {
            favouriteBtn.classList.add('active');
        } else {
            favouriteBtn.classList.remove('active');
        }
        
        // 4. Load images and EMA data
        const symbolImageData = allJournalImages[safeSymbol] || {}; 
        renderJournalImages(safeSymbol, timeframe, symbolImageData, yyyymmdd); 
        renderEmaData();
    }

    const saveJournalEntry = (() => { 
        let t; 
        return () => { 
            clearTimeout(t); 
            t = setTimeout(() => { 
                if (!isMasterUser) return; 
                const safeSymbol = getSafeSymbol(journalSymbolEl.value); 
                const yyyymmdd = getYYYYMMDD(selectedDate);
                const timeframe = journalTimeframeEl.value; 
                const text = journalEntryEl.value;
                document.getElementById('save-status').textContent = 'Saving...'; 
                journalRef.child(safeSymbol).child(yyyymmdd).child(timeframe).set(text)
                    .then(() => { 
                        document.getElementById('save-status').textContent = 'Saved.'; 
                        // After saving, check if this new text matches the favourite and update star
                        const favouriteText = (allFavouriteEntries[safeSymbol] || {})[timeframe];
                        if (text.trim() && text.trim() === favouriteText) {
                            favouriteBtn.classList.add('active');
                        } else {
                            favouriteBtn.classList.remove('active');
                        }
                        setTimeout(() => document.getElementById('save-status').textContent = '', 2000); 
                    })
                    .catch(e => document.getElementById('save-status').textContent = `Error: ${e.message}`); 
            }, 750); 
        }; 
    })();
    
    function renderSnapshotView() {
        const selectedSymbol = getSafeSymbol(snapshotSymbolEl.value);
        const symbolImageData = allJournalImages[selectedSymbol] || {};
        snapshotImagesContainer.innerHTML = '';
        const timeframesOrder = ['15min', '30min', '1hour', '2hour', '4hour', 'daily', 'weekly', 'monthly'];
        timeframesOrder.forEach(tf => {
            const imagesForTimeframe = symbolImageData[tf];
            if (!imagesForTimeframe || Object.keys(imagesForTimeframe).length === 0) return;
            const latestImage = Object.values(imagesForTimeframe).sort((a, b) => b.timestamp - a.timestamp)[0];
            if (latestImage) {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'snapshot-image-item';
                const heading = document.createElement('h4');
                heading.textContent = tf.replace('min', 'm').replace('hour', 'H');
                const wrapper = document.createElement('div');
                wrapper.className = 'journal-image-wrapper';
                wrapper.innerHTML = `<img src="${latestImage.url}" alt="Latest image for ${tf}">`;
                itemContainer.appendChild(heading);
                itemContainer.appendChild(wrapper);
                snapshotImagesContainer.appendChild(itemContainer);
            }
        });
    }

    function renderSrLevels() {
        const selectedSymbol = getSafeSymbol(srSymbolEl.value);
        const selectedLookback = srLookbackEl.value;
        const symbolSrData = (allSrData.data || {})[selectedSymbol] || {};
        const lookbackData = symbolSrData[selectedLookback] || {};
        const analysisParams = lookbackData.analysis_params || {};
        const lastUpdated = allSrData.last_updated ? new Date(allSrData.last_updated).toLocaleString() : '--';
        
        document.getElementById('sr-last-updated-time').textContent = lastUpdated;
        document.getElementById('sr-metadata-timeframes').textContent = (analysisParams.timeframes_analyzed || []).join(', ') || '--';
        document.getElementById('sr-metadata-windows').textContent = (analysisParams.pivot_windows || []).join(', ') || '--';
        document.getElementById('sr-metadata-dates').textContent = (analysisParams.oldest_pivot_date && analysisParams.newest_pivot_date) ? `${analysisParams.oldest_pivot_date} to ${analysisParams.newest_pivot_date}` : '--';

        const supportContainer = document.getElementById('support-levels-container');
        const resistanceContainer = document.getElementById('resistance-levels-container');
        const supportSummaryEl = document.getElementById('support-summary');
        const resistanceSummaryEl = document.getElementById('resistance-summary');

        supportContainer.innerHTML = '';
        resistanceContainer.innerHTML = '';
        supportSummaryEl.innerHTML = '';
        resistanceSummaryEl.innerHTML = '';

        const buildLevelCard = (level) => {
            const priceStart = level['Price Start'].toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            const priceEnd = level['Price End'].toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            return `<div class="sr-level-card"><div class="sr-level-header"><span class="sr-level-price-range">$${priceStart} - $${priceEnd}</span><span class="sr-level-strength">Score: ${level['Strength Score']}</span></div><div class="sr-level-pivots">Based on <span>${level['Pivot Count']}</span> pivots.</div></div>`;
        };

        const supportLevels = lookbackData.support || [];
        supportLevels.forEach(level => { supportContainer.innerHTML += buildLevelCard(level); });
        
        if (supportLevels.length > 0) {
            const lowestSupport = Math.min(...supportLevels.map(l => l['Price Start']));
            const highestSupport = Math.max(...supportLevels.map(l => l['Price End']));
            supportSummaryEl.innerHTML = `Full Range: <span>$${lowestSupport.toLocaleString('en-US', {maximumFractionDigits: 0})}</span> - <span>$${highestSupport.toLocaleString('en-US', {maximumFractionDigits: 0})}</span>`;
        }
        
        const resistanceLevels = lookbackData.resistance || [];
        resistanceLevels.forEach(level => { resistanceContainer.innerHTML += buildLevelCard(level); });

        if (resistanceLevels.length > 0) {
            const lowestResistance = Math.min(...resistanceLevels.map(l => l['Price Start']));
            const highestResistance = Math.max(...resistanceLevels.map(l => l['Price End']));
            resistanceSummaryEl.innerHTML = `Full Range: <span>$${lowestResistance.toLocaleString('en-US', {maximumFractionDigits: 0})}</span> - <span>$${highestResistance.toLocaleString('en-US', {maximumFractionDigits: 0})}</span>`;
        }
    }

    function renderJournalImages(symbol, timeframe, imagesForSymbol, selectedYMD) {
        journalImagesContainer.innerHTML = '';
        const imagesForTimeframe = imagesForSymbol[timeframe] || {};
        const allImageKeys = Object.keys(imagesForTimeframe);
        
        const filterMode = journalImageFilterEl.value;
        let imageKeys;

        if (filterMode === 'today') {
            imageKeys = allImageKeys.filter(key => {
                const imgData = imagesForTimeframe[key];
                if (!imgData || !imgData.timestamp) return false;
                const imgDate = new Date(imgData.timestamp);
                const imgYMD = getYYYYMMDD(imgDate);
                return imgYMD === selectedYMD;
            });
        } else {
            imageKeys = allImageKeys;
        }

        if (imageKeys.length === 0) return;

        imageKeys.sort((a, b) => imagesForTimeframe[b].timestamp - imagesForTimeframe[a].timestamp)
            .forEach(id => {
                const imgData = imagesForTimeframe[id];
                if (!imgData || !imgData.url || !imgData.fileName) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'journal-image-wrapper';
                const deleteButton = (isMasterUser && masterPassword) ? `<button class="delete-journal-image" title="Delete Image" data-safe-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${imgData.fileName}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : '';
                wrapper.innerHTML = `${deleteButton}<img src="${imgData.url}" alt="Journal Image for ${imgData.fileName}">`;
                journalImagesContainer.appendChild(wrapper);
            });
    }
    
    function renderEmaData() {
        const selectedSymbol = getSafeSymbol(journalSymbolEl.value);
        const symbolEmaData = (allEmaData.data || {})[selectedSymbol] || {};
        const lastUpdated = allEmaData.last_updated ? new Date(allEmaData.last_updated).toLocaleString() : '--';
        document.getElementById('ema-last-updated-time').textContent = lastUpdated;
        const priceDisplay = document.getElementById('ema-current-price');
        const dataFor15m = symbolEmaData['15min'];
        if (dataFor15m && dataFor15m.price !== undefined) {
            currentPrice = dataFor15m.price;
            priceDisplay.textContent = `$${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        } else { currentPrice = 0; priceDisplay.textContent = '...'; }
        const emaTbody = document.getElementById('ema-tbody');
        emaTbody.innerHTML = '';
        const timeframesToDisplay = ['15min', '30min', '1hour', '2hour', '4hour', 'daily'];
        const periodsToDisplay = [13, 49, 100, 200, 500, 1000];
        const tfShortNames = {'15min': '15m','30min': '30m','1hour': '1H','2hour': '2H','4hour': '4H','daily': '1D'};
        timeframesToDisplay.forEach(tf => {
            const tfData = symbolEmaData[tf];
            const row = emaTbody.insertRow();
            row.insertCell().textContent = tfShortNames[tf] || tf;
            periodsToDisplay.forEach(period => {
                ['EMA', 'SMA'].forEach(type => {
                    const cell = row.insertCell();
                    if (tfData && tfData[`${type}_${period}`] !== undefined) {
                        const val = tfData[`${type}_${period}`];
                        cell.textContent = Math.round(val).toLocaleString();
                        if (currentPrice > 0) {
                            cell.className = val > currentPrice ? 'price-above' : 'price-below';
                        }
                    } else { cell.textContent = '...'; }
                });
            });
        });
    }

    function checkMasterMode() { 
        const urlParams = new URLSearchParams(window.location.search); 
        if (urlParams.get('master') === 'true') { 
            const password = prompt("Please enter master password:"); 
            if (password) { 
                isMasterUser = true; masterPassword = password; 
                document.querySelectorAll('.master-only').forEach(el => { 
                    if (el.id === 'add-trade-form') el.style.display = 'grid'; 
                    else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell'; 
                    else if (el.classList.contains('backup-controls')) el.style.display = 'flex'; 
                    else if (el.id === 'favourite-btn') el.style.display = 'block';
                    else el.style.display = 'block'; 
                }); 
                journalEntryEl.readOnly = false; 
            } 
        } 
        if (!isMasterUser) { journalEntryEl.readOnly = true; } 
    }
    
    function handleFileUpload(file) {
        if (!isMasterUser || !masterPassword || !file || !file.type.startsWith('image/')) return;
        const uploadProgressEl = document.getElementById('upload-progress');
        uploadProgressEl.style.display = 'block';
        const safeSymbol = getSafeSymbol(journalSymbolEl.value);
        const timeframe = journalTimeframeEl.value;
        const fileName = `${Date.now()}_${file.name}`;
        const storagePath = `journal_images/${safeSymbol}/${timeframe}/${fileName}`;
        const fileRef = storage.ref(storagePath);
        const metadata = { customMetadata: { 'password': masterPassword } };
        const uploadTask = fileRef.put(file, metadata);
        uploadTask.on('state_changed', (s) => { uploadProgressEl.textContent = `Uploading... ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; },
        (storageError) => { console.error("STORAGE UPLOAD FAILED:", storageError); uploadProgressEl.textContent = `Upload Failed: ${storageError.code}`; },
        () => {
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                const imageDataForFirebase = { url: downloadURL, fileName: fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                const newRef = journalImagesRef.child(safeSymbol).child(timeframe).push(imageDataForFirebase);
                newRef.then(() => { 
                    uploadProgressEl.textContent = 'Upload Complete!'; 
                    setTimeout(() => { uploadProgressEl.style.display = 'none'; uploadProgressEl.textContent = ''; }, 2000); 
                    const imageDataForLocalCache = { url: downloadURL, fileName: fileName, timestamp: Date.now() };
                    if (!allJournalImages[safeSymbol]) allJournalImages[safeSymbol] = {};
                    if (!allJournalImages[safeSymbol][timeframe]) allJournalImages[safeSymbol][timeframe] = {};
                    allJournalImages[safeSymbol][timeframe][newRef.key] = imageDataForLocalCache;
                    updateJournalView();
                }).catch((dbError) => { console.error("DATABASE SAVE FAILED:", dbError); uploadProgressEl.textContent = 'DB save failed: ' + dbError.message; fileRef.delete(); });
            });
        });
    }
    
    function calculateNetResult(trade, exitPrice) { const entry=parseFloat(trade.entry),posValue=parseFloat(trade.size),exit=parseFloat(exitPrice);if(isNaN(entry)||isNaN(posValue)||isNaN(exit))return{net_result:0,entry_fee:0,exit_fee:0};const entryFee=posValue*FEE_RATE,exitPosValue=(exit/entry)*posValue,exitFee=exitPosValue*FEE_RATE;const grossResult=trade.type==="Long"?(exit-entry)*(posValue/entry):(entry-exit)*(posValue/entry);return{net_result:grossResult-entryFee-exitFee,entry_fee:entryFee,exit_fee:exitFee};}
    function completeTrade(tradeId,outcome){database.ref('trades/'+tradeId).once('value',s=>{const t=s.val();if(!t)return;const d=outcome==='win'?t.target:t.stoploss;const p=prompt(`Enter exact exit price:`,d);if(p===null)return;const e=parseFloat(p);if(isNaN(e))return alert("Invalid exit price.");const{net_result,entry_fee,exit_fee}=calculateNetResult(t,e);const c={...t,closed_date:new Date().toLocaleString(),exit_price:e,net_result,entry_fee,exit_fee};delete c.expected_profit;delete c.expected_loss;completedTradesRef.push(c).then(()=>tradesRef.child(tradeId).remove());});}
    function renderLiveTable(d){const t=document.getElementById('trades-tbody');t.innerHTML='';if(!d)return;Object.keys(d).sort((a,b)=>new Date(d[b].date)-new Date(d[a].date)).forEach(id=>{const a=d[id],r=document.createElement('tr');const noteText=a.note||'';const noteCell=`<td class="note-cell" title="${noteText}">${noteText}</td>`;const masterButtons=isMasterUser?`<td class="action-buttons"><button class="win-btn" data-id="${id}">Win</button><button class="loss-btn" data-id="${id}">Loss</button><button class="note-btn" data-id="${id}">Edit</button><button class="delete-btn" data-id="${id}">Delete</button></td>`:'';r.innerHTML=`<td>${a.symbol}</td><td>${a.type}</td><td>${parseFloat(a.entry).toFixed(2)}</td><td>${parseFloat(a.stoploss).toFixed(2)}</td><td>${parseFloat(a.target).toFixed(2)}</td><td>${parseFloat(a.size).toFixed(2)}</td><td style="color: #28a745;">${parseFloat(a.expected_profit||0).toFixed(2)}</td><td style="color: #dc3545;">${parseFloat(a.expected_loss||0).toFixed(2)}</td><td>${a.date}</td>${noteCell}${masterButtons}`;t.appendChild(r);});}
    function renderCompletedTable(d){const t=document.getElementById('completed-trades-tbody');t.innerHTML='';if(!d)return;Object.keys(d).sort((a,b)=>new Date(d[b].closed_date)-new Date(d[a].date)).forEach(id=>{const a=d[id],r=document.createElement('tr');const c=a.net_result>=0?'#28a745':'#dc3545',e=(a.entry_fee||0)+(a.exit_fee||0);const noteText=a.note||'';const noteCell=`<td class="note-cell" title="${noteText}">${noteText}</td>`;const masterButtons=isMasterUser?`<td class="action-buttons"><button class="note-btn-completed" data-id="${id}">Edit</button><button class="delete-btn-completed" data-id="${id}">Delete</button></td>`:'';r.innerHTML=`<td>${a.symbol}</td><td>${a.type}</td><td>${parseFloat(a.entry).toFixed(2)}</td><td>${parseFloat(a.exit_price).toFixed(2)}</td><td>${e.toFixed(2)}</td><td style="color:${c};font-weight:bold;">${parseFloat(a.net_result).toFixed(2)}</td><td>${a.date}</td><td>${a.closed_date}</td>${noteCell}${masterButtons}`;t.appendChild(r);});}

    // --- MODIFIED ANALYSIS TABLE FUNCTION ---
    function initializeAnalysisTable() {
        const container = document.getElementById('analysis-tab');
        if (!container) return;

        const timeframes = ["15min", "30min", "1hour", "2hour", "4hour", "daily", "weekly", "monthly"];
        const headers = ["Timeframe", "0candle", "4candle", "current cross", "target"];
        const colors = ["red", "green", "yellow", "grey"];
        const cellStates = {};
        const initialColor = "grey";
        const initialColorIndex = colors.indexOf(initialColor);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        
        // MODIFICATION: Add a class to the table if the user is a master
        if (isMasterUser) {
            table.classList.add('interactive');
        }
        
        const headerRow = document.createElement('tr');
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        timeframes.forEach((tfText, rowIndex) => {
            const row = document.createElement('tr');

            const tfCell = document.createElement('td');
            tfCell.textContent = tfText;
            tfCell.className = 'timeframe-cell';
            row.appendChild(tfCell);

            for (let colIndex = 1; colIndex < 4; colIndex++) {
                const cell = document.createElement('td');
                cell.className = 'clickable-cell';
                cell.textContent = headers[colIndex];
                cell.style.backgroundColor = initialColor;
                cell.style.color = 'black';
                cell.dataset.row = rowIndex;
                cell.dataset.col = colIndex;
                cellStates[`${rowIndex}-${colIndex}`] = initialColorIndex;
                row.appendChild(cell);
            }
            
            const entryCell = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            // MODIFICATION: Disable input field for non-master users
            input.disabled = !isMasterUser; 
            entryCell.appendChild(input);
            row.appendChild(entryCell);

            tbody.appendChild(row);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        container.appendChild(table);

        tbody.addEventListener('click', (event) => {
            // MODIFICATION: Add a guard to prevent clicks if not a master user
            if (!isMasterUser) return;

            const clickedCell = event.target.closest('.clickable-cell');
            if (!clickedCell) return;

            const { row, col } = clickedCell.dataset;
            const stateKey = `${row}-${col}`;
            const currentColorIndex = cellStates[stateKey];
            const nextColorIndex = (currentColorIndex + 1) % colors.length;
            cellStates[stateKey] = nextColorIndex;
            
            const newColor = colors[nextColorIndex];
            const textColor = (newColor === 'red' || newColor === 'green') ? 'white' : 'black';

            clickedCell.style.backgroundColor = newColor;
            clickedCell.style.color = textColor;
        });
    }
    
    // Call checkMasterMode() *before* initializing the tables that depend on it.
    checkMasterMode();
    
    // Initialize everything else
    renderDateNavigation();
    fetchEmaData();
    fetchSrData();
    initializeAnalysisTable(); // Now this function can correctly use isMasterUser

    if (srLegendHeader) {
        srLegendHeader.addEventListener('click', () => {
            const isCollapsed = srLegendContent.style.display === 'none';
            if (isCollapsed) {
                srLegendContent.style.display = 'block';
                srLegendHeader.classList.remove('collapsed');
                srLegendToggleBtn.textContent = '−';
                srLegendToggleBtn.style.transform = 'rotate(0deg)';
            } else {
                srLegendContent.style.display = 'none';
                srLegendHeader.classList.add('collapsed');
                srLegendToggleBtn.textContent = '+';
                srLegendToggleBtn.style.transform = 'rotate(180deg)';
            }
        });
        srLegendToggleBtn.textContent = '−';
    }

    journalImagesContainer.addEventListener('click', (e) => {
        const button = e.target.closest('.delete-journal-image');
        if (!isMasterUser || !masterPassword || !button) return;
        const { safeSymbol, timeframe, id, filename } = button.dataset;
        if (confirm(`Are you sure you want to delete this image?\n\n${filename}`)) {
            const storagePath = `journal_images/${safeSymbol}/${timeframe}/${filename}`;
            const dbPath = `journal_images/${safeSymbol}/${timeframe}/${id}`;
            storage.ref(storagePath).delete().then(() => { database.ref(dbPath).remove(); })
                .catch((err) => {
                    if (err.code === 'storage/object-not-found') { database.ref(dbPath).remove(); }
                });
        }
    });

    journalEntryEl.addEventListener('input', () => {
        autoResizeTextarea(journalEntryEl);
        const safeSymbol = getSafeSymbol(journalSymbolEl.value);
        const timeframe = journalTimeframeEl.value;
        const favouriteText = (allFavouriteEntries[safeSymbol] || {})[timeframe];
        if (favouriteText && journalEntryEl.value.trim() === favouriteText) {
            favouriteBtn.classList.add('active');
        } else {
            favouriteBtn.classList.remove('active');
        }
    });
    journalEntryEl.addEventListener('input', saveJournalEntry);
    
    favouriteBtn.addEventListener('click', () => {
        if (!isMasterUser) return;

        const safeSymbol = getSafeSymbol(journalSymbolEl.value);
        const timeframe = journalTimeframeEl.value;
        const currentText = journalEntryEl.value.trim();
        const currentTextIsThePin = favouriteBtn.classList.contains('active');

        if (currentTextIsThePin) {
            favouriteBtn.classList.remove('active');
            favouritedEntryContainer.style.display = 'none';
            if (allFavouriteEntries[safeSymbol]) {
                delete allFavouriteEntries[safeSymbol][timeframe];
            }
            favouritesRef.child(safeSymbol).child(timeframe).remove()
                .catch(e => {
                    console.error("Error un-pinning:", e);
                    alert("Error un-pinning note. Check console and try again.");
                    updateJournalView();
                });
        } else {
            if (!currentText) {
                alert('Cannot pin an empty note.');
                return;
            }
            favouriteBtn.classList.add('active');
            favouritedEntryText.textContent = currentText;
            favouritedEntryContainer.style.display = 'block';
            if (!allFavouriteEntries[safeSymbol]) {
                allFavouriteEntries[safeSymbol] = {};
            }
            allFavouriteEntries[safeSymbol][timeframe] = currentText;
            favouritesRef.child(safeSymbol).child(timeframe).set(currentText)
                .catch(e => {
                    console.error("Error pinning:", e);
                    alert("Error pinning note. Check console and try again.");
                    updateJournalView();
                });
        }
    });

    addTradeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!isMasterUser) return alert('You do not have permission to add trades.');
        const trade = {
            symbol: document.getElementById('trade-symbol').value,
            type: document.getElementById('trade-type').value,
            entry: parseFloat(document.getElementById('entry-price').value),
            stoploss: parseFloat(document.getElementById('stop-loss').value),
            target: parseFloat(document.getElementById('target').value),
            size: parseFloat(document.getElementById('position-value').value),
            date: new Date().toLocaleString()
        };
        if (isNaN(trade.entry) || isNaN(trade.stoploss) || isNaN(trade.target) || isNaN(trade.size)) return alert('Please ensure all numeric fields are filled correctly.');
        const positionQty = trade.size / trade.entry;
        if (trade.type === 'Long') {
            trade.expected_profit = positionQty * (trade.target - trade.entry);
            trade.expected_loss = positionQty * (trade.entry - trade.stoploss);
        } else {
            trade.expected_profit = positionQty * (trade.entry - trade.target);
            trade.expected_loss = positionQty * (trade.stoploss - trade.entry);
        }
        tradesRef.push(trade).then(() => { addTradeForm.reset(); }).catch((error) => { console.error('Error adding trade:', error); alert('There was an error adding the trade.'); });
    });
    
    tradesTbody.addEventListener('click', e => {
        if (!isMasterUser) return;
        const button = e.target.closest('button');
        if (!button) return;
        const { id } = button.dataset;
        if (button.classList.contains('note-btn')) {
            tradesRef.child(id).child('note').once('value', snapshot => {
                const currentNote = snapshot.val() || "";
                const newNote = prompt("Enter a note for this trade:", currentNote);
                if (newNote !== null) { tradesRef.child(id).update({ note: newNote }); }
            });
        } else if (button.classList.contains('delete-btn')) { 
            if (confirm('Delete live trade?')) tradesRef.child(id).remove(); 
        } else if (button.classList.contains('win-btn')) { 
            completeTrade(id, 'win'); 
        } else if (button.classList.contains('loss-btn')) { 
            completeTrade(id, 'loss'); 
        }
    });

    completedTradesTbody.addEventListener('click', e => {
        if (!isMasterUser) return;
        const button = e.target.closest('button');
        if (!button) return;
        const { id } = button.dataset;
        if (button.classList.contains('delete-btn-completed')) {
            if (confirm('Delete completed trade?')) { completedTradesRef.child(id).remove(); }
        } else if (button.classList.contains('note-btn-completed')) {
            completedTradesRef.child(id).child('note').once('value', snapshot => {
                const currentNote = snapshot.val() || "";
                const newNote = prompt("Edit note for this completed trade:", currentNote);
                if (newNote !== null) { completedTradesRef.child(id).update({ note: newNote }); }
            });
        }
    });
    
    dateButtonsContainer.addEventListener('click', (e) => {
        if (e.target.matches('.date-nav-btn')) {
            const dateStr = e.target.dataset.date;
            const parts = dateStr.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const day = parseInt(parts[2], 10);
            selectedDate = new Date(Date.UTC(year, month, day));
            renderDateNavigation();
            updateJournalView();
        }
    });
    datePrevBtn.addEventListener('click', () => { centerDate.setDate(centerDate.getDate() - 5); renderDateNavigation(); });
    dateNextBtn.addEventListener('click', () => { centerDate.setDate(centerDate.getDate() + 5); renderDateNavigation(); });
    snapshotSymbolEl.addEventListener('change', renderSnapshotView);
    srSymbolEl.addEventListener('change', renderSrLevels);
    srLookbackEl.addEventListener('change', renderSrLevels);
    journalSymbolEl.addEventListener('change', updateJournalView);
    journalTimeframeEl.addEventListener('change', updateJournalView);
    journalImageFilterEl.addEventListener('change', updateJournalView);
    document.getElementById('journal-image-upload').addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
    
    document.querySelector('.tabs').addEventListener('click', (e) => { 
        if (!e.target.matches('.tab-link')) return;
        document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); 
        e.target.classList.add('active'); 
        const activeTabId = e.target.dataset.tab + '-tab';
        const activeTabContent = document.getElementById(activeTabId);
        if (activeTabContent) {
            activeTabContent.classList.add('active'); 
        }
        if (e.target.dataset.tab === 'journal') { updateJournalView(); } 
        else if (e.target.dataset.tab === 'snapshot') { renderSnapshotView(); }
        else if (e.target.dataset.tab === 'sr-levels') { renderSrLevels(); }
    });
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => journalTab.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
    ['dragenter', 'dragover'].forEach(eventName => journalTab.addEventListener(eventName, () => { if (isMasterUser) journalTab.classList.add('drag-over'); }));
    journalTab.addEventListener('dragleave', () => journalTab.classList.remove('drag-over'));
    journalTab.addEventListener('drop', (e) => {
        journalTab.classList.remove('drag-over');
        if (isMasterUser && e.dataTransfer && e.dataTransfer.files.length > 0) {
            handleFileUpload(e.dataTransfer.files[0]);
        }
    });

    statsFab.addEventListener('click', () => statsPanel.classList.toggle('active'));
    closeStatsBtn.addEventListener('click', () => statsPanel.classList.remove('active'));
    document.addEventListener('click', (e) => {
        if (!statsPanel.contains(e.target) && !statsFab.contains(e.target) && statsPanel.classList.contains('active')) {
            statsPanel.classList.remove('active');
        }
    });

    const currentTheme = localStorage.getItem('theme');
    if (currentTheme) {
        document.documentElement.setAttribute('data-theme', currentTheme);
        if (currentTheme === 'dark') themeToggle.checked = true;
    }
    themeToggle.addEventListener('change', (e) => {
        const theme = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    });
    
    tradesRef.on('value',snapshot=>{
        const liveTrades = snapshot.val() || {};
        renderLiveTable(liveTrades);
        document.getElementById('stat-open-trades').textContent = Object.keys(liveTrades).length;
    });
    completedTradesRef.on('value',snapshot=>{
        const completedData = snapshot.val() || {};
        renderCompletedTable(completedData);
        const totalProfitLoss = Object.values(completedData).reduce((sum, trade) => sum + (trade.net_result || 0), 0);
        const newBalance = STARTING_BALANCE + totalProfitLoss;
        document.getElementById('stat-balance').textContent = `$${newBalance.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
        document.getElementById('stat-balance-aud').textContent = `A$${(newBalance * USD_TO_AUD_RATE).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
        const plElement = document.getElementById('stat-total-pl');
        plElement.textContent = `${totalProfitLoss >= 0 ? '+' : ''}$${totalProfitLoss.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
        plElement.style.color = totalProfitLoss >= 0 ? '#28a745' : '#dc3545';
        document.getElementById('stat-completed-trades').textContent = Object.keys(completedData).length;
        bankRef.set({ currentBalance: newBalance });
    });
    
    journalRef.on('value', (s) => { allJournalText = s.val() || {}; if(document.getElementById('journal-tab').classList.contains('active')) updateJournalView(); });
    journalImagesRef.on('value', (s) => {
        allJournalImages = s.val() || {};
        if (document.getElementById('journal-tab').classList.contains('active')) {
            updateJournalView();
        }
        if (document.getElementById('snapshot-tab').classList.contains('active')) {
            renderSnapshotView();
        }
    });

    favouritesRef.on('value', (s) => {
        allFavouriteEntries = s.val() || {};
        if (document.getElementById('journal-tab').classList.contains('active')) {
            updateJournalView();
        }
    });

});
</script>
</body>
</html>
