<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; }
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: #666; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: #007bff; border-bottom-color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .master-only { display: none; }
        #add-trade-form { max-width: 950px; margin: 20px auto; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button:hover { opacity: 0.85; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; }
        th { background-color: #e9ecef; font-weight: bold; }
        .action-buttons button { padding: 5px 10px; font-size: 12px; }

        #journal-tab, #snapshot-tab, #sr-levels-tab { position: relative; }
        .controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin: 20px auto; }
        .controls-container > div { display: flex; align-items: center; gap: 8px; }
        
        #journal-entry { width: 100%; min-height: 25vh; resize: vertical; line-height: 1.6; margin-top: 5px; overflow-y: hidden; }
        #journal-entry:read-only { background-color: #f8f9fa; cursor: not-allowed; color: #555; }
        
        #image-upload-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: #007bff; }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid #ddd; padding: 5px; background: #fafafa; border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; border-radius: 2px; }
        
        .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; opacity: 0.7; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .journal-image-wrapper:hover .delete-journal-image { opacity: 1; transform: scale(1.1); }
        .delete-journal-image svg { width: 16px; height: 16px; fill: white; }

        #journal-tab.drag-over { border: 3px dashed #007bff; background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #007bff; z-index: 999; pointer-events: none; }
        
        #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
        #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
        #stats-fab:hover { transform: scale(1.1); }
        #stats-fab svg { width: 28px; height: 28px; fill: white; }
        #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; }
        #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9ecef; padding-bottom: 10px; margin-bottom: 15px; }
        .stats-header h3 { margin: 0; font-size: 18px; color: #2c3e50; }
        #close-stats-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: #6c757d; cursor: pointer; padding: 0 5px; line-height: 1; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
        .stat-label { font-size: 14px; color: #555; }
        .stat-value { font-size: 16px; font-weight: 600; color: #333; }
        
        #ema-data-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; }
        #ema-data-section h2 { margin-top: 0; border-top: none; text-align: center; }
        .current-price-display { text-align: center; font-size: 18px; margin-bottom: 5px; color: #333; }
        .price-value { font-weight: bold; font-family: inherit; }
        .ema-last-updated { text-align: center; font-style: italic; color: #666; font-size: 14px; margin-bottom: 20px; }
        #ema-table { text-align: right; width: 100%; }
        #ema-table th, #ema-table td { font-family: inherit; font-size: 14px; padding: 10px 8px; }
        #ema-table th { font-weight: bold; background-color: #f8f9fa; color: #555; }
        #ema-table td:first-child { font-weight: bold; text-align: left; color: #007bff; padding-left: 15px; }

        #snapshot-images-container { display: flex; flex-direction: column; align-items: center; gap: 25px; margin-top: 20px; }
        .snapshot-image-item { width: 100%; max-width: 900px; }
        .snapshot-image-item h4 { text-align: center; margin-bottom: 8px; font-size: 18px; color: #555; text-transform: capitalize; }
        .snapshot-image-item .journal-image-wrapper { max-width: 100%; margin: auto; }

        #sr-metadata-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; padding: 15px; margin-bottom: 25px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; text-align: center; }
        .metadata-item { font-size: 14px; }
        .metadata-label { font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .metadata-value { font-family: 'Courier New', Courier, monospace; color: #333; }
        
        #sr-levels-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .sr-column h3 { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid; }
        .sr-column.support h3 { color: #28a745; border-color: #28a745; }
        .sr-column.resistance h3 { color: #dc3545; border-color: #dc3545; }
        .sr-level-card { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; background-color: #fafafa; }
        .sr-level-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9ecef; }
        .sr-level-price-range { font-size: 18px; font-weight: bold; font-family: 'Courier New', Courier, monospace; }
        .sr-level-strength { font-size: 14px; font-weight: 500; color: #fff; padding: 4px 10px; border-radius: 12px; }
        .sr-column.support .sr-level-strength { background-color: #28a745; }
        .sr-column.resistance .sr-level-strength { background-color: #dc3545; }
        .sr-level-pivots { padding: 15px; font-size: 13px; color: #555; }
        .sr-level-pivots span { font-weight: 600; color: #333; }

        @media (max-width: 768px) { 
            .container { padding: 10px; } 
            #add-trade-form { grid-template-columns: 1fr; } 
            .section-header { flex-direction: column; } 
            .backup-controls { position: static; margin-top: 10px; } 
            .journal-image-wrapper { max-width: 100%; } 
            th, td { font-size: 12px; padding: 6px; } 
            .action-buttons button { font-size: 11px; padding: 4px 8px; } 
            #stats-panel-container { bottom: 10px; left: 10px; }
            #stats-fab { width: 50px; height: 50px; }
            #stats-panel { width: calc(100vw - 40px); }
            #sr-levels-container { grid-template-columns: 1fr; }
            #sr-metadata-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">×</button></div>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
        </div>

        <h1>Live Trade & Journal Tracker</h1>
        <p class="subtitle">Data updates in real-time for all viewers.</p>
        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal</button>
            <button class="tab-link" data-tab="snapshot">Snapshot</button>
            <button class="tab-link" data-tab="sr-levels">S/R Levels</button>
        </div>
        
        <div id="tracker-tab" class="tab-content active">
            <form id="add-trade-form" class="master-only"><div><label for="trade-symbol">Symbol:</label><select id="trade-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div><div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div><div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div><div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div><div><label for="target">Target:</label><input type="number" id="target" step="any" required></div><div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div><div><button type="submit">Add Trade</button></div></form><div class="section-header"><h2>Live Trades</h2><div class="backup-controls master-only"><button id="save-live-btn">Save JSON</button><label for="load-live-input">Load JSON</label><input type="file" id="load-live-input" accept=".json"></div></div><div class="table-wrapper"><table><thead><tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Stop Loss</th><th>Target</th><th>Position Value ($)</th><th>Net Profit Est. ($)</th><th>Net Loss Est. ($)</th><th>Date Opened</th><th class="master-only">Actions</th></tr></thead><tbody id="trades-tbody"></tbody></table></div><div class="section-header"><h2>Completed Trades</h2><div class="backup-controls master-only"><button id="save-completed-btn">Save JSON</button><label for="load-completed-input">Load JSON</label><input type="file" id="load-completed-input" accept=".json"></div></div><div class="table-wrapper"><table><thead><tr><th>Symbol</th><th>Type</th><th>Entry Price</th><th>Exit Price</th><th>Fees ($)</th><th>Net Result ($)</th><th>Date Opened</th><th>Date Closed</th><th class="master-only">Actions</th></tr></thead><tbody id="completed-trades-tbody"></tbody></table></div>
        </div>

        <div id="journal-tab" class="tab-content">
            <div class="controls-container" id="journal-controls">
                <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
            </div>
            <textarea id="journal-entry" placeholder="Select a symbol and timeframe to view entry. Master access required to edit."></textarea>
            <p id="save-status" style="text-align:center;font-style:italic;color:#666;height:1em"></p>
            <div id="image-upload-section" class="master-only"><label for="journal-image-upload" class="image-upload-label">Add Picture</label><input type="file" id="journal-image-upload" accept="image/*"><div id="upload-progress" style="display:none"></div></div>
            <div id="journal-images-container"></div>
            <div id="ema-data-section">
                <h2>Market Snapshot</h2>
                <div class="current-price-display">Current Price (15m): <span id="ema-current-price" class="price-value">--</span></div>
                <p class="ema-last-updated">Last Updated: <span id="ema-last-updated-time">--</span></p>
                <div class="table-wrapper">
                    <table id="ema-table">
                        <thead>
                            <tr>
                                <th>TF</th>
                                <th>EMA 13</th><th>SMA 13</th><th>EMA 49</th><th>SMA 49</th><th>EMA 100</th><th>SMA 100</th>
                                <th>EMA 200</th><th>SMA 200</th><th>EMA 500</th><th>SMA 500</th><th>EMA 1000</th><th>SMA 1000</th>
                            </tr>
                        </thead>
                        <tbody id="ema-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="snapshot-tab" class="tab-content">
            <div class="controls-container" id="snapshot-controls">
                <div><label for="snapshot-symbol">Symbol:</label><select id="snapshot-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
            </div>
            <div id="snapshot-images-container"></div>
        </div>

        <div id="sr-levels-tab" class="tab-content">
            <div class="controls-container">
                <div><label for="sr-symbol">Symbol:</label><select id="sr-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="sr-lookback">Lookback:</label><select id="sr-lookback"><option value="60d">60 Days</option><option value="30d">30 Days</option><option value="21d">21 Days</option><option value="14d">14 Days</option><option value="7d">7 Days</option></select></div>
            </div>
            <p class="ema-last-updated">Last Updated: <span id="sr-last-updated-time">--</span></p>
<div id="sr-metadata-container">
    <div class="metadata-item">
        <span class="metadata-label">Lookback Period</span>
        <span id="sr-metadata-dates" class="metadata-value">--</span>
    </div>
    <div class="metadata-item">
        <span class="metadata-label">Timeframes Analyzed</span>
        <span id="sr-metadata-timeframes" class="metadata-value">--</span>
    </div>
    <div class="metadata-item">
        <span class="metadata-label">Pivot Windows</span>
        <span id="sr-metadata-windows" class="metadata-value">--</span>
    </div>
    
    <!-- ADD THE NEW HARDCODED ITEM HERE -->
    <div class="metadata-item">
        <span class="metadata-label">Pivot Sources</span>
        <span class="metadata-value">Wick High, Wick Low, Close High, Close Low</span>
    </div>
</div>
            <div id="sr-levels-container">
                <div class="sr-column support"><h3>Top Support Zones</h3><div id="support-levels-container"></div></div>
                <div class="sr-column resistance"><h3>Top Resistance Zones</h3><div id="resistance-levels-container"></div></div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
            authDomain: "journal-a003f.firebaseapp.com",
            databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "journal-a003f",
            storageBucket: "journal-a003f.firebasestorage.app",
            messagingSenderId: "1038636626553",
            appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const tradesRef = database.ref('trades');
        const completedTradesRef = database.ref('completed_trades');
        const bankRef = database.ref('bank');
        const journalRef = database.ref('journal_text'); 
        const journalImagesRef = database.ref('journal_images'); 
        const emaValuesRef = database.ref('ema_values');
        const srLevelsRef = database.ref('sr_levels_lookback');
        const FEE_RATE = 0.00075;
        const STARTING_BALANCE = 4000;

        document.addEventListener('DOMContentLoaded', function () {
            let isMasterUser = false, masterPassword = null, allJournalText = {}, allJournalImages = {}, allEmaData = {}, allSrData = {};
            
            const statsFab = document.getElementById('stats-fab');
            const statsPanel = document.getElementById('stats-panel');
            const closeStatsBtn = document.getElementById('close-stats-btn');
            const journalSymbolEl = document.getElementById('journal-symbol');
            const journalTimeframeEl = document.getElementById('journal-timeframe');
            const journalEntryEl = document.getElementById('journal-entry');
            const journalImagesContainer = document.getElementById('journal-images-container');
            const tradesTbody = document.getElementById('trades-tbody');
            const completedTradesTbody = document.getElementById('completed-trades-tbody');
            const journalTab = document.getElementById('journal-tab');
            const snapshotSymbolEl = document.getElementById('snapshot-symbol');
            const snapshotImagesContainer = document.getElementById('snapshot-images-container');
            const srSymbolEl = document.getElementById('sr-symbol');
            const srLookbackEl = document.getElementById('sr-lookback');

            function autoResizeTextarea(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }
            function getSafeSymbol(symbol) { return symbol.replace(/\//g, '-'); }
            
            function updateJournalView() { 
                const selectedSymbol = getSafeSymbol(journalSymbolEl.value); 
                const selectedTimeframe = journalTimeframeEl.value; 
                const symbolTextData = allJournalText[selectedSymbol] || {}; 
                journalEntryEl.value = symbolTextData[selectedTimeframe] || ''; 
                autoResizeTextarea(journalEntryEl); 
                const symbolImageData = allJournalImages[selectedSymbol] || {}; 
                renderJournalImages(selectedSymbol, selectedTimeframe, symbolImageData); 
                renderEmaData();
            }

            function renderSnapshotView() {
                const selectedSymbol = getSafeSymbol(snapshotSymbolEl.value);
                const symbolImageData = allJournalImages[selectedSymbol] || {};
                snapshotImagesContainer.innerHTML = '';
                const timeframesOrder = ['15min', '30min', '1hour', '2hour', '4hour', 'daily', 'weekly', 'monthly'];
                timeframesOrder.forEach(tf => {
                    const imagesForTimeframe = symbolImageData[tf];
                    if (!imagesForTimeframe || Object.keys(imagesForTimeframe).length === 0) return;
                    const latestImage = Object.values(imagesForTimeframe).sort((a, b) => b.timestamp - a.timestamp)[0];
                    if (latestImage) {
                        const itemContainer = document.createElement('div');
                        itemContainer.className = 'snapshot-image-item';
                        const heading = document.createElement('h4');
                        heading.textContent = tf.replace('min', 'm').replace('hour', 'H');
                        const wrapper = document.createElement('div');
                        wrapper.className = 'journal-image-wrapper';
                        wrapper.innerHTML = `<img src="${latestImage.url}" alt="Latest image for ${tf}">`;
                        itemContainer.appendChild(heading);
                        itemContainer.appendChild(wrapper);
                        snapshotImagesContainer.appendChild(itemContainer);
                    }
                });
            }

            function renderSrLevels() {
                const selectedSymbol = getSafeSymbol(srSymbolEl.value);
                const selectedLookback = srLookbackEl.value;
                const symbolSrData = (allSrData.data || {})[selectedSymbol] || {};
                const lookbackData = symbolSrData[selectedLookback] || {};
                const analysisParams = lookbackData.analysis_params || {};
                const lastUpdated = allSrData.last_updated ? new Date(allSrData.last_updated).toLocaleString() : '--';
                
                document.getElementById('sr-last-updated-time').textContent = lastUpdated;
                document.getElementById('sr-metadata-timeframes').textContent = (analysisParams.timeframes_analyzed || []).join(', ') || '--';
                document.getElementById('sr-metadata-windows').textContent = (analysisParams.pivot_windows || []).join(', ') || '--';
                document.getElementById('sr-metadata-dates').textContent = (analysisParams.oldest_pivot_date && analysisParams.newest_pivot_date) ? `${analysisParams.oldest_pivot_date} to ${analysisParams.newest_pivot_date}` : '--';

                const supportContainer = document.getElementById('support-levels-container');
                const resistanceContainer = document.getElementById('resistance-levels-container');
                supportContainer.innerHTML = '';
                resistanceContainer.innerHTML = '';

                const buildLevelCard = (level) => {
                    const priceStart = level['Price Start'].toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    const priceEnd = level['Price End'].toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    return `<div class="sr-level-card"><div class="sr-level-header"><span class="sr-level-price-range">$${priceStart} - $${priceEnd}</span><span class="sr-level-strength">Score: ${level['Strength Score']}</span></div><div class="sr-level-pivots">Based on <span>${level['Pivot Count']}</span> pivots.</div></div>`;
                };

                (lookbackData.support || []).forEach(level => { supportContainer.innerHTML += buildLevelCard(level); });
                (lookbackData.resistance || []).forEach(level => { resistanceContainer.innerHTML += buildLevelCard(level); });
            }

            function renderJournalImages(symbol, timeframe, imagesForSymbol) {
                journalImagesContainer.innerHTML = '';
                const imagesForTimeframe = imagesForSymbol[timeframe] || {};
                const imageKeys = Object.keys(imagesForTimeframe);
                if (imageKeys.length === 0) return;
                imageKeys.sort((a, b) => imagesForTimeframe[b].timestamp - imagesForTimeframe[a].timestamp)
                    .forEach(id => {
                        const imgData = imagesForTimeframe[id];
                        if (!imgData || !imgData.url || !imgData.fileName) return;
                        const wrapper = document.createElement('div');
                        wrapper.className = 'journal-image-wrapper';
                        const deleteButton = (isMasterUser && masterPassword) ? `<button class="delete-journal-image" title="Delete Image" data-safe-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${imgData.fileName}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : '';
                        wrapper.innerHTML = `${deleteButton}<img src="${imgData.url}" alt="Journal Image for ${imgData.fileName}">`;
                        journalImagesContainer.appendChild(wrapper);
                    });
            }
            
            function renderEmaData() {
                const selectedSymbol = getSafeSymbol(journalSymbolEl.value);
                const symbolEmaData = (allEmaData.data || {})[selectedSymbol] || {};
                const lastUpdated = allEmaData.last_updated ? new Date(allEmaData.last_updated).toLocaleString() : '--';
                document.getElementById('ema-last-updated-time').textContent = lastUpdated;
                const priceDisplay = document.getElementById('ema-current-price');
                const dataFor15m = symbolEmaData['15min'];
                if (dataFor15m && dataFor15m.price !== undefined) {
                    priceDisplay.textContent = `$${dataFor15m.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                } else { priceDisplay.textContent = '...'; }
                const emaTbody = document.getElementById('ema-tbody');
                emaTbody.innerHTML = '';
                const timeframesToDisplay = ['15min', '30min', '1hour', '2hour', '4hour', 'daily'];
                const periodsToDisplay = [13, 49, 100, 200, 500, 1000];
                const tfShortNames = {'15min': '15m','30min': '30m','1hour': '1H','2hour': '2H','4hour': '4H','daily': '1D'};
                timeframesToDisplay.forEach(tf => {
                    const tfData = symbolEmaData[tf];
                    const row = emaTbody.insertRow();
                    const tfCell = row.insertCell();
                    tfCell.textContent = tfShortNames[tf] || tf;
                    periodsToDisplay.forEach(period => {
                        const emaCell = row.insertCell();
                        const smaCell = row.insertCell();
                        if (tfData) {
                            emaCell.textContent = tfData[`EMA_${period}`] !== undefined ? Math.round(tfData[`EMA_${period}`]).toLocaleString() : '...';
                            smaCell.textContent = tfData[`SMA_${period}`] !== undefined ? Math.round(tfData[`SMA_${period}`]).toLocaleString() : '...';
                        } else { emaCell.textContent = '...'; smaCell.textContent = '...'; }
                    });
                });
            }

            function checkMasterMode() { 
                const urlParams = new URLSearchParams(window.location.search); 
                if (urlParams.get('master') === 'true') { 
                    const password = prompt("Please enter master password:"); 
                    if (password) { 
                        isMasterUser = true; masterPassword = password; 
                        document.querySelectorAll('.master-only').forEach(el => { 
                            if (el.id === 'add-trade-form') el.style.display = 'grid'; 
                            else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell'; 
                            else if (el.classList.contains('backup-controls')) el.style.display = 'flex'; 
                            else el.style.display = 'block'; 
                        }); 
                        journalEntryEl.readOnly = false; 
                    } 
                } 
                if (!isMasterUser) { journalEntryEl.readOnly = true; } 
            }
            checkMasterMode();

            function handleFileUpload(file) {
                if (!isMasterUser || !masterPassword || !file || !file.type.startsWith('image/')) return;
                const uploadProgressEl = document.getElementById('upload-progress');
                uploadProgressEl.style.display = 'block';
                const safeSymbol = getSafeSymbol(journalSymbolEl.value);
                const timeframe = journalTimeframeEl.value;
                const fileName = `${Date.now()}_${file.name}`;
                const storagePath = `journal_images/${safeSymbol}/${timeframe}/${fileName}`;
                const fileRef = storage.ref(storagePath);
                const metadata = { customMetadata: { 'password': masterPassword } };
                const uploadTask = fileRef.put(file, metadata);
                uploadTask.on('state_changed', (s) => { uploadProgressEl.textContent = `Uploading... ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; },
                (storageError) => { console.error("STORAGE UPLOAD FAILED:", storageError); uploadProgressEl.textContent = `Upload Failed: ${storageError.code}`; },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const imageDataForFirebase = { url: downloadURL, fileName: fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                        const newRef = journalImagesRef.child(safeSymbol).child(timeframe).push(imageDataForFirebase);
                        newRef.then(() => { 
                            uploadProgressEl.textContent = 'Upload Complete!'; 
                            setTimeout(() => { uploadProgressEl.style.display = 'none'; }, 2000); 
                            const imageDataForLocalCache = { url: downloadURL, fileName: fileName, timestamp: Date.now() };
                            if (!allJournalImages[safeSymbol]) allJournalImages[safeSymbol] = {};
                            if (!allJournalImages[safeSymbol][timeframe]) allJournalImages[safeSymbol][timeframe] = {};
                            allJournalImages[safeSymbol][timeframe][newRef.key] = imageDataForLocalCache;
                            updateJournalView();
                        }).catch((dbError) => { console.error("DATABASE SAVE FAILED:", dbError); uploadProgressEl.textContent = 'DB save failed: ' + dbError.message; fileRef.delete(); });
                    });
                });
            }
            
            journalImagesContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.delete-journal-image');
                if (!isMasterUser || !masterPassword || !button) return;
                const { safeSymbol, timeframe, id, filename } = button.dataset;
                if (confirm(`Are you sure you want to delete this image?\n\n${filename}`)) {
                    const storagePath = `journal_images/${safeSymbol}/${timeframe}/${filename}`;
                    const dbPath = `journal_images/${safeSymbol}/${timeframe}/${id}`;
                    storage.ref(storagePath).delete().then(() => { database.ref(dbPath).remove(); })
                        .catch((err) => {
                            if (err.code === 'storage/object-not-found') { database.ref(dbPath).remove(); }
                        });
                }
            });

            const saveJournalEntry = (() => { let t; return () => { clearTimeout(t); t = setTimeout(() => { if (!isMasterUser || !masterPassword) return; const safeSymbol = getSafeSymbol(journalSymbolEl.value); const timeframe = journalTimeframeEl.value; document.getElementById('save-status').textContent = 'Saving...'; journalRef.child(safeSymbol).child(timeframe).set(journalEntryEl.value).then(() => { document.getElementById('save-status').textContent = 'Saved.'; setTimeout(() => document.getElementById('save-status').textContent = '', 2000); }).catch(e => document.getElementById('save-status').textContent = `Error: ${e.message}`); }, 750); }; })();
            journalEntryEl.addEventListener('input', () => autoResizeTextarea(journalEntryEl));
            journalEntryEl.addEventListener('input', saveJournalEntry);
            tradesTbody.addEventListener('click', e => { if (!isMasterUser || !masterPassword) return; const button = e.target.closest('button'); if (!button) return; const { id } = button.dataset; if (button.classList.contains('delete-btn')) { if (confirm('Delete live trade?')) tradesRef.child(id).remove(); } else if (button.classList.contains('win-btn')) { completeTrade(id, 'win'); } else if (button.classList.contains('loss-btn')) { completeTrade(id, 'loss'); } });
            completedTradesTbody.addEventListener('click', e => { if (!isMasterUser || !masterPassword) return; const button = e.target.closest('.delete-btn-completed'); if (button && confirm('Delete completed trade?')) { completedTradesRef.child(button.dataset.id).remove(); } });
            
            snapshotSymbolEl.addEventListener('change', renderSnapshotView);
            srSymbolEl.addEventListener('change', renderSrLevels);
            srLookbackEl.addEventListener('change', renderSrLevels);
            journalSymbolEl.addEventListener('change', updateJournalView);
            journalTimeframeEl.addEventListener('change', updateJournalView);
            document.getElementById('journal-image-upload').addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
            
            document.querySelector('.tabs').addEventListener('click', (e) => { 
                if (!e.target.matches('.tab-link')) return;
                document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); 
                e.target.classList.add('active'); 
                const activeTabId = e.target.dataset.tab + '-tab';
                document.getElementById(activeTabId).classList.add('active'); 
                if (e.target.dataset.tab === 'journal') { updateJournalView(); } 
                else if (e.target.dataset.tab === 'snapshot') { renderSnapshotView(); }
                else if (e.target.dataset.tab === 'sr-levels') { renderSrLevels(); }
            });
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => journalTab.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
            ['dragenter', 'dragover'].forEach(eventName => journalTab.addEventListener(eventName, () => { if (isMasterUser) journalTab.classList.add('drag-over'); }));
            journalTab.addEventListener('dragleave', () => journalTab.classList.remove('drag-over'));
            journalTab.addEventListener('drop', (e) => {
                journalTab.classList.remove('drag-over');
                if (isMasterUser && e.dataTransfer && e.dataTransfer.files.length > 0) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            statsFab.addEventListener('click', () => statsPanel.classList.toggle('active'));
            closeStatsBtn.addEventListener('click', () => statsPanel.classList.remove('active'));
            document.addEventListener('click', (e) => {
                if (!statsPanel.contains(e.target) && !statsFab.contains(e.target) && statsPanel.classList.contains('active')) {
                    statsPanel.classList.remove('active');
                }
            });

            function calculateNetResult(trade, exitPrice) { const entry=parseFloat(trade.entry),posValue=parseFloat(trade.size),exit=parseFloat(exitPrice);if(isNaN(entry)||isNaN(posValue)||isNaN(exit))return{net_result:0,entry_fee:0,exit_fee:0};const entryFee=posValue*FEE_RATE,exitPosValue=(exit/entry)*posValue,exitFee=exitPosValue*FEE_RATE;const grossResult=trade.type==="Long"?(exit-entry)*(posValue/entry):(entry-exit)*(posValue/entry);return{net_result:grossResult-entryFee-exitFee,entry_fee:entryFee,exit_fee:exitFee};}
            function completeTrade(tradeId,outcome){database.ref('trades/'+tradeId).once('value',s=>{const t=s.val();if(!t)return;const d=outcome==='win'?t.target:t.stoploss;const p=prompt(`Enter exact exit price:`,d);if(p===null)return;const e=parseFloat(p);if(isNaN(e))return alert("Invalid exit price.");const{net_result,entry_fee,exit_fee}=calculateNetResult(t,e);const c={...t,closed_date:new Date().toLocaleString(),exit_price:e,net_result,entry_fee,exit_fee};delete c.expected_profit;delete c.expected_loss;completedTradesRef.push(c).then(()=>tradesRef.child(tradeId).remove());});}
            function renderLiveTable(d){const t=document.getElementById('trades-tbody');t.innerHTML='';if(!d)return;Object.keys(d).sort((a,b)=>new Date(d[b].date)-new Date(d[a].date)).forEach(id=>{const a=d[id],r=document.createElement('tr');r.innerHTML=`<td>${a.symbol}</td><td>${a.type}</td><td>${parseFloat(a.entry).toFixed(2)}</td><td>${parseFloat(a.stoploss).toFixed(2)}</td><td>${parseFloat(a.target).toFixed(2)}</td><td>${parseFloat(a.size).toFixed(2)}</td><td style="color: #28a745;">${parseFloat(a.expected_profit).toFixed(2)}</td><td style="color: #dc3545;">${parseFloat(a.expected_loss).toFixed(2)}</td><td>${a.date}</td>${isMasterUser?`<td class="action-buttons"><button class="win-btn" data-id="${id}">Win</button><button class="loss-btn" data-id="${id}">Loss</button><button class="delete-btn" data-id="${id}">Delete</button></td>`:''}`;t.appendChild(r);});}
            function renderCompletedTable(d){const t=document.getElementById('completed-trades-tbody');t.innerHTML='';if(!d)return;Object.keys(d).sort((a,b)=>new Date(d[b].closed_date)-new Date(d[a].date)).forEach(id=>{const a=d[id],r=document.createElement('tr');const c=a.net_result>=0?'#28a745':'#dc3545',e=(a.entry_fee||0)+(a.exit_fee||0);r.innerHTML=`<td>${a.symbol}</td><td>${a.type}</td><td>${parseFloat(a.entry).toFixed(2)}</td><td>${parseFloat(a.exit_price).toFixed(2)}</td><td>${e.toFixed(2)}</td><td style="color:${c};font-weight:bold;">${parseFloat(a.net_result).toFixed(2)}</td><td>${a.date}</td><td>${a.closed_date}</td>${isMasterUser?`<td class="action-buttons"><button class="delete-btn-completed" data-id="${id}">Delete</button></td>`:''}`;t.appendChild(r);});}
            
            tradesRef.on('value',snapshot=>{
                const liveTrades = snapshot.val() || {};
                renderLiveTable(liveTrades);
                document.getElementById('stat-open-trades').textContent = Object.keys(liveTrades).length;
            });
            completedTradesRef.on('value',snapshot=>{
                const completedData = snapshot.val() || {};
                renderCompletedTable(completedData);
                const totalProfitLoss = Object.values(completedData).reduce((sum, trade) => sum + (trade.net_result || 0), 0);
                const newBalance = STARTING_BALANCE + totalProfitLoss;
                const plElement = document.getElementById('stat-total-pl');
                plElement.textContent = `${totalProfitLoss >= 0 ? '+' : ''}$${totalProfitLoss.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
                plElement.style.color = totalProfitLoss >= 0 ? '#28a745' : '#dc3545';
                const balanceElement = document.getElementById('stat-balance');
                balanceElement.textContent = `$${newBalance.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
                balanceElement.style.color = newBalance >= STARTING_BALANCE ? '#28a745' : '#dc3545';
                document.getElementById('stat-completed-trades').textContent = Object.keys(completedData).length;
                bankRef.set({ currentBalance: newBalance });
            });
            
            emaValuesRef.on('value', (s) => { if (s.exists()) { allEmaData = s.val(); updateJournalView(); } });
            journalRef.on('value', (s) => { allJournalText = s.val() || {}; updateJournalView(); });
            journalImagesRef.on('value', (s) => {
                allJournalImages = s.val() || {};
                updateJournalView();
                if (document.getElementById('snapshot-tab').classList.contains('active')) {
                    renderSnapshotView();
                }
            });
            srLevelsRef.on('value', (s) => {
                if(s.exists()){
                    allSrData = s.val();
                    if(document.getElementById('sr-levels-tab').classList.contains('active')){
                        renderSrLevels();
                    }
                }
            });
        });
    </script>
</body>
</html>
