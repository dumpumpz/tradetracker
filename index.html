<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<style>
    :root {
        --bg-color: #f4f7f6; --container-bg: #fff; --text-color: #333; --border-color: #ddd;
        --header-bg: #e9ecef; --link-color: #007bff; --subtle-text: #666; --card-bg: #fafafa;
        --shadow-color: rgba(0,0,0,0.1); --green-bg: #d4edda; --red-bg: #f8d7da; --purple-bg: #e2d9f3;
        --green-text: #155724; --red-text: #721c24;
    }
    [data-theme="dark"] {
        --bg-color: #121212; --container-bg: #1e1e1e; --text-color: #e0e0e0; --border-color: #444;
        --header-bg: #2c2c2c; --link-color: #58a6ff; --subtle-text: #888; --card-bg: #2a2a2a;
        --shadow-color: rgba(0,0,0,0.4); --green-bg: #1c3b23; --red-bg: #4d1f24; --purple-bg: #3c2a4d;
        --green-text: #a7d7b2; --red-text: #f5b7bd;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
    .container { max-width: 1400px; margin: auto; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); }
    
    /* Layouts */
    h1, h2, h3 { color: var(--text-color); text-align: center; }
    .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
    .tab-link { padding: 10px 20px; cursor: pointer; border: none; background: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; }
    .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .collapsible-section { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; background-color: var(--card-bg); overflow: hidden; }
    .collapsible-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; cursor: pointer; background-color: var(--header-bg); }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .collapsible-content-inner { padding: 15px; }
    .collapsible-section.is-open .collapsible-content { max-height: none; } /* JS toggles this */

    /* Tables */
    .table-wrapper { width: 100%; overflow-x: auto; padding-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 13px; white-space: nowrap; vertical-align: middle; }
    th { background-color: var(--header-bg); font-weight: bold; text-align: center; }

    /* --- PARENT / CHILD ROW STYLING --- */
    tr.parent-row { background-color: var(--header-bg); border-top: 2px solid var(--border-color); }
    tr.parent-row td { font-weight: bold; border-bottom: 1px dashed var(--border-color); }
    tr.child-row td { background-color: var(--bg-color); border-top: none; }
    .child-indicator { padding-left: 20px; color: var(--subtle-text); font-style: italic; display: flex; align-items: center; font-size: 11px; }
    .child-indicator::before { content: "â†³"; margin-right: 5px; font-size: 14px; }
    
    /* Forms & Inputs */
    #add-trade-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end; }
    input, select, button, textarea { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; background-color: var(--container-bg); color: var(--text-color); width: 100%; box-sizing: border-box; }
    button { cursor: pointer; background-color: var(--link-color); color: white; border: none; margin-top: 5px; }
    button:hover { opacity: 0.9; }
    .master-only { display: none; }
    .action-buttons button { padding: 4px 8px; font-size: 11px; margin-right: 4px; border-radius: 3px; width: auto; display: inline-block; }
    
    /* Utility Colors for Buttons */
    .btn-green { background-color: #28a745 !important; }
    .btn-red { background-color: #dc3545 !important; }
    .btn-purple { background-color: #6f42c1 !important; }

    /* Summary Cards */
    .summary-split-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
    .summary-card { flex: 1; min-width: 250px; border: 1px solid var(--border-color); padding: 10px; border-radius: 6px; background: var(--bg-color); }
    .summary-card.long { border-top: 3px solid #28a745; background: rgba(40,167,69,0.05); }
    .summary-card.short { border-top: 3px solid #dc3545; background: rgba(220,53,69,0.05); }
    .sum-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .sum-val { font-weight: bold; font-family: monospace; }

    /* Scrollbar */
    .table-wrapper::-webkit-scrollbar { height: 12px; }
    .table-wrapper::-webkit-scrollbar-track { background: #333; }
    .table-wrapper::-webkit-scrollbar-thumb { background: #888; border-radius: 6px; border: 2px solid #333; }

    /* Stats Panel */
    #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
    #stats-fab { width: 50px; height: 50px; border-radius: 50%; background: var(--link-color); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    #stats-panel { position: absolute; bottom: 70px; left: 0; width: 250px; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none; }
    #stats-panel.active { display: block; }

    /* Journal & Images */
    .journal-image-wrapper { max-width: 200px; display: inline-block; margin: 5px; position: relative; border: 1px solid var(--border-color); }
    .journal-image-wrapper img { width: 100%; display: block; }
    .delete-journal-image { position: absolute; top: 0; right: 0; background: red; color: white; padding: 2px 6px; cursor: pointer; }
    
    /* Theme Switch */
    .theme-switch-wrapper { position: absolute; top: 15px; right: 20px; }
    .theme-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--link-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Calculator Styles */
    .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
</style>
<body>
    <div class="container">
        <div class="theme-switch-wrapper">
            <label class="theme-switch">
                <input type="checkbox" id="theme-checkbox">
                <span class="slider round"></span>
            </label>
        </div>

        <h1>Trading Journal</h1>

        <!-- STATS FAB -->
        <div id="stats-panel-container">
            <div id="stats-panel">
                <h3>Stats</h3>
                <div class="sum-row"><span>Balance:</span><span id="stat-balance" class="sum-val">$0.00</span></div>
                <div class="sum-row"><span>Wins:</span><span id="stat-wins" class="sum-val" style="color:green">0</span></div>
                <div class="sum-row"><span>Losses:</span><span id="stat-losses" class="sum-val" style="color:red">0</span></div>
                <div class="sum-row"><span>Win Rate:</span><span id="stat-wr" class="sum-val">0%</span></div>
                <div class="sum-row"><span>PF:</span><span id="stat-pf" class="sum-val">0.00</span></div>
            </div>
            <button id="stats-fab">ðŸ“Š</button>
        </div>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal</button>
            <button class="tab-link" data-tab="notes">Notes</button>
            <button class="tab-link" data-tab="calc">Calculators</button>
        </div>

        <!-- TRACKER TAB -->
        <div id="tracker-tab" class="tab-content active">

            <!-- ADD TRADE -->
            <div class="collapsible-section master-only is-open">
                <div class="collapsible-header"><h2>Add New Trade Idea</h2><button class="collapsible-toggle-btn">-</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <form id="add-trade-form">
                            <div><label>Setup:</label><select id="trade-setup-type"><option value="Major">Major Swing</option><option value="Scalp">Scalp</option><option value="Intraday">Intraday</option></select></div>
                            <div><label>Symbol:</label><input type="text" id="trade-symbol" placeholder="BTC/USDT" required></div>
                            <div><label>Exchange:</label><select id="trade-exchange"><option value="binance">Binance</option><option value="hyperliquid">Hyperliquid</option></select></div>
                            <div><label>Direction:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                            <div><label>Entry ($):</label><input type="number" id="entry-price" step="any" required></div>
                            <div><label>Stop ($):</label><input type="number" id="stop-loss" step="any" required></div>
                            <div><label>Target ($):</label><input type="number" id="target" step="any" required></div>
                            <div><label>Size ($):</label><input type="number" id="position-value" step="any" required></div>
                            <div><label>Fee:</label><select id="entry-fee-type"><option value="taker">Taker</option><option value="maker">Maker</option></select></div>
                            <div><label>Status:</label><select id="trade-status"><option value="live">Live</option><option value="resting">Resting</option></select></div>
                            <button type="submit" class="btn-green">Add Trade</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- RESTING ORDERS -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Resting Orders</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper">
                            <table>
                                <thead><tr><th>Symbol</th><th>Type</th><th>Entry</th><th>Stop</th><th>Target</th><th>Size</th><th>Notes</th><th class="master-only">Actions</th></tr></thead>
                                <tbody id="resting-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LIVE TRADES -->
            <div class="collapsible-section is-open">
                <div class="collapsible-header"><h2>Live Trades (Idea Groups)</h2><button class="collapsible-toggle-btn">-</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="live-summary-container" class="summary-split-container"></div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Idea / Symbol</th>
                                        <th>Type</th>
                                        <th>Avg/Entry</th>
                                        <th>Stop</th>
                                        <th>Target</th>
                                        <th>Total Size ($)</th>
                                        <th>Breakeven</th>
                                        <th>PnL (Est)</th>
                                        <th>Notes</th>
                                        <th class="master-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="live-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPLETED TRADES -->
            <div class="collapsible-section">
                <div class="collapsible-header"><h2>Completed Ideas</h2><button class="collapsible-toggle-btn">+</button></div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Idea / Symbol</th>
                                        <th>Type</th>
                                        <th>Avg Entry</th>
                                        <th>Avg Exit</th>
                                        <th>Total Size</th>
                                        <th>Net Result ($)</th>
                                        <th>Opened</th>
                                        <th>Closed</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="completed-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JOURNAL TAB -->
        <div id="journal-tab" class="tab-content">
            <div class="collapsible-section is-open">
                <div class="collapsible-content-inner">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="date" id="journal-date">
                        <select id="journal-timeframe"><option value="Daily">Daily</option><option value="4H">4H</option></select>
                        <input type="text" id="journal-symbol" placeholder="BTC/USDT">
                    </div>
                    <textarea id="journal-entry" rows="10" placeholder="Write your journal here..."></textarea>
                    <div class="master-only" style="margin-top:10px;">
                        <input type="file" id="journal-image-upload" accept="image/*">
                    </div>
                    <div id="journal-images-container" style="margin-top:20px;"></div>
                </div>
            </div>
        </div>

        <!-- NOTES TAB -->
        <div id="notes-tab" class="tab-content">
            <div class="collapsible-section is-open">
                <div class="collapsible-header"><h2>General Notes</h2></div>
                <div class="collapsible-content-inner">
                    <div id="notes-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:10px;"></div>
                    <button id="add-note-btn" class="master-only" style="margin-top:10px;">+ New Note</button>
                </div>
            </div>
        </div>

        <!-- CALCULATOR TAB -->
        <div id="calc-tab" class="tab-content">
            <div class="collapsible-section is-open">
                <div class="collapsible-header"><h2>Fib / Risk Calculator</h2></div>
                <div class="collapsible-content-inner calc-grid">
                    <div>
                        <label>Swing High</label><input type="number" id="calc-high">
                        <label>Swing Low</label><input type="number" id="calc-low">
                        <label>Risk ($)</label><input type="number" id="calc-risk" value="100">
                        <label>Stop ($)</label><input type="number" id="calc-stop">
                        <button id="btn-calc-fib">Calculate</button>
                    </div>
                    <div id="calc-results"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const CONFIG = {
            FIREBASE: {
                apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                authDomain: "journal-a003f.firebaseapp.com",
                databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "journal-a003f",
                storageBucket: "journal-a003f.firebasestorage.app",
                appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
            }
        };
        firebase.initializeApp(CONFIG.FIREBASE);
        const db = firebase.database();
        const storage = firebase.storage();
        const refs = {
            trades: db.ref('trades'),
            completed: db.ref('completed_trades'),
            resting: db.ref('resting_orders'),
            journal: db.ref('journal_text'),
            images: db.ref('journal_images'),
            notes: db.ref('general_notes'),
            bank: db.ref('bank')
        };

        let STATE = { isMasterUser: false, selectedDate: new Date().toISOString().split('T')[0] };

        // --- MASTER MODE CHECK ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('master') === 'true') {
            const p = prompt("Password:");
            if(p) { // In real app, check password hash
                STATE.isMasterUser = true;
                document.querySelectorAll('.master-only').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.master-only').forEach(el => {
                    if(el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                });
            }
        }

        // --- HELPER FUNCTIONS ---
        const getFeeRate = (ex, type) => {
            const isHyp = (ex || '').toLowerCase() === 'hyperliquid';
            if (isHyp) return type === 'maker' ? 0.00015 : 0.00045;
            return type === 'maker' ? 0.0000 : 0.00075;
        };

        const formatMoney = (n) => `$${parseFloat(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;

        // --- 1. ADD NEW TRADE (Creates Parent Idea) ---
        document.getElementById('add-trade-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(!STATE.isMasterUser) return;
            
            const parentId = `idea_${Date.now()}`;
            const trade = {
                parentId: parentId,
                symbol: document.getElementById('trade-symbol').value.toUpperCase(),
                exchange: document.getElementById('trade-exchange').value,
                type: document.getElementById('trade-type').value,
                setupType: document.getElementById('trade-setup-type').value,
                entry: parseFloat(document.getElementById('entry-price').value),
                stoploss: parseFloat(document.getElementById('stop-loss').value),
                target: parseFloat(document.getElementById('target').value),
                size: parseFloat(document.getElementById('position-value').value),
                entryFeeType: document.getElementById('entry-fee-type').value,
                date: firebase.database.ServerValue.TIMESTAMP,
                note: "Initial Entry"
            };

            const status = document.getElementById('trade-status').value;
            const ref = status === 'resting' ? refs.resting : refs.trades;
            ref.push(trade).then(() => { e.target.reset(); alert("Trade Added!"); });
        });

        // --- 2. ADD SIBLING / CHILD TRADE ---
        window.handleAddSibling = (parentId, symbol, type, exchange) => {
            if(!STATE.isMasterUser) return;
            const price = prompt(`Add to ${symbol} (${type})\nPrice:`);
            if(!price) return;
            const size = prompt("Size ($):");
            if(!size) return;

            const trade = {
                parentId: parentId,
                symbol: symbol,
                type: type,
                exchange: exchange,
                setupType: "Add-on",
                entry: parseFloat(price),
                size: parseFloat(size),
                stoploss: 0, // Inherits mentally from parent
                target: 0,
                entryFeeType: 'taker',
                date: firebase.database.ServerValue.TIMESTAMP,
                note: "Add-on execution"
            };
            refs.trades.push(trade);
        };

        // --- 3. CLOSE LOGIC ---
        // Close specific execution
        window.handleCloseSingle = (id) => {
            if(!STATE.isMasterUser) return;
            const exit = prompt("Exit Price:");
            if(!exit) return;
            
            refs.trades.child(id).once('value', s => {
                const t = s.val();
                const exitP = parseFloat(exit);
                const qty = t.size / t.entry;
                const fees = (t.size * getFeeRate(t.exchange, t.entryFeeType)) + ((qty*exitP) * getFeeRate(t.exchange, 'taker'));
                
                const gross = t.type==='Long' ? (exitP - t.entry)*qty : (t.entry - exitP)*qty;
                const net = gross - fees;

                const completed = {
                    ...t,
                    exit_price: exitP,
                    net_result: net,
                    closed_date: firebase.database.ServerValue.TIMESTAMP,
                    note: (t.note||'') + " [Single Close]"
                };
                
                const updates = {};
                updates[`/trades/${id}`] = null;
                updates[`/completed_trades/${id}`] = completed;
                db.ref().update(updates);
            });
        };

        // Close Entire Idea
        window.handleCloseIdea = (parentId) => {
            if(!STATE.isMasterUser) return;
            const exit = prompt("Exit Price for ALL positions:");
            if(!exit) return;
            const exitP = parseFloat(exit);

            refs.trades.orderByChild('parentId').equalTo(parentId).once('value', s => {
                const trades = s.val();
                if(!trades) return;
                const updates = {};

                Object.keys(trades).forEach(key => {
                    const t = trades[key];
                    const qty = t.size / t.entry;
                    const fees = (t.size * getFeeRate(t.exchange, t.entryFeeType)) + ((qty*exitP) * getFeeRate(t.exchange, 'taker'));
                    const gross = t.type==='Long' ? (exitP - t.entry)*qty : (t.entry - exitP)*qty;
                    const net = gross - fees;

                    const completed = {
                        ...t,
                        exit_price: exitP,
                        net_result: net,
                        closed_date: firebase.database.ServerValue.TIMESTAMP,
                        note: (t.note||'') + " [Idea Close]"
                    };
                    updates[`/trades/${key}`] = null;
                    updates[`/completed_trades/${key}`] = completed;
                });
                db.ref().update(updates).then(() => alert("Idea Closed"));
            });
        };

        // --- 4. RENDERING LIVE TRADES ---
        const renderLive = (data) => {
            const tbody = document.getElementById('live-tbody');
            const summaryDiv = document.getElementById('live-summary-container');
            tbody.innerHTML = '';
            summaryDiv.innerHTML = '';

            const groups = {};
            Object.keys(data).forEach(key => {
                const t = data[key];
                const pid = t.parentId || `legacy_${key}`;
                if(!groups[pid]) groups[pid] = { trades: [] };
                groups[pid].trades.push({...t, id:key});
            });

            const summaryGroups = { Long: {size:0, count:0}, Short: {size:0, count:0} };

            Object.keys(groups).forEach(pid => {
                const group = groups[pid];
                const first = group.trades[0];
                let totalSize = 0, totalQty = 0;

                group.trades.forEach(t => {
                    totalSize += t.size;
                    totalQty += (t.size/t.entry);
                });
                const avgEntry = totalSize / totalQty;
                
                // Update Summary Cards Data
                if(summaryGroups[first.type]) {
                    summaryGroups[first.type].size += totalSize;
                    summaryGroups[first.type].count++;
                }

                // PARENT ROW
                const pRow = document.createElement('tr');
                pRow.className = 'parent-row';
                
                const masterBtns = STATE.isMasterUser ? `
                    <button class="btn-purple" onclick="handleAddSibling('${pid}','${first.symbol}','${first.type}','${first.exchange}')" title="Add">Add</button>
                    <button class="btn-green" onclick="handleCloseIdea('${pid}')">Close Idea</button>
                ` : '';

                // Calc Breakeven (approx taker fees)
                const beFee = 0.00075 * 2; 
                const be = first.type === 'Long' ? avgEntry * (1+beFee) : avgEntry * (1-beFee);

                pRow.innerHTML = `
                    <td>${first.symbol} <span style="font-size:10px; color:#666">(${group.trades.length})</span></td>
                    <td style="color:${first.type==='Long'?'green':'red'}; font-weight:bold">${first.type}</td>
                    <td style="font-weight:bold">${avgEntry.toFixed(4)}</td>
                    <td>${first.stoploss || '-'}</td>
                    <td>${first.target || '-'}</td>
                    <td>${formatMoney(totalSize)}</td>
                    <td style="color:#888">${be.toFixed(4)}</td>
                    <td>--</td>
                    <td style="font-style:italic">Parent Idea</td>
                    <td class="master-only action-buttons">${masterBtns}</td>
                `;
                tbody.appendChild(pRow);

                // CHILD ROWS
                group.trades.forEach(t => {
                    const cRow = document.createElement('tr');
                    cRow.className = 'child-row';
                    const childBtns = STATE.isMasterUser ? `<button class="btn-red" onclick="handleCloseSingle('${t.id}')">Close</button>` : '';
                    cRow.innerHTML = `
                        <td><div class="child-indicator">Execution</div></td>
                        <td style="font-size:11px">${t.type}</td>
                        <td>${t.entry.toFixed(4)}</td>
                        <td style="color:#aaa">${t.stoploss}</td>
                        <td style="color:#aaa">${t.target}</td>
                        <td>${formatMoney(t.size)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="note-cell">${t.note||''}</td>
                        <td class="master-only action-buttons">${childBtns}</td>
                    `;
                    tbody.appendChild(cRow);
                });
            });

            // Render Summaries
            ['Long', 'Short'].forEach(type => {
                if(summaryGroups[type].count > 0) {
                    const card = document.createElement('div');
                    card.className = `summary-card ${type.toLowerCase()}`;
                    card.innerHTML = `
                        <h4>${type}s (${summaryGroups[type].count})</h4>
                        <div class="sum-row"><span>Total Size:</span><span class="sum-val">${formatMoney(summaryGroups[type].size)}</span></div>
                    `;
                    summaryDiv.appendChild(card);
                }
            });
        };

        // --- 5. RENDER COMPLETED TRADES ---
        const renderCompleted = (data) => {
            const tbody = document.getElementById('completed-tbody');
            tbody.innerHTML = '';
            
            const groups = {};
            let totalWins = 0, totalLosses = 0, totalPnL = 0;

            Object.keys(data).forEach(key => {
                const t = data[key];
                const pid = t.parentId || `legacy_${key}`;
                if(!groups[pid]) groups[pid] = { trades: [] };
                groups[pid].trades.push(t);
                
                // Stats Logic
                if(t.net_result > 0) totalWins++; else totalLosses++;
                totalPnL += (t.net_result || 0);
            });

            // Update Stats Panel
            document.getElementById('stat-wins').textContent = totalWins;
            document.getElementById('stat-losses').textContent = totalLosses;
            document.getElementById('stat-balance').textContent = formatMoney(5000 + totalPnL); // Assuming 5000 start
            const total = totalWins + totalLosses;
            document.getElementById('stat-wr').textContent = total > 0 ? ((totalWins/total)*100).toFixed(1)+'%' : '0%';

            // Sort Groups by Date
            const sortedPids = Object.keys(groups).sort((a,b) => {
                const lastA = groups[a].trades[groups[a].trades.length-1].closed_date;
                const lastB = groups[b].trades[groups[b].trades.length-1].closed_date;
                return lastB - lastA;
            });

            sortedPids.forEach(pid => {
                const group = groups[pid];
                const first = group.trades[0];
                let net = 0, size = 0;
                group.trades.forEach(t => { net += t.net_result; size += t.size; });

                // PARENT ROW
                const pRow = document.createElement('tr');
                pRow.className = 'parent-row';
                pRow.innerHTML = `
                    <td>${first.symbol}</td>
                    <td>${first.type}</td>
                    <td>Multiple</td>
                    <td>Multiple</td>
                    <td>${formatMoney(size)}</td>
                    <td style="font-weight:bold; color:${net>=0?'green':'red'}">${formatMoney(net)}</td>
                    <td>${new Date(first.date).toLocaleDateString()}</td>
                    <td>${new Date(first.closed_date).toLocaleDateString()}</td>
                    <td>Idea Result</td>
                `;
                tbody.appendChild(pRow);

                // CHILDREN
                group.trades.forEach(t => {
                    const cRow = document.createElement('tr');
                    cRow.className = 'child-row';
                    cRow.innerHTML = `
                        <td><div class="child-indicator">Execution</div></td>
                        <td>${t.type}</td>
                        <td>${t.entry.toFixed(4)}</td>
                        <td>${t.exit_price.toFixed(4)}</td>
                        <td>${formatMoney(t.size)}</td>
                        <td style="color:${t.net_result>=0?'green':'red'}">${formatMoney(t.net_result)}</td>
                        <td>${new Date(t.date).toLocaleTimeString()}</td>
                        <td>${new Date(t.closed_date).toLocaleTimeString()}</td>
                        <td class="note-cell">${t.note||''}</td>
                    `;
                    tbody.appendChild(cRow);
                });
            });
        };

        // --- 6. RENDER RESTING ---
        const renderResting = (data) => {
            const tbody = document.getElementById('resting-tbody');
            tbody.innerHTML = '';
            Object.keys(data).forEach(key => {
                const t = data[key];
                const tr = document.createElement('tr');
                const btns = STATE.isMasterUser ? `<button class="btn-red" onclick="firebase.database().ref('resting_orders/${key}').remove()">Del</button>` : '';
                tr.innerHTML = `<td>${t.symbol}</td><td style="color:${t.type==='Long'?'green':'red'}">${t.type}</td><td>${t.entry}</td><td>${t.stoploss}</td><td>${t.target}</td><td>${t.size}</td><td>${t.note||''}</td><td class="master-only">${btns}</td>`;
                tbody.appendChild(tr);
            });
        };

        // --- 7. CALCULATOR ---
        document.getElementById('btn-calc-fib').addEventListener('click', () => {
            const h = parseFloat(document.getElementById('calc-high').value);
            const l = parseFloat(document.getElementById('calc-low').value);
            const risk = parseFloat(document.getElementById('calc-risk').value);
            const stop = parseFloat(document.getElementById('calc-stop').value);
            const resDiv = document.getElementById('calc-results');
            
            if(!h || !l || !risk || !stop) return;
            
            const diff = Math.abs(h-l);
            const levels = [0.5, 0.618, 0.705];
            let html = '<h4>Results</h4><ul>';
            
            levels.forEach(lev => {
                // Assuming Long from low for simplicity, logic works both ways if explicit
                const entry = l + (diff * lev); 
                const stopDist = Math.abs(entry - stop);
                const posSize = (risk / stopDist) * entry;
                html += `<li>Fib ${lev}: Entry ${entry.toFixed(2)} | Size $${posSize.toFixed(2)}</li>`;
            });
            html += '</ul>';
            resDiv.innerHTML = html;
        });

        // --- 8. JOURNAL & NOTES LOGIC ---
        // Simple handlers for saving text areas on blur
        document.getElementById('journal-entry').addEventListener('blur', (e) => {
            if(!STATE.isMasterUser) return;
            const date = document.getElementById('journal-date').value || STATE.selectedDate;
            refs.journal.child(date).set(e.target.value);
        });

        document.getElementById('journal-date').addEventListener('change', (e) => {
            STATE.selectedDate = e.target.value;
            refs.journal.child(STATE.selectedDate).once('value', s => {
                document.getElementById('journal-entry').value = s.val() || '';
            });
        });

        document.getElementById('add-note-btn').addEventListener('click', () => {
            if(!STATE.isMasterUser) return;
            const title = prompt("Note Title:");
            if(title) refs.notes.push({title, text:""});
        });

        refs.notes.on('value', s => {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            const data = s.val() || {};
            Object.keys(data).forEach(key => {
                const n = data[key];
                const d = document.createElement('div');
                d.className = 'collapsible-section';
                d.style.padding = '10px';
                d.innerHTML = `<b>${n.title}</b><textarea onblur="if(STATE.isMasterUser) firebase.database().ref('general_notes/${key}/text').set(this.value)" style="width:100%">${n.text||''}</textarea>`;
                list.appendChild(d);
            });
        });

        // --- SUBSCRIPTIONS ---
        refs.trades.on('value', s => renderLive(s.val() || {}));
        refs.completed.on('value', s => renderCompleted(s.val() || {}));
        refs.resting.on('value', s => renderResting(s.val() || {}));

        // --- UI INTERACTION ---
        document.querySelector('.tabs').addEventListener('click', e => {
            if(!e.target.matches('.tab-link')) return;
            document.querySelectorAll('.tab-link').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(e.target.dataset.tab+'-tab').classList.add('active');
        });

        document.body.addEventListener('click', e => {
            if(e.target.closest('.collapsible-header')) {
                const s = e.target.closest('.collapsible-section');
                s.classList.toggle('is-open');
                const btn = s.querySelector('.collapsible-toggle-btn');
                if(btn) btn.textContent = s.classList.contains('is-open') ? '-' : '+';
            }
        });
        
        document.getElementById('stats-fab').addEventListener('click', () => {
            document.getElementById('stats-panel').classList.toggle('active');
        });
        
        document.getElementById('theme-checkbox').addEventListener('change', (e) => {
            document.documentElement.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
        });
    });
    </script>
</body>
</html>
