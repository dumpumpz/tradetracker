<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

</head>
<style>
    :root {
        --bg-color: #f4f7f6;
        --container-bg: #fff;
        --text-color: #333;
        --border-color: #ddd;
        --header-bg: #e9ecef;
        --link-color: #007bff;
        --subtle-text: #666;
        --card-bg: #fafafa;
        --shadow-color: rgba(0,0,0,0.1);
        --green-bg: #d4edda;
        --red-bg: #f8d7da;
        --purple-bg: #e2d9f3;
        --green-border: #c3e6cb;
        --red-border: #f5c6cb;
        --green-text: #155724;
        --red-text: #721c24;
        --green-bar: rgba(40, 167, 69, 0.2);
        --red-bar: rgba(220, 53, 69, 0.2);
        
        /* NEW VARS FOR GROUPING */
        --group-header-bg: #dfe4ea;
        --group-header-hover: #d1d8e0;
    }

    [data-theme="dark"] {
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --border-color: #444;
        --header-bg: #2c2c2c;
        --link-color: #58a6ff;
        --subtle-text: #888;
        --card-bg: #2a2a2a;
        --shadow-color: rgba(0,0,0,0.4);
        --green-bg: #1c3b23;
        --red-bg: #4d1f24;
        --purple-bg: #3c2a4d;
        --green-border: #285732;
        --red-border: #6b282e;
        --green-text: #a7d7b2;
        --red-text: #f5b7bd;
        --green-bar: rgba(40, 167, 69, 0.4);
        --red-bar: rgba(220, 53, 69, 0.4);
        
        /* NEW VARS FOR GROUPING */
        --group-header-bg: #2d3436;
        --group-header-hover: #353b48;
    }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        margin: 0; 
        padding: 10px; 
        background-color: var(--bg-color); 
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    .container { max-width: 1200px; margin: auto; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
    h1 { text-align: center; color: var(--text-color); margin-bottom: 5px; }
    h2 { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
    h3 { text-align: center; color: var(--text-color); margin-top: 30px; margin-bottom: -5px; font-weight: 500;}
    .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
    .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
    .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
    .backup-controls input[type="file"] { display: none; }
    p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: var(--subtle-text); }
    .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
    .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .master-only { display: none; }
    #add-trade-form { margin: 0 auto; padding: 0; border: none; border-radius: 0; background-color: transparent; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
    label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
    input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
    button:hover { opacity: 0.85; }
    .table-wrapper { 
        width: 100%;
        overflow-x: auto;   
        overflow-y: hidden; 
        padding-bottom: 5px; 
        margin-bottom: 10px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
    th { background-color: var(--header-bg); font-weight: bold; vertical-align: middle; text-align: center; }
    .action-buttons button { padding: 3px 4px; font-size: 10px; margin-right: 4px; }

    .note-cell { white-space: normal; max-width: 300px; min-width: 250px; font-size: 12px; line-height: 1.4; }

    /* --- NEW GROUPING STYLES --- */
    tr.group-row {
        background-color: var(--group-header-bg);
        border-top: 2px solid var(--border-color);
        font-weight: bold;
    }
    tr.group-row:hover {
        background-color: var(--group-header-hover);
    }
    tr.child-row {
        background-color: var(--container-bg);
    }
    tr.child-row td:first-child {
        border-left: 4px solid var(--link-color); /* Indication indent */
    }
    .group-name-cell {
        color: var(--link-color);
        font-weight: 800;
        font-size: 15px;
    }

    #journal-tab { position: relative; }
    .controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin: 20px auto; }
    .controls-container > div { display: flex; align-items: center; gap: 8px; }

    #journal-entry, #persistent-notes-entry, #tracker-scratchpad, .setups-notes-area {
        width: 100%; 
        resize: vertical;
        line-height: 1.6;
        margin-top: 5px;
        overflow-y: hidden; 
        min-height: 120px; 
    }
    #tracker-scratchpad, #persistent-notes-entry { margin: 0; }
    .setups-notes-area {
        margin-top: 15px;
        min-height: 80px;
    }

    #journal-entry:read-only, #persistent-notes-entry:read-only, #tracker-scratchpad:read-only, .setups-notes-area:read-only { 
        background-color: var(--card-bg); 
        cursor: not-allowed; 
    }

    #image-upload-section { margin-top: 20px; border-top: 1px dashed var(--border-color); padding-top: 20px; }
    .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
    #journal-image-upload, #library-image-upload { display: none; }
    #upload-progress { margin-top: 10px; font-style: italic; color: var(--link-color); }
    #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
    .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid var(--border-color); padding: 5px; background: var(--card-bg); border-radius: 4px; }
    .journal-image-wrapper img { max-width: 100%; height: auto; display: block; border-radius: 2px; cursor: pointer; }

    .delete-journal-image { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(220, 53, 69, 0.85); border: 1px solid rgba(255,255,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; opacity: 0.7; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .journal-image-wrapper:hover .delete-journal-image { opacity: 1; }
    .delete-journal-image svg { width: 16px; height: 16px; fill: white; }

    #journal-tab.drag-over { border: 3px dashed var(--link-color); background-color: rgba(0, 123, 255, 0.05); }
    #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: var(--link-color); z-index: 999; pointer-events: none; }

    #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
    #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
    #stats-fab:hover { opacity: 0.9; }
    #stats-fab svg { width: 28px; height: 28px; fill: white; }
    #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s; pointer-events: none; }
    #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
    .stats-header h3 { margin: 0; font-size: 18px; color: var(--text-color); }
    #close-stats-btn { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 5px; line-height: 1; margin: 0; }
    .stats-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
    .stat-label { font-size: 14px; color: var(--subtle-text); }
    .stat-value { font-size: 16px; font-weight: 600; color: var(--text-color); }
    #stat-balance-aud { font-size: 14px; color: var(--subtle-text); }

    .date-nav-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px auto 20px auto; }
    #date-buttons-container { display: flex; gap: 8px; }
    .date-nav-btn { padding: 8px 12px; font-size: 14px; background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--subtle-text); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; border-bottom: 3px solid transparent; }

    .date-nav-btn.active { background-color: var(--link-color); color: white; border-color: var(--link-color); font-weight: bold; }
    .date-nav-btn.has-entry { border-bottom: 3px solid var(--green-border); }
    .date-nav-arrow { background: none; border: none; font-size: 24px; font-weight: bold; color: var(--subtle-text); cursor: pointer; padding: 0 10px; }


    .ema-summary-container {
        font-size: 13px;
        padding: 8px 12px;
        margin: 0 auto 15px auto;
        max-width: 95%;
        border-radius: 6px;
        background-color: var(--bg-color);
    }
    .ema-level-summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .ema-summary-container h4 {
        font-size: 14px;
        text-align: center;
        margin-top: 5px;
        margin-bottom: 10px;
        color: var(--subtle-text);
    }
    .ema-level-summary {
        line-height: 1.5;
    }

    .ema-level-summary ul {
        margin: 5px 0 0 0;
        padding-left: 20px;
        list-style-type: disc;
    }
    .ema-level-summary li {
        margin-bottom: 4px;
        line-height: 1.4;
    }
    .ema-level-summary strong {
        font-weight: 600;
    }
    
    .sr-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0;
    }
    .sr-table th, .sr-table td {
        font-size: 13px;
        padding: 8px;
        text-align: right;
        border-bottom: 1px solid var(--border-color);
        border-left: none;
        border-right: none;
    }
    .sr-table th {
        text-align: center;
        font-weight: 500;
        color: var(--subtle-text);
        border-top: none;
    }
    .sr-table tr:last-child td {
        border-bottom: none;
    }
    .sr-table td:first-child, .sr-table th:first-child {
        text-align: center;
    }

    .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 20px; z-index: 10; }
    .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
    .theme-switch input { display: none; }
    .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
    .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
    input:checked + .slider { background-color: var(--link-color); }
    input:checked + .slider:before { transform: translateX(26px); }
    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }

    .journal-input-wrapper {
        position: relative;
    }
    #favourite-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        padding: 0;
        margin: 0;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: #ccc; 
        cursor: pointer;
        display: none; 
        transition: all 0.2s ease;
        z-index: 5;
    }
    #favourite-btn:hover {
        border-color: #ffc107;
        color: #ffc107;
    }
    #favourite-btn.active {
        color: #ffc107;
        border-color: #ffc107;
        box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
    }
    #favourited-entry-container {
        background-color: var(--purple-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .favourited-header {
        display: flex;
        align-items: center;
        font-weight: bold;
        color: var(--text-color);
        margin-bottom: 10px;
        font-size: 14px;
    }
    .favourited-header .star-icon {
        font-size: 18px;
        margin-right: 8px;
        color: #ffc107;
    }
    #favourited-entry-text {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-color);
    }

    .setups-table th:first-child { text-align: left; padding-left: 15px; color: var(--link-color); }
    .setups-table td { text-align: center; }
    .setups-table .editable-setup-cell[contenteditable="true"]:focus {
        background-color: var(--header-bg);
        outline: 2px solid var(--link-color);
        box-shadow: 0 0 5px var(--shadow-color);
    }

    .setups-table td.highlight-long {
        background-color: var(--green-bg);
        color: var(--green-text);
        font-weight: bold;
    }
    .setups-table td.highlight-short {
        background-color: var(--red-bg);
        color: var(--red-text);
        font-weight: bold;
    }

    .setups-table .percent-cell {
        font-size: 11px;
        color: var(--subtle-text);
        text-align: right;
        padding-right: 10px;
        font-style: italic;
    }

    .setups-table thead tr:first-child th:nth-child(n+2) {
        border-top: 2px solid yellow;
    }
    .setups-table tbody tr:last-child td:nth-child(n+1),
    .setups-table thead tr:last-child th:nth-child(n+1) {
        border-bottom: 2px solid yellow;
    }
    .setups-table thead tr:first-child th:nth-child(2), 
    .setups-table thead tr:last-child th:nth-child(1),
    .setups-table tbody td:nth-child(2),
    .setups-table thead tr:first-child th:nth-child(3),
    .setups-table thead tr:last-child th:nth-child(6),
    .setups-table tbody td:nth-child(7),
    .setups-table thead tr:first-child th:nth-child(4),
    .setups-table thead tr:last-child th:nth-child(11),
    .setups-table tbody td:nth-child(12) {
        border-left: 2px solid yellow;
    }
    .setups-table thead tr:first-child th:nth-child(2),
    .setups-table thead tr:last-child th:nth-child(5),
    .setups-table tbody td:nth-child(6),
    .setups-table thead tr:first-child th:nth-child(3),
    .setups-table thead tr:last-child th:nth-child(10),
    .setups-table tbody td:nth-child(11),
    .setups-table thead tr:first-child th:nth-child(4),
    .setups-table thead tr:last-child th:nth-child(15),
    .setups-table tbody td:nth-child(16) {
        border-right: 2px solid yellow;
    }

    .setups-container {
        margin-bottom: 30px; 
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 8px;
        background-color: var(--card-bg);
    }
    .setups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        cursor: pointer;
    }
    .setups-header h2 {
        margin: 0;
        font-size: 18px;
        padding: 0;
        border: none;
    }
    .setups-toggle-btn {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--subtle-text);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 20px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        padding: 0;
        font-weight: bold;
        margin: 0;
        transition: transform 0.3s ease, color 0.2s, border-color 0.2s;
    }
    .setups-header:hover .setups-toggle-btn {
        border-color: var(--link-color);
        color: var(--link-color);
    }
    .setups-controls {
        text-align: center;
        margin-top: 15px;
    }
    .setups-controls button {
        margin: 0 10px;
    }
    .setups-save-status {
        text-align:center;
        font-style:italic;
        color:var(--subtle-text);
        height:1em;
    }

    .editable-cell[contenteditable="true"]:focus {
        background-color: var(--header-bg);
        outline: 2px solid var(--link-color);
        box-shadow: 0 0 5px var(--shadow-color);
    }

    .toggle-history-btn {
        font-size: 12px;
        padding: 4px 10px;
        margin: 15px auto 0 auto;
        cursor: pointer;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--subtle-text);
        border-radius: 4px;
        display: none; 
    }
    .toggle-history-btn:hover {
        border-color: var(--link-color);
        color: var(--link-color);
    }
    .section-header h2 {
        margin-bottom: 0; 
    }

    .historical-entry {
        display: none;
    }
    .pagination-controls {
        text-align: center;
        margin-top: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }
    .pagination-btn {
        padding: 6px 12px;
        font-size: 14px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--subtle-text);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .pagination-btn:hover:not(:disabled) {
        border-color: var(--link-color);
        color: var(--link-color);
    }
    .pagination-btn:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    #sentiment-page-info, #completed-trades-page-info {
        font-size: 14px;
        color: var(--subtle-text);
    }


    #image-library-container, #setups-image-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 10px;
    }
    .library-image-wrapper {
        position: relative;
        border: 1px solid var(--border-color);
        padding: 5px;
        background: var(--container-bg);
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .library-image-wrapper img {
        width: 100%;
        object-fit: contain;
        aspect-ratio: 16 / 9;
        display: block;
        border-radius: 2px;
        cursor: pointer;
        flex-grow: 1; 
        min-height: 0;
    }
    .library-image-wrapper:hover .delete-library-image,
    .library-image-wrapper:hover .edit-caption-btn {
        opacity: 1;
    }
    .delete-library-image {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: rgba(220, 53, 69, 0.85);
        border: 1px solid rgba(255,255,255,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease-in-out;
        opacity: 0;
        padding: 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .delete-library-image svg {
        width: 14px;
        height: 14px;
        fill: white;
    }
    .edit-caption-btn {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: rgba(0, 123, 255, 0.85);
        border: 1px solid rgba(255,255,255,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease-in-out;
        opacity: 0;
        padding: 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .edit-caption-btn svg {
        width: 14px;
        height: 14px;
        fill: white;
    }
    .library-image-caption {
        font-size: 12px;
        line-height: 1.4;
        color: var(--subtle-text);
        padding: 8px 4px 4px 4px;
        text-align: center;
        flex-shrink: 0;
        word-wrap: break-word;
    }
    .library-image-caption.is-today {
        color: #ffc107;
        font-weight: 500;
    }

    .modal-overlay {
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px 0;
        overflow-y: auto;
        animation-name: fadeIn;
        animation-duration: 0.3s;
    }
    #image-modal .modal-content {
        margin: auto;
        display: block;
        max-width: 90vw;
        max-height: 85vh;
        animation-name: zoomIn;
        animation-duration: 0.4s;
    }

    @keyframes fadeIn {
        from {opacity: 0}
        to {opacity: 1}
    }
    @keyframes zoomIn {
        from {transform:scale(0.1)}
        to {transform:scale(1)}
    }
    .modal-close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
        z-index: 2002;
    }
    .modal-close:hover,
    .modal-close:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }
    #modal-caption {
        text-align: center;
        color: #ccc;
        padding: 15px 0;
        font-size: 18px;
        line-height: 1.4;
        max-width: 80vw;
        word-wrap: break-word; 
    }
    .modal-nav {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
        border: none;
        border-radius: 50%;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2001;
        transition: background-color 0.2s ease;
    }
    .modal-nav:hover {
        background-color: rgba(255, 255, 255, 0.4);
    }
    #modal-prev { left: 20px; }
    #modal-next { right: 20px; }

    .collapsible-section {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 20px;
        background-color: var(--card-bg);
        overflow: hidden; 
    }
    .collapsible-section.master-only {
        display: none;
    }
    .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        background-color: var(--header-bg);
        transition: background-color 0.2s ease;
    }
    .collapsible-header h2 {
        margin: 0;
        padding: 0;
        border: none;
        font-size: 1.1em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .collapsible-toggle-btn {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--subtle-text);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-size: 22px;
        line-height: 26px;
        font-weight: bold;
        padding: 0;
        margin: 0;
        text-align: center;
        transition: transform 0.3s ease, background-color 0.2s, border-color 0.2s, color 0.2s;
        flex-shrink: 0;
    }
    .collapsible-header:hover .collapsible-toggle-btn {
        border-color: var(--link-color);
        color: var(--link-color);
    }
    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out;
    }
    .collapsible-content-inner {
        padding: 20px;
        border-top: 1px solid var(--border-color);
    }

    .trade-image-thumbnails {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        max-width: 150px;
    }
    .trade-image-thumbnails .thumbnail-wrapper {
        position: relative;
        width: 40px;
        height: 40px;
    }
    .trade-image-thumbnails img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid var(--border-color);
    }
    .trade-image-thumbnails .delete-trade-image {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 16px;
        height: 16px;
        background-color: rgba(220, 53, 69, 0.9);
        color: white;
        border: 1px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        line-height: 10px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        padding: 0;
        z-index: 1;
    }
    .trade-image-thumbnails .thumbnail-wrapper:hover .delete-trade-image {
        opacity: 1;
    }

    #notes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
    }
    .note-item {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--container-bg);
        overflow: hidden;
        aspect-ratio: 1 / 1;
    }
    .note-item-header {
        padding: 15px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        position: relative;
        transition: background-color 0.2s ease;
        height: 100%;
    }
    .note-item-header:hover {
        background-color: var(--header-bg);
    }
    .note-icon {
        font-size: 40px;
        margin-bottom: 10px;
    }
    .note-title {
        font-weight: 500;
        color: var(--text-color);
        word-break: break-word;
        margin: 0;
    }
    .note-delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: transparent;
        border: 1px solid transparent;
        color: var(--subtle-text);
        cursor: pointer;
        font-size: 16px;
        line-height: 22px;
        padding: 0;
        transition: all 0.2s ease;
        opacity: 0.5;
    }
    .note-item:hover .note-delete-btn {
        opacity: 1;
    }
    .note-delete-btn:hover {
        background-color: var(--red-bg);
        color: var(--red-text);
        border-color: var(--red-border);
    }

    .note-modal-container {
        background-color: var(--container-bg);
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 5px 25px var(--shadow-color);
        animation-name: zoomIn;
        animation-duration: 0.4s;
        margin: auto;
        max-height: 90vh;
    }
    #note-modal-title {
        font-size: 24px;
        font-weight: 600;
        border: none;
        border-bottom: 2px solid var(--border-color);
        padding: 10px 5px;
        margin: 0 0 20px 0;
        background-color: transparent;
        flex-shrink: 0;
    }
    #note-modal-title:focus {
        outline: none;
        border-bottom-color: var(--link-color);
    }
    #note-modal-content {
        flex-grow: 1;
        font-size: 16px;
        line-height: 1.7;
        border: 1px solid var(--border-color);
        padding: 15px;
        resize: none;
        overflow-y: auto;
    }
    .note-modal-actions {
        margin-top: 20px;
        text-align: right;
        flex-shrink: 0;
    }
    #note-modal-close {
            width: auto;
            padding: 10px 20px;
    }

    #calculator-tab .calculator-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    @media (max-width: 768px) { 
        .container { padding: 10px; } 
        #add-trade-form { grid-template-columns: 1fr; } 
        .journal-image-wrapper { max-width: 100%; } 
        th, td { font-size: 12px; padding: 6px; } 
        .action-buttons button { font-size: 11px; padding: 4px 8px; } 
        #stats-panel-container { bottom: 10px; left: 10px; }
        #stats-fab { width: 50px; height: 50px; }
        #stats-panel { width: calc(100vw - 40px); }
        .theme-switch-wrapper { top: 8px; right: 10px; }
        .modal-nav {
            width: 40px;
            height: 40px;
            font-size: 24px;
        }
        #modal-prev { left: 5px; }
        #modal-next { right: 5px; }
        .collapsible-content-inner { padding: 15px 10px; }
        .collapsible-header { padding: 10px 15px; }
        .collapsible-header h2 { font-size: 1em; }
        .ema-level-summary-grid { grid-template-columns: 1fr; }

        .modal-overlay {
            padding: 0;
        }
        .note-modal-container {
            width: 100%;
            min-height: 100%;
            height: auto;
            border-radius: 0;
            box-shadow: none;
            padding: 15px;
        }
        #note-modal-title { font-size: 20px; }
        #note-modal-content { font-size: 15px; }
    }


    /* --- NEW SPLIT SUMMARY STYLES --- */
    .summary-split-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        width: 100%;
    }
    .summary-card {
        flex: 1;
        min-width: 300px;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
    }
    .summary-card.long-card {
        border-top: 3px solid var(--green-text);
        background-color: rgba(40, 167, 69, 0.05);
    }
    .summary-card.short-card {
        border-top: 3px solid var(--red-text);
        background-color: rgba(220, 53, 69, 0.05);
    }
    .summary-card h5 {
        margin: 0 0 10px 0;
        text-align: center;
        text-transform: uppercase;
        font-size: 14px;
        letter-spacing: 1px;
    }
    .summary-grid-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 8px;
        text-align: center;
    }
    .summary-grid-row.financials {
        grid-template-columns: repeat(2, 1fr);
        border-top: 1px dashed var(--border-color);
        padding-top: 8px;
    }
    .sum-label { font-size: 10px; color: var(--subtle-text); text-transform: uppercase; display: block; }
    .sum-val { font-size: 15px; font-weight: 700; font-family: 'Courier New', monospace; }
    .val-green { color: var(--green-text); }
    .val-red { color: var(--red-text); }

    /* --- FORCE VISIBLE SCROLLBAR --- */
    .table-wrapper::-webkit-scrollbar {
        height: 16px !important;
        width: 16px !important;
    }
    .table-wrapper::-webkit-scrollbar-track {
        background-color: #333333 !important; 
        border-top: 1px solid #555 !important;
        border-radius: 0 !important;
    }
    .table-wrapper::-webkit-scrollbar-thumb {
        background-color: #c0c0c0 !important;
        border-radius: 10px !important;
        border: 4px solid #333333 !important;
        min-height: 50px !important;
    }
    .table-wrapper::-webkit-scrollbar-thumb:hover {
        background-color: #ffffff !important;
        border-color: #333333 !important;
    }
    .table-wrapper::-webkit-scrollbar-button {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
    }
    .table-wrapper::-webkit-scrollbar-corner {
        background: #333333 !important;
    }
</style>
<body>
    <div class="container">

        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="theme-checkbox">
                <input type="checkbox" id="theme-checkbox" />
                <div class="slider round"></div>
            </label>
        </div>

        <div id="stats-panel-container">
            <div id="stats-panel">
                <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">Ã—</button></div>
                <div class="stats-grid">
                    <!-- Core Balance Stats -->
                    <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">AUD Value (est.)</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Total P/L (AUD)</span><span id="stat-total-pl-aud" class="stat-value">A$0.00</span></div>

                    <hr style="grid-column: 1 / -1; border: 0; border-top: 1px solid var(--border-color); margin: 5px 0;">

                    <!-- Performance Metrics -->
                    <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                    <div class="stat-item">
                        <span class="stat-label">Wins / Losses</span>
                        <div><span id="stat-wins" class="stat-value" style="color: var(--green-text);">0</span> / <span id="stat-losses" class="stat-value" style="color: var(--red-text);">0</span></div>
                    </div>
                    <div class="stat-item"><span class="stat-label">Win Rate</span><span id="stat-win-rate" class="stat-value">0.0%</span></div>
                    <div class="stat-item"><span class="stat-label">Profit Factor</span><span id="stat-profit-factor" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Win</span><span id="stat-avg-win" class="stat-value" style="color: var(--green-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Avg. Loss</span><span id="stat-avg-loss" class="stat-value" style="color: var(--red-text);">$0.00</span></div>
                    <div class="stat-item"><span class="stat-label">Reward:Risk Ratio</span><span id="stat-reward-risk" class="stat-value">N/A</span></div>
                    <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
                </div>
            </div>
            <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7-14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
        </div>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal & Setups</button>
            <button class="tab-link" data-tab="notes">Notes</button>
        </div>

        <div id="tracker-tab" class="tab-content active">

            <!-- Add New Trade Section -->
            <div class="collapsible-section master-only">
                <div class="collapsible-header">
                    <h2>Add New Trade</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <form id="add-trade-form">
                            <!-- NEW FIELD: PARENT GROUP NAME -->
                            <div style="grid-column: 1 / -1;">
                                <label for="trade-group-name">Trade Idea / Group Name:</label>
                                <input type="text" id="trade-group-name" placeholder="e.g. BTC Weekly Swing (Optional)">
                            </div>
                            
                            <div>
                                <label for="trade-setup-type">Setup Class:</label>
                                <select id="trade-setup-type">
                                    <option value="Major">Major Swing</option>
                                    <option value="Scalp">Fast/Scalp</option>
                                    <option value="Intraday">Intraday</option>
                                </select>
                                <label for="trade-symbol">Symbol:</label>
                                <input type="text" id="trade-symbol" list="symbol-list" placeholder="Type or select a symbol">
                                <datalist id="symbol-list">
                                    <option value="BTC/USDT">
                                    <option value="ETH/USDT">
                                </datalist>
                            </div>
                            
                            <div>
                                <label for="trade-exchange">Exchange / Fees:</label>
                                <select id="trade-exchange">
                                    <option value="binance">Binance (0% M / 0.075% T)</option>
                                    <option value="hyperliquid">Hyperliquid (0.015% M / 0.045% T)</option>
                                </select>
                            </div>

                            <div><label for="trade-type">Trade Type:</label><select id="trade-type"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                            
                            <div>
                                <label for="trade-status">Status:</label>
                                <select id="trade-status">
                                    <option value="live">Live Trade</option>
                                    <option value="resting">Resting (Limit)</option>
                                </select>
                            </div>

                            <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                            <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                            <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                            <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                            <div>
                                <label for="entry-fee-type">Entry Fee:</label>
                                <select id="entry-fee-type">
                                    <option value="taker">Taker Fee</option>
                                    <option value="maker">Maker Fee</option>
                                </select>
                            </div>
                            <div><button type="submit">Add Trade</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- FIBONACCI SETUP CALCULATOR -->
            <div class="collapsible-section master-only">
                <div class="collapsible-header">
                    <h2>Add Fib Setup (OTE)</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="calculator-grid" id="fib-calc-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end;">
                            
                            <!-- Column 1: Asset Details -->
                            <div>
                                <label for="fib-symbol">Symbol:</label>
                                <input type="text" id="fib-symbol" list="symbol-list" placeholder="BTC/USDT">
                            </div>
                            <div>
                                <label for="fib-type">Direction:</label>
                                <select id="fib-type">
                                    <option value="Long">Long (Buy Dip)</option>
                                    <option value="Short">Short (Sell Rally)</option>
                                </select>
                            </div>
                            <div>
                                <label for="fib-setup-type">Setup Class:</label>
                                <select id="fib-setup-type">
                                    <option value="Major">Major Swing</option>
                                    <option value="Scalp">Fast/Scalp</option>
                                    <option value="Intraday">Intraday</option>
                                </select>
                            </div>

                            <!-- Column 2: Fib Range -->
                            <div><label for="fib-high">Swing High ($):</label><input type="number" id="fib-high" step="any"></div>
                            <div><label for="fib-low">Swing Low ($):</label><input type="number" id="fib-low" step="any"></div>

                            <!-- Column 3: Risk & Targets -->
                            <div><label for="fib-stop">Stop Loss ($):</label><input type="number" id="fib-stop" step="any"></div>
                            <div><label for="fib-target">Target ($):</label><input type="number" id="fib-target" step="any"></div>
                            <div><label for="fib-risk">Risk Amount ($):</label><input type="number" id="fib-risk" placeholder="e.g. 100"></div>

                            <!-- Column 4: Settings -->
                            <div>
                              <label for="fib-exchange">Exchange:</label>
                                <select id="fib-exchange">
                                    <option value="binance">Binance</option>
                                    <option value="hyperliquid">Hyperliquid</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="fib-fee-type">Entry Fee:</label>
                                <select id="fib-fee-type">
                                    <option value="maker">Maker (Limit)</option>
                                    <option value="taker">Taker (Market)</option>
                                </select>
                            </div>

                            <div>
                                <label for="fib-status">Add To:</label>
                                <select id="fib-status">
                                    <option value="resting">Resting Orders</option>
                                    <option value="live">Live Trades</option>
                                </select>
                            </div>
                            <div>
                                <button type="button" id="calc-fib-btn" style="background-color: var(--purple-bg); color: var(--text-color); border: 1px solid var(--border-color); font-weight: bold; width: 100%; padding: 10px;">Calculate Levels</button>
                            </div>
                        </div>

                       <div id="fib-results-container" style="margin-top: 20px; display: none;">
                            <h4 style="text-align: center; margin-bottom: 10px;">Calculated OTE Entries</h4>
                            <div class="table-wrapper">
                                <table class="sr-table">
                                    <thead>
                                        <tr>
                                            <th>Fib Level</th>
                                            <th>Entry Price</th>
                                            <th>Stop Loss</th>
                                            <th>Risk ($)</th>       <!-- NEW COLUMN -->
                                            <th>Size (Coins)</th>   <!-- NEW COLUMN -->
                                            <th>Size ($)</th>
                                            <th>Risk %</th>
                                            <th>Est. PnL</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fib-results-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resting Limit Orders Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Resting Limit Orders</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">

                        <div id="resting-trades-summary-container" class="ema-summary-container" style="display:none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--link-color);">
                        </div>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Entry Price</th>
                                        <th>Stop Loss</th>
                                        <th>Target</th>
                                        <th>Position Value ($)</th>
                                        <th>Est. Total Fee ($)</th>
                                        <th>Proj. Profit (Taker)</th>
                                        <th>Proj. Profit (Maker)</th>
                                        <th>Proj. Loss (Taker)</th>
                                        <th>Proj. Loss (Maker)</th>
                                        <th>RR (Taker)</th>
                                        <th>RR (Maker)</th>
                                        <th>Date Added</th>
                                        <th>Note</th>
                                        <th class="master-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resting-trades-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Trades Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Live Trades (Grouped by Trade Idea)</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">

                        <div id="live-trades-summary-container" class="summary-split-container" style="display:none; margin-bottom: 20px;">
                        </div>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Trade Idea / Symbol</th>
                                        <th>Type</th>
                                        <th>Setup</th>
                                        <th>Avg. Entry</th>
                                        <th>Stop Loss</th>
                                        <th>Avg Target</th>
                                        <th>Total Size ($)</th>
                                        <th>Total Qty</th>
                                        <th>Est. Total Fee ($)</th>
                                        <th>Profit (Taker)</th>
                                        <th>Loss (Taker)</th>
                                        <th>RR</th>
                                        <th>Date Opened</th>
                                        <th>Note</th>
                                        <th>Charts</th>
                                        <th class="master-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trades-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Setups Section (Combined) -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Trading Setups</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <textarea id="primary-setups-notes" class="setups-notes-area" placeholder=""></textarea>
                        <textarea id="secondary-setups-notes" class="setups-notes-area" placeholder=""></textarea>
                    </div>
                </div>
            </div>

            <!-- Setups Image Library Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Setups</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="setups-image-library-section">
                            <div id="setups-upload-section" class="master-only" style="text-align: center; margin-bottom: 20px;">
                                <label for="setups-image-upload" class="image-upload-label">Add Setup Image</label>
                                <input type="file" id="setups-image-upload" accept="image/*" multiple style="display:none;">
                                <div id="setups-upload-progress" style="margin-top: 10px; font-style: italic; color: var(--link-color);"></div>
                            </div>
                            <div id="setups-image-container"></div>
                            <button id="toggle-all-setups-images" class="toggle-history-btn">Show All</button>
                            <div id="setups-images-pagination-controls" class="pagination-controls" style="display: none;">
                                <button id="setups-images-prev-page" class="pagination-btn">&lt; Prev</button>
                                <span id="setups-images-page-info"></span>
                                <button id="setups-images-next-page" class="pagination-btn">Next &gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Trades Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h2>Completed Trades</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Trade Idea / Symbol</th>
                                        <th>Type</th>
                                        <th>Avg Entry</th>
                                        <th>Exit Price</th>
                                        <th>Total Size ($)</th>
                                        <th>Fees ($)</th>
                                        <th>Net Result ($)</th>
                                        <th>Date Closed</th>
                                        <th>Note</th>
                                        <th>Charts</th>
                                        <th class="master-only">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="completed-trades-tbody"></tbody>
                            </table>
                        </div>
                        <button id="toggle-all-completed-trades" class="toggle-history-btn">Show All</button>
                    </div>
                </div>
            </div> 

        </div>

        <div id="journal-tab" class="tab-content">
            <div class="controls-container" id="journal-controls">
                <div><label for="journal-symbol">Symbol:</label><select id="journal-symbol"><option value="BTC/USDT">BTC/USDT</option><option value="ETH/USDT">ETH/USDT</option></select></div>
                <div><label for="journal-timeframe">Timeframe:</label><select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
                <div>
                    <label for="journal-image-filter">Filter Images:</label>
                    <select id="journal-image-filter">
                        <option value="all" selected>All for Timeframe</option>
                        <option value="today">Selected Day Only</option>
                    </select>
                </div>
            </div>
            <div class="date-nav-container">
                <button id="date-prev" class="date-nav-arrow"><</button>
                <div id="date-buttons-container"></div>
                <button id="date-next" class="date-nav-arrow">></button>
            </div>

            <div id="favourited-entry-container" style="display: none;">
                <div class="favourited-header">
                    <span class="star-icon">â­</span>
                    <span>Pinned Note for this Timeframe</span>
                </div>
                <div id="favourited-entry-text"></div>
            </div>

            <div class="journal-input-wrapper">
                 <button id="favourite-btn" class="master-only" title="Pin this note for this timeframe on all days">â­</button>
                 <textarea id="journal-entry" placeholder=""></textarea>
            </div>

            <p id="save-status" style="text-align:center;font-style:italic;color:#666;height:1em"></p>

            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture</label>
                <input type="file" id="journal-image-upload" accept="image/*" multiple>
                <div id="upload-progress"></div>
            </div>

            <div id="journal-images-container"></div>
        </div>

        <div id="notes-tab" class="tab-content">
            <div class="collapsible-section">
                 <div class="collapsible-header">
                    <h2>My Notes</h2>
                    <button class="collapsible-toggle-btn">+</button>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <div id="notes-controls" class="master-only" style="text-align: right; margin-bottom: 20px;">
                            <button id="create-new-note-btn">Create New Note</button>
                        </div>
                        <div id="notes-container">
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="image-modal" class="modal-overlay" style="display: none;">
        <span class="modal-close">&times;</span>
        <button id="modal-prev" class="modal-nav">&lt;</button>
        <img class="modal-content" id="modal-image-content">
        <button id="modal-next" class="modal-nav">&gt;</button>
        <div id="modal-caption"></div>
    </div>

    <div id="note-edit-modal" class="modal-overlay" style="display: none;">
        <div class="note-modal-container">
            <input type="text" id="note-modal-title" placeholder="Note Title">
            <textarea id="note-modal-content" placeholder="Start typing..."></textarea>
            <div class="note-modal-actions">
                <button id="note-modal-close">Close</button>
            </div>
        </div>
    </div>

    <input type="file" id="trade-image-uploader" accept="image/*" style="display:none;" multiple>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const CONFIG = {
            FIREBASE: {
                apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                authDomain: "journal-a003f.firebaseapp.com",
                databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "journal-a003f",
                storageBucket: "journal-a003f.firebasestorage.app", 
                messagingSenderId: "1038636626553",
                appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
            },
            DB_PATHS: { TRADES: 'trades', COMPLETED_TRADES: 'completed_trades', BANK: 'bank', JOURNAL_TEXT: 'journal_text', JOURNAL_IMAGES: 'journal_images', IMAGE_LIBRARY: 'image_library', SETUPS_IMAGES: 'setups_images', CHART_LIBRARY_2: 'chart_library_2', JOURNAL_FAVOURITES: 'journal_favourites', SETUPS_1: 'current_setups_1', SETUPS_2: 'current_setups_2', GENERAL_NOTES: 'general_notes', RESTING_ORDERS: 'resting_orders' },
            TRADE_SETTINGS: {
                STARTING_BALANCE: 5137,
                STATS_RESET_DATE: '2025-10-20',
            }
        };

        // --- DOM ELEMENT CACHE ---
        const DOM = {
            tabs: document.querySelector('.tabs'),
            themeToggle: document.getElementById('theme-checkbox'),
            trackerTab: document.getElementById('tracker-tab'),
            tradeImageUploader: document.getElementById('trade-image-uploader'),
            statsPanelContainer: document.getElementById('stats-panel-container'),
            statsFab: document.getElementById('stats-fab'),
            statsPanel: document.getElementById('stats-panel'),
            closeStatsBtn: document.getElementById('close-stats-btn'),
            statBalance: document.getElementById('stat-balance'),
            statBalanceAud: document.getElementById('stat-balance-aud'),
            statTotalPl: document.getElementById('stat-total-pl'),
            statTotalPlAud: document.getElementById('stat-total-pl-aud'),
            statCompletedTrades: document.getElementById('stat-completed-trades'),
            statWins: document.getElementById('stat-wins'),
            statLosses: document.getElementById('stat-losses'),
            statWinRate: document.getElementById('stat-win-rate'),
            statProfitFactor: document.getElementById('stat-profit-factor'),
            statAvgWin: document.getElementById('stat-avg-win'),
            statAvgLoss: document.getElementById('stat-avg-loss'),
            statRewardRisk: document.getElementById('stat-reward-risk'),
            statOpenTrades: document.getElementById('stat-open-trades'),
            addTradeForm: document.getElementById('add-trade-form'),
            tradesTbody: document.getElementById('trades-tbody'),
            completedTradesTbody: document.getElementById('completed-trades-tbody'),
            restingTradesTbody: document.getElementById('resting-trades-tbody'),
            setupsImageContainer: document.getElementById('setups-image-container'),
            setupsImageUpload: document.getElementById('setups-image-upload'),
            setupsUploadProgress: document.getElementById('setups-upload-progress'),
            imageModal: document.getElementById('image-modal'),
            modalImageContent: document.getElementById('modal-image-content'),
            modalClose: document.querySelector('.modal-close'),
            modalCaption: document.getElementById('modal-caption'),
            modalPrevBtn: document.getElementById('modal-prev'),
            modalNextBtn: document.getElementById('modal-next'),
            journalTab: document.getElementById('journal-tab'),
            notesTab: document.getElementById('notes-tab'),
            createNewNoteBtn: document.getElementById('create-new-note-btn'),
            notesContainer: document.getElementById('notes-container'),
            primarySetupsNotes: document.getElementById('primary-setups-notes'),
            secondarySetupsNotes: document.getElementById('secondary-setups-notes'),
            journalSymbolEl: document.getElementById('journal-symbol'),
            journalTimeframeEl: document.getElementById('journal-timeframe'),
            journalImageFilterEl: document.getElementById('journal-image-filter'),
            dateButtonsContainer: document.getElementById('date-buttons-container'),
            datePrevBtn: document.getElementById('date-prev'),
            dateNextBtn: document.getElementById('date-next'),
            favouritedEntryContainer: document.getElementById('favourited-entry-container'),
            favouritedEntryText: document.getElementById('favourited-entry-text'),
            favouriteBtn: document.getElementById('favourite-btn'),
            journalEntryEl: document.getElementById('journal-entry'),
            saveStatus: document.getElementById('save-status'),
            journalImageUpload: document.getElementById('journal-image-upload'),
            uploadProgress: document.getElementById('upload-progress'),
            journalImagesContainer: document.getElementById('journal-images-container'),
            noteEditModal: document.getElementById('note-edit-modal'),
            noteModalTitle: document.getElementById('note-modal-title'),
            noteModalContent: document.getElementById('note-modal-content'),
            noteModalClose: document.getElementById('note-modal-close'),
        };

        // --- APPLICATION STATE ---
        const STATE = {
            isMasterUser: false, masterPassword: null, viewerId: null, usdToAudRate: 1.53, journalText: {}, journalImages: {}, favouriteEntries: {}, setupsData1: {}, setupsData2: {}, generalNotes: {}, selectedDate: null, centerDate: null, journalSaveTimer: null, notesSaveTimer: null, 
            completedTradesShowAll: false, completedTradesCurrentPage: 1,
            allSetupsImages: {}, setupsImagesShowAll: false, setupsImagesCurrentPage: 1, setupsImagesItemsPerPage: 50,
            modalImageGallery: [], modalImageIndex: -1, imageUploadContext: { id: null, type: null }
        };

        // --- INITIALIZE FIREBASE ---
        firebase.initializeApp(CONFIG.FIREBASE);
        const database = firebase.database();
        const storage = firebase.storage();
        const dbRefs = { trades: database.ref(CONFIG.DB_PATHS.TRADES), completedTrades: database.ref(CONFIG.DB_PATHS.COMPLETED_TRADES), bank: database.ref(CONFIG.DB_PATHS.BANK), journalText: database.ref(CONFIG.DB_PATHS.JOURNAL_TEXT), journalImages: database.ref(CONFIG.DB_PATHS.JOURNAL_IMAGES), setupsImages: database.ref(CONFIG.DB_PATHS.SETUPS_IMAGES), favourites: database.ref(CONFIG.DB_PATHS.JOURNAL_FAVOURITES), setups1: database.ref(CONFIG.DB_PATHS.SETUPS_1), setups2: database.ref(CONFIG.DB_PATHS.SETUPS_2), generalNotes: database.ref(CONFIG.DB_PATHS.GENERAL_NOTES), restingOrders: database.ref(CONFIG.DB_PATHS.RESTING_ORDERS) };

        // --- HELPER FUNCTIONS ---
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
        const formatCurrency = (num, symbol = '$') => { if (typeof num !== 'number' || isNaN(num)) { return '--'; } const maximumFractionDigits = num > 100 ? 2 : (num > 1 ? 4 : 8); return `${symbol}${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits })}`; };
        function autoResizeTextarea(textarea) { if (!textarea || textarea.tagName !== 'TEXTAREA') return; textarea.style.height = 'auto'; textarea.style.height = `${textarea.scrollHeight}px`; }
        function resizeParentCollapsible(elementInside) { const section = elementInside.closest('.collapsible-section'); if (section && section.classList.contains('is-open')) { const content = section.querySelector('.collapsible-content'); if (content) { content.style.maxHeight = content.scrollHeight + 'px'; } } }
        const debouncedResizeParent = debounce(resizeParentCollapsible, 250);
        const getYYYYMMDD = (date) => date.toISOString().split('T')[0];
        const getSafeSymbol = (symbol) => symbol.replace(/\//g, '-');
        
        // --- DATA FETCHING ---
        async function fetchLiveConversionRate() { try { const response = await fetch('https://open.er-api.com/v6/latest/USD'); if (!response.ok) return; const data = await response.json(); if (data?.result === "success" && data?.rates?.AUD) { STATE.usdToAudRate = data.rates.AUD; } } catch (error) { console.error("Could not fetch conversion rate.", error); } }

        function getFeeRates(exchangeName) {
            const exchange = (exchangeName || 'binance').toLowerCase();
            if (exchange === 'hyperliquid') return { MAKER: 0.00015, TAKER: 0.00045 };
            return { MAKER: 0.0000, TAKER: 0.00075 };
        }

        // --- METRICS CALCULATION ---
        function calculateTradeMetrics(tradeData) {
            const entry = parseFloat(tradeData.entry); 
            const stoploss = parseFloat(tradeData.stoploss); 
            const target = parseFloat(tradeData.target); 
            const size = parseFloat(tradeData.size); 
            const type = tradeData.type;

            const baseReturn = { 
                rr: 0, estimated_total_fee: 0, 
                expected_profit_taker: 0, expected_loss_taker: 0
            };

            if ([entry, stoploss, target, size].some(v => isNaN(v) || v <= 0)) { return baseReturn; }

            const rates = getFeeRates(tradeData.exchange);
            const entryFeeRate = tradeData.entryFeeType === 'maker' ? rates.MAKER : rates.TAKER;

            const positionQty = size / entry; 
            const entryFee = size * entryFeeRate;

            let potentialProfit, potentialLoss;
            if (type === 'Long') { 
                potentialProfit = positionQty * (target - entry); 
                potentialLoss = positionQty * (entry - stoploss); 
            } else { 
                potentialProfit = positionQty * (entry - target); 
                potentialLoss = positionQty * (stoploss - entry); 
            }

            // Taker Profit Calculation
            const exitFeeAtTarget_Taker = (target / entry) * size * rates.TAKER; 
            const expected_profit_taker = potentialProfit - entryFee - exitFeeAtTarget_Taker;

            // Taker Loss Calculation
            const exitFeeAtStop_Taker = (stoploss / entry) * size * rates.TAKER; 
            const expected_loss_taker = potentialLoss + entryFee + exitFeeAtStop_Taker;

            const rr = (Math.abs(expected_loss_taker) > 0) ? (expected_profit_taker / Math.abs(expected_loss_taker)) : 0;

            return { 
                rr: rr.toFixed(2),
                estimated_total_fee: entryFee + exitFeeAtTarget_Taker, 
                expected_profit_taker: expected_profit_taker, 
                expected_loss_taker: expected_loss_taker
            };
        }

        // --- GROUPING HELPER ---
        function groupTradesByParent(trades) {
            const groups = {};
            Object.keys(trades).forEach(key => {
                const t = trades[key];
                // Use explicit parentId or fallback to the trade ID if it's old/orphan
                const pid = t.parentId || `orphan_${key}`;
                const ideaName = t.ideaName || `${t.symbol} Trade`;

                if (!groups[pid]) {
                    groups[pid] = {
                        id: pid,
                        name: ideaName,
                        symbol: t.symbol,
                        type: t.type,
                        setupType: t.setupType,
                        trades: [],
                        totalSize: 0,
                        totalQty: 0,
                        weightedEntrySum: 0,
                        weightedTargetSum: 0,
                        startDate: t.date,
                        projProfit: 0,
                        projLoss: 0
                    };
                }
                const g = groups[pid];
                // Metrics for this specific trade entry
                const metrics = calculateTradeMetrics(t);
                const size = parseFloat(t.size);
                const entry = parseFloat(t.entry);
                const qty = size / entry;

                g.trades.push({ ...t, id: key, ...metrics });

                // Accumulate Group Stats
                g.totalSize += size;
                g.totalQty += qty;
                g.weightedEntrySum += (entry * qty);
                g.weightedTargetSum += (parseFloat(t.target) * qty);
                g.projProfit += metrics.expected_profit_taker;
                g.projLoss += metrics.expected_loss_taker;
                if (t.date < g.startDate) g.startDate = t.date;
            });

            // Finalize Averages
            Object.values(groups).forEach(g => {
                g.avgEntry = g.totalQty > 0 ? g.weightedEntrySum / g.totalQty : 0;
                g.avgTarget = g.totalQty > 0 ? g.weightedTargetSum / g.totalQty : 0;
            });

            return groups;
        }

        // --- RENDER LIVE TRADES (HIERARCHICAL) ---
        function renderLiveTable(trades) {
            const groups = groupTradesByParent(trades || {});
            const sortedGroupIds = Object.keys(groups).sort((a, b) => groups[b].startDate - groups[a].startDate);
            let html = '';
            let totalLongSize = 0, totalShortSize = 0, totalLongPnl = 0, totalShortPnl = 0;

            sortedGroupIds.forEach(pid => {
                const g = groups[pid];
                const isLong = g.type === 'Long';
                const color = isLong ? 'var(--green-text)' : 'var(--red-text)';

                if(isLong) { totalLongSize += g.totalSize; totalLongPnl += g.projProfit; }
                else { totalShortSize += g.totalSize; totalShortPnl += g.projProfit; }

                // Group Stop Loss (Visual approximation from first child or logic)
                const stopLossDisplay = g.trades[0]?.stoploss || '--'; 

                // --- 1. Group Summary Row ---
                const masterGroupBtns = STATE.isMasterUser ?
                    `<button class="add-to-position-btn" data-parent-id="${pid}" data-symbol="${g.symbol}" data-type="${g.type}" data-exchange="${g.trades[0].exchange}" data-setup="${g.setupType}" style="background-color: var(--link-color);">+ Add</button>
                     <button class="close-group-btn" data-parent-id="${pid}" style="background-color: var(--purple-bg); color: #333; font-weight: bold;">Close All</button>` : '';

                html += `<tr class="group-row">
                    <td class="group-name-cell">${g.name} (${g.trades.length})</td>
                    <td style="color:${color}">${g.type}</td>
                    <td>${g.setupType || ''}</td>
                    <td>${g.avgEntry.toFixed(4)}</td>
                    <td>${stopLossDisplay}</td>
                    <td>${g.avgTarget.toFixed(4)}</td>
                    <td>$${g.totalSize.toLocaleString()}</td>
                    <td style="font-family:'Courier New'">${g.totalQty.toFixed(4)}</td>
                    <td>--</td>
                    <td style="color:var(--green-text)">$${g.projProfit.toFixed(2)}</td>
                    <td style="color:var(--red-text)">$${g.projLoss.toFixed(2)}</td>
                    <td>--</td>
                    <td>${new Date(g.startDate).toLocaleDateString()}</td>
                    <td>--</td>
                    <td></td>
                    <td class="master-only" style="text-align:right;">${masterGroupBtns}</td>
                </tr>`;

                // --- 2. Child Rows (Individual Entries) ---
                g.trades.sort((a, b) => b.date - a.date).forEach(t => {
                    const masterChildBtns = STATE.isMasterUser ?
                        `<button class="close-single-btn" data-id="${t.id}" style="background-color: #dc3545;">Close</button>
                         <button class="delete-btn" data-id="${t.id}" style="background-color: #6c757d;">Del</button>
                         <button class="attach-image-btn" data-id="${t.id}" data-type="live" style="background-color: #17a2b8;">Pic</button>` : '';

                    html += `<tr class="child-row">
                        <td style="padding-left: 20px; font-size: 0.9em; color: var(--subtle-text);">Entry: ${parseFloat(t.entry).toFixed(4)}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${parseFloat(t.stoploss).toFixed(4)}</td>
                        <td>${parseFloat(t.target).toFixed(4)}</td>
                        <td>$${parseFloat(t.size).toFixed(2)}</td>
                        <td style="font-family:'Courier New'; font-size:0.9em;">${(t.size/t.entry).toFixed(4)}</td>
                        <td>$${parseFloat(t.estimated_total_fee).toFixed(2)}</td>
                        <td style="color: #28a745; font-size: 0.9em;">$${t.expected_profit_taker.toFixed(2)}</td>
                        <td style="color: #dc3545; font-size: 0.9em;">$${t.expected_loss_taker.toFixed(2)}</td>
                        <td>${t.rr}</td>
                        <td style="font-size: 0.8em;">${new Date(t.date).toLocaleTimeString()}</td>
                        <td class="note-cell">${t.note || ''}</td>
                        ${renderAttachmentThumbnails(t, t.id, 'live')}
                        <td class="master-only" style="text-align:right;">${masterChildBtns}</td>
                    </tr>`;
                });
            });

            DOM.tradesTbody.innerHTML = html;
            renderSummaryCards(totalLongSize, totalShortSize, totalLongPnl, totalShortPnl);
            checkMasterMode(); // Ensure buttons show if master
            adjustCollapsibleSize(DOM.tradesTbody);
        }

        function renderSummaryCards(lSize, sSize, lPnl, sPnl) {
            const container = document.getElementById('live-trades-summary-container');
            if(lSize === 0 && sSize === 0) { container.style.display = 'none'; return; }
            container.style.display = 'flex';
            container.innerHTML = `
                <div class="summary-card long-card">
                    <h5 style="color:var(--green-text); margin:0 0 10px 0; text-align:center;">LONG EXPOSURE</h5>
                    <div class="summary-grid-row">
                        <div><span class="sum-label">Total Size</span><span class="sum-val">$${lSize.toLocaleString()}</span></div>
                        <div><span class="sum-label">Proj Profit</span><span class="sum-val val-green">$${lPnl.toLocaleString()}</span></div>
                    </div>
                </div>
                <div class="summary-card short-card">
                    <h5 style="color:var(--red-text); margin:0 0 10px 0; text-align:center;">SHORT EXPOSURE</h5>
                    <div class="summary-grid-row">
                        <div><span class="sum-label">Total Size</span><span class="sum-val">$${sSize.toLocaleString()}</span></div>
                        <div><span class="sum-label">Proj Profit</span><span class="sum-val val-green">$${sPnl.toLocaleString()}</span></div>
                    </div>
                </div>
            `;
        }

        // --- RENDER COMPLETED TRADES (GROUPED) ---
        function renderCompletedTable(trades) {
            const groups = {};
            
            Object.keys(trades).forEach(key => {
                const t = trades[key];
                const pid = t.parentId || `completed_orphan_${key}`;
                if(!groups[pid]) {
                    groups[pid] = {
                        id: pid, name: t.ideaName || `${t.symbol} Trade`,
                        symbol: t.symbol, type: t.type,
                        trades: [], totalSize: 0, totalFees: 0, totalNet: 0,
                        lastDate: t.closed_date
                    };
                }
                const g = groups[pid];
                g.trades.push({...t, id: key});
                g.totalSize += parseFloat(t.size);
                g.totalFees += (parseFloat(t.entry_fee||0) + parseFloat(t.exit_fee||0));
                g.totalNet += parseFloat(t.net_result);
                if(t.closed_date > g.lastDate) g.lastDate = t.closed_date;
            });

            const sortedGroupIds = Object.keys(groups).sort((a,b) => groups[b].lastDate - groups[a].lastDate);
            let html = '';

            // Stats
            let wins=0, losses=0, totalPL=0, completedIdeas=0;

            sortedGroupIds.forEach(pid => {
                const g = groups[pid];
                completedIdeas++;
                if(g.totalNet > 0) wins++; else losses++;
                totalPL += g.totalNet;

                // Weighted Averages for the group row
                const totalQty = g.trades.reduce((acc, t) => acc + (parseFloat(t.size)/parseFloat(t.entry)), 0);
                const avgEntry = totalQty ? g.trades.reduce((acc,t) => acc + (parseFloat(t.entry)*(parseFloat(t.size)/parseFloat(t.entry))), 0) / totalQty : 0;
                const avgExit = totalQty ? g.trades.reduce((acc,t) => acc + (parseFloat(t.exit_price)*(parseFloat(t.size)/parseFloat(t.entry))), 0) / totalQty : 0;

                const netColor = g.totalNet >= 0 ? 'var(--green-text)' : 'var(--red-text)';

                // Group Row
                html += `<tr class="group-row">
                    <td>${g.name} <span style="font-weight:normal; font-size:0.8em;">(${g.trades.length})</span></td>
                    <td>${g.symbol}</td>
                    <td style="color:${g.type==='Long'?'var(--green-text)':'var(--red-text)'}">${g.type}</td>
                    <td>${avgEntry.toFixed(4)}</td>
                    <td>${avgExit.toFixed(4)}</td>
                    <td>$${g.totalSize.toLocaleString()}</td>
                    <td>$${g.totalFees.toFixed(2)}</td>
                    <td style="color:${netColor}; font-weight:bold;">$${g.totalNet.toFixed(2)}</td>
                    <td>${new Date(g.lastDate).toLocaleDateString()}</td>
                    <td></td>
                    <td></td>
                    <td class="master-only"></td>
                </tr>`;

                // Child Rows
                g.trades.forEach(t => {
                   const subNetColor = t.net_result >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                   const delBtn = STATE.isMasterUser ? `<button class="delete-completed-btn" data-id="${t.id}" style="background-color:#6c757d;">Del</button> <button class="attach-image-btn" data-id="${t.id}" data-type="completed" style="background-color: #17a2b8;">Pic</button>` : '';
                   
                   html += `<tr class="child-row">
                        <td style="padding-left:20px; font-size:0.85em; color:#666;">Sub-trade</td>
                        <td></td>
                        <td></td>
                        <td>${parseFloat(t.entry).toFixed(4)}</td>
                        <td>${parseFloat(t.exit_price).toFixed(4)}</td>
                        <td>$${parseFloat(t.size).toFixed(2)}</td>
                        <td>$${((t.entry_fee||0)+(t.exit_fee||0)).toFixed(2)}</td>
                        <td style="color:${subNetColor}; font-size:0.9em;">$${parseFloat(t.net_result).toFixed(2)}</td>
                        <td style="font-size:0.8em;">${new Date(t.closed_date).toLocaleTimeString()}</td>
                        <td class="note-cell">${t.note || ''}</td>
                        ${renderAttachmentThumbnails(t, t.id, 'completed')}
                        <td class="master-only">${delBtn}</td>
                   </tr>`;
                });
            });

            DOM.completedTradesTbody.innerHTML = html;
            
            // Update Stats
            DOM.statTotalPl.textContent = formatCurrency(totalPL);
            DOM.statTotalPl.style.color = totalPL >= 0 ? 'var(--green-text)' : 'var(--red-text)';
            DOM.statCompletedTrades.textContent = completedIdeas;
            DOM.statWins.textContent = wins;
            DOM.statLosses.textContent = losses;
            const winRate = (wins + losses) > 0 ? (wins/(wins+losses)*100).toFixed(1) : 0;
            DOM.statWinRate.textContent = `${winRate}%`;

            checkMasterMode();
            adjustCollapsibleSize(DOM.completedTradesTbody);
        }

        // --- ATTACHMENT RENDERING (Unchanged) ---
        function renderAttachmentThumbnails(entry, entryId, entryType) {
            const images = entry.attachedImages || {};
            const masterDeleteBtn = (imageId, fileName) => (STATE.isMasterUser) ? `<button class="delete-trade-image" title="Delete Attachment" data-entry-id="${entryId}" data-entry-type="${entryType}" data-image-id="${imageId}" data-filename="${fileName}">Ã—</button>` : '';
            const thumbnailsHtml = Object.keys(images).sort((a, b) => images[b].timestamp - images[a].timestamp).map(imageId => {
                const imgData = images[imageId];
                if (!imgData?.url) return '';
                return `<div class="thumbnail-wrapper">${masterDeleteBtn(imageId, imgData.fileName)}<img src="${imgData.url}" alt="Attachment" data-full-src="${imgData.url}" data-caption="Attachment for ${entryType} ${entryId}"></div>`;
            }).join('');
            return `<td class="trade-image-thumbnails">${thumbnailsHtml}</td>`;
        }

        // --- ACTIONS ---

        function handleAddTradeSubmit(e) {
            e.preventDefault();
            if (!STATE.isMasterUser) return;

            const symbol = document.getElementById('trade-symbol').value.toUpperCase();
            const type = document.getElementById('trade-type').value;
            // Generated Parent ID for this new group
            const parentId = `idea_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            // Use input name or default to "Symbol Type"
            const ideaName = document.getElementById('trade-group-name').value || `${symbol} ${type} Trade`;

            const trade = {
                parentId: parentId,
                ideaName: ideaName,
                symbol: symbol,
                setupType: document.getElementById('trade-setup-type').value,
                exchange: document.getElementById('trade-exchange').value,
                type: type,
                entry: parseFloat(document.getElementById('entry-price').value),
                stoploss: parseFloat(document.getElementById('stop-loss').value),
                target: parseFloat(document.getElementById('target').value),
                size: parseFloat(document.getElementById('position-value').value),
                entryFeeType: document.getElementById('entry-fee-type').value,
                date: firebase.database.ServerValue.TIMESTAMP
            };

            const status = document.getElementById('trade-status').value;
            const ref = status === 'resting' ? dbRefs.restingOrders : dbRefs.trades;

            ref.push(trade).then(() => {
                e.target.reset();
                alert("Trade added as a new group.");
            });
        }

        function handleAddStaggeredEntry(parentId, symbol, type, exchange, setupType) {
            if (!STATE.isMasterUser) return;
            const priceStr = prompt("Enter Entry Price for new add:");
            const sizeStr = prompt("Enter Size ($) for new add:");
            if (!priceStr || !sizeStr) return;

            const newTrade = {
                parentId: parentId,
                ideaName: "", // Inherited visually
                symbol: symbol,
                exchange: exchange,
                type: type,
                setupType: setupType,
                entry: parseFloat(priceStr),
                size: parseFloat(sizeStr),
                stoploss: 0, 
                target: 0,
                entryFeeType: 'taker',
                date: firebase.database.ServerValue.TIMESTAMP
            };

            // Fetch defaults from sibling
            dbRefs.trades.orderByChild('parentId').equalTo(parentId).limitToFirst(1).once('value', s => {
               const sibling = s.val() ? Object.values(s.val())[0] : null;
               if(sibling) {
                   newTrade.stoploss = sibling.stoploss;
                   newTrade.target = sibling.target;
                   newTrade.ideaName = sibling.ideaName;
               }
               dbRefs.trades.push(newTrade);
            });
        }

        function closeSingleTrade(tradeId) {
            if (!confirm("Close this specific entry?")) return;
            const exitPrice = prompt("Exit Price:");
            if (!exitPrice) return;
            dbRefs.trades.child(tradeId).once('value', s => {
                const t = s.val();
                processClosure(t, tradeId, parseFloat(exitPrice));
            });
        }

        function closeGroup(parentId) {
            if (!confirm("Close ALL trades in this group?")) return;
            const exitPrice = prompt("Exit Price for ALL entries:");
            if (!exitPrice) return;
            dbRefs.trades.orderByChild('parentId').equalTo(parentId).once('value', s => {
                const trades = s.val();
                if (!trades) return;
                Object.keys(trades).forEach(key => {
                    processClosure(trades[key], key, parseFloat(exitPrice));
                });
            });
        }

        function processClosure(trade, tradeKey, exitPrice) {
            const rates = getFeeRates(trade.exchange);
            const entryFee = parseFloat(trade.size) * (trade.entryFeeType==='maker'?rates.MAKER:rates.TAKER);
            const qty = parseFloat(trade.size) / parseFloat(trade.entry);
            const exitValue = qty * exitPrice;
            const exitFee = exitValue * rates.TAKER; // Assume taker exit
            const grossPnL = trade.type === 'Long' ? (exitValue - parseFloat(trade.size)) : (parseFloat(trade.size) - exitValue);
            const netResult = grossPnL - entryFee - exitFee;

            const completed = {
                ...trade,
                exit_price: exitPrice,
                entry_fee: entryFee,
                exit_fee: exitFee,
                net_result: netResult,
                closed_date: firebase.database.ServerValue.TIMESTAMP
            };

            dbRefs.completedTrades.push(completed).then(() => {
                dbRefs.trades.child(tradeKey).remove();
            });
        }

        // --- NOTES, IMAGES, JOURNALS (UNCHANGED) ---
        function renderNotes(notesData) {
            const container = DOM.notesContainer;
            if (!container) return;
            const sortedIds = Object.keys(notesData).sort((a, b) => (notesData[b].timestamp || 0) - (notesData[a].timestamp || 0));
            const notesHtml = sortedIds.map(id => {
                const note = notesData[id];
                const masterDeleteBtn = STATE.isMasterUser ? `<button class="note-delete-btn" data-note-id="${id}" title="Delete Note">&times;</button>` : '';
                return `<div class="note-item" id="note-item-${id}"><div class="note-item-header" data-note-id="${id}">${masterDeleteBtn}<div class="note-icon">ðŸ“</div><h4 class="note-title">${note.title || 'Untitled Note'}</h4></div></div>`;
            }).join('');
            container.innerHTML = notesHtml;
            adjustCollapsibleSize(container);
        }

        function renderGenericImageLibrary(imagesData, containerElement, libraryType) {
            const images = imagesData || {};
            if (!containerElement) return;
            const masterButtonsHtml = (id, fileName) => (STATE.isMasterUser) ? `<button class="delete-library-image" title="Delete Image" data-id="${id}" data-filename="${fileName}" data-library-type="${libraryType}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : '';
            const allImageIds = Object.keys(images).sort((a, b) => images[b].timestamp - images[a].timestamp);
            const imagesHtml = allImageIds.map(id => {
                const imgData = images[id]; if (!imgData?.url) return '';
                const caption = imgData.caption || (imgData.timestamp ? new Date(imgData.timestamp).toLocaleString() : ' ');
                return `<div class="library-image-wrapper">${masterButtonsHtml(id, imgData.fileName)}<img src="${imgData.url}" alt="${libraryType} Image" data-full-src="${imgData.url}" data-caption="${caption}"><div class="library-image-caption ${STATE.isMasterUser ? '' : 'master-only'}" title="${caption}">${caption}</div></div>`;
            }).join('');
            containerElement.innerHTML = imagesHtml;
            adjustCollapsibleSize(containerElement);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            DOM.themeToggle.addEventListener('change', (e) => {
                const theme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            });

            DOM.tabs.addEventListener('click', (e) => {
                if (!e.target.matches('.tab-link')) return;
                document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                const tabId = e.target.dataset.tab;
                document.getElementById(`${tabId}-tab`).classList.add('active');
                DOM.statsPanelContainer.style.display = (tabId === 'tracker' || tabId === 'journal') ? 'block' : 'none';
            });

            DOM.statsFab.addEventListener('click', () => DOM.statsPanel.classList.toggle('active'));
            DOM.closeStatsBtn.addEventListener('click', () => DOM.statsPanel.classList.remove('active'));

            DOM.addTradeForm.addEventListener('submit', handleAddTradeSubmit);

            // Dynamic Button Delegation
            document.body.addEventListener('click', (e) => {
                const btn = e.target;
                
                // Grouping Logic Buttons
                if (btn.classList.contains('add-to-position-btn')) {
                    handleAddStaggeredEntry(btn.dataset.parentId, btn.dataset.symbol, btn.dataset.type, btn.dataset.exchange, btn.dataset.setup);
                }
                if (btn.classList.contains('close-single-btn')) {
                    closeSingleTrade(btn.dataset.id);
                }
                if (btn.classList.contains('close-group-btn')) {
                    closeGroup(btn.dataset.parentId);
                }
                if (btn.classList.contains('delete-btn')) {
                    if(confirm("Delete trade?")) dbRefs.trades.child(btn.dataset.id).remove();
                }
                if (btn.classList.contains('delete-completed-btn')) {
                    if(confirm("Delete history?")) dbRefs.completedTrades.child(btn.dataset.id).remove();
                }

                // Attachments
                if (btn.classList.contains('attach-image-btn')) {
                     if (!STATE.isMasterUser) return;
                     STATE.imageUploadContext = { id: btn.dataset.id, type: btn.dataset.type };
                     DOM.tradeImageUploader.value = null; DOM.tradeImageUploader.click();
                }

                // Collapsibles
                if(btn.classList.contains('collapsible-toggle-btn') || btn.closest('.collapsible-header')) {
                    const section = btn.closest('.collapsible-section');
                    const content = section.querySelector('.collapsible-content');
                    const tgl = section.querySelector('.collapsible-toggle-btn');
                    if(section.classList.contains('is-open')) {
                        section.classList.remove('is-open');
                        content.style.maxHeight = '0px';
                        tgl.textContent = '+';
                    } else {
                        section.classList.add('is-open');
                        content.style.maxHeight = content.scrollHeight + 'px';
                        tgl.textContent = '-';
                    }
                }
            });

            DOM.tradeImageUploader.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!STATE.isMasterUser || !files || files.length === 0) return;
                const { id, type } = STATE.imageUploadContext;
                const dbRefPath = type === 'live' ? CONFIG.DB_PATHS.TRADES : CONFIG.DB_PATHS.COMPLETED_TRADES;
                
                Array.from(files).forEach((file) => {
                    if (!file.type.startsWith('image/')) return;
                    const fileName = `${Date.now()}_${file.name}`;
                    const storagePath = `trade_attachments/${id}/${fileName}`;
                    storage.ref(storagePath).put(file).then(snapshot => {
                        snapshot.ref.getDownloadURL().then((url) => {
                            database.ref(dbRefPath).child(id).child('attachedImages').push({ url, fileName, timestamp: firebase.database.ServerValue.TIMESTAMP });
                        });
                    });
                });
            });
            
            // Fib Calc
            const calcFibBtn = document.getElementById('calc-fib-btn');
            if(calcFibBtn) calcFibBtn.addEventListener('click', calculateFibLevels);
        }

        // --- FIB CALC LOGIC (Restored) ---
        function calculateFibLevels() {
            const high = parseFloat(document.getElementById('fib-high').value);
            const low = parseFloat(document.getElementById('fib-low').value);
            const stop = parseFloat(document.getElementById('fib-stop').value);
            const risk = parseFloat(document.getElementById('fib-risk').value);
            const type = document.getElementById('fib-type').value;
            const tbody = document.getElementById('fib-results-tbody');
            const container = document.getElementById('fib-results-container');
            
            if (isNaN(high) || isNaN(low) || isNaN(stop) || isNaN(risk)) return alert("Invalid inputs");
            
            const range = Math.abs(high - low);
            const levels = [0.5, 0.618, 0.705, 0.786];
            tbody.innerHTML = '';
            
            levels.forEach(level => {
                let entryPrice = type === 'Long' ? high - (range * level) : low + (range * level);
                if ((type === 'Long' && stop >= entryPrice) || (type === 'Short' && stop <= entryPrice)) return;
                const riskDist = Math.abs(entryPrice - stop);
                const positionCoins = risk / riskDist;
                const positionSizeUSD = positionCoins * entryPrice;
                
                tbody.innerHTML += `<tr><td>${level}</td><td>${entryPrice.toFixed(4)}</td><td>${stop}</td><td>$${risk}</td><td>${positionCoins.toFixed(4)}</td><td>$${positionSizeUSD.toFixed(2)}</td><td>--</td><td>--</td><td><button>Add</button></td></tr>`;
            });
            container.style.display = 'block';
        }

        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true' && !STATE.isMasterUser) {
                const password = prompt("Please enter master password:");
                if (password) {
                    STATE.isMasterUser = true;
                    document.querySelectorAll('.master-only').forEach(el => {
                       if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                       else el.style.display = 'block';
                    });
                }
            } else if (STATE.isMasterUser) {
                 document.querySelectorAll('.master-only').forEach(el => {
                       if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                       else el.style.display = 'block';
                 });
            }
        }

        function subscribeToData() {
            dbRefs.trades.on('value', s => { renderLiveTable(s.val() || {}); DOM.statOpenTrades.textContent = s.val() ? Object.keys(s.val()).length : 0; });
            dbRefs.restingOrders.on('value', s => {
                const trades = s.val() || {};
                let html = '';
                Object.keys(trades).forEach(key => {
                    const t = trades[key];
                    html += `<tr><td>${t.symbol}</td><td>${t.type}</td><td>${t.entry}</td><td>${t.stoploss}</td><td>${t.target}</td><td>${t.size}</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td class="master-only"></td></tr>`;
                });
                DOM.restingTradesTbody.innerHTML = html;
            });
            dbRefs.completedTrades.on('value', s => renderCompletedTable(s.val() || {}));
            dbRefs.generalNotes.on('value', (s) => renderNotes(s.val() || {}));
            dbRefs.setupsImages.on('value', (s) => renderGenericImageLibrary(s.val(), DOM.setupsImageContainer, 'setups_images'));
        }

        async function initializeApp() {
            checkMasterMode(); 
            await fetchLiveConversionRate();
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) { 
                document.documentElement.setAttribute('data-theme', savedTheme); 
                DOM.themeToggle.checked = savedTheme === 'dark'; 
            }
            setupEventListeners(); 
            subscribeToData();
        }

        initializeApp();
    });
</script>
</body>
</html>
