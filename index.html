const firebaseConfig = {
    apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
    authDomain: "journal-a003f.firebaseapp.com",
    databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "journal-a003f",
    storageBucket: "journal-a003f.firebasestorage.app",
    messagingSenderId: "1038636626553",
    appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();
const tradesRef = database.ref('trades');
const completedTradesRef = database.ref('completed_trades');
const bankRef = database.ref('bank');
const journalRef = database.ref('journal_text'); 
const journalImagesRef = database.ref('journal_images'); 
const emaValuesRef = database.ref('ema_values');
const FEE_RATE = 0.00075;
const STARTING_BALANCE = 4000;

document.addEventListener('DOMContentLoaded', function () {
    let isMasterUser = false, masterPassword = null, allJournalText = {}, allJournalImages = {}, allEmaData = {};
    
    // Element constants
    const statsFab = document.getElementById('stats-fab');
    const statsPanel = document.getElementById('stats-panel');
    const closeStatsBtn = document.getElementById('close-stats-btn');
    const journalSymbolEl = document.getElementById('journal-symbol');
    const journalTimeframeEl = document.getElementById('journal-timeframe');
    const journalEntryEl = document.getElementById('journal-entry');
    const journalImagesContainer = document.getElementById('journal-images-container');
    const tradesTbody = document.getElementById('trades-tbody');
    const completedTradesTbody = document.getElementById('completed-trades-tbody');
    const journalTab = document.getElementById('journal-tab');
    const snapshotSymbolEl = document.getElementById('snapshot-symbol');
    const snapshotImagesContainer = document.getElementById('snapshot-images-container');

    // Helper functions
    function autoResizeTextarea(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }
    function getSafeSymbol(symbol) { return symbol.replace(/\//g, '-'); }
    
    // --- RENDER FUNCTIONS ---
    function updateJournalView() { 
        const selectedSymbol = getSafeSymbol(journalSymbolEl.value); 
        const selectedTimeframe = journalTimeframeEl.value; 
        const symbolTextData = allJournalText[selectedSymbol] || {}; 
        journalEntryEl.value = symbolTextData[selectedTimeframe] || ''; 
        autoResizeTextarea(journalEntryEl); 
        const symbolImageData = allJournalImages[selectedSymbol] || {}; 
        renderJournalImages(selectedSymbol, selectedTimeframe, symbolImageData); 
        renderEmaData();
    }

    function renderSnapshotView() {
        const selectedSymbol = getSafeSymbol(snapshotSymbolEl.value);
        const symbolImageData = allJournalImages[selectedSymbol] || {};
        snapshotImagesContainer.innerHTML = '';

        const timeframesOrder = ['15min', '30min', '1hour', '2hour', '4hour', 'daily', 'weekly', 'monthly'];

        timeframesOrder.forEach(tf => {
            const imagesForTimeframe = symbolImageData[tf];
            if (!imagesForTimeframe || Object.keys(imagesForTimeframe).length === 0) {
                return; // Skip if no images for this timeframe
            }

            // Find the latest image by sorting by timestamp
            const latestImage = Object.values(imagesForTimeframe).sort((a, b) => b.timestamp - a.timestamp)[0];

            if (latestImage) {
                const itemContainer = document.createElement('div');
                itemContainer.className = 'snapshot-image-item';
                
                const heading = document.createElement('h4');
                heading.textContent = tf;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'journal-image-wrapper';
                wrapper.innerHTML = `<img src="${latestImage.url}" alt="Latest image for ${tf}">`;
                
                itemContainer.appendChild(heading);
                itemContainer.appendChild(wrapper);
                snapshotImagesContainer.appendChild(itemContainer);
            }
        });
    }

    function renderJournalImages(symbol, timeframe, imagesForSymbol) {
        journalImagesContainer.innerHTML = '';
        const imagesForTimeframe = imagesForSymbol[timeframe] || {};
        const imageKeys = Object.keys(imagesForTimeframe);
        if (imageKeys.length === 0) return;

        imageKeys.sort((a, b) => imagesForTimeframe[b].timestamp - imagesForTimeframe[a].timestamp)
            .forEach(id => {
                const imgData = imagesForTimeframe[id];
                if (!imgData || !imgData.url || !imgData.fileName) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'journal-image-wrapper';
                const deleteButton = (isMasterUser && masterPassword) ? `<button class="delete-journal-image" title="Delete Image" data-safe-symbol="${symbol}" data-timeframe="${timeframe}" data-id="${id}" data-filename="${imgData.fileName}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h245.8c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></button>` : '';
                wrapper.innerHTML = `${deleteButton}<img src="${imgData.url}" alt="Journal Image for ${imgData.fileName}">`;
                journalImagesContainer.appendChild(wrapper);
            });
    }
    
    function renderEmaData() {
        const selectedSymbol = getSafeSymbol(journalSymbolEl.value);
        const symbolEmaData = (allEmaData.data || {})[selectedSymbol] || {};
        const lastUpdated = allEmaData.last_updated ? new Date(allEmaData.last_updated).toLocaleString() : '--';
        document.getElementById('ema-last-updated-time').textContent = lastUpdated;
        
        const priceDisplay = document.getElementById('ema-current-price');
        const dataFor15m = symbolEmaData['15min'];
        if (dataFor15m && dataFor15m.price !== undefined) {
            priceDisplay.textContent = `$${dataFor15m.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        } else { priceDisplay.textContent = '...'; }

        const emaTbody = document.getElementById('ema-tbody');
        emaTbody.innerHTML = '';
        const timeframesToDisplay = ['15min', '30min', '1hour', '2hour', '4hour', 'daily'];
        const periodsToDisplay = [13, 49, 100, 200, 500, 1000];
        const tfShortNames = {'15min': '15m','30min': '30m','1hour': '1H','2hour': '2H','4hour': '4H','daily': '1D'};

        timeframesToDisplay.forEach(tf => {
            const tfData = symbolEmaData[tf];
            const row = emaTbody.insertRow();
            const tfCell = row.insertCell();
            tfCell.textContent = tfShortNames[tf] || tf;
            periodsToDisplay.forEach(period => {
                const emaCell = row.insertCell();
                const smaCell = row.insertCell();
                if (tfData) {
                    emaCell.textContent = tfData[`EMA_${period}`] !== undefined ? Math.round(tfData[`EMA_${period}`]).toLocaleString() : '...';
                    smaCell.textContent = tfData[`SMA_${period}`] !== undefined ? Math.round(tfData[`SMA_${period}`]).toLocaleString() : '...';
                } else {
                    emaCell.textContent = '...';
                    smaCell.textContent = '...';
                }
            });
        });
    }

    // --- SETUP AND EVENT LISTENERS ---
    checkMasterMode(); // Run initial setup

    function checkMasterMode() { 
        const urlParams = new URLSearchParams(window.location.search); 
        if (urlParams.get('master') === 'true') { 
            const password = prompt("Please enter master password:"); 
            if (password) { 
                isMasterUser = true; masterPassword = password; 
                document.querySelectorAll('.master-only').forEach(el => { 
                    if (el.id === 'add-trade-form') el.style.display = 'grid'; 
                    else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell'; 
                    else if (el.classList.contains('backup-controls')) el.style.display = 'flex'; 
                    else el.style.display = 'block'; 
                }); 
                journalEntryEl.readOnly = false; 
            } 
        } 
        if (!isMasterUser) { journalEntryEl.readOnly = true; } 
    }

    function handleFileUpload(file) {
        if (!isMasterUser || !masterPassword || !file || !file.type.startsWith('image/')) return;
        const uploadProgressEl = document.getElementById('upload-progress');
        uploadProgressEl.style.display = 'block';
        const safeSymbol = getSafeSymbol(journalSymbolEl.value);
        const timeframe = journalTimeframeEl.value;
        const fileName = `${Date.now()}_${file.name}`;
        const storagePath = `journal_images/${safeSymbol}/${timeframe}/${fileName}`;
        const fileRef = storage.ref(storagePath);
        const metadata = { customMetadata: { 'password': masterPassword } };
        const uploadTask = fileRef.put(file, metadata);

        uploadTask.on('state_changed', (s) => { uploadProgressEl.textContent = `Uploading... ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`; },
        (storageError) => { console.error("STORAGE UPLOAD FAILED:", storageError); uploadProgressEl.textContent = `Upload Failed: ${storageError.code}`; },
        () => {
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                const imageDataForFirebase = { url: downloadURL, fileName: fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                const newRef = journalImagesRef.child(safeSymbol).child(timeframe).push(imageDataForFirebase);
                newRef.then(() => { 
                    uploadProgressEl.textContent = 'Upload Complete!'; 
                    setTimeout(() => { uploadProgressEl.style.display = 'none'; }, 2000); 
                    const imageDataForLocalCache = { url: downloadURL, fileName: fileName, timestamp: Date.now() };
                    if (!allJournalImages[safeSymbol]) allJournalImages[safeSymbol] = {};
                    if (!allJournalImages[safeSymbol][timeframe]) allJournalImages[safeSymbol][timeframe] = {};
                    allJournalImages[safeSymbol][timeframe][newRef.key] = imageDataForLocalCache;
                    updateJournalView();
                }).catch((dbError) => { console.error("DATABASE SAVE FAILED:", dbError); uploadProgressEl.textContent = 'DB save failed: ' + dbError.message; fileRef.delete(); });
            });
        });
    }
    
    document.querySelector('.tabs').addEventListener('click', (e) => { 
        if (!e.target.matches('.tab-link')) return;
        document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); 
        e.target.classList.add('active'); 
        const activeTabId = e.target.dataset.tab + '-tab';
        document.getElementById(activeTabId).classList.add('active'); 
        
        if (e.target.dataset.tab === 'journal') {
            updateJournalView();
        } else if (e.target.dataset.tab === 'snapshot') {
            renderSnapshotView();
        }
    });

    snapshotSymbolEl.addEventListener('change', renderSnapshotView);
    journalSymbolEl.addEventListener('change', updateJournalView);
    journalTimeframeEl.addEventListener('change', updateJournalView);
    
    // ... Other listeners for trades, journal input, image delete etc.
    
    // --- FIREBASE DATA LISTENERS ---
    emaValuesRef.on('value', (s) => { if (s.exists()) { allEmaData = s.val(); updateJournalView(); } });
    journalRef.on('value', (s) => { allJournalText = s.val() || {}; updateJournalView(); });
    journalImagesRef.on('value', (s) => {
        allJournalImages = s.val() || {};
        updateJournalView();
        // Also update snapshot in case the active tab is snapshot when a new image arrives
        if (document.getElementById('snapshot-tab').classList.contains('active')) {
            renderSnapshotView();
        }
    });

    // ... Other listeners for trades, bank, etc.
});

</script>
