<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h2 { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; }
        .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
        .backup-controls { position: absolute; right: 0; display: flex; gap: 10px; }
        .backup-controls button, .backup-controls label { font-size: 12px; padding: 6px 12px; cursor: pointer; background-color: #6c757d; border: none; color: white; border-radius: 4px; }
        .backup-controls input[type="file"] { display: none; }
        p.subtitle { text-align: center; font-style: italic; margin-top: 0; color: #666; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: #007bff; border-bottom-color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #bank-balance-container { text-align: center; margin: 10px auto 25px auto; font-size: 24px; font-weight: bold; color: #333; padding: 10px; background-color: #e9ecef; border-radius: 8px; max-width: 400px; }
        #bank-balance-value { font-weight: bolder; }
        .master-only { display: none; }
        #add-trade-form { max-width: 950px; margin: 20px auto; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        #add-trade-form div { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select, button, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
        button.delete-btn, button.delete-btn-completed, button.delete-journal-image { background-color: #dc3545; }
        button:hover { opacity: 0.85; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; white-space: nowrap; }
        th { background-color: #e9ecef; font-weight: bold; }
        #journal-tab { position: relative; }
        #journal-controls { display: flex; align-items: center; gap: 15px; max-width: 500px; margin: 20px auto; }
        #journal-entry { width: 100%; height: 40vh; resize: vertical; line-height: 1.6; }
        #journal-entry:read-only { background-color: #f8f9fa; cursor: not-allowed; color: #555; }
        #image-upload-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; }
        .image-upload-label { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: center; display: inline-block; }
        #journal-image-upload { display: none; }
        #upload-progress { margin-top: 10px; font-style: italic; color: #007bff; }
        #journal-images-container { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .journal-image-wrapper { position: relative; max-width: 80%; border: 1px solid #ddd; padding: 5px; background: #fafafa; border-radius: 4px; }
        .journal-image-wrapper img { max-width: 100%; height: auto; display: block; }
        .delete-journal-image { position: absolute; top: 10px; right: 10px; padding: 4px 8px; font-size: 12px; z-index: 10; }
        #journal-tab.drag-over { border: 3px dashed #007bff; background-color: rgba(0, 123, 255, 0.05); }
        #journal-tab.drag-over::before { content: "Drop Image Here"; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #007bff; z-index: 999; pointer-events: none; }
        @media (max-width: 768px) { .container { padding: 10px; } #add-trade-form { grid-template-columns: 1fr; } .section-header { flex-direction: column; } .backup-controls { position: static; margin-top: 10px; } .journal-image-wrapper { max-width: 100%; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Live Trade & Journal Tracker</h1>
        <p class="subtitle">Data updates in real-time for all viewers.</p>

        <div class="tabs">
            <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
            <button class="tab-link" data-tab="journal">Journal</button>
        </div>
        
        <div id="tracker-tab" class="tab-content active"><!-- TRADES CONTENT --></div>

        <div id="journal-tab" class="tab-content">
            <h2>Text & Image Journal</h2>
            <div id="journal-controls">
                <label for="journal-timeframe">Select Entry:</label>
                <select id="journal-timeframe"><option value="15min">15min</option><option value="30min">30min</option><option value="1hour">1hour</option><option value="2hour">2hour</option><option value="4hour">4hour</option><option value="daily">Daily</option></select>
            </div>
            <textarea id="journal-entry" placeholder="Select a timeframe and start typing..."></textarea>
            <p id="save-status" style="text-align:center; font-style:italic; color:#666; height: 1em;"></p>
            <div id="image-upload-section" class="master-only">
                <label for="journal-image-upload" class="image-upload-label">Add Picture to this Timeframe</label>
                <input type="file" id="journal-image-upload" accept="image/*">
                <div id="upload-progress" style="display: none;"></div>
            </div>
            <div id="journal-images-container"></div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
    // --- Paste your Firebase config here ---
    const firebaseConfig = {
        apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
        authDomain: "journal-a003f.firebaseapp.com",
        databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "journal-a003f",
        storageBucket: "journal-a003f.appspot.com",
        messagingSenderId: "1038636626553",
        appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
    };
    // ------------------------------------

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();
    const tradesRef = database.ref('trades');
    const completedTradesRef = database.ref('completed_trades');
    const bankRef = database.ref('bank');
    const journalRef = database.ref('journal_text'); 
    const journalImagesRef = database.ref('journal_images'); 

    document.addEventListener('DOMContentLoaded', function () {
        let isMasterUser = false;
        let masterPassword = null; // Will store the entered password
        let allJournalEntries = {}; 
        let allJournalImages = {};
        
        const journalTab = document.getElementById('journal-tab');
        const journalTimeframeEl = document.getElementById('journal-timeframe');
        const journalEntryEl = document.getElementById('journal-entry');
        const saveStatusEl = document.getElementById('save-status');
        const journalImageUploadEl = document.getElementById('journal-image-upload');
        const uploadProgressEl = document.getElementById('upload-progress');
        const journalImagesContainer = document.getElementById('journal-images-container');

        // This function now handles password validation
        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true') {
                const password = prompt("Please enter the master password:");
                if (password) { // If user didn't click cancel
                    isMasterUser = true;
                    masterPassword = password; // Store the password for uploads
                    document.querySelectorAll('.master-only').forEach(el => {
                         if (el.id === 'add-trade-form') el.style.display = 'grid';
                         else if (el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                         else if (el.classList.contains('backup-controls')) el.style.display = 'flex';
                         else el.style.display = 'block';
                    });
                    // Note: Deleting trades and text also needs securing, but this change focuses on the image upload vulnerability as requested.
                }
            }
            // If not master, or password prompt is cancelled/wrong, everything remains read-only by default.
            if (!isMasterUser) {
                 journalEntryEl.readOnly = true;
            }
        }
        
        checkMasterMode(); 

        function handleFileUpload(file) {
            // Re-check master status AND if a password was provided.
            if (!isMasterUser || !masterPassword) {
                alert("You do not have permission to upload files.");
                return;
            }
            if (!file || !file.type.startsWith('image/')) {
                if (file) alert('Only image files can be uploaded.');
                return;
            }

            const selectedTimeframe = journalTimeframeEl.value;
            const fileName = `${Date.now()}_${file.name}`;
            
            // **IMPORTANT**: Add the password to the file's metadata for the rules to check
            const metadata = {
                customMetadata: {
                    'password': masterPassword 
                }
            };
            
            const uploadTask = storage.ref(`journal_images/${selectedTimeframe}/${fileName}`).put(file, metadata);
            
            uploadProgressEl.style.display = 'block';
            uploadTask.on('state_changed', 
                (snapshot) => { uploadProgressEl.textContent = `Uploading... ${Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100)}%`; }, 
                (error) => { 
                    console.error("Upload error:", error);
                    // Give user helpful feedback if the password was wrong
                    if (error.code === 'storage/unauthorized') {
                        uploadProgressEl.textContent = 'Upload failed. Permission denied (check password).';
                    } else {
                        uploadProgressEl.textContent = `Upload failed: ${error.code}`;
                    }
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const imageData = { url: downloadURL, fileName: fileName, timestamp: firebase.database.ServerValue.TIMESTAMP };
                        journalImagesRef.child(selectedTimeframe).push(imageData);
                        uploadProgressEl.textContent = 'Upload complete!';
                        setTimeout(() => { uploadProgressEl.style.display = 'none'; }, 2000);
                    });
                }
            );
        }
        
        // --- ALL OTHER LISTENERS AND FUNCTIONS (NO CHANGES NEEDED) ---
        document.querySelector('.tabs').addEventListener('click', (e) => {
            if (e.target.matches('.tab-link')) {
                document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab + '-tab').classList.add('active');
            }
        });
        const saveJournalEntry = (() => { let t; return () => { clearTimeout(t); t = setTimeout(() => { if (!isMasterUser) return; saveStatusEl.textContent = 'Saving...'; journalRef.child(journalTimeframeEl.value).set(journalEntryEl.value).then(() => { saveStatusEl.textContent = 'Saved.'; setTimeout(() => saveStatusEl.textContent = '', 2000); }).catch(e => saveStatusEl.textContent = `Error: ${e.message}`); }, 750); }; })();
        function renderJournalImages(timeframe) {
            journalImagesContainer.innerHTML = '';
            const images = allJournalImages[timeframe]; if (!images) return;
            Object.keys(images).sort((a,b) => images[a].timestamp - images[b].timestamp).forEach(id => {
                const img = images[id]; const w = document.createElement('div'); w.className = 'journal-image-wrapper';
                w.innerHTML = `${isMasterUser ? `<button class="delete-journal-image" data-timeframe="${timeframe}" data-id="${id}" data-filename="${img.fileName}">Delete</button>` : ''}<img src="${img.url}" alt="Journal Image">`;
                journalImagesContainer.appendChild(w);
            });
        }
        function updateJournalView() { renderJournalImages(journalTimeframeEl.value); journalEntryEl.value = allJournalEntries[journalTimeframeEl.value] || ''; }
        journalTimeframeEl.addEventListener('change', updateJournalView);
        journalEntryEl.addEventListener('input', saveJournalEntry);
        journalRef.on('value', (s) => { allJournalEntries = s.val() || {}; if (journalTab.classList.contains('active')) updateJournalView(); });
        journalImagesRef.on('value', (s) => { allJournalImages = s.val() || {}; if (journalTab.classList.contains('active')) renderJournalImages(journalTimeframeEl.value); });
        journalImageUploadEl.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
        journalImagesContainer.addEventListener('click', (e) => { if (!isMasterUser || !e.target.classList.contains('delete-journal-image')) return; const { timeframe, id, filename } = e.target.dataset; if (confirm('Delete this image?')) storage.ref(`journal_images/${timeframe}/${filename}`).delete().then(() => journalImagesRef.child(timeframe).child(id).remove()).catch((err) => { console.error(err); if (err.code === 'storage/object-not-found') journalImagesRef.child(timeframe).child(id).remove(); }); });
        ['dragenter','dragover','dragleave','drop'].forEach(ev=>journalTab.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
        ['dragenter','dragover'].forEach(ev=>journalTab.addEventListener(ev,()=>isMasterUser&&journalTab.classList.add('drag-over')));
        ['dragleave','drop'].forEach(ev=>journalTab.addEventListener(ev,()=>isMasterUser&&journalTab.classList.remove('drag-over')));
        journalTab.addEventListener('drop', (e) => { if (isMasterUser && e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]); });
        // Minimal trade-tracker placeholder for the demo
        document.getElementById('tracker-tab').innerHTML = '<div style="text-align:center;padding:50px;color:#777;">Trade Tracker content would be here.</div>';
    });
</script>

</body>
</html>
