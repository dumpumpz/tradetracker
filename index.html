<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trade & Journal Tracker (Grouped)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

</head>
<style>
    :root {
        --bg-color: #f4f7f6;
        --container-bg: #fff;
        --text-color: #333;
        --border-color: #ddd;
        --header-bg: #e9ecef;
        --link-color: #007bff;
        --subtle-text: #666;
        --card-bg: #fafafa;
        --shadow-color: rgba(0,0,0,0.1);
        --green-bg: #d4edda;
        --red-bg: #f8d7da;
        --purple-bg: #e2d9f3;
        --green-border: #c3e6cb;
        --red-border: #f5c6cb;
        --green-text: #155724;
        --red-text: #721c24;
        --group-header-bg: #e2e6ea;
        --group-hover: #dbe2e8;
    }

    [data-theme="dark"] {
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --border-color: #444;
        --header-bg: #2c2c2c;
        --link-color: #58a6ff;
        --subtle-text: #888;
        --card-bg: #2a2a2a;
        --shadow-color: rgba(0,0,0,0.4);
        --green-bg: #1c3b23;
        --red-bg: #4d1f24;
        --purple-bg: #3c2a4d;
        --green-border: #285732;
        --red-border: #6b282e;
        --green-text: #a7d7b2;
        --red-text: #f5b7bd;
        --group-header-bg: #383838;
        --group-hover: #444;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
    .container { max-width: 1200px; margin: auto; background: var(--container-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); transition: background-color 0.3s; }
    h1 { text-align: center; color: var(--text-color); margin-bottom: 5px; }
    h2 { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
    h3 { text-align: center; color: var(--text-color); margin-top: 30px; margin-bottom: -5px; font-weight: 500;}
    .section-header { display: flex; justify-content: center; align-items: center; position: relative; }
    .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
    .tab-link { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--subtle-text); border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab-link.active { color: var(--link-color); border-bottom-color: var(--link-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .master-only { display: none; }
    #add-trade-form { margin: 0 auto; padding: 0; border: none; border-radius: 0; background-color: transparent; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
    label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
    input, select, button, textarea { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; font-family: inherit; background-color: var(--container-bg); color: var(--text-color); }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.3s; margin-top: 5px; }
    button:hover { opacity: 0.85; }
    .table-wrapper { width: 100%; overflow-x: auto; overflow-y: hidden; padding-bottom: 5px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 14px; white-space: nowrap; vertical-align: top; }
    th { background-color: var(--header-bg); font-weight: bold; vertical-align: middle; text-align: center; }
    .action-buttons button { padding: 3px 4px; font-size: 10px; margin-right: 4px; }
    .note-cell { white-space: normal; max-width: 300px; min-width: 250px; font-size: 12px; line-height: 1.4; }

    /* Grouping Styles */
    tr.group-row { background-color: var(--group-header-bg); border-top: 2px solid var(--border-color); font-weight: bold; }
    tr.group-row:hover { background-color: var(--group-hover); }
    tr.child-row td:first-child { border-left: 4px solid var(--link-color); }
    tr.child-row { background-color: var(--container-bg); }
    .group-name { font-weight: 800; color: var(--link-color); }

    /* Stats Panel */
    #stats-panel-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
    #stats-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease-in-out; }
    #stats-panel { position: absolute; bottom: 80px; left: 0; width: 300px; background: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); padding: 15px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; }
    #stats-panel.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .stats-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
    .stat-item { display: flex; justify-content: space-between; align-items: baseline; padding: 5px 0; }
    .stat-value { font-size: 16px; font-weight: 600; color: var(--text-color); }

    /* Collapsible */
    .collapsible-section { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; background-color: var(--card-bg); overflow: hidden; }
    .collapsible-section.master-only { display: none; }
    .collapsible-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; cursor: pointer; background-color: var(--header-bg); }
    .collapsible-header h2 { margin: 0; padding: 0; border: none; font-size: 1.1em; font-weight: 600; }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
    .collapsible-content-inner { padding: 20px; border-top: 1px solid var(--border-color); }

    /* Misc */
    .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 20px; z-index: 10; }
    .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
    .theme-switch input { display: none; }
    .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
    .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
    input:checked + .slider { background-color: var(--link-color); }
    input:checked + .slider:before { transform: translateX(26px); }
    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }

    /* Scrollbar */
    .table-wrapper::-webkit-scrollbar { height: 16px !important; width: 16px !important; }
    .table-wrapper::-webkit-scrollbar-track { background-color: #333 !important; border-top: 1px solid #555 !important; }
    .table-wrapper::-webkit-scrollbar-thumb { background-color: #c0c0c0 !important; border-radius: 10px !important; border: 4px solid #333 !important; min-height: 50px !important; }
    .table-wrapper::-webkit-scrollbar-thumb:hover { background-color: #fff !important; }

    /* Summary Cards */
    .summary-split-container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; }
    .summary-card { flex: 1; min-width: 300px; border-radius: 8px; padding: 12px; border: 1px solid var(--border-color); background-color: var(--bg-color); }
    .summary-card.long-card { border-top: 3px solid var(--green-text); background-color: rgba(40, 167, 69, 0.05); }
    .summary-card.short-card { border-top: 3px solid var(--red-text); background-color: rgba(220, 53, 69, 0.05); }
    .summary-grid-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 8px; text-align: center; }
    .sum-label { font-size: 10px; color: var(--subtle-text); text-transform: uppercase; display: block; }
    .sum-val { font-size: 15px; font-weight: 700; font-family: 'Courier New', monospace; }
    .val-green { color: var(--green-text); }
    .val-red { color: var(--red-text); }

    @media (max-width: 768px) {
        .container { padding: 10px; }
        #add-trade-form { grid-template-columns: 1fr; }
        th, td { font-size: 12px; padding: 6px; }
        .summary-card { min-width: 100%; }
    }
</style>
<body>
<div class="container">

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="theme-checkbox">
            <input type="checkbox" id="theme-checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div id="stats-panel-container">
        <div id="stats-panel">
            <div class="stats-header"><h3>Performance Stats</h3><button id="close-stats-btn" title="Close Panel">Ã—</button></div>
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">Current Balance</span><span id="stat-balance" class="stat-value">$0.00</span></div>
                <div class="stat-item"><span class="stat-label">AUD Value</span><span id="stat-balance-aud" class="stat-value">--</span></div>
                <div class="stat-item"><span class="stat-label">Total P/L</span><span id="stat-total-pl" class="stat-value">$0.00</span></div>
                <hr style="grid-column: 1 / -1; border: 0; border-top: 1px solid var(--border-color); margin: 5px 0;">
                <div class="stat-item"><span class="stat-label">Completed Trades</span><span id="stat-completed-trades" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">Wins / Losses</span><div><span id="stat-wins" class="stat-value" style="color: var(--green-text);">0</span> / <span id="stat-losses" class="stat-value" style="color: var(--red-text);">0</span></div></div>
                <div class="stat-item"><span class="stat-label">Win Rate</span><span id="stat-win-rate" class="stat-value">0.0%</span></div>
                <div class="stat-item"><span class="stat-label">Open Trades</span><span id="stat-open-trades" class="stat-value">0</span></div>
            </div>
        </div>
        <button id="stats-fab" title="Show Stats"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width:28px;height:28px;fill:white"><path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8-7.2 16-16 16H48c-8.8 0-16-7.2-16-16V64C32 46.3 46.3 32 64 32H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H96v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96H64V64zM256 224c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7-14.3 32 32 32s32-14.3 32-32V224zM352 288c-17.7 0-32 14.3-32 32v64H256c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32zM480 32c17.7 0 32 14.3 32 32s-14.3 32-32 32H416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V96h-1.5c-16.3 0-30.8-12.4-32-28.5c-.2-2.1-.2-4.2-.2-6.4V64c0-17.7 14.3-32 32-32H480z"/></svg></button>
    </div>

    <div class="tabs">
        <button class="tab-link active" data-tab="tracker">Trade Tracker</button>
        <button class="tab-link" data-tab="journal">Journal</button>
    </div>

    <div id="tracker-tab" class="tab-content active">

        <!-- Add New Trade Section -->
        <div class="collapsible-section master-only">
            <div class="collapsible-header">
                <h2>Add New Trade</h2>
                <button class="collapsible-toggle-btn">+</button>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-content-inner">
                    <form id="add-trade-form">
                        <div>
                            <label for="trade-idea-name">Trade Idea / Group Name:</label>
                            <input type="text" id="trade-idea-name" placeholder="e.g. BTC Spot Swing (Optional)">
                        </div>
                        <div>
                            <label for="trade-symbol">Symbol:</label>
                            <input type="text" id="trade-symbol" placeholder="BTC/USDT">
                        </div>
                        <div>
                            <label for="trade-exchange">Exchange / Fees:</label>
                            <select id="trade-exchange">
                                <option value="binance">Binance</option>
                                <option value="hyperliquid">Hyperliquid</option>
                            </select>
                        </div>
                        <div>
                            <label for="trade-type">Trade Type:</label>
                            <select id="trade-type">
                                <option value="Long">Long</option>
                                <option value="Short">Short</option>
                            </select>
                        </div>
                        <div>
                            <label for="trade-status">Status:</label>
                            <select id="trade-status">
                                <option value="live">Live Trade</option>
                                <option value="resting">Resting (Limit)</option>
                            </select>
                        </div>
                        <div><label for="entry-price">Entry Price:</label><input type="number" id="entry-price" step="any" required></div>
                        <div><label for="stop-loss">Stop Loss:</label><input type="number" id="stop-loss" step="any" required></div>
                        <div><label for="target">Target:</label><input type="number" id="target" step="any" required></div>
                        <div><label for="position-value">Position Value ($):</label><input type="number" id="position-value" step="any" required></div>
                        <div>
                            <label for="entry-fee-type">Entry Fee:</label>
                            <select id="entry-fee-type">
                                <option value="taker">Taker Fee</option>
                                <option value="maker">Maker Fee</option>
                            </select>
                        </div>
                        <div><button type="submit">Add Trade</button></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resting Limit Orders Section -->
        <div class="collapsible-section">
            <div class="collapsible-header">
                <h2>Resting Limit Orders</h2>
                <button class="collapsible-toggle-btn">+</button>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-content-inner">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                            <tr>
                                <th>Idea / Group</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Entry Price</th>
                                <th>Stop Loss</th>
                                <th>Target</th>
                                <th>Position Value ($)</th>
                                <th>Est. Profit</th>
                                <th>Est. Loss</th>
                                <th>Note</th>
                                <th class="master-only">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="resting-trades-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Trades Section -->
        <div class="collapsible-section">
            <div class="collapsible-header">
                <h2>Live Trades (Grouped by Trade Idea)</h2>
                <button class="collapsible-toggle-btn">+</button>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-content-inner">

                    <div id="live-trades-summary-container" class="summary-split-container" style="display:none; margin-bottom: 20px;"></div>

                    <div class="table-wrapper">
                        <table id="live-trades-table">
                            <thead>
                            <tr>
                                <th>Trade Idea / Symbol</th>
                                <th>Type</th>
                                <th>Avg. Entry</th>
                                <th>Stop Loss</th>
                                <th>Avg. Target</th>
                                <th>Total Size ($)</th>
                                <th>Total Qty</th>
                                <th>Proj. Profit (T)</th>
                                <th>Proj. Loss (T)</th>
                                <th>Date Started</th>
                                <th class="master-only">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="trades-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Trades Section -->
        <div class="collapsible-section">
            <div class="collapsible-header">
                <h2>Completed Trades</h2>
                <button class="collapsible-toggle-btn">+</button>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-content-inner">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                            <tr>
                                <th>Trade Idea</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Avg Entry</th>
                                <th>Avg Exit</th>
                                <th>Total Size ($)</th>
                                <th>Total Fees ($)</th>
                                <th>Net Result ($)</th>
                                <th>Date Closed</th>
                                <th class="master-only">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="completed-trades-tbody"></tbody>
                        </table>
                    </div>
                    <button id="toggle-all-completed-trades" class="toggle-history-btn" style="display:none; margin:10px auto; display:block; cursor:pointer; padding:5px;">Show All</button>
                </div>
            </div>
        </div>

    </div>

    <div id="journal-tab" class="tab-content">
        <h3 style="margin:20px 0;">Journal feature is active but simplified for this view.</h3>
        <textarea id="journal-entry" style="width:100%; height:150px;" placeholder="Journal notes..."></textarea>
        <p id="save-status" style="text-align:center; font-style:italic; color:#666;"></p>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const CONFIG = {
            FIREBASE: {
                apiKey: "AIzaSyCQ4vHqGiv_yRkA0zZaaOU24gxhqBkxnv4",
                authDomain: "journal-a003f.firebaseapp.com",
                databaseURL: "https://journal-a003f-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "journal-a003f",
                storageBucket: "journal-a003f.firebasestorage.app",
                messagingSenderId: "1038636626553",
                appId: "1:1038636626553:web:7a91c321e39c146bdc9aa8"
            },
            DB_PATHS: { TRADES: 'trades', COMPLETED_TRADES: 'completed_trades', BANK: 'bank', RESTING_ORDERS: 'resting_orders' },
            TRADE_SETTINGS: { STARTING_BALANCE: 5137 }
        };

        const DOM = {
            tabs: document.querySelector('.tabs'),
            themeToggle: document.getElementById('theme-checkbox'),
            addTradeForm: document.getElementById('add-trade-form'),
            tradesTbody: document.getElementById('trades-tbody'),
            restingTradesTbody: document.getElementById('resting-trades-tbody'),
            completedTradesTbody: document.getElementById('completed-trades-tbody'),
            statBalance: document.getElementById('stat-balance'),
            statBalanceAud: document.getElementById('stat-balance-aud'),
            statTotalPl: document.getElementById('stat-total-pl'),
            statCompletedTrades: document.getElementById('stat-completed-trades'),
            statWins: document.getElementById('stat-wins'),
            statLosses: document.getElementById('stat-losses'),
            statWinRate: document.getElementById('stat-win-rate'),
            statOpenTrades: document.getElementById('stat-open-trades'),
            summaryContainer: document.getElementById('live-trades-summary-container'),
            statsFab: document.getElementById('stats-fab'),
            statsPanel: document.getElementById('stats-panel'),
            closeStatsBtn: document.getElementById('close-stats-btn'),
            journalEntryEl: document.getElementById('journal-entry'),
            saveStatus: document.getElementById('save-status')
        };

        const STATE = {
            isMasterUser: false,
            usdToAudRate: 1.53,
            completedTradesShowAll: false
        };

        firebase.initializeApp(CONFIG.FIREBASE);
        const database = firebase.database();
        const dbRefs = {
            trades: database.ref(CONFIG.DB_PATHS.TRADES),
            completedTrades: database.ref(CONFIG.DB_PATHS.COMPLETED_TRADES),
            bank: database.ref(CONFIG.DB_PATHS.BANK),
            restingOrders: database.ref(CONFIG.DB_PATHS.RESTING_ORDERS)
        };

        const formatCurrency = (num, symbol = '$') => `${symbol}${parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const getFeeRates = (exchange) => (exchange === 'hyperliquid') ? { MAKER: 0.00015, TAKER: 0.00045 } : { MAKER: 0.0000, TAKER: 0.00075 };

        // --- METRICS CALCULATION ---
        function calculateTradeMetrics(trade) {
            const entry = parseFloat(trade.entry);
            const stoploss = parseFloat(trade.stoploss);
            const target = parseFloat(trade.target);
            const size = parseFloat(trade.size);

            if ([entry, stoploss, target, size].some(v => isNaN(v) || v <= 0)) return { expected_profit_taker: 0, expected_loss_taker: 0 };

            const rates = getFeeRates(trade.exchange);
            const entryFeeRate = trade.entryFeeType === 'maker' ? rates.MAKER : rates.TAKER;
            const positionQty = size / entry;
            const entryFee = size * entryFeeRate;

            let potentialProfit, potentialLoss;
            if (trade.type === 'Long') {
                potentialProfit = positionQty * (target - entry);
                potentialLoss = positionQty * (entry - stoploss);
            } else {
                potentialProfit = positionQty * (entry - target);
                potentialLoss = positionQty * (stoploss - entry);
            }

            const exitFeeTaker = (target / entry) * size * rates.TAKER;
            const exitFeeTakerStop = (stoploss / entry) * size * rates.TAKER;

            return {
                expected_profit_taker: potentialProfit - entryFee - exitFeeTaker,
                expected_loss_taker: potentialLoss + entryFee + exitFeeTakerStop
            };
        }

        // --- HELPER: GROUP TRADES BY PARENT ID ---
        function groupTradesByParent(trades) {
            const groups = {};
            Object.keys(trades).forEach(key => {
                const t = trades[key];
                const pid = t.parentId || `orphan_${key}`; // Fallback for old data
                const ideaName = t.ideaName || `${t.symbol} Trade`;

                if (!groups[pid]) {
                    groups[pid] = {
                        id: pid,
                        name: ideaName,
                        symbol: t.symbol,
                        type: t.type,
                        trades: [],
                        totalSize: 0,
                        totalQty: 0,
                        weightedEntrySum: 0,
                        weightedTargetSum: 0,
                        startDate: t.date,
                        projProfit: 0,
                        projLoss: 0
                    };
                }
                const g = groups[pid];
                // Metrics for this specific trade entry
                const metrics = calculateTradeMetrics(t);
                const size = parseFloat(t.size);
                const entry = parseFloat(t.entry);
                const qty = size / entry;

                g.trades.push({ ...t, id: key, ...metrics });

                // Accumulate Group Stats
                g.totalSize += size;
                g.totalQty += qty;
                g.weightedEntrySum += (entry * qty);
                g.weightedTargetSum += (parseFloat(t.target) * qty);
                g.projProfit += metrics.expected_profit_taker;
                g.projLoss += metrics.expected_loss_taker;
                if (t.date < g.startDate) g.startDate = t.date;
            });

            // Finalize Averages
            Object.values(groups).forEach(g => {
                g.avgEntry = g.totalQty > 0 ? g.weightedEntrySum / g.totalQty : 0;
                g.avgTarget = g.totalQty > 0 ? g.weightedTargetSum / g.totalQty : 0;
            });

            return groups;
        }

        // --- RENDER LIVE TRADES (HIERARCHICAL) ---
        function renderLiveTable(trades) {
            const groups = groupTradesByParent(trades || {});
            const sortedGroupIds = Object.keys(groups).sort((a, b) => groups[b].startDate - groups[a].startDate);
            let html = '';
            let totalLongSize = 0, totalShortSize = 0, totalLongPnl = 0, totalShortPnl = 0;

            sortedGroupIds.forEach(pid => {
                const g = groups[pid];
                const isLong = g.type === 'Long';
                const color = isLong ? 'var(--green-text)' : 'var(--red-text)';

                if(isLong) { totalLongSize += g.totalSize; totalLongPnl += g.projProfit; }
                else { totalShortSize += g.totalSize; totalShortPnl += g.projProfit; }

                // 1. Group Summary Row
                const stopLossDisplay = g.trades[0]?.stoploss || '--'; // Simplification: Take first SL or calculate weighted if needed

                const masterGroupBtns = STATE.isMasterUser ?
                    `<button class="add-to-position-btn" data-parent-id="${pid}" data-symbol="${g.symbol}" data-type="${g.type}" data-exchange="${g.trades[0].exchange}" style="background-color: var(--link-color);">+ Add</button>
                     <button class="close-group-btn" data-parent-id="${pid}" style="background-color: var(--purple-bg); color: #333; font-weight: bold;">Close All</button>` : '';

                html += `<tr class="group-row">
                    <td class="group-name">${g.name} (${g.trades.length})</td>
                    <td style="color:${color}">${g.type}</td>
                    <td>${g.avgEntry.toFixed(4)}</td>
                    <td>${stopLossDisplay}</td>
                    <td>${g.avgTarget.toFixed(4)}</td>
                    <td>$${g.totalSize.toLocaleString()}</td>
                    <td style="font-family:'Courier New'">${g.totalQty.toFixed(4)}</td>
                    <td style="color:var(--green-text)">$${g.projProfit.toFixed(2)}</td>
                    <td style="color:var(--red-text)">$${g.projLoss.toFixed(2)}</td>
                    <td>${new Date(g.startDate).toLocaleDateString()}</td>
                    <td class="master-only" style="text-align:right;">${masterGroupBtns}</td>
                </tr>`;

                // 2. Child Rows (Individual Entries)
                g.trades.sort((a, b) => b.date - a.date).forEach(t => {
                    const masterChildBtns = STATE.isMasterUser ?
                        `<button class="close-single-btn" data-id="${t.id}" style="background-color: #dc3545;">Close</button>
                         <button class="delete-btn" data-id="${t.id}" style="background-color: #6c757d;">Del</button>` : '';

                    html += `<tr class="child-row">
                        <td style="padding-left: 20px; font-size: 0.9em; color: var(--subtle-text);">Entry: ${parseFloat(t.entry).toFixed(4)}</td>
                        <td></td>
                        <td></td>
                        <td>${parseFloat(t.stoploss).toFixed(4)}</td>
                        <td>${parseFloat(t.target).toFixed(4)}</td>
                        <td>$${parseFloat(t.size).toFixed(2)}</td>
                        <td style="font-family:'Courier New'; font-size:0.9em;">${(t.size/t.entry).toFixed(4)}</td>
                        <td style="color: #28a745; font-size: 0.9em;">$${t.expected_profit_taker.toFixed(2)}</td>
                        <td style="color: #dc3545; font-size: 0.9em;">$${t.expected_loss_taker.toFixed(2)}</td>
                        <td style="font-size: 0.8em;">${new Date(t.date).toLocaleTimeString()}</td>
                        <td class="master-only" style="text-align:right;">${masterChildBtns}</td>
                    </tr>`;
                });
            });

            DOM.tradesTbody.innerHTML = html;
            renderSummaryCards(totalLongSize, totalShortSize, totalLongPnl, totalShortPnl);
            checkMasterMode();
        }

        function renderSummaryCards(lSize, sSize, lPnl, sPnl) {
            if(lSize === 0 && sSize === 0) { DOM.summaryContainer.style.display = 'none'; return; }
            DOM.summaryContainer.style.display = 'flex';
            DOM.summaryContainer.innerHTML = `
                <div class="summary-card long-card">
                    <h5 style="color:var(--green-text); margin:0 0 10px 0; text-align:center;">LONG EXPOSURE</h5>
                    <div class="summary-grid-row">
                        <div><span class="sum-label">Total Size</span><span class="sum-val">$${lSize.toLocaleString()}</span></div>
                        <div><span class="sum-label">Proj Profit</span><span class="sum-val val-green">$${lPnl.toLocaleString()}</span></div>
                    </div>
                </div>
                <div class="summary-card short-card">
                    <h5 style="color:var(--red-text); margin:0 0 10px 0; text-align:center;">SHORT EXPOSURE</h5>
                    <div class="summary-grid-row">
                        <div><span class="sum-label">Total Size</span><span class="sum-val">$${sSize.toLocaleString()}</span></div>
                        <div><span class="sum-label">Proj Profit</span><span class="sum-val val-green">$${sPnl.toLocaleString()}</span></div>
                    </div>
                </div>
            `;
        }

        // --- RENDER RESTING ORDERS ---
        function renderRestingTable(trades) {
            let html = '';
            Object.keys(trades).forEach(key => {
                const t = trades[key];
                const metrics = calculateTradeMetrics(t);
                const btns = STATE.isMasterUser ? `<button class="activate-btn" data-id="${key}" style="background-color:#28a745;">Activate</button><button class="delete-resting-btn" data-id="${key}" style="background-color:#dc3545;">Del</button>` : '';
                html += `<tr>
                    <td>${t.ideaName || '--'}</td>
                    <td>${t.symbol}</td>
                    <td style="color:${t.type==='Long'?'var(--green-text)':'var(--red-text)'}">${t.type}</td>
                    <td>${t.entry}</td>
                    <td>${t.stoploss}</td>
                    <td>${t.target}</td>
                    <td>${t.size}</td>
                    <td style="color:var(--green-text)">$${metrics.expected_profit_taker.toFixed(2)}</td>
                    <td style="color:var(--red-text)">$${metrics.expected_loss_taker.toFixed(2)}</td>
                    <td>${t.note || ''}</td>
                    <td class="master-only">${btns}</td>
                </tr>`;
            });
            DOM.restingTradesTbody.innerHTML = html;
            checkMasterMode();
        }

        // --- RENDER COMPLETED TRADES (GROUPED) ---
        function renderCompletedTable(trades) {
            const groups = {};
            // Group completed trades by parentId
            Object.keys(trades).forEach(key => {
                const t = trades[key];
                const pid = t.parentId || `completed_orphan_${key}`;
                if(!groups[pid]) {
                    groups[pid] = {
                        id: pid, name: t.ideaName || `${t.symbol} Trade`,
                        symbol: t.symbol, type: t.type,
                        trades: [], totalSize: 0, totalFees: 0, totalNet: 0,
                        lastDate: t.closed_date
                    };
                }
                const g = groups[pid];
                g.trades.push({...t, id: key});
                g.totalSize += parseFloat(t.size);
                g.totalFees += (parseFloat(t.entry_fee||0) + parseFloat(t.exit_fee||0));
                g.totalNet += parseFloat(t.net_result);
                if(t.closed_date > g.lastDate) g.lastDate = t.closed_date;
            });

            const sortedGroupIds = Object.keys(groups).sort((a,b) => groups[b].lastDate - groups[a].lastDate);
            let html = '';

            // Stats Aggregation
            let wins=0, losses=0, totalPL=0;

            sortedGroupIds.forEach(pid => {
                const g = groups[pid];
                // Stats
                if(g.totalNet > 0) wins++; else losses++;
                totalPL += g.totalNet;

                // Averages
                const totalQty = g.trades.reduce((acc, t) => acc + (parseFloat(t.size)/parseFloat(t.entry)), 0);
                const avgEntry = totalQty ? g.trades.reduce((acc,t) => acc + (parseFloat(t.entry)*(parseFloat(t.size)/parseFloat(t.entry))), 0) / totalQty : 0;
                const avgExit = totalQty ? g.trades.reduce((acc,t) => acc + (parseFloat(t.exit_price)*(parseFloat(t.size)/parseFloat(t.entry))), 0) / totalQty : 0;

                const netColor = g.totalNet >= 0 ? 'var(--green-text)' : 'var(--red-text)';

                // Group Row
                html += `<tr class="group-row" style="background-color: #f1f3f5;">
                    <td>${g.name} <span style="font-weight:normal; font-size:0.8em;">(${g.trades.length} trades)</span></td>
                    <td>${g.symbol}</td>
                    <td style="color:${g.type==='Long'?'var(--green-text)':'var(--red-text)'}">${g.type}</td>
                    <td>${avgEntry.toFixed(4)}</td>
                    <td>${avgExit.toFixed(4)}</td>
                    <td>$${g.totalSize.toLocaleString()}</td>
                    <td>$${g.totalFees.toFixed(2)}</td>
                    <td style="color:${netColor}">$${g.totalNet.toFixed(2)}</td>
                    <td>${new Date(g.lastDate).toLocaleDateString()}</td>
                    <td class="master-only"></td>
                </tr>`;

                // Sub rows
                g.trades.forEach(t => {
                   const subNetColor = t.net_result >= 0 ? 'var(--green-text)' : 'var(--red-text)';
                   const delBtn = STATE.isMasterUser ? `<button class="delete-completed-btn" data-id="${t.id}" style="background-color:#6c757d;">Del</button>` : '';
                   html += `<tr class="child-row">
                        <td style="padding-left:20px; font-size:0.85em; color:#666;">Sub-trade</td>
                        <td></td>
                        <td></td>
                        <td>${parseFloat(t.entry).toFixed(4)}</td>
                        <td>${parseFloat(t.exit_price).toFixed(4)}</td>
                        <td>$${parseFloat(t.size).toFixed(2)}</td>
                        <td>$${((t.entry_fee||0)+(t.exit_fee||0)).toFixed(2)}</td>
                        <td style="color:${subNetColor}; font-size:0.9em;">$${parseFloat(t.net_result).toFixed(2)}</td>
                        <td style="font-size:0.8em;">${new Date(t.closed_date).toLocaleTimeString()}</td>
                        <td class="master-only">${delBtn}</td>
                   </tr>`;
                });
            });

            DOM.completedTradesTbody.innerHTML = html;
            DOM.statTotalPl.textContent = formatCurrency(totalPL);
            DOM.statTotalPl.style.color = totalPL >= 0 ? 'var(--green-text)' : 'var(--red-text)';
            DOM.statCompletedTrades.textContent = sortedGroupIds.length; // Counting completed IDEAS
            DOM.statWins.textContent = wins;
            DOM.statLosses.textContent = losses;
            const winRate = (wins + losses) > 0 ? (wins/(wins+losses)*100).toFixed(1) : 0;
            DOM.statWinRate.textContent = `${winRate}%`;
            checkMasterMode();
        }

        // --- ACTIONS ---

        function handleAddTradeSubmit(e) {
            e.preventDefault();
            if (!STATE.isMasterUser) return;

            const symbol = document.getElementById('trade-symbol').value.toUpperCase();
            const type = document.getElementById('trade-type').value;
            // Generated Parent ID for this new group
            const parentId = `idea_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            // Use input name or default to "Symbol Type"
            const ideaName = document.getElementById('trade-idea-name').value || `${symbol} ${type} Trade`;

            const trade = {
                parentId: parentId,
                ideaName: ideaName,
                symbol: symbol,
                exchange: document.getElementById('trade-exchange').value,
                type: type,
                entry: parseFloat(document.getElementById('entry-price').value),
                stoploss: parseFloat(document.getElementById('stop-loss').value),
                target: parseFloat(document.getElementById('target').value),
                size: parseFloat(document.getElementById('position-value').value),
                entryFeeType: document.getElementById('entry-fee-type').value,
                date: firebase.database.ServerValue.TIMESTAMP
            };

            const status = document.getElementById('trade-status').value;
            const ref = status === 'resting' ? dbRefs.restingOrders : dbRefs.trades;

            ref.push(trade).then(() => {
                e.target.reset();
            });
        }

        // Add to Position: Creates a NEW trade entry sharing the same Parent ID
        function handleAddStaggeredEntry(parentId, symbol, type, exchange) {
            if (!STATE.isMasterUser) return;
            const priceStr = prompt("Enter Entry Price for new add:");
            const sizeStr = prompt("Enter Size ($) for new add:");
            if (!priceStr || !sizeStr) return;

            const newTrade = {
                parentId: parentId,
                ideaName: "", // Inherited visually from group
                symbol: symbol,
                exchange: exchange,
                type: type,
                entry: parseFloat(priceStr),
                size: parseFloat(sizeStr),
                stoploss: 0, // Should prompt or inherit, simplification for now: 0 or user edits
                target: 0,
                entryFeeType: 'taker',
                date: firebase.database.ServerValue.TIMESTAMP
            };

            // Fetch one sibling to get SL/Target/Name defaults
            dbRefs.trades.orderByChild('parentId').equalTo(parentId).limitToFirst(1).once('value', s => {
               const sibling = s.val() ? Object.values(s.val())[0] : null;
               if(sibling) {
                   newTrade.stoploss = sibling.stoploss;
                   newTrade.target = sibling.target;
                   newTrade.ideaName = sibling.ideaName;
               }
               dbRefs.trades.push(newTrade);
            });
        }

        function closeSingleTrade(tradeId) {
            if (!confirm("Close this specific entry?")) return;
            const exitPrice = prompt("Exit Price:");
            if (!exitPrice) return;

            dbRefs.trades.child(tradeId).once('value', s => {
                const t = s.val();
                processClosure(t, tradeId, parseFloat(exitPrice));
            });
        }

        function closeGroup(parentId) {
            if (!confirm("Close ALL trades in this group?")) return;
            const exitPrice = prompt("Exit Price for ALL entries:");
            if (!exitPrice) return;

            dbRefs.trades.orderByChild('parentId').equalTo(parentId).once('value', s => {
                const trades = s.val();
                if (!trades) return;
                Object.keys(trades).forEach(key => {
                    processClosure(trades[key], key, parseFloat(exitPrice));
                });
            });
        }

        function processClosure(trade, tradeKey, exitPrice) {
            const rates = getFeeRates(trade.exchange);
            const entryFee = parseFloat(trade.size) * (trade.entryFeeType==='maker'?rates.MAKER:rates.TAKER);
            const qty = parseFloat(trade.size) / parseFloat(trade.entry);
            const exitValue = qty * exitPrice;
            const exitFee = exitValue * rates.TAKER; // Assume taker exit
            const grossPnL = trade.type === 'Long' ? (exitValue - parseFloat(trade.size)) : (parseFloat(trade.size) - exitValue);
            const netResult = grossPnL - entryFee - exitFee;

            const completed = {
                ...trade,
                exit_price: exitPrice,
                entry_fee: entryFee,
                exit_fee: exitFee,
                net_result: netResult,
                closed_date: firebase.database.ServerValue.TIMESTAMP
            };

            dbRefs.completedTrades.push(completed).then(() => {
                dbRefs.trades.child(tradeKey).remove();
            });
        }

        // --- EVENTS ---
        DOM.addTradeForm.addEventListener('submit', handleAddTradeSubmit);

        // Delegation for dynamic buttons
        document.body.addEventListener('click', e => {
            const btn = e.target;
            if (btn.classList.contains('add-to-position-btn')) {
                handleAddStaggeredEntry(btn.dataset.parentId, btn.dataset.symbol, btn.dataset.type, btn.dataset.exchange);
            }
            if (btn.classList.contains('close-single-btn')) {
                closeSingleTrade(btn.dataset.id);
            }
            if (btn.classList.contains('close-group-btn')) {
                closeGroup(btn.dataset.parentId);
            }
            if (btn.classList.contains('delete-btn')) {
                if(confirm("Delete trade?")) dbRefs.trades.child(btn.dataset.id).remove();
            }
            if (btn.classList.contains('delete-completed-btn')) {
                if(confirm("Delete history?")) dbRefs.completedTrades.child(btn.dataset.id).remove();
            }
            if (btn.classList.contains('activate-btn')) {
                dbRefs.restingOrders.child(btn.dataset.id).once('value', s => {
                    const t = s.val();
                    t.date = firebase.database.ServerValue.TIMESTAMP;
                    dbRefs.trades.push(t).then(() => dbRefs.restingOrders.child(btn.dataset.id).remove());
                });
            }
            if (btn.classList.contains('delete-resting-btn')) {
                dbRefs.restingOrders.child(btn.dataset.id).remove();
            }
            // Stats & Tabs
            if (btn.id === 'stats-fab') DOM.statsPanel.classList.toggle('active');
            if (btn.id === 'close-stats-btn') DOM.statsPanel.classList.remove('active');
            if (btn.classList.contains('tab-link')) {
                document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
            }
            // Collapsible
            if(btn.classList.contains('collapsible-toggle-btn') || btn.closest('.collapsible-header')) {
                const section = btn.closest('.collapsible-section');
                const content = section.querySelector('.collapsible-content');
                const tgl = section.querySelector('.collapsible-toggle-btn');
                if(content.style.maxHeight && content.style.maxHeight !== '0px') {
                    content.style.maxHeight = '0px';
                    tgl.textContent = '+';
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    tgl.textContent = '-';
                }
            }
            // Journal
            if(e.target.id === 'toggle-all-completed-trades') {
                // Logic to pagination would go here, currently strictly viewing latest
                alert("Pagination placeholder");
            }
        });

        // Journal Simple Logic
        DOM.journalEntryEl.addEventListener('input', (e) => {
            clearTimeout(window.journalTimer);
            window.journalTimer = setTimeout(() => {
                if(!STATE.isMasterUser) return;
                // Just saving a simple string for demo purposes, original had complex date logic
                DOM.saveStatus.textContent = "Saving...";
                localStorage.setItem('simple_journal', e.target.value);
                setTimeout(() => DOM.saveStatus.textContent = "Saved locally", 500);
            }, 1000);
        });
        DOM.journalEntryEl.value = localStorage.getItem('simple_journal') || "";


        DOM.themeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
        });

        function checkMasterMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('master') === 'true') {
                if (!STATE.isMasterUser) {
                    const password = prompt("Master Password:");
                    if (password === '123') { // Simple pass for demo
                        STATE.isMasterUser = true;
                    }
                }
            }
            if (STATE.isMasterUser) {
                document.querySelectorAll('.master-only').forEach(el => {
                   if(el.tagName === 'TH' || el.tagName === 'TD') el.style.display = 'table-cell';
                   else el.style.display = 'block';
                });
            }
        }

        // --- LISTENERS ---
        dbRefs.trades.on('value', s => {
            renderLiveTable(s.val() || {});
            DOM.statOpenTrades.textContent = s.val() ? Object.keys(s.val()).length : 0;
        });
        dbRefs.restingOrders.on('value', s => renderRestingTable(s.val() || {}));
        dbRefs.completedTrades.on('value', s => renderCompletedTable(s.val() || {}));

        checkMasterMode();
    });
</script>
</body>
</html>
